2021-10-28 16:25:04.439893 (MainThread): Running with dbt=0.21.0
2021-10-28 16:25:04.747308 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-10-28 16:25:04.748489 (MainThread): Tracking: tracking
2021-10-28 16:25:04.758853 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ca38370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ea24ac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ea24b20>]}
2021-10-28 16:25:04.770746 (MainThread): Partial parsing not enabled
2021-10-28 16:25:04.792384 (MainThread): Parsing macros/etc.sql
2021-10-28 16:25:04.796892 (MainThread): Parsing macros/catalog.sql
2021-10-28 16:25:04.803044 (MainThread): Parsing macros/adapters.sql
2021-10-28 16:25:04.825463 (MainThread): Parsing macros/materializations/seed.sql
2021-10-28 16:25:04.828099 (MainThread): Parsing macros/materializations/view.sql
2021-10-28 16:25:04.830647 (MainThread): Parsing macros/materializations/table.sql
2021-10-28 16:25:04.839823 (MainThread): Parsing macros/materializations/copy.sql
2021-10-28 16:25:04.842378 (MainThread): Parsing macros/materializations/incremental.sql
2021-10-28 16:25:04.856497 (MainThread): Parsing macros/materializations/snapshot.sql
2021-10-28 16:25:04.858299 (MainThread): Parsing macros/core.sql
2021-10-28 16:25:04.862348 (MainThread): Parsing macros/materializations/test.sql
2021-10-28 16:25:04.868944 (MainThread): Parsing macros/materializations/helpers.sql
2021-10-28 16:25:04.878413 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-10-28 16:25:04.880222 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-10-28 16:25:04.896866 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-10-28 16:25:04.928713 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-10-28 16:25:04.950829 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-10-28 16:25:04.952532 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-10-28 16:25:04.962404 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-10-28 16:25:04.981866 (MainThread): Parsing macros/materializations/common/merge.sql
2021-10-28 16:25:04.995551 (MainThread): Parsing macros/materializations/table/table.sql
2021-10-28 16:25:05.003690 (MainThread): Parsing macros/materializations/view/view.sql
2021-10-28 16:25:05.010502 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-10-28 16:25:05.013971 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-10-28 16:25:05.015293 (MainThread): Parsing macros/etc/query.sql
2021-10-28 16:25:05.016150 (MainThread): Parsing macros/etc/is_incremental.sql
2021-10-28 16:25:05.017505 (MainThread): Parsing macros/etc/datetime.sql
2021-10-28 16:25:05.025638 (MainThread): Parsing macros/etc/where_subquery.sql
2021-10-28 16:25:05.027294 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-10-28 16:25:05.029659 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-10-28 16:25:05.031101 (MainThread): Parsing macros/adapters/common.sql
2021-10-28 16:25:05.084980 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-10-28 16:25:05.086580 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-10-28 16:25:05.087680 (MainThread): Parsing macros/schema_tests/unique.sql
2021-10-28 16:25:05.088900 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-10-28 16:25:05.281693 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:25:05.293653 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:25:05.319734 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:25:05.321485 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:25:05.323219 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:25:05.325061 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:25:05.339674 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e45a346c-60fb-451a-b6e2-491c46ae0a08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eba1f70>]}
2021-10-28 16:25:05.344328 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-10-28 16:25:05.344680 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e45a346c-60fb-451a-b6e2-491c46ae0a08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eba1d60>]}
2021-10-28 16:25:05.344944 (MainThread): Found 2 models, 4 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-10-28 16:25:05.346353 (MainThread): 
2021-10-28 16:25:05.346752 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:25:05.347613 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-10-28 16:25:05.347854 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-10-28 16:25:05.348019 (ThreadPoolExecutor-0_0): Got an error when attempting to create a bigquery client: 'expected str, bytes or os.PathLike object, not NoneType'
2021-10-28 16:25:05.348922 (MainThread): Connection 'master' was properly closed.
2021-10-28 16:25:05.349038 (MainThread): Connection 'list_ft-data-330317' was properly closed.
2021-10-28 16:25:05.349153 (MainThread): ERROR: Database Error
  expected str, bytes or os.PathLike object, not NoneType
2021-10-28 16:25:05.349349 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eac6f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eba1190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eba14c0>]}
2021-10-28 16:25:05.349592 (MainThread): Flushing usage events
2021-10-28 16:28:01.124246 (MainThread): Running with dbt=0.21.0
2021-10-28 16:28:01.418464 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-10-28 16:28:01.419858 (MainThread): Tracking: tracking
2021-10-28 16:28:01.429676 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112fba9a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112fdb250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112fdb1c0>]}
2021-10-28 16:28:01.440554 (MainThread): Partial parsing not enabled
2021-10-28 16:28:01.451699 (MainThread): Parsing macros/etc.sql
2021-10-28 16:28:01.454524 (MainThread): Parsing macros/catalog.sql
2021-10-28 16:28:01.460822 (MainThread): Parsing macros/adapters.sql
2021-10-28 16:28:01.482834 (MainThread): Parsing macros/materializations/seed.sql
2021-10-28 16:28:01.485197 (MainThread): Parsing macros/materializations/view.sql
2021-10-28 16:28:01.487652 (MainThread): Parsing macros/materializations/table.sql
2021-10-28 16:28:01.496411 (MainThread): Parsing macros/materializations/copy.sql
2021-10-28 16:28:01.498930 (MainThread): Parsing macros/materializations/incremental.sql
2021-10-28 16:28:01.512223 (MainThread): Parsing macros/materializations/snapshot.sql
2021-10-28 16:28:01.513711 (MainThread): Parsing macros/core.sql
2021-10-28 16:28:01.517087 (MainThread): Parsing macros/materializations/test.sql
2021-10-28 16:28:01.523839 (MainThread): Parsing macros/materializations/helpers.sql
2021-10-28 16:28:01.534743 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-10-28 16:28:01.536576 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-10-28 16:28:01.553091 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-10-28 16:28:01.584402 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-10-28 16:28:01.605822 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-10-28 16:28:01.607395 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-10-28 16:28:01.617126 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-10-28 16:28:01.635925 (MainThread): Parsing macros/materializations/common/merge.sql
2021-10-28 16:28:01.649080 (MainThread): Parsing macros/materializations/table/table.sql
2021-10-28 16:28:01.656733 (MainThread): Parsing macros/materializations/view/view.sql
2021-10-28 16:28:01.663468 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-10-28 16:28:01.667167 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-10-28 16:28:01.668507 (MainThread): Parsing macros/etc/query.sql
2021-10-28 16:28:01.669365 (MainThread): Parsing macros/etc/is_incremental.sql
2021-10-28 16:28:01.670837 (MainThread): Parsing macros/etc/datetime.sql
2021-10-28 16:28:01.678749 (MainThread): Parsing macros/etc/where_subquery.sql
2021-10-28 16:28:01.680363 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-10-28 16:28:01.682550 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-10-28 16:28:01.684067 (MainThread): Parsing macros/adapters/common.sql
2021-10-28 16:28:01.736319 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-10-28 16:28:01.737877 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-10-28 16:28:01.738951 (MainThread): Parsing macros/schema_tests/unique.sql
2021-10-28 16:28:01.740166 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-10-28 16:28:01.928896 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:28:01.940601 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:28:01.965641 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:28:01.967408 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:28:01.969133 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:28:01.970884 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:28:01.984520 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7eaa4841-45eb-4558-bd8f-a62e5215d80c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11304a040>]}
2021-10-28 16:28:01.989050 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-10-28 16:28:01.989436 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7eaa4841-45eb-4558-bd8f-a62e5215d80c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113065460>]}
2021-10-28 16:28:01.989698 (MainThread): Found 2 models, 4 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-10-28 16:28:01.991126 (MainThread): 
2021-10-28 16:28:01.991510 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:28:01.992335 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-10-28 16:28:01.992528 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-10-28 16:28:02.801397 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-10-28 16:28:02.802056 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-10-28 16:28:02.814493 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:28:03.435021 (MainThread): 17:28:03 | Concurrency: 4 threads (target='dev')
2021-10-28 16:28:03.435542 (MainThread): 17:28:03 | 
2021-10-28 16:28:03.450990 (Thread-1): Began running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:28:03.451491 (Thread-1): 17:28:03 | 1 of 2 START table model ft_data.my_first_dbt_model.................. [RUN]
2021-10-28 16:28:03.452039 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:28:03.452281 (Thread-1): Compiling model.freetrade_test.my_first_dbt_model
2021-10-28 16:28:03.455770 (Thread-1): Writing injected SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:28:03.456621 (Thread-1): finished collecting timing info
2021-10-28 16:28:03.494745 (Thread-1): Writing runtime SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:28:03.495565 (Thread-1): Opening a new connection, currently in state closed
2021-10-28 16:28:03.500944 (Thread-1): On model.freetrade_test.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_first_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_first_dbt_model`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
    union all
    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-10-28 16:28:06.052890 (Thread-1): finished collecting timing info
2021-10-28 16:28:06.053565 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa4841-45eb-4558-bd8f-a62e5215d80c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1131b2730>]}
2021-10-28 16:28:06.054084 (Thread-1): 17:28:06 | 1 of 2 OK created table model ft_data.my_first_dbt_model............. [CREATE TABLE (2.0 rows, 0.0 Bytes processed) in 2.60s]
2021-10-28 16:28:06.054337 (Thread-1): Finished running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:28:06.054969 (Thread-3): Began running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:28:06.055341 (Thread-3): 17:28:06 | 2 of 2 START view model ft_data.my_second_dbt_model.................. [RUN]
2021-10-28 16:28:06.055819 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:28:06.056043 (Thread-3): Compiling model.freetrade_test.my_second_dbt_model
2021-10-28 16:28:06.057601 (Thread-3): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61659), raddr=('216.58.215.170', 443)>
2021-10-28 16:28:06.058216 (Thread-3): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61660), raddr=('216.58.215.170', 443)>
2021-10-28 16:28:06.058489 (Thread-3): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61661), raddr=('216.58.215.170', 443)>
2021-10-28 16:28:06.058731 (Thread-3): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61662), raddr=('216.58.215.170', 443)>
2021-10-28 16:28:06.061560 (Thread-3): Writing injected SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:28:06.062121 (Thread-3): finished collecting timing info
2021-10-28 16:28:06.085972 (Thread-3): Writing runtime SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:28:06.086542 (Thread-3): Opening a new connection, currently in state init
2021-10-28 16:28:06.092236 (Thread-3): On model.freetrade_test.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */


  create or replace view `ft-data-330317`.`ft_data`.`my_second_dbt_model`
  OPTIONS()
  as -- Use the `ref` function to select from other models

select *
from `ft-data-330317`.`ft_data`.`my_first_dbt_model`
where id = 1;


2021-10-28 16:28:07.583840 (Thread-3): finished collecting timing info
2021-10-28 16:28:07.584594 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa4841-45eb-4558-bd8f-a62e5215d80c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11429d370>]}
2021-10-28 16:28:07.585170 (Thread-3): 17:28:07 | 2 of 2 OK created view model ft_data.my_second_dbt_model............. [OK in 1.53s]
2021-10-28 16:28:07.585461 (Thread-3): Finished running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:28:07.587355 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:28:07.587929 (MainThread): 17:28:07 | 
2021-10-28 16:28:07.588207 (MainThread): 17:28:07 | Finished running 1 table model, 1 view model in 5.60s.
2021-10-28 16:28:07.588447 (MainThread): Connection 'master' was properly closed.
2021-10-28 16:28:07.588642 (MainThread): Connection 'model.freetrade_test.my_first_dbt_model' was properly closed.
2021-10-28 16:28:07.588825 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-10-28 16:28:07.590781 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61665), raddr=('216.58.215.170', 443)>
2021-10-28 16:28:07.591054 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61666), raddr=('216.58.215.170', 443)>
2021-10-28 16:28:07.596517 (MainThread): 
2021-10-28 16:28:07.596757 (MainThread): Completed successfully
2021-10-28 16:28:07.596935 (MainThread): 
Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
2021-10-28 16:28:07.597189 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1130ca940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113183700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113183190>]}
2021-10-28 16:28:07.597451 (MainThread): Flushing usage events
2021-10-28 16:30:15.296684 (MainThread): Running with dbt=0.21.0
2021-10-28 16:30:15.594039 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-10-28 16:30:15.595148 (MainThread): Tracking: tracking
2021-10-28 16:30:15.606065 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11179a760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117bdfa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117bd370>]}
2021-10-28 16:30:15.617221 (MainThread): Partial parsing not enabled
2021-10-28 16:30:15.628329 (MainThread): Parsing macros/etc.sql
2021-10-28 16:30:15.631200 (MainThread): Parsing macros/catalog.sql
2021-10-28 16:30:15.637573 (MainThread): Parsing macros/adapters.sql
2021-10-28 16:30:15.659885 (MainThread): Parsing macros/materializations/seed.sql
2021-10-28 16:30:15.662271 (MainThread): Parsing macros/materializations/view.sql
2021-10-28 16:30:15.664638 (MainThread): Parsing macros/materializations/table.sql
2021-10-28 16:30:15.673572 (MainThread): Parsing macros/materializations/copy.sql
2021-10-28 16:30:15.675980 (MainThread): Parsing macros/materializations/incremental.sql
2021-10-28 16:30:15.689416 (MainThread): Parsing macros/materializations/snapshot.sql
2021-10-28 16:30:15.690920 (MainThread): Parsing macros/core.sql
2021-10-28 16:30:15.694365 (MainThread): Parsing macros/materializations/test.sql
2021-10-28 16:30:15.701550 (MainThread): Parsing macros/materializations/helpers.sql
2021-10-28 16:30:15.711231 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-10-28 16:30:15.713383 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-10-28 16:30:15.730321 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-10-28 16:30:15.761949 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-10-28 16:30:15.783361 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-10-28 16:30:15.785009 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-10-28 16:30:15.794585 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-10-28 16:30:15.813497 (MainThread): Parsing macros/materializations/common/merge.sql
2021-10-28 16:30:15.826563 (MainThread): Parsing macros/materializations/table/table.sql
2021-10-28 16:30:15.834177 (MainThread): Parsing macros/materializations/view/view.sql
2021-10-28 16:30:15.841262 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-10-28 16:30:15.844855 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-10-28 16:30:15.846184 (MainThread): Parsing macros/etc/query.sql
2021-10-28 16:30:15.847043 (MainThread): Parsing macros/etc/is_incremental.sql
2021-10-28 16:30:15.848400 (MainThread): Parsing macros/etc/datetime.sql
2021-10-28 16:30:15.856278 (MainThread): Parsing macros/etc/where_subquery.sql
2021-10-28 16:30:15.857882 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-10-28 16:30:15.860157 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-10-28 16:30:15.861571 (MainThread): Parsing macros/adapters/common.sql
2021-10-28 16:30:15.913505 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-10-28 16:30:15.915022 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-10-28 16:30:15.916176 (MainThread): Parsing macros/schema_tests/unique.sql
2021-10-28 16:30:15.917388 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-10-28 16:30:16.106197 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:30:16.117611 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:30:16.142925 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:30:16.144649 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:30:16.146370 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:30:16.147987 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:30:16.161457 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5775c0e6-c3e4-4978-b96a-1461722af859', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11183bee0>]}
2021-10-28 16:30:16.166000 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-10-28 16:30:16.166433 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5775c0e6-c3e4-4978-b96a-1461722af859', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11183bac0>]}
2021-10-28 16:30:16.166746 (MainThread): Found 2 models, 4 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-10-28 16:30:16.168274 (MainThread): 
2021-10-28 16:30:16.168738 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:30:16.169560 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-10-28 16:30:16.169758 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-10-28 16:30:16.943195 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-10-28 16:30:16.943826 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-10-28 16:30:16.955842 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:30:17.420606 (MainThread): 17:30:17 | Concurrency: 4 threads (target='dev')
2021-10-28 16:30:17.420884 (MainThread): 17:30:17 | 
2021-10-28 16:30:17.423325 (Thread-1): Began running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:30:17.423661 (Thread-1): 17:30:17 | 1 of 2 START table model ft_data.my_first_dbt_model.................. [RUN]
2021-10-28 16:30:17.424042 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:30:17.424218 (Thread-1): Compiling model.freetrade_test.my_first_dbt_model
2021-10-28 16:30:17.426924 (Thread-1): Writing injected SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:30:17.427424 (Thread-1): finished collecting timing info
2021-10-28 16:30:17.446563 (Thread-1): Opening a new connection, currently in state closed
2021-10-28 16:30:17.451824 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:30:17.991859 (Thread-1): Writing runtime SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:30:17.992470 (Thread-1): On model.freetrade_test.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_first_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_first_dbt_model`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



SELECT * FROM `ft-data-330317.ft_data.clients` LIMIT 10

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-10-28 16:30:20.327312 (Thread-1): finished collecting timing info
2021-10-28 16:30:20.327976 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5775c0e6-c3e4-4978-b96a-1461722af859', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118a92e0>]}
2021-10-28 16:30:20.328532 (Thread-1): 17:30:20 | 1 of 2 OK created table model ft_data.my_first_dbt_model............. [CREATE TABLE (10.0 rows, 49.3 KB processed) in 2.90s]
2021-10-28 16:30:20.328785 (Thread-1): Finished running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:30:20.329540 (Thread-3): Began running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:30:20.329912 (Thread-3): 17:30:20 | 2 of 2 START view model ft_data.my_second_dbt_model.................. [RUN]
2021-10-28 16:30:20.330454 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:30:20.330701 (Thread-3): Compiling model.freetrade_test.my_second_dbt_model
2021-10-28 16:30:20.332265 (Thread-3): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61681), raddr=('216.58.215.170', 443)>
2021-10-28 16:30:20.332633 (Thread-3): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61682), raddr=('216.58.215.170', 443)>
2021-10-28 16:30:20.332885 (Thread-3): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61683), raddr=('216.58.215.170', 443)>
2021-10-28 16:30:20.333114 (Thread-3): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61684), raddr=('216.58.215.170', 443)>
2021-10-28 16:30:20.335777 (Thread-3): Writing injected SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:30:20.336304 (Thread-3): finished collecting timing info
2021-10-28 16:30:20.359996 (Thread-3): Writing runtime SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:30:20.360563 (Thread-3): Opening a new connection, currently in state init
2021-10-28 16:30:20.366273 (Thread-3): On model.freetrade_test.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */


  create or replace view `ft-data-330317`.`ft_data`.`my_second_dbt_model`
  OPTIONS()
  as -- Use the `ref` function to select from other models

select *
from `ft-data-330317`.`ft_data`.`my_first_dbt_model`
where id = 1;


2021-10-28 16:30:21.297962 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: id at [10:7]')
2021-10-28 16:30:22.258320 (Thread-3): finished collecting timing info
2021-10-28 16:30:22.259355 (Thread-3): Database Error in model my_second_dbt_model (models/example/my_second_dbt_model.sql)
  Unrecognized name: id at [10:7]
  compiled SQL at target/run/freetrade_test/models/example/my_second_dbt_model.sql
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Unrecognized name: id at [10:7]

(job ID: 3e4a3ea8-7340-4420-b0de-6dd406855671)

                                                                 -----Query Job SQL Follows-----                                                                 

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */
   2:
   3:
   4:  create or replace view `ft-data-330317`.`ft_data`.`my_second_dbt_model`
   5:  OPTIONS()
   6:  as -- Use the `ref` function to select from other models
   7:
   8:select *
   9:from `ft-data-330317`.`ft_data`.`my_first_dbt_model`
  10:where id = 1;
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 291, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 393, in run
    return self.execute(compiled_node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 249, in execute
    result = MacroGenerator(materialization_macro, context)()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 22, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 55, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 41, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model my_second_dbt_model (models/example/my_second_dbt_model.sql)
  Unrecognized name: id at [10:7]
  compiled SQL at target/run/freetrade_test/models/example/my_second_dbt_model.sql
2021-10-28 16:30:22.287486 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5775c0e6-c3e4-4978-b96a-1461722af859', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a77eb0>]}
2021-10-28 16:30:22.288343 (Thread-3): 17:30:22 | 2 of 2 ERROR creating view model ft_data.my_second_dbt_model......... [ERROR in 1.96s]
2021-10-28 16:30:22.288782 (Thread-3): Finished running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:30:22.291000 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:30:22.291588 (MainThread): 17:30:22 | 
2021-10-28 16:30:22.291866 (MainThread): 17:30:22 | Finished running 1 table model, 1 view model in 6.12s.
2021-10-28 16:30:22.292111 (MainThread): Connection 'master' was properly closed.
2021-10-28 16:30:22.292307 (MainThread): Connection 'model.freetrade_test.my_first_dbt_model' was properly closed.
2021-10-28 16:30:22.292494 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-10-28 16:30:22.300416 (MainThread): 
2021-10-28 16:30:22.300703 (MainThread): Completed with 1 error and 0 warnings:
2021-10-28 16:30:22.300922 (MainThread): 
2021-10-28 16:30:22.301134 (MainThread): Database Error in model my_second_dbt_model (models/example/my_second_dbt_model.sql)
2021-10-28 16:30:22.301330 (MainThread):   Unrecognized name: id at [10:7]
2021-10-28 16:30:22.301520 (MainThread):   compiled SQL at target/run/freetrade_test/models/example/my_second_dbt_model.sql
2021-10-28 16:30:22.301716 (MainThread): 
Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
2021-10-28 16:30:22.302029 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11183b7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111848d60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111848d00>]}
2021-10-28 16:30:22.302285 (MainThread): Flushing usage events
2021-10-28 16:32:05.572226 (MainThread): Running with dbt=0.21.0
2021-10-28 16:32:05.876828 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-10-28 16:32:05.877810 (MainThread): Tracking: tracking
2021-10-28 16:32:05.888226 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9e23a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111997dc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1119970d0>]}
2021-10-28 16:32:05.899339 (MainThread): Partial parsing not enabled
2021-10-28 16:32:05.910576 (MainThread): Parsing macros/etc.sql
2021-10-28 16:32:05.913460 (MainThread): Parsing macros/catalog.sql
2021-10-28 16:32:05.919579 (MainThread): Parsing macros/adapters.sql
2021-10-28 16:32:05.941828 (MainThread): Parsing macros/materializations/seed.sql
2021-10-28 16:32:05.944287 (MainThread): Parsing macros/materializations/view.sql
2021-10-28 16:32:05.946769 (MainThread): Parsing macros/materializations/table.sql
2021-10-28 16:32:05.955744 (MainThread): Parsing macros/materializations/copy.sql
2021-10-28 16:32:05.958184 (MainThread): Parsing macros/materializations/incremental.sql
2021-10-28 16:32:05.971843 (MainThread): Parsing macros/materializations/snapshot.sql
2021-10-28 16:32:05.973471 (MainThread): Parsing macros/core.sql
2021-10-28 16:32:05.976919 (MainThread): Parsing macros/materializations/test.sql
2021-10-28 16:32:05.984014 (MainThread): Parsing macros/materializations/helpers.sql
2021-10-28 16:32:05.994261 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-10-28 16:32:05.996448 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-10-28 16:32:06.013024 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-10-28 16:32:06.044220 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-10-28 16:32:06.066085 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-10-28 16:32:06.067823 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-10-28 16:32:06.077384 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-10-28 16:32:06.097461 (MainThread): Parsing macros/materializations/common/merge.sql
2021-10-28 16:32:06.110862 (MainThread): Parsing macros/materializations/table/table.sql
2021-10-28 16:32:06.118879 (MainThread): Parsing macros/materializations/view/view.sql
2021-10-28 16:32:06.125886 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-10-28 16:32:06.129433 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-10-28 16:32:06.130843 (MainThread): Parsing macros/etc/query.sql
2021-10-28 16:32:06.131702 (MainThread): Parsing macros/etc/is_incremental.sql
2021-10-28 16:32:06.133066 (MainThread): Parsing macros/etc/datetime.sql
2021-10-28 16:32:06.141035 (MainThread): Parsing macros/etc/where_subquery.sql
2021-10-28 16:32:06.142719 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-10-28 16:32:06.144909 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-10-28 16:32:06.146338 (MainThread): Parsing macros/adapters/common.sql
2021-10-28 16:32:06.198838 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-10-28 16:32:06.200367 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-10-28 16:32:06.201481 (MainThread): Parsing macros/schema_tests/unique.sql
2021-10-28 16:32:06.202690 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-10-28 16:32:06.391425 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:32:06.402914 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:32:06.427993 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:32:06.429729 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:32:06.431548 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:32:06.433125 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:32:06.446996 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e3e83be3-ecbc-4377-8f9b-ea196f158696', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c8afa0>]}
2021-10-28 16:32:06.451756 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-10-28 16:32:06.452157 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e3e83be3-ecbc-4377-8f9b-ea196f158696', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c8afa0>]}
2021-10-28 16:32:06.452416 (MainThread): Found 2 models, 4 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-10-28 16:32:06.453926 (MainThread): 
2021-10-28 16:32:06.454338 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:32:06.455210 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-10-28 16:32:06.455375 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-10-28 16:32:07.226124 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-10-28 16:32:07.226762 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-10-28 16:32:07.238909 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:32:07.840549 (MainThread): 17:32:07 | Concurrency: 4 threads (target='dev')
2021-10-28 16:32:07.841078 (MainThread): 17:32:07 | 
2021-10-28 16:32:07.846016 (Thread-1): Began running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:32:07.846756 (Thread-1): 17:32:07 | 1 of 2 START table model ft_data.my_first_dbt_model.................. [RUN]
2021-10-28 16:32:07.847579 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:32:07.847997 (Thread-1): Compiling model.freetrade_test.my_first_dbt_model
2021-10-28 16:32:07.852888 (Thread-1): Writing injected SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:32:07.853705 (Thread-1): finished collecting timing info
2021-10-28 16:32:07.878992 (Thread-1): Opening a new connection, currently in state closed
2021-10-28 16:32:07.884828 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:32:08.479901 (Thread-1): Writing runtime SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:32:08.480524 (Thread-1): On model.freetrade_test.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_first_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_first_dbt_model`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



SELECT * FROM `ft-data-330317.ft_data.clients` LIMIT 10

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-10-28 16:32:10.934876 (Thread-1): finished collecting timing info
2021-10-28 16:32:10.935569 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3e83be3-ecbc-4377-8f9b-ea196f158696', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111bbd0d0>]}
2021-10-28 16:32:10.936108 (Thread-1): 17:32:10 | 1 of 2 OK created table model ft_data.my_first_dbt_model............. [CREATE TABLE (10.0 rows, 49.3 KB processed) in 3.09s]
2021-10-28 16:32:10.936369 (Thread-1): Finished running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:32:10.937144 (Thread-3): Began running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:32:10.937525 (Thread-3): 17:32:10 | 2 of 2 START view model ft_data.my_second_dbt_model.................. [RUN]
2021-10-28 16:32:10.938131 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:32:10.938384 (Thread-3): Compiling model.freetrade_test.my_second_dbt_model
2021-10-28 16:32:10.939973 (Thread-3): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61703), raddr=('142.250.184.10', 443)>
2021-10-28 16:32:10.940275 (Thread-3): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61704), raddr=('216.58.215.170', 443)>
2021-10-28 16:32:10.940515 (Thread-3): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61705), raddr=('142.250.184.10', 443)>
2021-10-28 16:32:10.940745 (Thread-3): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61706), raddr=('216.58.215.170', 443)>
2021-10-28 16:32:10.943418 (Thread-3): Writing injected SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:32:10.943944 (Thread-3): finished collecting timing info
2021-10-28 16:32:10.967789 (Thread-3): Writing runtime SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:32:10.968368 (Thread-3): Opening a new connection, currently in state init
2021-10-28 16:32:10.974078 (Thread-3): On model.freetrade_test.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */


  create or replace view `ft-data-330317`.`ft_data`.`my_second_dbt_model`
  OPTIONS()
  as -- Use the `ref` function to select from other models

select *
from `ft-data-330317`.`ft_data`.`my_first_dbt_model`
where nationality = aus;


2021-10-28 16:32:12.132682 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: aus at [10:21]')
2021-10-28 16:32:13.984448 (Thread-3): finished collecting timing info
2021-10-28 16:32:13.985475 (Thread-3): Database Error in model my_second_dbt_model (models/example/my_second_dbt_model.sql)
  Unrecognized name: aus at [10:21]
  compiled SQL at target/run/freetrade_test/models/example/my_second_dbt_model.sql
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Unrecognized name: aus at [10:21]

(job ID: 6b486548-2d7b-4a50-a146-223f5a67edfc)

                                                                 -----Query Job SQL Follows-----                                                                 

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */
   2:
   3:
   4:  create or replace view `ft-data-330317`.`ft_data`.`my_second_dbt_model`
   5:  OPTIONS()
   6:  as -- Use the `ref` function to select from other models
   7:
   8:select *
   9:from `ft-data-330317`.`ft_data`.`my_first_dbt_model`
  10:where nationality = aus;
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 291, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 393, in run
    return self.execute(compiled_node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 249, in execute
    result = MacroGenerator(materialization_macro, context)()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 22, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 55, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 41, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model my_second_dbt_model (models/example/my_second_dbt_model.sql)
  Unrecognized name: aus at [10:21]
  compiled SQL at target/run/freetrade_test/models/example/my_second_dbt_model.sql
2021-10-28 16:32:13.991510 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3e83be3-ecbc-4377-8f9b-ea196f158696', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111d3d190>]}
2021-10-28 16:32:13.992121 (Thread-3): 17:32:13 | 2 of 2 ERROR creating view model ft_data.my_second_dbt_model......... [ERROR in 3.05s]
2021-10-28 16:32:13.992436 (Thread-3): Finished running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:32:13.994275 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:32:13.994800 (MainThread): 17:32:13 | 
2021-10-28 16:32:13.995046 (MainThread): 17:32:13 | Finished running 1 table model, 1 view model in 7.54s.
2021-10-28 16:32:13.995256 (MainThread): Connection 'master' was properly closed.
2021-10-28 16:32:13.995428 (MainThread): Connection 'model.freetrade_test.my_first_dbt_model' was properly closed.
2021-10-28 16:32:13.995589 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-10-28 16:32:14.002370 (MainThread): 
2021-10-28 16:32:14.002606 (MainThread): Completed with 1 error and 0 warnings:
2021-10-28 16:32:14.002780 (MainThread): 
2021-10-28 16:32:14.002946 (MainThread): Database Error in model my_second_dbt_model (models/example/my_second_dbt_model.sql)
2021-10-28 16:32:14.003099 (MainThread):   Unrecognized name: aus at [10:21]
2021-10-28 16:32:14.003241 (MainThread):   compiled SQL at target/run/freetrade_test/models/example/my_second_dbt_model.sql
2021-10-28 16:32:14.003395 (MainThread): 
Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
2021-10-28 16:32:14.003641 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a462e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a2ea90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c51040>]}
2021-10-28 16:32:14.003908 (MainThread): Flushing usage events
2021-10-28 16:42:01.281291 (MainThread): Running with dbt=0.21.0
2021-10-28 16:42:01.584642 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-10-28 16:42:01.585575 (MainThread): Tracking: tracking
2021-10-28 16:42:01.595685 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083cd280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a48fdc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a48f0d0>]}
2021-10-28 16:42:01.606706 (MainThread): Partial parsing not enabled
2021-10-28 16:42:01.618082 (MainThread): Parsing macros/etc.sql
2021-10-28 16:42:01.621182 (MainThread): Parsing macros/catalog.sql
2021-10-28 16:42:01.627405 (MainThread): Parsing macros/adapters.sql
2021-10-28 16:42:01.649697 (MainThread): Parsing macros/materializations/seed.sql
2021-10-28 16:42:01.652135 (MainThread): Parsing macros/materializations/view.sql
2021-10-28 16:42:01.654693 (MainThread): Parsing macros/materializations/table.sql
2021-10-28 16:42:01.663718 (MainThread): Parsing macros/materializations/copy.sql
2021-10-28 16:42:01.666159 (MainThread): Parsing macros/materializations/incremental.sql
2021-10-28 16:42:01.680504 (MainThread): Parsing macros/materializations/snapshot.sql
2021-10-28 16:42:01.682101 (MainThread): Parsing macros/core.sql
2021-10-28 16:42:01.685600 (MainThread): Parsing macros/materializations/test.sql
2021-10-28 16:42:01.692623 (MainThread): Parsing macros/materializations/helpers.sql
2021-10-28 16:42:01.702649 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-10-28 16:42:01.704273 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-10-28 16:42:01.720984 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-10-28 16:42:01.752591 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-10-28 16:42:01.774490 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-10-28 16:42:01.776072 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-10-28 16:42:01.785398 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-10-28 16:42:01.804097 (MainThread): Parsing macros/materializations/common/merge.sql
2021-10-28 16:42:01.816981 (MainThread): Parsing macros/materializations/table/table.sql
2021-10-28 16:42:01.824637 (MainThread): Parsing macros/materializations/view/view.sql
2021-10-28 16:42:01.831297 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-10-28 16:42:01.834896 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-10-28 16:42:01.836229 (MainThread): Parsing macros/etc/query.sql
2021-10-28 16:42:01.837113 (MainThread): Parsing macros/etc/is_incremental.sql
2021-10-28 16:42:01.838526 (MainThread): Parsing macros/etc/datetime.sql
2021-10-28 16:42:01.846283 (MainThread): Parsing macros/etc/where_subquery.sql
2021-10-28 16:42:01.847939 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-10-28 16:42:01.850104 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-10-28 16:42:01.851513 (MainThread): Parsing macros/adapters/common.sql
2021-10-28 16:42:01.904437 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-10-28 16:42:01.906094 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-10-28 16:42:01.907166 (MainThread): Parsing macros/schema_tests/unique.sql
2021-10-28 16:42:01.908377 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-10-28 16:42:02.096650 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:42:02.108174 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:42:02.133578 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:42:02.135282 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:42:02.136990 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:42:02.138609 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:42:02.152820 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5d216b1f-b539-4a03-af54-50ba747fd976', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a634fa0>]}
2021-10-28 16:42:02.157490 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-10-28 16:42:02.157872 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5d216b1f-b539-4a03-af54-50ba747fd976', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a634fa0>]}
2021-10-28 16:42:02.158100 (MainThread): Found 2 models, 4 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-10-28 16:42:02.159505 (MainThread): 
2021-10-28 16:42:02.159866 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:42:02.160610 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-10-28 16:42:02.160766 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-10-28 16:42:03.014110 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-10-28 16:42:03.014604 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-10-28 16:42:03.025062 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:42:03.652877 (MainThread): 17:42:03 | Concurrency: 4 threads (target='dev')
2021-10-28 16:42:03.653375 (MainThread): 17:42:03 | 
2021-10-28 16:42:03.657372 (Thread-1): Began running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:42:03.657887 (Thread-1): 17:42:03 | 1 of 2 START table model ft_data.my_first_dbt_model.................. [RUN]
2021-10-28 16:42:03.658506 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:42:03.658790 (Thread-1): Compiling model.freetrade_test.my_first_dbt_model
2021-10-28 16:42:03.662711 (Thread-1): Writing injected SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:42:03.663384 (Thread-1): finished collecting timing info
2021-10-28 16:42:03.685787 (Thread-1): Opening a new connection, currently in state closed
2021-10-28 16:42:03.691661 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:42:04.301798 (Thread-1): Writing runtime SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:42:04.302433 (Thread-1): On model.freetrade_test.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_first_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_first_dbt_model`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



SELECT * FROM `ft-data-330317.ft_data.clients` LIMIT 10

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-10-28 16:42:07.334866 (Thread-1): finished collecting timing info
2021-10-28 16:42:07.335550 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5d216b1f-b539-4a03-af54-50ba747fd976', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a689850>]}
2021-10-28 16:42:07.336077 (Thread-1): 17:42:07 | 1 of 2 OK created table model ft_data.my_first_dbt_model............. [CREATE TABLE (10.0 rows, 49.3 KB processed) in 3.68s]
2021-10-28 16:42:07.336337 (Thread-1): Finished running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:42:07.337120 (Thread-3): Began running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:42:07.337504 (Thread-3): 17:42:07 | 2 of 2 START view model ft_data.my_second_dbt_model.................. [RUN]
2021-10-28 16:42:07.338012 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:42:07.338244 (Thread-3): Compiling model.freetrade_test.my_second_dbt_model
2021-10-28 16:42:07.339798 (Thread-3): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61740), raddr=('142.250.185.10', 443)>
2021-10-28 16:42:07.340225 (Thread-3): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61741), raddr=('142.250.184.170', 443)>
2021-10-28 16:42:07.340499 (Thread-3): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61743), raddr=('142.250.185.10', 443)>
2021-10-28 16:42:07.340753 (Thread-3): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61746), raddr=('142.250.184.170', 443)>
2021-10-28 16:42:07.343518 (Thread-3): Writing injected SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:42:07.344069 (Thread-3): finished collecting timing info
2021-10-28 16:42:07.367847 (Thread-3): Writing runtime SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:42:07.368412 (Thread-3): Opening a new connection, currently in state init
2021-10-28 16:42:07.374256 (Thread-3): On model.freetrade_test.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */


  create or replace view `ft-data-330317`.`ft_data`.`my_second_dbt_model`
  OPTIONS()
  as -- Use the `ref` function to select from other models

select *
from `ft-data-330317`.`ft_data`.`my_first_dbt_model`
where nationality = 'aus';


2021-10-28 16:42:09.120152 (Thread-3): finished collecting timing info
2021-10-28 16:42:09.120911 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5d216b1f-b539-4a03-af54-50ba747fd976', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a731ac0>]}
2021-10-28 16:42:09.121500 (Thread-3): 17:42:09 | 2 of 2 OK created view model ft_data.my_second_dbt_model............. [OK in 1.78s]
2021-10-28 16:42:09.121800 (Thread-3): Finished running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:42:09.123568 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:42:09.124169 (MainThread): 17:42:09 | 
2021-10-28 16:42:09.124453 (MainThread): 17:42:09 | Finished running 1 table model, 1 view model in 6.96s.
2021-10-28 16:42:09.124694 (MainThread): Connection 'master' was properly closed.
2021-10-28 16:42:09.124889 (MainThread): Connection 'model.freetrade_test.my_first_dbt_model' was properly closed.
2021-10-28 16:42:09.125074 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-10-28 16:42:09.127102 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61752), raddr=('142.250.185.10', 443)>
2021-10-28 16:42:09.127377 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61753), raddr=('142.250.184.170', 443)>
2021-10-28 16:42:09.133006 (MainThread): 
2021-10-28 16:42:09.133222 (MainThread): Completed successfully
2021-10-28 16:42:09.133396 (MainThread): 
Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
2021-10-28 16:42:09.133647 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a53b820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a523d00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a60b130>]}
2021-10-28 16:42:09.133906 (MainThread): Flushing usage events
2021-10-28 16:44:15.181952 (MainThread): Running with dbt=0.21.0
2021-10-28 16:44:15.480188 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-10-28 16:44:15.481396 (MainThread): Tracking: tracking
2021-10-28 16:44:15.491210 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c185820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c160f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c1a75b0>]}
2021-10-28 16:44:15.502218 (MainThread): Partial parsing not enabled
2021-10-28 16:44:15.513475 (MainThread): Parsing macros/etc.sql
2021-10-28 16:44:15.516279 (MainThread): Parsing macros/catalog.sql
2021-10-28 16:44:15.522452 (MainThread): Parsing macros/adapters.sql
2021-10-28 16:44:15.544823 (MainThread): Parsing macros/materializations/seed.sql
2021-10-28 16:44:15.547261 (MainThread): Parsing macros/materializations/view.sql
2021-10-28 16:44:15.549626 (MainThread): Parsing macros/materializations/table.sql
2021-10-28 16:44:15.558466 (MainThread): Parsing macros/materializations/copy.sql
2021-10-28 16:44:15.560890 (MainThread): Parsing macros/materializations/incremental.sql
2021-10-28 16:44:15.574158 (MainThread): Parsing macros/materializations/snapshot.sql
2021-10-28 16:44:15.575670 (MainThread): Parsing macros/core.sql
2021-10-28 16:44:15.578994 (MainThread): Parsing macros/materializations/test.sql
2021-10-28 16:44:15.586290 (MainThread): Parsing macros/materializations/helpers.sql
2021-10-28 16:44:15.596051 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-10-28 16:44:15.597716 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-10-28 16:44:15.614695 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-10-28 16:44:15.646395 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-10-28 16:44:15.669222 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-10-28 16:44:15.670992 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-10-28 16:44:15.680818 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-10-28 16:44:15.700912 (MainThread): Parsing macros/materializations/common/merge.sql
2021-10-28 16:44:15.716196 (MainThread): Parsing macros/materializations/table/table.sql
2021-10-28 16:44:15.725372 (MainThread): Parsing macros/materializations/view/view.sql
2021-10-28 16:44:15.733399 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-10-28 16:44:15.737328 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-10-28 16:44:15.738723 (MainThread): Parsing macros/etc/query.sql
2021-10-28 16:44:15.739656 (MainThread): Parsing macros/etc/is_incremental.sql
2021-10-28 16:44:15.741077 (MainThread): Parsing macros/etc/datetime.sql
2021-10-28 16:44:15.749074 (MainThread): Parsing macros/etc/where_subquery.sql
2021-10-28 16:44:15.750727 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-10-28 16:44:15.753019 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-10-28 16:44:15.754482 (MainThread): Parsing macros/adapters/common.sql
2021-10-28 16:44:15.806587 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-10-28 16:44:15.808125 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-10-28 16:44:15.809209 (MainThread): Parsing macros/schema_tests/unique.sql
2021-10-28 16:44:15.810425 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-10-28 16:44:15.998430 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:44:16.009907 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:44:16.035157 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:44:16.037153 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:44:16.039524 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:44:16.041574 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:44:16.057293 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3fcbf2f1-392b-4c78-b6e8-79e28ad61215', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c273fd0>]}
2021-10-28 16:44:16.061738 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-10-28 16:44:16.062106 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3fcbf2f1-392b-4c78-b6e8-79e28ad61215', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c2d1940>]}
2021-10-28 16:44:16.062332 (MainThread): Found 2 models, 4 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-10-28 16:44:16.063599 (MainThread): 
2021-10-28 16:44:16.064104 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:44:16.065414 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-10-28 16:44:16.065841 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-10-28 16:44:16.766147 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-10-28 16:44:16.766791 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-10-28 16:44:16.779085 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:44:17.178157 (MainThread): 17:44:17 | Concurrency: 4 threads (target='dev')
2021-10-28 16:44:17.178702 (MainThread): 17:44:17 | 
2021-10-28 16:44:17.183652 (Thread-1): Began running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:44:17.184328 (Thread-1): 17:44:17 | 1 of 2 START table model ft_data.my_first_dbt_model.................. [RUN]
2021-10-28 16:44:17.185107 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:44:17.185500 (Thread-1): Compiling model.freetrade_test.my_first_dbt_model
2021-10-28 16:44:17.190263 (Thread-1): Writing injected SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:44:17.191086 (Thread-1): finished collecting timing info
2021-10-28 16:44:17.216393 (Thread-1): Opening a new connection, currently in state closed
2021-10-28 16:44:17.222271 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:44:17.785578 (Thread-1): Writing runtime SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:44:17.786278 (Thread-1): On model.freetrade_test.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_first_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_first_dbt_model`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



SELECT * FROM `ft-data-330317.ft_data.clients` LIMIT 10

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-10-28 16:44:20.035557 (Thread-1): finished collecting timing info
2021-10-28 16:44:20.036256 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3fcbf2f1-392b-4c78-b6e8-79e28ad61215', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c3a18e0>]}
2021-10-28 16:44:20.036793 (Thread-1): 17:44:20 | 1 of 2 OK created table model ft_data.my_first_dbt_model............. [CREATE TABLE (10.0 rows, 49.3 KB processed) in 2.85s]
2021-10-28 16:44:20.037057 (Thread-1): Finished running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:44:20.037823 (Thread-3): Began running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:44:20.038204 (Thread-3): 17:44:20 | 2 of 2 START view model ft_data.my_second_dbt_model.................. [RUN]
2021-10-28 16:44:20.038816 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:44:20.039078 (Thread-3): Compiling model.freetrade_test.my_second_dbt_model
2021-10-28 16:44:20.040610 (Thread-3): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61772), raddr=('142.250.185.10', 443)>
2021-10-28 16:44:20.040958 (Thread-3): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61773), raddr=('142.250.184.170', 443)>
2021-10-28 16:44:20.041221 (Thread-3): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61774), raddr=('142.250.185.10', 443)>
2021-10-28 16:44:20.041458 (Thread-3): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61775), raddr=('142.250.184.170', 443)>
2021-10-28 16:44:20.044457 (Thread-3): Writing injected SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:44:20.045088 (Thread-3): finished collecting timing info
2021-10-28 16:44:20.069085 (Thread-3): Writing runtime SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:44:20.069663 (Thread-3): Opening a new connection, currently in state init
2021-10-28 16:44:20.075334 (Thread-3): On model.freetrade_test.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */


  create or replace view `ft-data-330317`.`ft_data`.`my_second_dbt_model`
  OPTIONS()
  as -- Use the `ref` function to select from other models

select *
from `ft-data-330317`.`ft_data`.`my_first_dbt_model`
where nationality = "aus";


2021-10-28 16:44:21.779448 (Thread-3): finished collecting timing info
2021-10-28 16:44:21.780234 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3fcbf2f1-392b-4c78-b6e8-79e28ad61215', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d44c4c0>]}
2021-10-28 16:44:21.780834 (Thread-3): 17:44:21 | 2 of 2 OK created view model ft_data.my_second_dbt_model............. [OK in 1.74s]
2021-10-28 16:44:21.781150 (Thread-3): Finished running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:44:21.783034 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:44:21.783640 (MainThread): 17:44:21 | 
2021-10-28 16:44:21.783936 (MainThread): 17:44:21 | Finished running 1 table model, 1 view model in 5.72s.
2021-10-28 16:44:21.784196 (MainThread): Connection 'master' was properly closed.
2021-10-28 16:44:21.784406 (MainThread): Connection 'model.freetrade_test.my_first_dbt_model' was properly closed.
2021-10-28 16:44:21.784602 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-10-28 16:44:21.786565 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61778), raddr=('142.250.185.10', 443)>
2021-10-28 16:44:21.786854 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61779), raddr=('142.250.184.170', 443)>
2021-10-28 16:44:21.792387 (MainThread): 
2021-10-28 16:44:21.792631 (MainThread): Completed successfully
2021-10-28 16:44:21.792817 (MainThread): 
Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
2021-10-28 16:44:21.793076 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c174820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c23d850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c3498b0>]}
2021-10-28 16:44:21.793350 (MainThread): Flushing usage events
2021-10-28 16:45:38.822554 (MainThread): Running with dbt=0.21.0
2021-10-28 16:45:39.122653 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-10-28 16:45:39.123821 (MainThread): Tracking: tracking
2021-10-28 16:45:39.134058 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1090c7550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1090e9250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1090e91c0>]}
2021-10-28 16:45:39.145051 (MainThread): Partial parsing not enabled
2021-10-28 16:45:39.156443 (MainThread): Parsing macros/etc.sql
2021-10-28 16:45:39.159350 (MainThread): Parsing macros/catalog.sql
2021-10-28 16:45:39.165544 (MainThread): Parsing macros/adapters.sql
2021-10-28 16:45:39.187590 (MainThread): Parsing macros/materializations/seed.sql
2021-10-28 16:45:39.189983 (MainThread): Parsing macros/materializations/view.sql
2021-10-28 16:45:39.192394 (MainThread): Parsing macros/materializations/table.sql
2021-10-28 16:45:39.201627 (MainThread): Parsing macros/materializations/copy.sql
2021-10-28 16:45:39.204118 (MainThread): Parsing macros/materializations/incremental.sql
2021-10-28 16:45:39.217822 (MainThread): Parsing macros/materializations/snapshot.sql
2021-10-28 16:45:39.219412 (MainThread): Parsing macros/core.sql
2021-10-28 16:45:39.222900 (MainThread): Parsing macros/materializations/test.sql
2021-10-28 16:45:39.230024 (MainThread): Parsing macros/materializations/helpers.sql
2021-10-28 16:45:39.239716 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-10-28 16:45:39.241296 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-10-28 16:45:39.257432 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-10-28 16:45:39.288159 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-10-28 16:45:39.309404 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-10-28 16:45:39.311037 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-10-28 16:45:39.320631 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-10-28 16:45:39.339791 (MainThread): Parsing macros/materializations/common/merge.sql
2021-10-28 16:45:39.356373 (MainThread): Parsing macros/materializations/table/table.sql
2021-10-28 16:45:39.364732 (MainThread): Parsing macros/materializations/view/view.sql
2021-10-28 16:45:39.371807 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-10-28 16:45:39.375512 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-10-28 16:45:39.376888 (MainThread): Parsing macros/etc/query.sql
2021-10-28 16:45:39.377773 (MainThread): Parsing macros/etc/is_incremental.sql
2021-10-28 16:45:39.379174 (MainThread): Parsing macros/etc/datetime.sql
2021-10-28 16:45:39.387339 (MainThread): Parsing macros/etc/where_subquery.sql
2021-10-28 16:45:39.388957 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-10-28 16:45:39.391156 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-10-28 16:45:39.392589 (MainThread): Parsing macros/adapters/common.sql
2021-10-28 16:45:39.445243 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-10-28 16:45:39.446803 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-10-28 16:45:39.447884 (MainThread): Parsing macros/schema_tests/unique.sql
2021-10-28 16:45:39.449095 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-10-28 16:45:39.636741 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:45:39.648603 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:45:39.673752 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:45:39.675472 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:45:39.677196 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:45:39.678746 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:45:39.692575 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8f223b1c-72db-4c22-bb82-de4956589981', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109164040>]}
2021-10-28 16:45:39.696916 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-10-28 16:45:39.697284 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8f223b1c-72db-4c22-bb82-de4956589981', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109179460>]}
2021-10-28 16:45:39.697543 (MainThread): Found 2 models, 4 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-10-28 16:45:39.698866 (MainThread): 
2021-10-28 16:45:39.699356 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:45:39.700476 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-10-28 16:45:39.700790 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-10-28 16:45:40.388406 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-10-28 16:45:40.389045 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-10-28 16:45:40.401204 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:45:40.911929 (MainThread): 17:45:40 | Concurrency: 4 threads (target='dev')
2021-10-28 16:45:40.912472 (MainThread): 17:45:40 | 
2021-10-28 16:45:40.917435 (Thread-1): Began running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:45:40.918139 (Thread-1): 17:45:40 | 1 of 2 START table model ft_data.my_first_dbt_model.................. [RUN]
2021-10-28 16:45:40.918924 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:45:40.919310 (Thread-1): Compiling model.freetrade_test.my_first_dbt_model
2021-10-28 16:45:40.924010 (Thread-1): Writing injected SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:45:40.924755 (Thread-1): finished collecting timing info
2021-10-28 16:45:40.949624 (Thread-1): Opening a new connection, currently in state closed
2021-10-28 16:45:40.955734 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:45:41.476357 (Thread-1): Writing runtime SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:45:41.476978 (Thread-1): On model.freetrade_test.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_first_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_first_dbt_model`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



SELECT * FROM `ft-data-330317.ft_data.clients` LIMIT 10

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-10-28 16:45:44.323259 (Thread-1): finished collecting timing info
2021-10-28 16:45:44.323961 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f223b1c-72db-4c22-bb82-de4956589981', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092e48b0>]}
2021-10-28 16:45:44.324510 (Thread-1): 17:45:44 | 1 of 2 OK created table model ft_data.my_first_dbt_model............. [CREATE TABLE (10.0 rows, 49.3 KB processed) in 3.41s]
2021-10-28 16:45:44.324779 (Thread-1): Finished running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:45:44.325418 (Thread-3): Began running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:45:44.325805 (Thread-3): 17:45:44 | 2 of 2 START view model ft_data.my_second_dbt_model.................. [RUN]
2021-10-28 16:45:44.326308 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:45:44.326717 (Thread-3): Compiling model.freetrade_test.my_second_dbt_model
2021-10-28 16:45:44.328411 (Thread-3): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61782), raddr=('142.250.200.74', 443)>
2021-10-28 16:45:44.328816 (Thread-3): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61783), raddr=('142.250.184.170', 443)>
2021-10-28 16:45:44.329098 (Thread-3): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61784), raddr=('142.250.200.74', 443)>
2021-10-28 16:45:44.329352 (Thread-3): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61785), raddr=('142.250.184.170', 443)>
2021-10-28 16:45:44.332055 (Thread-3): Writing injected SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:45:44.332587 (Thread-3): finished collecting timing info
2021-10-28 16:45:44.357302 (Thread-3): Writing runtime SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:45:44.357880 (Thread-3): Opening a new connection, currently in state init
2021-10-28 16:45:44.363607 (Thread-3): On model.freetrade_test.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */


  create or replace view `ft-data-330317`.`ft_data`.`my_second_dbt_model`
  OPTIONS()
  as -- Use the `ref` function to select from other models

select *
from `ft-data-330317`.`ft_data`.`my_first_dbt_model` limit 1;


2021-10-28 16:45:45.751038 (Thread-3): finished collecting timing info
2021-10-28 16:45:45.751700 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f223b1c-72db-4c22-bb82-de4956589981', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109358fa0>]}
2021-10-28 16:45:45.752278 (Thread-3): 17:45:45 | 2 of 2 OK created view model ft_data.my_second_dbt_model............. [OK in 1.43s]
2021-10-28 16:45:45.752553 (Thread-3): Finished running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:45:45.753982 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:45:45.754379 (MainThread): 17:45:45 | 
2021-10-28 16:45:45.754567 (MainThread): 17:45:45 | Finished running 1 table model, 1 view model in 6.06s.
2021-10-28 16:45:45.754730 (MainThread): Connection 'master' was properly closed.
2021-10-28 16:45:45.754862 (MainThread): Connection 'model.freetrade_test.my_first_dbt_model' was properly closed.
2021-10-28 16:45:45.754988 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-10-28 16:45:45.756457 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61789), raddr=('142.250.200.74', 443)>
2021-10-28 16:45:45.756685 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61790), raddr=('142.250.184.170', 443)>
2021-10-28 16:45:45.761005 (MainThread): 
2021-10-28 16:45:45.761222 (MainThread): Completed successfully
2021-10-28 16:45:45.761422 (MainThread): 
Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
2021-10-28 16:45:45.761652 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109179cd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10928b760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10928b3d0>]}
2021-10-28 16:45:45.761894 (MainThread): Flushing usage events
2021-10-28 16:47:22.755187 (MainThread): Running with dbt=0.21.0
2021-10-28 16:47:23.051981 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-10-28 16:47:23.053066 (MainThread): Tracking: tracking
2021-10-28 16:47:23.063346 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108435280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3ec220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3ecf10>]}
2021-10-28 16:47:23.074940 (MainThread): Partial parsing not enabled
2021-10-28 16:47:23.085978 (MainThread): Parsing macros/etc.sql
2021-10-28 16:47:23.088782 (MainThread): Parsing macros/catalog.sql
2021-10-28 16:47:23.094954 (MainThread): Parsing macros/adapters.sql
2021-10-28 16:47:23.117446 (MainThread): Parsing macros/materializations/seed.sql
2021-10-28 16:47:23.120040 (MainThread): Parsing macros/materializations/view.sql
2021-10-28 16:47:23.122490 (MainThread): Parsing macros/materializations/table.sql
2021-10-28 16:47:23.131448 (MainThread): Parsing macros/materializations/copy.sql
2021-10-28 16:47:23.133847 (MainThread): Parsing macros/materializations/incremental.sql
2021-10-28 16:47:23.147522 (MainThread): Parsing macros/materializations/snapshot.sql
2021-10-28 16:47:23.149142 (MainThread): Parsing macros/core.sql
2021-10-28 16:47:23.152738 (MainThread): Parsing macros/materializations/test.sql
2021-10-28 16:47:23.159865 (MainThread): Parsing macros/materializations/helpers.sql
2021-10-28 16:47:23.170252 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-10-28 16:47:23.171862 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-10-28 16:47:23.188500 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-10-28 16:47:23.219718 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-10-28 16:47:23.241232 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-10-28 16:47:23.242843 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-10-28 16:47:23.252586 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-10-28 16:47:23.271557 (MainThread): Parsing macros/materializations/common/merge.sql
2021-10-28 16:47:23.284742 (MainThread): Parsing macros/materializations/table/table.sql
2021-10-28 16:47:23.292368 (MainThread): Parsing macros/materializations/view/view.sql
2021-10-28 16:47:23.299530 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-10-28 16:47:23.303102 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-10-28 16:47:23.304475 (MainThread): Parsing macros/etc/query.sql
2021-10-28 16:47:23.305364 (MainThread): Parsing macros/etc/is_incremental.sql
2021-10-28 16:47:23.306765 (MainThread): Parsing macros/etc/datetime.sql
2021-10-28 16:47:23.314921 (MainThread): Parsing macros/etc/where_subquery.sql
2021-10-28 16:47:23.316701 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-10-28 16:47:23.318911 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-10-28 16:47:23.320342 (MainThread): Parsing macros/adapters/common.sql
2021-10-28 16:47:23.372526 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-10-28 16:47:23.374075 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-10-28 16:47:23.375161 (MainThread): Parsing macros/schema_tests/unique.sql
2021-10-28 16:47:23.376380 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-10-28 16:47:23.566059 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:47:23.577718 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:47:23.602420 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:47:23.604325 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:47:23.606110 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:47:23.607698 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:47:23.621564 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '075fd512-86a0-4104-acc4-3d7ec670bf0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a591eb0>]}
2021-10-28 16:47:23.626009 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-10-28 16:47:23.626389 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '075fd512-86a0-4104-acc4-3d7ec670bf0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a591df0>]}
2021-10-28 16:47:23.626649 (MainThread): Found 2 models, 4 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-10-28 16:47:23.627969 (MainThread): 
2021-10-28 16:47:23.628550 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:47:23.629499 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-10-28 16:47:23.629809 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-10-28 16:47:24.358589 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-10-28 16:47:24.359234 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-10-28 16:47:24.371412 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:47:24.720331 (MainThread): 17:47:24 | Concurrency: 4 threads (target='dev')
2021-10-28 16:47:24.720829 (MainThread): 17:47:24 | 
2021-10-28 16:47:24.725586 (Thread-1): Began running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:47:24.726085 (Thread-2): Began running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:47:24.726677 (Thread-1): 17:47:24 | 1 of 2 START table model ft_data.my_first_dbt_model.................. [RUN]
2021-10-28 16:47:24.727215 (Thread-2): 17:47:24 | 2 of 2 START view model ft_data.my_second_dbt_model.................. [RUN]
2021-10-28 16:47:24.727974 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:47:24.728645 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:47:24.728975 (Thread-1): Compiling model.freetrade_test.my_first_dbt_model
2021-10-28 16:47:24.729217 (Thread-2): Compiling model.freetrade_test.my_second_dbt_model
2021-10-28 16:47:24.733482 (Thread-1): Writing injected SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:47:24.735569 (Thread-2): Writing injected SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:47:24.736314 (Thread-1): finished collecting timing info
2021-10-28 16:47:24.742217 (Thread-2): finished collecting timing info
2021-10-28 16:47:24.752904 (Thread-2): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61798), raddr=('142.250.200.138', 443)>
2021-10-28 16:47:24.764567 (Thread-1): Opening a new connection, currently in state closed
2021-10-28 16:47:24.764866 (Thread-2): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61799), raddr=('142.250.184.170', 443)>
2021-10-28 16:47:24.765627 (Thread-2): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61800), raddr=('142.250.200.138', 443)>
2021-10-28 16:47:24.765918 (Thread-2): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61801), raddr=('142.250.184.170', 443)>
2021-10-28 16:47:24.789466 (Thread-2): Writing runtime SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:47:24.789802 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:47:24.790776 (Thread-2): Opening a new connection, currently in state init
2021-10-28 16:47:24.795968 (Thread-2): On model.freetrade_test.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */


  create or replace view `ft-data-330317`.`ft_data`.`my_second_dbt_model`
  OPTIONS()
  as -- Use the `ref` function to select from other models

select *
from `ft-data-330317.ft_data.orders` limit 10;


2021-10-28 16:47:25.403467 (Thread-1): Writing runtime SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:47:25.404156 (Thread-1): On model.freetrade_test.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_first_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_first_dbt_model`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



SELECT * FROM `ft-data-330317.ft_data.clients` LIMIT 10

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-10-28 16:47:26.432669 (Thread-2): finished collecting timing info
2021-10-28 16:47:26.433368 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '075fd512-86a0-4104-acc4-3d7ec670bf0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5056a0>]}
2021-10-28 16:47:26.433907 (Thread-2): 17:47:26 | 2 of 2 OK created view model ft_data.my_second_dbt_model............. [OK in 1.70s]
2021-10-28 16:47:26.434166 (Thread-2): Finished running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:47:28.288555 (Thread-1): finished collecting timing info
2021-10-28 16:47:28.289619 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '075fd512-86a0-4104-acc4-3d7ec670bf0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a653d00>]}
2021-10-28 16:47:28.290425 (Thread-1): 17:47:28 | 1 of 2 OK created table model ft_data.my_first_dbt_model............. [CREATE TABLE (10.0 rows, 49.3 KB processed) in 3.56s]
2021-10-28 16:47:28.290722 (Thread-1): Finished running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:47:28.292650 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:47:28.293242 (MainThread): 17:47:28 | 
2021-10-28 16:47:28.293526 (MainThread): 17:47:28 | Finished running 1 view model, 1 table model in 4.66s.
2021-10-28 16:47:28.293772 (MainThread): Connection 'master' was properly closed.
2021-10-28 16:47:28.293972 (MainThread): Connection 'model.freetrade_test.my_first_dbt_model' was properly closed.
2021-10-28 16:47:28.294161 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-10-28 16:47:28.301640 (MainThread): 
2021-10-28 16:47:28.301920 (MainThread): Completed successfully
2021-10-28 16:47:28.302288 (MainThread): 
Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
2021-10-28 16:47:28.302648 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4c3e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084359a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108435700>]}
2021-10-28 16:47:28.302986 (MainThread): Flushing usage events
2021-10-28 16:48:48.180101 (MainThread): Running with dbt=0.21.0
2021-10-28 16:48:48.477404 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-10-28 16:48:48.478611 (MainThread): Tracking: tracking
2021-10-28 16:48:48.489093 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c36370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10abebd90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10abeb0d0>]}
2021-10-28 16:48:48.500029 (MainThread): Partial parsing not enabled
2021-10-28 16:48:48.511079 (MainThread): Parsing macros/etc.sql
2021-10-28 16:48:48.513903 (MainThread): Parsing macros/catalog.sql
2021-10-28 16:48:48.520162 (MainThread): Parsing macros/adapters.sql
2021-10-28 16:48:48.542407 (MainThread): Parsing macros/materializations/seed.sql
2021-10-28 16:48:48.544941 (MainThread): Parsing macros/materializations/view.sql
2021-10-28 16:48:48.547371 (MainThread): Parsing macros/materializations/table.sql
2021-10-28 16:48:48.556324 (MainThread): Parsing macros/materializations/copy.sql
2021-10-28 16:48:48.558764 (MainThread): Parsing macros/materializations/incremental.sql
2021-10-28 16:48:48.572034 (MainThread): Parsing macros/materializations/snapshot.sql
2021-10-28 16:48:48.573525 (MainThread): Parsing macros/core.sql
2021-10-28 16:48:48.577277 (MainThread): Parsing macros/materializations/test.sql
2021-10-28 16:48:48.584196 (MainThread): Parsing macros/materializations/helpers.sql
2021-10-28 16:48:48.593821 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-10-28 16:48:48.595476 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-10-28 16:48:48.612301 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-10-28 16:48:48.643304 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-10-28 16:48:48.664671 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-10-28 16:48:48.666232 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-10-28 16:48:48.675651 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-10-28 16:48:48.694321 (MainThread): Parsing macros/materializations/common/merge.sql
2021-10-28 16:48:48.707195 (MainThread): Parsing macros/materializations/table/table.sql
2021-10-28 16:48:48.714803 (MainThread): Parsing macros/materializations/view/view.sql
2021-10-28 16:48:48.721715 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-10-28 16:48:48.725215 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-10-28 16:48:48.726540 (MainThread): Parsing macros/etc/query.sql
2021-10-28 16:48:48.727392 (MainThread): Parsing macros/etc/is_incremental.sql
2021-10-28 16:48:48.728734 (MainThread): Parsing macros/etc/datetime.sql
2021-10-28 16:48:48.736598 (MainThread): Parsing macros/etc/where_subquery.sql
2021-10-28 16:48:48.738193 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-10-28 16:48:48.740357 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-10-28 16:48:48.741758 (MainThread): Parsing macros/adapters/common.sql
2021-10-28 16:48:48.793495 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-10-28 16:48:48.795004 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-10-28 16:48:48.796193 (MainThread): Parsing macros/schema_tests/unique.sql
2021-10-28 16:48:48.797398 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-10-28 16:48:48.983550 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:48:48.994988 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:48:49.020917 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:48:49.022679 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:48:49.024413 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:48:49.025986 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:48:49.039633 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9535e5bb-3334-428b-ab92-abf784990aa3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acb70d0>]}
2021-10-28 16:48:49.044006 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-10-28 16:48:49.044410 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9535e5bb-3334-428b-ab92-abf784990aa3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad159a0>]}
2021-10-28 16:48:49.044667 (MainThread): Found 2 models, 4 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-10-28 16:48:49.046292 (MainThread): 
2021-10-28 16:48:49.046735 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:48:49.047621 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-10-28 16:48:49.047964 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-10-28 16:48:50.428180 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-10-28 16:48:50.428830 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-10-28 16:48:50.440912 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:48:50.988809 (MainThread): 17:48:50 | Concurrency: 4 threads (target='dev')
2021-10-28 16:48:50.989353 (MainThread): 17:48:50 | 
2021-10-28 16:48:50.994337 (Thread-1): Began running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:48:50.995072 (Thread-1): 17:48:50 | 1 of 2 START table model ft_data.my_first_dbt_model.................. [RUN]
2021-10-28 16:48:50.995997 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:48:50.996467 (Thread-1): Compiling model.freetrade_test.my_first_dbt_model
2021-10-28 16:48:51.001210 (Thread-1): Writing injected SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:48:51.001983 (Thread-1): finished collecting timing info
2021-10-28 16:48:51.026636 (Thread-1): Opening a new connection, currently in state closed
2021-10-28 16:48:51.032780 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:48:51.629915 (Thread-1): Writing runtime SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:48:51.630517 (Thread-1): On model.freetrade_test.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_first_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_first_dbt_model`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



SELECT * FROM `ft-data-330317.ft_data.clients` LIMIT 10

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-10-28 16:48:54.346627 (Thread-1): finished collecting timing info
2021-10-28 16:48:54.347331 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9535e5bb-3334-428b-ab92-abf784990aa3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ade6850>]}
2021-10-28 16:48:54.347873 (Thread-1): 17:48:54 | 1 of 2 OK created table model ft_data.my_first_dbt_model............. [CREATE TABLE (10.0 rows, 49.3 KB processed) in 3.35s]
2021-10-28 16:48:54.348137 (Thread-1): Finished running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:48:54.348775 (Thread-3): Began running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:48:54.349166 (Thread-3): 17:48:54 | 2 of 2 START table model ft_data.my_second_dbt_model................. [RUN]
2021-10-28 16:48:54.349659 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:48:54.349894 (Thread-3): Compiling model.freetrade_test.my_second_dbt_model
2021-10-28 16:48:54.351524 (Thread-3): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61816), raddr=('142.250.200.138', 443)>
2021-10-28 16:48:54.351935 (Thread-3): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61817), raddr=('142.250.178.170', 443)>
2021-10-28 16:48:54.352341 (Thread-3): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61818), raddr=('142.250.200.138', 443)>
2021-10-28 16:48:54.352722 (Thread-3): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61819), raddr=('142.250.178.170', 443)>
2021-10-28 16:48:54.355780 (Thread-3): Writing injected SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:48:54.356307 (Thread-3): finished collecting timing info
2021-10-28 16:48:54.365697 (Thread-3): Opening a new connection, currently in state init
2021-10-28 16:48:54.372108 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:48:54.980945 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:48:55.212685 (Thread-3): Writing runtime SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:48:55.213827 (Thread-3): On model.freetrade_test.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_second_dbt_model`
  
  
  OPTIONS()
  as (
    -- Use the `ref` function to select from other models


select *
from `ft-data-330317`.`ft_data`.`my_first_dbt_model`
where nationality = 'aus'
  );
    
2021-10-28 16:48:57.089665 (Thread-3): finished collecting timing info
2021-10-28 16:48:57.090755 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9535e5bb-3334-428b-ab92-abf784990aa3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae58880>]}
2021-10-28 16:48:57.091539 (Thread-3): 17:48:57 | 2 of 2 OK created table model ft_data.my_second_dbt_model............ [CREATE TABLE (6.0 rows, 290.0 Bytes processed) in 2.74s]
2021-10-28 16:48:57.091844 (Thread-3): Finished running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:48:57.093719 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:48:57.094335 (MainThread): 17:48:57 | 
2021-10-28 16:48:57.094638 (MainThread): 17:48:57 | Finished running 2 table models in 8.05s.
2021-10-28 16:48:57.094904 (MainThread): Connection 'master' was properly closed.
2021-10-28 16:48:57.095117 (MainThread): Connection 'model.freetrade_test.my_first_dbt_model' was properly closed.
2021-10-28 16:48:57.095312 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-10-28 16:48:57.102787 (MainThread): 
2021-10-28 16:48:57.103085 (MainThread): Completed successfully
2021-10-28 16:48:57.103323 (MainThread): 
Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
2021-10-28 16:48:57.103653 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acfc5b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acfc850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad8c6a0>]}
2021-10-28 16:48:57.103994 (MainThread): Flushing usage events
2021-10-28 16:58:03.466456 (MainThread): Running with dbt=0.21.0
2021-10-28 16:58:03.762112 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-10-28 16:58:03.762925 (MainThread): Tracking: tracking
2021-10-28 16:58:03.772780 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2b5370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11026bd90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11026b0d0>]}
2021-10-28 16:58:03.783986 (MainThread): Partial parsing not enabled
2021-10-28 16:58:03.795224 (MainThread): Parsing macros/etc.sql
2021-10-28 16:58:03.798111 (MainThread): Parsing macros/catalog.sql
2021-10-28 16:58:03.804405 (MainThread): Parsing macros/adapters.sql
2021-10-28 16:58:03.826531 (MainThread): Parsing macros/materializations/seed.sql
2021-10-28 16:58:03.828933 (MainThread): Parsing macros/materializations/view.sql
2021-10-28 16:58:03.831408 (MainThread): Parsing macros/materializations/table.sql
2021-10-28 16:58:03.840244 (MainThread): Parsing macros/materializations/copy.sql
2021-10-28 16:58:03.842623 (MainThread): Parsing macros/materializations/incremental.sql
2021-10-28 16:58:03.856026 (MainThread): Parsing macros/materializations/snapshot.sql
2021-10-28 16:58:03.857549 (MainThread): Parsing macros/core.sql
2021-10-28 16:58:03.860940 (MainThread): Parsing macros/materializations/test.sql
2021-10-28 16:58:03.868401 (MainThread): Parsing macros/materializations/helpers.sql
2021-10-28 16:58:03.878359 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-10-28 16:58:03.879988 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-10-28 16:58:03.897105 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-10-28 16:58:03.929104 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-10-28 16:58:03.950657 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-10-28 16:58:03.952235 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-10-28 16:58:03.961640 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-10-28 16:58:03.980252 (MainThread): Parsing macros/materializations/common/merge.sql
2021-10-28 16:58:03.993700 (MainThread): Parsing macros/materializations/table/table.sql
2021-10-28 16:58:04.001313 (MainThread): Parsing macros/materializations/view/view.sql
2021-10-28 16:58:04.008356 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-10-28 16:58:04.012086 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-10-28 16:58:04.013467 (MainThread): Parsing macros/etc/query.sql
2021-10-28 16:58:04.014345 (MainThread): Parsing macros/etc/is_incremental.sql
2021-10-28 16:58:04.015768 (MainThread): Parsing macros/etc/datetime.sql
2021-10-28 16:58:04.023639 (MainThread): Parsing macros/etc/where_subquery.sql
2021-10-28 16:58:04.025300 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-10-28 16:58:04.027470 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-10-28 16:58:04.028882 (MainThread): Parsing macros/adapters/common.sql
2021-10-28 16:58:04.080814 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-10-28 16:58:04.082412 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-10-28 16:58:04.083543 (MainThread): Parsing macros/schema_tests/unique.sql
2021-10-28 16:58:04.084797 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-10-28 16:58:04.271744 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:58:04.283409 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:58:04.309002 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:58:04.310743 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:58:04.312481 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:58:04.314045 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-10-28 16:58:04.327736 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f5af23af-ded6-4850-a100-a3f5a9d892f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1103390d0>]}
2021-10-28 16:58:04.332113 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-10-28 16:58:04.332485 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f5af23af-ded6-4850-a100-a3f5a9d892f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1103979a0>]}
2021-10-28 16:58:04.332741 (MainThread): Found 2 models, 4 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-10-28 16:58:04.334037 (MainThread): 
2021-10-28 16:58:04.334486 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:58:04.335437 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-10-28 16:58:04.335640 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-10-28 16:58:05.065896 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-10-28 16:58:05.066540 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-10-28 16:58:05.078461 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:58:05.680263 (MainThread): 17:58:05 | Concurrency: 4 threads (target='dev')
2021-10-28 16:58:05.680799 (MainThread): 17:58:05 | 
2021-10-28 16:58:05.685792 (Thread-1): Began running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:58:05.686469 (Thread-1): 17:58:05 | 1 of 2 START table model ft_data.my_first_dbt_model.................. [RUN]
2021-10-28 16:58:05.687235 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.my_first_dbt_model".
2021-10-28 16:58:05.687618 (Thread-1): Compiling model.freetrade_test.my_first_dbt_model
2021-10-28 16:58:05.691789 (Thread-1): Writing injected SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:58:05.692538 (Thread-1): finished collecting timing info
2021-10-28 16:58:05.716496 (Thread-1): Opening a new connection, currently in state closed
2021-10-28 16:58:05.722604 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:58:06.321968 (Thread-1): Writing runtime SQL for node "model.freetrade_test.my_first_dbt_model"
2021-10-28 16:58:06.322583 (Thread-1): On model.freetrade_test.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_first_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_first_dbt_model`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



SELECT * FROM `ft-data-330317.ft_source_data.clients` LIMIT 10

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-10-28 16:58:08.697230 (Thread-1): finished collecting timing info
2021-10-28 16:58:08.697916 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f5af23af-ded6-4850-a100-a3f5a9d892f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110458400>]}
2021-10-28 16:58:08.698535 (Thread-1): 17:58:08 | 1 of 2 OK created table model ft_data.my_first_dbt_model............. [CREATE TABLE (10.0 rows, 49.3 KB processed) in 3.01s]
2021-10-28 16:58:08.698843 (Thread-1): Finished running node model.freetrade_test.my_first_dbt_model
2021-10-28 16:58:08.699668 (Thread-3): Began running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:58:08.699986 (Thread-3): 17:58:08 | 2 of 2 START table model ft_data.my_second_dbt_model................. [RUN]
2021-10-28 16:58:08.700524 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-10-28 16:58:08.700721 (Thread-3): Compiling model.freetrade_test.my_second_dbt_model
2021-10-28 16:58:08.702037 (Thread-3): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61856), raddr=('142.250.185.10', 443)>
2021-10-28 16:58:08.702280 (Thread-3): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61857), raddr=('142.250.178.170', 443)>
2021-10-28 16:58:08.702464 (Thread-3): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61858), raddr=('142.250.185.10', 443)>
2021-10-28 16:58:08.702648 (Thread-3): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.1.4', 61859), raddr=('142.250.178.170', 443)>
2021-10-28 16:58:08.705584 (Thread-3): Writing injected SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:58:08.706083 (Thread-3): finished collecting timing info
2021-10-28 16:58:08.713774 (Thread-3): Opening a new connection, currently in state init
2021-10-28 16:58:08.719829 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-10-28 16:58:09.263605 (Thread-3): Writing runtime SQL for node "model.freetrade_test.my_second_dbt_model"
2021-10-28 16:58:09.264891 (Thread-3): On model.freetrade_test.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_second_dbt_model`
  
  
  OPTIONS()
  as (
    -- Use the `ref` function to select from other models


select *
from `ft-data-330317`.`ft_data`.`my_first_dbt_model`
where nationality = 'aus'
  );
    
2021-10-28 16:58:11.373307 (Thread-3): finished collecting timing info
2021-10-28 16:58:11.374360 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f5af23af-ded6-4850-a100-a3f5a9d892f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1104675e0>]}
2021-10-28 16:58:11.375127 (Thread-3): 17:58:11 | 2 of 2 OK created table model ft_data.my_second_dbt_model............ [CREATE TABLE (6.0 rows, 290.0 Bytes processed) in 2.67s]
2021-10-28 16:58:11.375426 (Thread-3): Finished running node model.freetrade_test.my_second_dbt_model
2021-10-28 16:58:11.377331 (MainThread): Acquiring new bigquery connection "master".
2021-10-28 16:58:11.377933 (MainThread): 17:58:11 | 
2021-10-28 16:58:11.378216 (MainThread): 17:58:11 | Finished running 2 table models in 7.04s.
2021-10-28 16:58:11.378465 (MainThread): Connection 'master' was properly closed.
2021-10-28 16:58:11.378666 (MainThread): Connection 'model.freetrade_test.my_first_dbt_model' was properly closed.
2021-10-28 16:58:11.378853 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-10-28 16:58:11.386359 (MainThread): 
2021-10-28 16:58:11.386641 (MainThread): Completed successfully
2021-10-28 16:58:11.386883 (MainThread): 
Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
2021-10-28 16:58:11.387205 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11033dee0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11037bb20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11037b7c0>]}
2021-10-28 16:58:11.387558 (MainThread): Flushing usage events
2021-11-01 01:16:45.475359 (MainThread): Running with dbt=0.21.0
2021-11-01 01:16:46.146135 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 01:16:46.147705 (MainThread): Tracking: tracking
2021-11-01 01:16:46.171576 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11339ed90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1113fafa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1133893d0>]}
2021-11-01 01:16:46.183224 (MainThread): Partial parsing not enabled
2021-11-01 01:16:46.204927 (MainThread): Parsing macros/etc.sql
2021-11-01 01:16:46.208183 (MainThread): Parsing macros/catalog.sql
2021-11-01 01:16:46.214203 (MainThread): Parsing macros/adapters.sql
2021-11-01 01:16:46.235671 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 01:16:46.238053 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 01:16:46.240396 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 01:16:46.249838 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 01:16:46.252779 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 01:16:46.267337 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 01:16:46.269004 (MainThread): Parsing macros/core.sql
2021-11-01 01:16:46.272506 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 01:16:46.278842 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 01:16:46.288417 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 01:16:46.289994 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 01:16:46.306073 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 01:16:46.336861 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 01:16:46.358424 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 01:16:46.360040 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 01:16:46.369679 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 01:16:46.388200 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 01:16:46.401248 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 01:16:46.408763 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 01:16:46.415647 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 01:16:46.419122 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 01:16:46.420495 (MainThread): Parsing macros/etc/query.sql
2021-11-01 01:16:46.421349 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 01:16:46.422735 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 01:16:46.430472 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 01:16:46.432184 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 01:16:46.434428 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 01:16:46.435842 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 01:16:46.487343 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 01:16:46.488881 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 01:16:46.489946 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 01:16:46.491156 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 01:16:46.677990 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_logs".
2021-11-01 01:16:46.690156 (MainThread): 1699: statically parsed example/my_second_dbt_model.sql
2021-11-01 01:16:46.690370 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-11-01 01:16:46.693243 (MainThread): Sending event: {'category': 'dbt', 'action': 'experimental_parser', 'label': 'c38f81c6-bea6-4dc7-8fa6-9a18ff24236d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1134bd100>]}
2021-11-01 01:16:46.715977 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:16:46.717680 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:16:46.719583 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:16:46.721165 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:16:46.721592 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113532ac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1135329a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113532bb0>]}
2021-11-01 01:16:46.721798 (MainThread): Flushing usage events
2021-11-01 01:16:47.223033 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-11-01 01:16:47.223447 (MainThread): Encountered an error:
2021-11-01 01:16:47.223765 (MainThread): Compilation Error in model my_second_dbt_model (models/example/my_second_dbt_model.sql)
  Model 'model.freetrade_test.my_second_dbt_model' (models/example/my_second_dbt_model.sql) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 01:16:47.233224 (MainThread): Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 127, in main
    results, succeeded = handle_and_check(args)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 205, in handle_and_check
    task, res = run_from_args(parsed)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 258, in run_from_args
    results = task.run()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 433, in run
    self._runtime_initialize()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 149, in _runtime_initialize
    super()._runtime_initialize()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 87, in _runtime_initialize
    self.load_manifest()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 74, in load_manifest
    self.manifest = ManifestLoader.get_full_manifest(self.config)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/parser/manifest.py", line 182, in get_full_manifest
    manifest = loader.load()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/parser/manifest.py", line 355, in load
    self.process_refs(self.root_project.project_name)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/parser/manifest.py", line 715, in process_refs
    _process_refs_for_node(self.manifest, current_project, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/parser/manifest.py", line 1026, in _process_refs_for_node
    invalid_ref_fail_unless_test(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/parser/manifest.py", line 799, in invalid_ref_fail_unless_test
    ref_target_not_found(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/exceptions.py", line 575, in ref_target_not_found
    raise_compiler_error(msg, model)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/exceptions.py", line 444, in raise_compiler_error
    raise CompilationException(msg, node)
dbt.exceptions.CompilationException: Compilation Error in model my_second_dbt_model (models/example/my_second_dbt_model.sql)
  Model 'model.freetrade_test.my_second_dbt_model' (models/example/my_second_dbt_model.sql) depends on a node named 'my_first_dbt_model' which was not found

2021-11-01 01:17:15.112261 (MainThread): Running with dbt=0.21.0
2021-11-01 01:17:15.412866 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 01:17:15.413762 (MainThread): Tracking: tracking
2021-11-01 01:17:15.423177 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e1b7700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c20d9d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e19c040>]}
2021-11-01 01:17:15.434124 (MainThread): Partial parsing not enabled
2021-11-01 01:17:15.445272 (MainThread): Parsing macros/etc.sql
2021-11-01 01:17:15.448137 (MainThread): Parsing macros/catalog.sql
2021-11-01 01:17:15.454368 (MainThread): Parsing macros/adapters.sql
2021-11-01 01:17:15.476783 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 01:17:15.479170 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 01:17:15.481620 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 01:17:15.490380 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 01:17:15.492981 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 01:17:15.506510 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 01:17:15.508186 (MainThread): Parsing macros/core.sql
2021-11-01 01:17:15.511528 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 01:17:15.518441 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 01:17:15.528916 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 01:17:15.530821 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 01:17:15.547609 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 01:17:15.578826 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 01:17:15.600198 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 01:17:15.601821 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 01:17:15.611346 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 01:17:15.629899 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 01:17:15.642918 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 01:17:15.650582 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 01:17:15.658532 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 01:17:15.662166 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 01:17:15.663613 (MainThread): Parsing macros/etc/query.sql
2021-11-01 01:17:15.664500 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 01:17:15.665890 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 01:17:15.673904 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 01:17:15.675598 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 01:17:15.677829 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 01:17:15.679280 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 01:17:15.731906 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 01:17:15.733462 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 01:17:15.734548 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 01:17:15.735763 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 01:17:15.925681 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_logs".
2021-11-01 01:17:15.937512 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-11-01 01:17:15.963449 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:17:15.965208 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:17:15.966950 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:17:15.968525 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:17:15.968880 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/example/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 01:17:15.969050 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/example/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 01:17:15.984787 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a01693f5-6635-45da-bfe6-01cd098620b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2889d0>]}
2021-11-01 01:17:15.991577 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 01:17:15.992010 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a01693f5-6635-45da-bfe6-01cd098620b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2f2ca0>]}
2021-11-01 01:17:15.992254 (MainThread): Found 2 models, 2 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-11-01 01:17:15.993495 (MainThread): 
2021-11-01 01:17:15.993816 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 01:17:15.994585 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-01 01:17:15.994752 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 01:17:16.469648 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 01:17:16.470307 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-01 01:17:16.482464 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 01:17:16.795205 (MainThread): 01:17:16 | Concurrency: 4 threads (target='dev')
2021-11-01 01:17:16.795739 (MainThread): 01:17:16 | 
2021-11-01 01:17:16.802154 (Thread-1): Began running node model.freetrade_test.account_logs
2021-11-01 01:17:16.802902 (Thread-1): 01:17:16 | 1 of 2 START table model ft_data.account_logs........................ [RUN]
2021-11-01 01:17:16.803702 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_logs".
2021-11-01 01:17:16.804078 (Thread-1): Compiling model.freetrade_test.account_logs
2021-11-01 01:17:16.808927 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_logs"
2021-11-01 01:17:16.809800 (Thread-1): finished collecting timing info
2021-11-01 01:17:16.853365 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_logs"
2021-11-01 01:17:16.853895 (Thread-1): Opening a new connection, currently in state closed
2021-11-01 01:17:16.858996 (Thread-1): On model.freetrade_test.account_logs: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_logs"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_logs`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`), buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'), sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'), cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   * ,
         sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
FROM     cashflows
ORDER BY log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-01 01:17:19.367350 (Thread-1): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64660), raddr=('142.250.180.10', 443)>
2021-11-01 01:17:19.367802 (Thread-1): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64661), raddr=('142.250.187.234', 443)>
2021-11-01 01:17:19.368213 (Thread-1): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64662), raddr=('142.250.180.10', 443)>
2021-11-01 01:17:19.369283 (Thread-1): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64663), raddr=('142.250.187.234', 443)>
2021-11-01 01:17:19.373527 (Thread-1): finished collecting timing info
2021-11-01 01:17:19.374196 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a01693f5-6635-45da-bfe6-01cd098620b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f44b2b0>]}
2021-11-01 01:17:19.374711 (Thread-1): 01:17:19 | 1 of 2 OK created table model ft_data.account_logs................... [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.57s]
2021-11-01 01:17:19.374969 (Thread-1): Finished running node model.freetrade_test.account_logs
2021-11-01 01:17:19.375614 (Thread-3): Began running node model.freetrade_test.my_second_dbt_model
2021-11-01 01:17:19.375984 (Thread-3): 01:17:19 | 2 of 2 START table model ft_data.my_second_dbt_model................. [RUN]
2021-11-01 01:17:19.376683 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-11-01 01:17:19.376934 (Thread-3): Compiling model.freetrade_test.my_second_dbt_model
2021-11-01 01:17:19.387980 (Thread-3): Writing injected SQL for node "model.freetrade_test.my_second_dbt_model"
2021-11-01 01:17:19.388548 (Thread-3): finished collecting timing info
2021-11-01 01:17:19.390183 (Thread-3): Opening a new connection, currently in state init
2021-11-01 01:17:19.396378 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 01:17:19.669144 (Thread-3): Writing runtime SQL for node "model.freetrade_test.my_second_dbt_model"
2021-11-01 01:17:19.670310 (Thread-3): On model.freetrade_test.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_second_dbt_model`
  
  
  OPTIONS()
  as (
    -- Use the `ref` function to select from other models


select *
from `ft-data-330317`.`ft_data`.`account_logs`
where nationality = 'aus'
  );
    
2021-11-01 01:17:20.386349 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: nationality at [14:7]')
2021-11-01 01:17:22.708765 (Thread-3): finished collecting timing info
2021-11-01 01:17:22.709821 (Thread-3): Database Error in model my_second_dbt_model (models/example/my_second_dbt_model.sql)
  Unrecognized name: nationality at [14:7]
  compiled SQL at target/run/freetrade_test/models/example/my_second_dbt_model.sql
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Unrecognized name: nationality at [14:7]

(job ID: fa7cf409-fd13-4dfa-857c-34fc360051dc)

                                                                 -----Query Job SQL Follows-----                                                                 

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */
   2:
   3:
   4:  create or replace table `ft-data-330317`.`ft_data`.`my_second_dbt_model`
   5:  
   6:  
   7:  OPTIONS()
   8:  as (
   9:    -- Use the `ref` function to select from other models
  10:
  11:
  12:select *
  13:from `ft-data-330317`.`ft_data`.`account_logs`
  14:where nationality = 'aus'
  15:  );
  16:    
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 291, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 393, in run
    return self.execute(compiled_node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 249, in execute
    result = MacroGenerator(materialization_macro, context)()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 128, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 41, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model my_second_dbt_model (models/example/my_second_dbt_model.sql)
  Unrecognized name: nationality at [14:7]
  compiled SQL at target/run/freetrade_test/models/example/my_second_dbt_model.sql
2021-11-01 01:17:22.739541 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a01693f5-6635-45da-bfe6-01cd098620b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f44b850>]}
2021-11-01 01:17:22.740406 (Thread-3): 01:17:22 | 2 of 2 ERROR creating table model ft_data.my_second_dbt_model........ [ERROR in 3.36s]
2021-11-01 01:17:22.740819 (Thread-3): Finished running node model.freetrade_test.my_second_dbt_model
2021-11-01 01:17:22.743263 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 01:17:22.743878 (MainThread): 01:17:22 | 
2021-11-01 01:17:22.744167 (MainThread): 01:17:22 | Finished running 2 table models in 6.75s.
2021-11-01 01:17:22.744417 (MainThread): Connection 'master' was properly closed.
2021-11-01 01:17:22.744616 (MainThread): Connection 'model.freetrade_test.account_logs' was properly closed.
2021-11-01 01:17:22.744805 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-11-01 01:17:22.754138 (MainThread): 
2021-11-01 01:17:22.754522 (MainThread): Completed with 1 error and 0 warnings:
2021-11-01 01:17:22.754824 (MainThread): 
2021-11-01 01:17:22.755064 (MainThread): Database Error in model my_second_dbt_model (models/example/my_second_dbt_model.sql)
2021-11-01 01:17:22.755265 (MainThread):   Unrecognized name: nationality at [14:7]
2021-11-01 01:17:22.755453 (MainThread):   compiled SQL at target/run/freetrade_test/models/example/my_second_dbt_model.sql
2021-11-01 01:17:22.755655 (MainThread): 
Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
2021-11-01 01:17:22.755984 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c20d430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e233820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e233880>]}
2021-11-01 01:17:22.756344 (MainThread): Flushing usage events
2021-11-01 01:18:22.895977 (MainThread): Running with dbt=0.21.0
2021-11-01 01:18:23.193384 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 01:18:23.194423 (MainThread): Tracking: tracking
2021-11-01 01:18:23.203970 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111aa9c70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9f5a00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a91160>]}
2021-11-01 01:18:23.215541 (MainThread): Partial parsing not enabled
2021-11-01 01:18:23.226945 (MainThread): Parsing macros/etc.sql
2021-11-01 01:18:23.229825 (MainThread): Parsing macros/catalog.sql
2021-11-01 01:18:23.236161 (MainThread): Parsing macros/adapters.sql
2021-11-01 01:18:23.258614 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 01:18:23.261080 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 01:18:23.263555 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 01:18:23.272434 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 01:18:23.274842 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 01:18:23.288182 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 01:18:23.289691 (MainThread): Parsing macros/core.sql
2021-11-01 01:18:23.293173 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 01:18:23.300187 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 01:18:23.310198 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 01:18:23.312413 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 01:18:23.328895 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 01:18:23.360648 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 01:18:23.382814 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 01:18:23.384460 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 01:18:23.393977 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 01:18:23.412892 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 01:18:23.425977 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 01:18:23.433661 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 01:18:23.440602 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 01:18:23.444139 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 01:18:23.445585 (MainThread): Parsing macros/etc/query.sql
2021-11-01 01:18:23.446449 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 01:18:23.447799 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 01:18:23.455973 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 01:18:23.457704 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 01:18:23.459939 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 01:18:23.461449 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 01:18:23.514852 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 01:18:23.516498 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 01:18:23.517668 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 01:18:23.519062 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 01:18:23.711662 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_logs".
2021-11-01 01:18:23.723410 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-11-01 01:18:23.748815 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:18:23.750554 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:18:23.752293 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:18:23.753865 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:18:23.754220 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/example/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 01:18:23.754396 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/example/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 01:18:23.768023 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '18158d41-d9c6-4c75-8c05-297d5ad53a30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b84340>]}
2021-11-01 01:18:23.772384 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 01:18:23.772742 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '18158d41-d9c6-4c75-8c05-297d5ad53a30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111be3c70>]}
2021-11-01 01:18:23.772998 (MainThread): Found 2 models, 2 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-11-01 01:18:23.774384 (MainThread): 
2021-11-01 01:18:23.774911 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 01:18:23.775864 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-01 01:18:23.776066 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 01:18:24.156068 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 01:18:24.156732 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-01 01:18:24.169245 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 01:18:24.441585 (MainThread): 01:18:24 | Concurrency: 4 threads (target='dev')
2021-11-01 01:18:24.442126 (MainThread): 01:18:24 | 
2021-11-01 01:18:24.446274 (Thread-1): Began running node model.freetrade_test.account_logs
2021-11-01 01:18:24.446814 (Thread-1): 01:18:24 | 1 of 2 START table model ft_data.account_logs........................ [RUN]
2021-11-01 01:18:24.447425 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_logs".
2021-11-01 01:18:24.447718 (Thread-1): Compiling model.freetrade_test.account_logs
2021-11-01 01:18:24.451910 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_logs"
2021-11-01 01:18:24.452588 (Thread-1): finished collecting timing info
2021-11-01 01:18:24.474850 (Thread-1): Opening a new connection, currently in state closed
2021-11-01 01:18:24.480663 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 01:18:24.798322 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_logs"
2021-11-01 01:18:24.798929 (Thread-1): On model.freetrade_test.account_logs: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_logs"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_logs`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`), buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'), sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'), cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   * ,
         sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
FROM     cashflows
ORDER BY log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-01 01:18:27.364151 (Thread-1): finished collecting timing info
2021-11-01 01:18:27.364875 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18158d41-d9c6-4c75-8c05-297d5ad53a30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ca69a0>]}
2021-11-01 01:18:27.365417 (Thread-1): 01:18:27 | 1 of 2 OK created table model ft_data.account_logs................... [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.92s]
2021-11-01 01:18:27.365682 (Thread-1): Finished running node model.freetrade_test.account_logs
2021-11-01 01:18:27.366329 (Thread-3): Began running node model.freetrade_test.my_second_dbt_model
2021-11-01 01:18:27.366713 (Thread-3): 01:18:27 | 2 of 2 START table model ft_data.my_second_dbt_model................. [RUN]
2021-11-01 01:18:27.367206 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-11-01 01:18:27.367441 (Thread-3): Compiling model.freetrade_test.my_second_dbt_model
2021-11-01 01:18:27.369034 (Thread-3): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64670), raddr=('142.250.180.10', 443)>
2021-11-01 01:18:27.369545 (Thread-3): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64671), raddr=('142.250.187.234', 443)>
2021-11-01 01:18:27.369923 (Thread-3): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64672), raddr=('142.250.180.10', 443)>
2021-11-01 01:18:27.370202 (Thread-3): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64673), raddr=('142.250.187.234', 443)>
2021-11-01 01:18:27.373332 (Thread-3): Writing injected SQL for node "model.freetrade_test.my_second_dbt_model"
2021-11-01 01:18:27.373875 (Thread-3): finished collecting timing info
2021-11-01 01:18:27.382342 (Thread-3): Opening a new connection, currently in state init
2021-11-01 01:18:27.388735 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 01:18:27.671422 (Thread-3): Writing runtime SQL for node "model.freetrade_test.my_second_dbt_model"
2021-11-01 01:18:27.672502 (Thread-3): On model.freetrade_test.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.my_second_dbt_model"} */


  create or replace table `ft-data-330317`.`ft_data`.`my_second_dbt_model`
  
  
  OPTIONS()
  as (
    -- Use the `ref` function to select from other models


select *
from `ft-data-330317`.`ft_data`.`account_logs`
where customer_id = 1539
  );
    
2021-11-01 01:18:29.579829 (Thread-3): finished collecting timing info
2021-11-01 01:18:29.580604 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18158d41-d9c6-4c75-8c05-297d5ad53a30', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111cb4a60>]}
2021-11-01 01:18:29.581191 (Thread-3): 01:18:29 | 2 of 2 OK created table model ft_data.my_second_dbt_model............ [CREATE TABLE (2.1k rows, 1.4 MB processed) in 2.21s]
2021-11-01 01:18:29.581532 (Thread-3): Finished running node model.freetrade_test.my_second_dbt_model
2021-11-01 01:18:29.583822 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 01:18:29.584482 (MainThread): 01:18:29 | 
2021-11-01 01:18:29.584785 (MainThread): 01:18:29 | Finished running 2 table models in 5.81s.
2021-11-01 01:18:29.585040 (MainThread): Connection 'master' was properly closed.
2021-11-01 01:18:29.585244 (MainThread): Connection 'model.freetrade_test.account_logs' was properly closed.
2021-11-01 01:18:29.585451 (MainThread): Connection 'model.freetrade_test.my_second_dbt_model' was properly closed.
2021-11-01 01:18:29.592795 (MainThread): 
2021-11-01 01:18:29.593045 (MainThread): Completed successfully
2021-11-01 01:18:29.593232 (MainThread): 
Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
2021-11-01 01:18:29.593496 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111be3c70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111bc8af0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111bc8280>]}
2021-11-01 01:18:29.593769 (MainThread): Flushing usage events
2021-11-01 01:26:40.223330 (MainThread): Running with dbt=0.21.0
2021-11-01 01:26:40.518871 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 01:26:40.519751 (MainThread): Tracking: tracking
2021-11-01 01:26:40.530450 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9ca880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba21ac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9b0160>]}
2021-11-01 01:26:40.541541 (MainThread): Partial parsing not enabled
2021-11-01 01:26:40.552985 (MainThread): Parsing macros/etc.sql
2021-11-01 01:26:40.555908 (MainThread): Parsing macros/catalog.sql
2021-11-01 01:26:40.562074 (MainThread): Parsing macros/adapters.sql
2021-11-01 01:26:40.584073 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 01:26:40.586473 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 01:26:40.588895 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 01:26:40.597905 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 01:26:40.600435 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 01:26:40.614235 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 01:26:40.615806 (MainThread): Parsing macros/core.sql
2021-11-01 01:26:40.619313 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 01:26:40.626189 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 01:26:40.636816 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 01:26:40.638440 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 01:26:40.654939 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 01:26:40.686229 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 01:26:40.707880 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 01:26:40.709509 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 01:26:40.719144 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 01:26:40.738107 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 01:26:40.751131 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 01:26:40.758783 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 01:26:40.766023 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 01:26:40.769740 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 01:26:40.771135 (MainThread): Parsing macros/etc/query.sql
2021-11-01 01:26:40.772026 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 01:26:40.773594 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 01:26:40.781605 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 01:26:40.783237 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 01:26:40.785478 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 01:26:40.786910 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 01:26:40.839323 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 01:26:40.840901 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 01:26:40.841986 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 01:26:40.843345 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 01:26:41.038091 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_logs".
2021-11-01 01:26:41.050501 (MainThread): Acquiring new bigquery connection "model.freetrade_test.my_second_dbt_model".
2021-11-01 01:26:41.077537 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:26:41.079371 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:26:41.081340 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:26:41.083062 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 01:26:41.083453 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/example/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 01:26:41.083612 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/example/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 01:26:41.099561 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '65e9b789-0d8d-43a9-824a-fce397ed8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10daa5340>]}
2021-11-01 01:26:41.104587 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 01:26:41.104966 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '65e9b789-0d8d-43a9-824a-fce397ed8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db05c70>]}
2021-11-01 01:26:41.105196 (MainThread): Found 2 models, 2 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-11-01 01:26:41.106476 (MainThread): 
2021-11-01 01:26:41.106816 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 01:26:41.107802 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-01 01:26:41.107967 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 01:26:41.551074 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 01:26:41.551347 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-01 01:26:41.557491 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 01:26:41.858162 (MainThread): 01:26:41 | Concurrency: 4 threads (target='dev')
2021-11-01 01:26:41.858701 (MainThread): 01:26:41 | 
2021-11-01 01:26:41.862838 (Thread-1): Began running node model.freetrade_test.account_logs
2021-11-01 01:26:41.863373 (Thread-1): 01:26:41 | 1 of 2 START table model ft_data.account_logs........................ [RUN]
2021-11-01 01:26:41.863976 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_logs".
2021-11-01 01:26:41.864270 (Thread-1): Compiling model.freetrade_test.account_logs
2021-11-01 01:26:41.868407 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_logs"
2021-11-01 01:26:41.869078 (Thread-1): finished collecting timing info
2021-11-01 01:26:41.891373 (Thread-1): Opening a new connection, currently in state closed
2021-11-01 01:26:41.897282 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 01:26:42.164969 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_logs"
2021-11-01 01:26:42.165497 (Thread-1): On model.freetrade_test.account_logs: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_logs"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_logs`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`), buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'), sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'), cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   * ,
         sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
FROM     cashflows
ORDER BY log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-01 01:26:42.528738 (Thread-1): Unhandled error while running:
/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_logs"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_logs`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`), buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'), sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'), cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   * ,
         sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
FROM     cashflows
ORDER BY log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-01 01:26:42.529196 (Thread-1): 404 Not found: Dataset ft-data-330317:ft_source_data was not found in location US

(job ID: 280a409b-0879-4831-8f88-b787b18e3560)

                                                             -----Query Job SQL Follows-----                                                              

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_logs"} */
   2:
   3:
   4:  create or replace table `ft-data-330317`.`ft_data`.`account_logs`
   5:  
   6:  
   7:  OPTIONS()
   8:  as (
   9:    /*
  10:    Welcome to your first dbt model!
  11:    Did you know that you can also configure models directly within SQL files?
  12:    This will override configurations stated in dbt_project.yml
  13:
  14:    Try changing "table" to "view" below
  15:*/
  16:
  17:
  18:
  19:WITH deposits AS
  20:(
  21:       SELECT customer_id,
  22:              deposited_at  AS log_datetime,
  23:              amount_in_gbp AS amount,
  24:              "deposit"     AS transaction_type
  25:       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
  26:(
  27:       SELECT customer_id,
  28:              requested_at AS log_datetime,
  29:              -amount      AS amount,
  30:              "withdrawal" AS transaction_type
  31:       FROM   `ft-data-330317.ft_source_data.withdrawals`), buys AS
  32:(
  33:       SELECT customer_id,
  34:              executed_at AS log_datetime,
  35:              -value      AS amount,
  36:              "buy"       AS transaction_type,
  37:       FROM   `ft-data-330317.ft_source_data.orders`
  38:       WHERE  side = 'buy'), sells AS
  39:(
  40:       SELECT customer_id,
  41:              executed_at AS log_datetime,
  42:              value       AS amount,
  43:              "sell"      AS transaction_type,
  44:       FROM   `ft-data-330317.ft_source_data.orders`
  45:       WHERE  side = 'sell'), cashflows AS
  46:(
  47:       SELECT *
  48:       FROM   withdrawals
  49:       UNION ALL
  50:                 (
  51:                        SELECT *
  52:                        FROM   deposits)
  53:          UNION ALL
  54:                    (
  55:                           SELECT *
  56:                           FROM   buys)
  57:             UNION ALL
  58:                       (
  59:                              SELECT *
  60:                              FROM   sells)
  61:             ORDER BY  customer_id,
  62:                       log_datetime)
  63:SELECT   * ,
  64:         sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
  65:FROM     cashflows
  66:ORDER BY log_datetime ASC
  67:
  68:/*
  69:    Uncomment the line below to remove records with null `id` values
  70:*/
  71:
  72:-- where id is not null
  73:  );
  74:    
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
2021-11-01 01:26:42.529719 (Thread-1): finished collecting timing info
2021-11-01 01:26:42.530613 (Thread-1): Runtime Error in model account_logs (models/example/account_logs.sql)
  404 Not found: Dataset ft-data-330317:ft_source_data was not found in location US
  
  (job ID: 280a409b-0879-4831-8f88-b787b18e3560)
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.NotFound: 404 Not found: Dataset ft-data-330317:ft_source_data was not found in location US

(job ID: 280a409b-0879-4831-8f88-b787b18e3560)

                                                             -----Query Job SQL Follows-----                                                              

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_logs"} */
   2:
   3:
   4:  create or replace table `ft-data-330317`.`ft_data`.`account_logs`
   5:  
   6:  
   7:  OPTIONS()
   8:  as (
   9:    /*
  10:    Welcome to your first dbt model!
  11:    Did you know that you can also configure models directly within SQL files?
  12:    This will override configurations stated in dbt_project.yml
  13:
  14:    Try changing "table" to "view" below
  15:*/
  16:
  17:
  18:
  19:WITH deposits AS
  20:(
  21:       SELECT customer_id,
  22:              deposited_at  AS log_datetime,
  23:              amount_in_gbp AS amount,
  24:              "deposit"     AS transaction_type
  25:       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
  26:(
  27:       SELECT customer_id,
  28:              requested_at AS log_datetime,
  29:              -amount      AS amount,
  30:              "withdrawal" AS transaction_type
  31:       FROM   `ft-data-330317.ft_source_data.withdrawals`), buys AS
  32:(
  33:       SELECT customer_id,
  34:              executed_at AS log_datetime,
  35:              -value      AS amount,
  36:              "buy"       AS transaction_type,
  37:       FROM   `ft-data-330317.ft_source_data.orders`
  38:       WHERE  side = 'buy'), sells AS
  39:(
  40:       SELECT customer_id,
  41:              executed_at AS log_datetime,
  42:              value       AS amount,
  43:              "sell"      AS transaction_type,
  44:       FROM   `ft-data-330317.ft_source_data.orders`
  45:       WHERE  side = 'sell'), cashflows AS
  46:(
  47:       SELECT *
  48:       FROM   withdrawals
  49:       UNION ALL
  50:                 (
  51:                        SELECT *
  52:                        FROM   deposits)
  53:          UNION ALL
  54:                    (
  55:                           SELECT *
  56:                           FROM   buys)
  57:             UNION ALL
  58:                       (
  59:                              SELECT *
  60:                              FROM   sells)
  61:             ORDER BY  customer_id,
  62:                       log_datetime)
  63:SELECT   * ,
  64:         sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
  65:FROM     cashflows
  66:ORDER BY log_datetime ASC
  67:
  68:/*
  69:    Uncomment the line below to remove records with null `id` values
  70:*/
  71:
  72:-- where id is not null
  73:  );
  74:    
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 291, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 393, in run
    return self.execute(compiled_node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 249, in execute
    result = MacroGenerator(materialization_macro, context)()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 128, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 41, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 195, in exception_handler
    raise RuntimeException(exc_message)
dbt.exceptions.RuntimeException: Runtime Error in model account_logs (models/example/account_logs.sql)
  404 Not found: Dataset ft-data-330317:ft_source_data was not found in location US
  
  (job ID: 280a409b-0879-4831-8f88-b787b18e3560)
2021-11-01 01:26:42.536315 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '65e9b789-0d8d-43a9-824a-fce397ed8616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dbb7520>]}
2021-11-01 01:26:42.536940 (Thread-1): 01:26:42 | 1 of 2 ERROR creating table model ft_data.account_logs............... [ERROR in 0.67s]
2021-11-01 01:26:42.537239 (Thread-1): Finished running node model.freetrade_test.account_logs
2021-11-01 01:26:42.537948 (Thread-3): Began running node model.freetrade_test.my_second_dbt_model
2021-11-01 01:26:42.538229 (Thread-3): 01:26:42 | 2 of 2 SKIP relation ft_data.my_second_dbt_model..................... [SKIP]
2021-11-01 01:26:42.538686 (Thread-3): Finished running node model.freetrade_test.my_second_dbt_model
2021-11-01 01:26:42.540275 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 01:26:42.540792 (MainThread): 01:26:42 | 
2021-11-01 01:26:42.541038 (MainThread): 01:26:42 | Finished running 2 table models in 1.43s.
2021-11-01 01:26:42.541255 (MainThread): Connection 'master' was properly closed.
2021-11-01 01:26:42.541436 (MainThread): Connection 'model.freetrade_test.account_logs' was properly closed.
2021-11-01 01:26:42.543804 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64699), raddr=('142.250.187.202', 443)>
2021-11-01 01:26:42.544048 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64700), raddr=('142.250.187.234', 443)>
2021-11-01 01:26:42.544230 (MainThread): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64701), raddr=('142.250.187.202', 443)>
2021-11-01 01:26:42.544402 (MainThread): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64702), raddr=('142.250.187.234', 443)>
2021-11-01 01:26:42.544606 (MainThread): unclosed <ssl.SSLSocket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64703), raddr=('142.250.187.202', 443)>
2021-11-01 01:26:42.544771 (MainThread): unclosed <ssl.SSLSocket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 64704), raddr=('142.250.187.234', 443)>
2021-11-01 01:26:42.560192 (MainThread): 
2021-11-01 01:26:42.560421 (MainThread): Completed with 1 error and 0 warnings:
2021-11-01 01:26:42.560565 (MainThread): 
2021-11-01 01:26:42.560703 (MainThread): Runtime Error in model account_logs (models/example/account_logs.sql)
2021-11-01 01:26:42.560937 (MainThread):   404 Not found: Dataset ft-data-330317:ft_source_data was not found in location US
2021-11-01 01:26:42.561080 (MainThread):   
2021-11-01 01:26:42.561204 (MainThread):   (job ID: 280a409b-0879-4831-8f88-b787b18e3560)
2021-11-01 01:26:42.561345 (MainThread): 
Done. PASS=0 WARN=0 ERROR=1 SKIP=1 TOTAL=2
2021-11-01 01:26:42.561569 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da47a60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10daeaca0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10daea9a0>]}
2021-11-01 01:26:42.561802 (MainThread): Flushing usage events
2021-11-01 03:47:40.817601 (MainThread): Running with dbt=0.21.0
2021-11-01 03:47:41.268940 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 03:47:41.269958 (MainThread): Tracking: tracking
2021-11-01 03:47:41.287469 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e86280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103edc9d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e6e3d0>]}
2021-11-01 03:47:41.298955 (MainThread): Partial parsing not enabled
2021-11-01 03:47:41.314239 (MainThread): Parsing macros/etc.sql
2021-11-01 03:47:41.317167 (MainThread): Parsing macros/catalog.sql
2021-11-01 03:47:41.323410 (MainThread): Parsing macros/adapters.sql
2021-11-01 03:47:41.345351 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 03:47:41.347719 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 03:47:41.350077 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 03:47:41.359016 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 03:47:41.361492 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 03:47:41.375754 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 03:47:41.377477 (MainThread): Parsing macros/core.sql
2021-11-01 03:47:41.381562 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 03:47:41.387896 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 03:47:41.397518 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 03:47:41.399064 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 03:47:41.415429 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 03:47:41.446431 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 03:47:41.468102 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 03:47:41.469720 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 03:47:41.479306 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 03:47:41.497810 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 03:47:41.510799 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 03:47:41.518383 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 03:47:41.525016 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 03:47:41.528589 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 03:47:41.529997 (MainThread): Parsing macros/etc/query.sql
2021-11-01 03:47:41.530849 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 03:47:41.532198 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 03:47:41.540181 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 03:47:41.541902 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 03:47:41.544089 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 03:47:41.545701 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 03:47:41.597545 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 03:47:41.599077 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 03:47:41.600162 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 03:47:41.601373 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 03:47:41.790298 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 03:47:41.802317 (MainThread): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 03:47:41.827942 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 03:47:41.829775 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 03:47:41.831554 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 03:47:41.833111 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 03:47:41.833476 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 03:47:41.833651 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 03:47:41.833831 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 03:47:41.834000 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 03:47:41.843668 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-01 03:47:41.848239 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b47b1df0-61e2-4834-8fc5-d865e5bc9686', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fcdaf0>]}
2021-11-01 03:47:41.852710 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 03:47:41.853074 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b47b1df0-61e2-4834-8fc5-d865e5bc9686', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fcdaf0>]}
2021-11-01 03:47:41.853336 (MainThread): Found 2 models, 0 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-11-01 03:47:41.854860 (MainThread): 
2021-11-01 03:47:41.855330 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 03:47:41.856227 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-01 03:47:41.856571 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 03:47:42.355042 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 03:47:42.355439 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-01 03:47:42.363892 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 03:47:42.641748 (MainThread): 03:47:42 | Concurrency: 4 threads (target='dev')
2021-11-01 03:47:42.642296 (MainThread): 03:47:42 | 
2021-11-01 03:47:42.646454 (Thread-1): Began running node model.freetrade_test.cashflows
2021-11-01 03:47:42.646974 (Thread-1): 03:47:42 | 1 of 2 START table model ft_data.cashflows........................... [RUN]
2021-11-01 03:47:42.647577 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 03:47:42.647874 (Thread-1): Compiling model.freetrade_test.cashflows
2021-11-01 03:47:42.652148 (Thread-1): Writing injected SQL for node "model.freetrade_test.cashflows"
2021-11-01 03:47:42.653024 (Thread-1): finished collecting timing info
2021-11-01 03:47:42.693641 (Thread-1): Writing runtime SQL for node "model.freetrade_test.cashflows"
2021-11-01 03:47:42.695123 (Thread-1): Opening a new connection, currently in state closed
2021-11-01 03:47:42.700589 (Thread-1): On model.freetrade_test.cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-01 03:47:44.213794 (Thread-1): Unhandled error while running:
/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-01 03:47:44.214288 (Thread-1): 404 Not found: Dataset ft-data-330317:ft_source_data was not found in location US

(job ID: 5a211531-2ea6-4bb7-b6ed-25d6b44d80f0)

                                                            -----Query Job SQL Follows-----                                                            

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.cashflows"} */
   2:
   3:
   4:  create or replace table `ft-data-330317`.`ft_data`.`cashflows`
   5:  
   6:  
   7:  OPTIONS()
   8:  as (
   9:    /*
  10:    Welcome to your first dbt model!
  11:    Did you know that you can also configure models directly within SQL files?
  12:    This will override configurations stated in dbt_project.yml
  13:
  14:    Try changing "table" to "view" below
  15:*/
  16:
  17:
  18:
  19:WITH deposits AS
  20:(
  21:       SELECT customer_id,
  22:              deposited_at  AS log_datetime,
  23:              amount_in_gbp AS amount,
  24:              "deposit"     AS transaction_type
  25:       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
  26:(
  27:       SELECT customer_id,
  28:              requested_at AS log_datetime,
  29:              -amount      AS amount,
  30:              "withdrawal" AS transaction_type
  31:       FROM   `ft-data-330317.ft_source_data.withdrawals`),
  32:
  33:       buys AS
  34:(
  35:       SELECT customer_id,
  36:              executed_at AS log_datetime,
  37:              -value      AS amount,
  38:              "buy"       AS transaction_type,
  39:       FROM   `ft-data-330317.ft_source_data.orders`
  40:       WHERE  side = 'buy'),
  41:
  42:       sells AS
  43:(
  44:       SELECT customer_id,
  45:              executed_at AS log_datetime,
  46:              value       AS amount,
  47:              "sell"      AS transaction_type,
  48:       FROM   `ft-data-330317.ft_source_data.orders`
  49:       WHERE  side = 'sell'),
  50:
  51:       cashflows AS
  52:(
  53:       SELECT *
  54:       FROM   withdrawals
  55:       UNION ALL
  56:                 (
  57:                        SELECT *
  58:                        FROM   deposits)
  59:          UNION ALL
  60:                    (
  61:                           SELECT *
  62:                           FROM   buys)
  63:             UNION ALL
  64:                       (
  65:                              SELECT *
  66:                              FROM   sells)
  67:             ORDER BY  customer_id,
  68:                       log_datetime)
  69:SELECT   *
  70:FROM     cashflows
  71:ORDER BY log_datetime ASC
  72:
  73:/*
  74:    Uncomment the line below to remove records with null `id` values
  75:*/
  76:
  77:-- where id is not null
  78:  );
  79:    
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
2021-11-01 03:47:44.214855 (Thread-1): finished collecting timing info
2021-11-01 03:47:44.215756 (Thread-1): Runtime Error in model cashflows (models/accounts/cashflows.sql)
  404 Not found: Dataset ft-data-330317:ft_source_data was not found in location US
  
  (job ID: 5a211531-2ea6-4bb7-b6ed-25d6b44d80f0)
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.NotFound: 404 Not found: Dataset ft-data-330317:ft_source_data was not found in location US

(job ID: 5a211531-2ea6-4bb7-b6ed-25d6b44d80f0)

                                                            -----Query Job SQL Follows-----                                                            

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.cashflows"} */
   2:
   3:
   4:  create or replace table `ft-data-330317`.`ft_data`.`cashflows`
   5:  
   6:  
   7:  OPTIONS()
   8:  as (
   9:    /*
  10:    Welcome to your first dbt model!
  11:    Did you know that you can also configure models directly within SQL files?
  12:    This will override configurations stated in dbt_project.yml
  13:
  14:    Try changing "table" to "view" below
  15:*/
  16:
  17:
  18:
  19:WITH deposits AS
  20:(
  21:       SELECT customer_id,
  22:              deposited_at  AS log_datetime,
  23:              amount_in_gbp AS amount,
  24:              "deposit"     AS transaction_type
  25:       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
  26:(
  27:       SELECT customer_id,
  28:              requested_at AS log_datetime,
  29:              -amount      AS amount,
  30:              "withdrawal" AS transaction_type
  31:       FROM   `ft-data-330317.ft_source_data.withdrawals`),
  32:
  33:       buys AS
  34:(
  35:       SELECT customer_id,
  36:              executed_at AS log_datetime,
  37:              -value      AS amount,
  38:              "buy"       AS transaction_type,
  39:       FROM   `ft-data-330317.ft_source_data.orders`
  40:       WHERE  side = 'buy'),
  41:
  42:       sells AS
  43:(
  44:       SELECT customer_id,
  45:              executed_at AS log_datetime,
  46:              value       AS amount,
  47:              "sell"      AS transaction_type,
  48:       FROM   `ft-data-330317.ft_source_data.orders`
  49:       WHERE  side = 'sell'),
  50:
  51:       cashflows AS
  52:(
  53:       SELECT *
  54:       FROM   withdrawals
  55:       UNION ALL
  56:                 (
  57:                        SELECT *
  58:                        FROM   deposits)
  59:          UNION ALL
  60:                    (
  61:                           SELECT *
  62:                           FROM   buys)
  63:             UNION ALL
  64:                       (
  65:                              SELECT *
  66:                              FROM   sells)
  67:             ORDER BY  customer_id,
  68:                       log_datetime)
  69:SELECT   *
  70:FROM     cashflows
  71:ORDER BY log_datetime ASC
  72:
  73:/*
  74:    Uncomment the line below to remove records with null `id` values
  75:*/
  76:
  77:-- where id is not null
  78:  );
  79:    
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 291, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 393, in run
    return self.execute(compiled_node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 249, in execute
    result = MacroGenerator(materialization_macro, context)()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 128, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 41, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 195, in exception_handler
    raise RuntimeException(exc_message)
dbt.exceptions.RuntimeException: Runtime Error in model cashflows (models/accounts/cashflows.sql)
  404 Not found: Dataset ft-data-330317:ft_source_data was not found in location US
  
  (job ID: 5a211531-2ea6-4bb7-b6ed-25d6b44d80f0)
2021-11-01 03:47:44.225429 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b47b1df0-61e2-4834-8fc5-d865e5bc9686', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10612c370>]}
2021-11-01 03:47:44.226134 (Thread-1): 03:47:44 | 1 of 2 ERROR creating table model ft_data.cashflows.................. [ERROR in 1.58s]
2021-11-01 03:47:44.226456 (Thread-1): Finished running node model.freetrade_test.cashflows
2021-11-01 03:47:44.227230 (Thread-3): Began running node model.freetrade_test.account_timeseries
2021-11-01 03:47:44.227534 (Thread-3): 03:47:44 | 2 of 2 SKIP relation ft_data.account_timeseries...................... [SKIP]
2021-11-01 03:47:44.228113 (Thread-3): Finished running node model.freetrade_test.account_timeseries
2021-11-01 03:47:44.229849 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 03:47:44.230385 (MainThread): 03:47:44 | 
2021-11-01 03:47:44.230634 (MainThread): 03:47:44 | Finished running 2 table models in 2.38s.
2021-11-01 03:47:44.230850 (MainThread): Connection 'master' was properly closed.
2021-11-01 03:47:44.231025 (MainThread): Connection 'model.freetrade_test.cashflows' was properly closed.
2021-11-01 03:47:44.233275 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65171), raddr=('172.217.16.234', 443)>
2021-11-01 03:47:44.233609 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65172), raddr=('142.250.187.234', 443)>
2021-11-01 03:47:44.233805 (MainThread): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65173), raddr=('172.217.16.234', 443)>
2021-11-01 03:47:44.233992 (MainThread): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65174), raddr=('142.250.187.234', 443)>
2021-11-01 03:47:44.234220 (MainThread): unclosed <ssl.SSLSocket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65175), raddr=('172.217.16.234', 443)>
2021-11-01 03:47:44.234402 (MainThread): unclosed <ssl.SSLSocket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65176), raddr=('142.250.187.234', 443)>
2021-11-01 03:47:44.249737 (MainThread): 
2021-11-01 03:47:44.249968 (MainThread): Completed with 1 error and 0 warnings:
2021-11-01 03:47:44.250121 (MainThread): 
2021-11-01 03:47:44.250305 (MainThread): Runtime Error in model cashflows (models/accounts/cashflows.sql)
2021-11-01 03:47:44.250498 (MainThread):   404 Not found: Dataset ft-data-330317:ft_source_data was not found in location US
2021-11-01 03:47:44.250639 (MainThread):   
2021-11-01 03:47:44.250766 (MainThread):   (job ID: 5a211531-2ea6-4bb7-b6ed-25d6b44d80f0)
2021-11-01 03:47:44.250899 (MainThread): 
Done. PASS=0 WARN=0 ERROR=1 SKIP=1 TOTAL=2
2021-11-01 03:47:44.251130 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fc6580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f31400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f67a00>]}
2021-11-01 03:47:44.251366 (MainThread): Flushing usage events
2021-11-01 03:48:15.504123 (MainThread): Running with dbt=0.21.0
2021-11-01 03:48:15.799503 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 03:48:15.800686 (MainThread): Tracking: tracking
2021-11-01 03:48:15.810668 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1126cf280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110726be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1126b83d0>]}
2021-11-01 03:48:15.821626 (MainThread): Partial parsing not enabled
2021-11-01 03:48:15.832881 (MainThread): Parsing macros/etc.sql
2021-11-01 03:48:15.835679 (MainThread): Parsing macros/catalog.sql
2021-11-01 03:48:15.841901 (MainThread): Parsing macros/adapters.sql
2021-11-01 03:48:15.865308 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 03:48:15.867808 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 03:48:15.870429 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 03:48:15.879649 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 03:48:15.882100 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 03:48:15.895437 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 03:48:15.896928 (MainThread): Parsing macros/core.sql
2021-11-01 03:48:15.900415 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 03:48:15.907191 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 03:48:15.917478 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 03:48:15.919123 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 03:48:15.935507 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 03:48:15.967108 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 03:48:15.988980 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 03:48:15.990582 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 03:48:16.000000 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 03:48:16.018682 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 03:48:16.031690 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 03:48:16.039271 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 03:48:16.046294 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 03:48:16.049931 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 03:48:16.051289 (MainThread): Parsing macros/etc/query.sql
2021-11-01 03:48:16.052170 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 03:48:16.053559 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 03:48:16.061523 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 03:48:16.063199 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 03:48:16.065435 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 03:48:16.066849 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 03:48:16.119400 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 03:48:16.120992 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 03:48:16.122070 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 03:48:16.123278 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 03:48:16.310511 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 03:48:16.322413 (MainThread): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 03:48:16.347464 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 03:48:16.349239 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 03:48:16.350977 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 03:48:16.352584 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 03:48:16.352951 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 03:48:16.353126 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 03:48:16.353309 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 03:48:16.353437 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 03:48:16.363554 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-01 03:48:16.368005 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd701e119-eeeb-4db5-b675-0f3d31384f45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112813f40>]}
2021-11-01 03:48:16.372464 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 03:48:16.372824 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd701e119-eeeb-4db5-b675-0f3d31384f45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112813df0>]}
2021-11-01 03:48:16.373053 (MainThread): Found 2 models, 0 tests, 0 snapshots, 0 analyses, 184 macros, 0 operations, 0 seed files, 0 sources, 0 exposures
2021-11-01 03:48:16.374451 (MainThread): 
2021-11-01 03:48:16.374856 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 03:48:16.375734 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-01 03:48:16.376072 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 03:48:16.811450 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 03:48:16.812088 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-01 03:48:16.824193 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 03:48:17.104398 (MainThread): 03:48:17 | Concurrency: 4 threads (target='dev')
2021-11-01 03:48:17.104903 (MainThread): 03:48:17 | 
2021-11-01 03:48:17.109519 (Thread-1): Began running node model.freetrade_test.cashflows
2021-11-01 03:48:17.110203 (Thread-1): 03:48:17 | 1 of 2 START table model ft_data.cashflows........................... [RUN]
2021-11-01 03:48:17.110953 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 03:48:17.111353 (Thread-1): Compiling model.freetrade_test.cashflows
2021-11-01 03:48:17.115863 (Thread-1): Writing injected SQL for node "model.freetrade_test.cashflows"
2021-11-01 03:48:17.116648 (Thread-1): finished collecting timing info
2021-11-01 03:48:17.158604 (Thread-1): Writing runtime SQL for node "model.freetrade_test.cashflows"
2021-11-01 03:48:17.159229 (Thread-1): Opening a new connection, currently in state closed
2021-11-01 03:48:17.164965 (Thread-1): On model.freetrade_test.cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-01 03:48:19.675896 (Thread-1): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65181), raddr=('172.217.169.42', 443)>
2021-11-01 03:48:19.676336 (Thread-1): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65182), raddr=('142.250.187.234', 443)>
2021-11-01 03:48:19.676651 (Thread-1): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65183), raddr=('172.217.169.42', 443)>
2021-11-01 03:48:19.676934 (Thread-1): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65184), raddr=('142.250.187.234', 443)>
2021-11-01 03:48:19.680029 (Thread-1): finished collecting timing info
2021-11-01 03:48:19.680648 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd701e119-eeeb-4db5-b675-0f3d31384f45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11280c730>]}
2021-11-01 03:48:19.681176 (Thread-1): 03:48:19 | 1 of 2 OK created table model ft_data.cashflows...................... [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.57s]
2021-11-01 03:48:19.681442 (Thread-1): Finished running node model.freetrade_test.cashflows
2021-11-01 03:48:19.682216 (Thread-3): Began running node model.freetrade_test.account_timeseries
2021-11-01 03:48:19.682596 (Thread-3): 03:48:19 | 2 of 2 START table model ft_data.account_timeseries.................. [RUN]
2021-11-01 03:48:19.683212 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 03:48:19.683463 (Thread-3): Compiling model.freetrade_test.account_timeseries
2021-11-01 03:48:19.686922 (Thread-3): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-01 03:48:19.687467 (Thread-3): finished collecting timing info
2021-11-01 03:48:19.697363 (Thread-3): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-01 03:48:19.697959 (Thread-3): Opening a new connection, currently in state init
2021-11-01 03:48:19.704187 (Thread-3): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/




/*
 inline function to "tumble" datetimes into date bins
*/


    CREATE TEMP FUNCTION tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds));

/*
inline function to create the customer_id, datetime index onto which account data will be projected
*/

    CREATE TEMP FUNCTION
     gen_ts_candidates(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           tumble_interval(min_ts, tumble_seconds),
           tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ));

/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                      tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT gen_ts_candidates(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-01 03:48:20.037315 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Syntax error: Expected "(" or keyword SELECT or keyword WITH but got keyword CREATE at [22:5]')
2021-11-01 03:48:21.117973 (Thread-3): finished collecting timing info
2021-11-01 03:48:21.118907 (Thread-3): Database Error in model account_timeseries (models/accounts/account_timeseries.sql)
  Syntax error: Expected "(" or keyword SELECT or keyword WITH but got keyword CREATE at [22:5]
  compiled SQL at target/run/freetrade_test/models/accounts/account_timeseries.sql
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Expected "(" or keyword SELECT or keyword WITH but got keyword CREATE at [22:5]

(job ID: 4e4e62f4-a87f-45a5-af7d-764af04efe4c)

                                                                -----Query Job SQL Follows-----                                                                 

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */
   2:
   3:
   4:  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
   5:  
   6:  
   7:  OPTIONS()
   8:  as (
   9:    /*
  10:A timeseries of account balances for each client binned every 4hrs.
  11:Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
  12:*/
  13:
  14:
  15:
  16:
  17:/*
  18: inline function to "tumble" datetimes into date bins
  19:*/
  20:
  21:
  22:    CREATE TEMP FUNCTION tumble_interval(
  23:     val TIMESTAMP, tumble_seconds INT64)
  24:    AS (
  25:     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds));
  26:
  27:/*
  28:inline function to create the customer_id, datetime index onto which account data will be projected
  29:*/
  30:
  31:    CREATE TEMP FUNCTION
  32:     gen_ts_candidates(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
  33:    AS ((
  34:     SELECT ARRAY_AGG(x)
  35:     FROM (
  36:       SELECT series_key, tumble_val
  37:       FROM UNNEST(
  38:         GENERATE_TIMESTAMP_ARRAY(
  39:           tumble_interval(min_ts, tumble_seconds),
  40:           tumble_interval(max_ts, tumble_seconds),
  41:           INTERVAL tumble_seconds SECOND
  42:         )
  43:       ) AS tumble_val
  44:       CROSS JOIN UNNEST(keys) AS series_key
  45:     ) x
  46:    ));
  47:
  48:/*
  49:Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
  50:*/
  51:
  52:    WITH event_logs AS
  53:    (
  54:             SELECT   * ,
  55:                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
  56:             FROM     `ft-data-330317`.`ft_data`.`cashflows`
  57:             ORDER BY log_datetime ASC),
  58:
  59:          agged_events AS
  60:    (
  61:             SELECT   sum(amount) delta,
  62:                      customer_id,
  63:                      tumble_interval(log_datetime, 21600) tumble
  64:             FROM     event_logs
  65:             GROUP BY customer_id,
  66:                      tumble
  67:             ORDER BY customer_id,
  68:                      tumble ASC ),
  69:           args AS
  70:    (
  71:           SELECT array_agg(DISTINCT customer_id) AS KEY,
  72:                  min(tumble)                     AS min_ts,
  73:                  max(tumble)                     AS max_ts
  74:           FROM   agged_events ),
  75:
  76:           timeseries AS
  77:    (
  78:                    SELECT          series_key         AS customer_id,
  79:                                    tumble_val         AS tumble,
  80:                                    COALESCE(delta, 0) AS def,
  81:                                    delta              AS unfilled
  82:                    FROM            unnest(
  83:                                    (
  84:                                           SELECT gen_ts_candidates(KEY, 21600, min_ts, max_ts)
  85:                                           FROM   args) ) a
  86:                    LEFT OUTER JOIN agged_events b
  87:                    ON              a.series_key = b.customer_id
  88:                    AND             a.tumble_val = b.tumble
  89:                    ORDER BY        customer_id,
  90:                                    tumble_val DESC)
  91:
  92:    SELECT   customer_id,
  93:             tumble                                                                                                           AS datetime,
  94:             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
  95:    FROM     timeseries
  96:    ORDER BY customer_id,
  97:             tumble ASC
  98:  );
  99:    
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 291, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 393, in run
    return self.execute(compiled_node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 249, in execute
    result = MacroGenerator(materialization_macro, context)()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 128, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 41, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model account_timeseries (models/accounts/account_timeseries.sql)
  Syntax error: Expected "(" or keyword SELECT or keyword WITH but got keyword CREATE at [22:5]
  compiled SQL at target/run/freetrade_test/models/accounts/account_timeseries.sql
2021-11-01 03:48:21.124809 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd701e119-eeeb-4db5-b675-0f3d31384f45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128d7d90>]}
2021-11-01 03:48:21.125443 (Thread-3): 03:48:21 | 2 of 2 ERROR creating table model ft_data.account_timeseries......... [ERROR in 1.44s]
2021-11-01 03:48:21.125760 (Thread-3): Finished running node model.freetrade_test.account_timeseries
2021-11-01 03:48:21.127654 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 03:48:21.128179 (MainThread): 03:48:21 | 
2021-11-01 03:48:21.128421 (MainThread): 03:48:21 | Finished running 2 table models in 4.75s.
2021-11-01 03:48:21.128628 (MainThread): Connection 'master' was properly closed.
2021-11-01 03:48:21.128797 (MainThread): Connection 'model.freetrade_test.cashflows' was properly closed.
2021-11-01 03:48:21.128956 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-01 03:48:21.135665 (MainThread): 
2021-11-01 03:48:21.135885 (MainThread): Completed with 1 error and 0 warnings:
2021-11-01 03:48:21.136058 (MainThread): 
2021-11-01 03:48:21.136224 (MainThread): Database Error in model account_timeseries (models/accounts/account_timeseries.sql)
2021-11-01 03:48:21.136377 (MainThread):   Syntax error: Expected "(" or keyword SELECT or keyword WITH but got keyword CREATE at [22:5]
2021-11-01 03:48:21.136519 (MainThread):   compiled SQL at target/run/freetrade_test/models/accounts/account_timeseries.sql
2021-11-01 03:48:21.136672 (MainThread): 
Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
2021-11-01 03:48:21.136922 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1127dcca0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11285ea60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11285ed00>]}
2021-11-01 03:48:21.137190 (MainThread): Flushing usage events
2021-11-01 04:03:57.539187 (MainThread): Running with dbt=0.21.0
2021-11-01 04:03:57.837037 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 04:03:57.838091 (MainThread): Tracking: tracking
2021-11-01 04:03:57.848316 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e0e8d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c147fa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e0d43d0>]}
2021-11-01 04:03:57.859434 (MainThread): Partial parsing not enabled
2021-11-01 04:03:57.871259 (MainThread): Parsing macros/create_udfs.sql
2021-11-01 04:03:57.872422 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-01 04:03:57.872984 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-01 04:03:57.873799 (MainThread): Parsing macros/etc.sql
2021-11-01 04:03:57.876121 (MainThread): Parsing macros/catalog.sql
2021-11-01 04:03:57.882324 (MainThread): Parsing macros/adapters.sql
2021-11-01 04:03:57.904450 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 04:03:57.907086 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 04:03:57.909472 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 04:03:57.918248 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 04:03:57.920621 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 04:03:57.934115 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 04:03:57.935652 (MainThread): Parsing macros/core.sql
2021-11-01 04:03:57.939352 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 04:03:57.946929 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 04:03:57.956616 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 04:03:57.958202 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 04:03:57.974700 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 04:03:58.005938 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 04:03:58.027472 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 04:03:58.029050 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 04:03:58.038452 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 04:03:58.057373 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 04:03:58.070419 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 04:03:58.078278 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 04:03:58.085230 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 04:03:58.088942 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 04:03:58.090295 (MainThread): Parsing macros/etc/query.sql
2021-11-01 04:03:58.091153 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 04:03:58.092500 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 04:03:58.100327 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 04:03:58.102121 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 04:03:58.104484 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 04:03:58.106046 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 04:03:58.158212 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 04:03:58.159744 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 04:03:58.160812 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 04:03:58.162022 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 04:03:58.349066 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 04:03:58.362049 (MainThread): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 04:03:58.371858 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-01 04:03:58.397657 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:03:58.399396 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:03:58.401047 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:03:58.403855 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:03:58.404226 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 04:03:58.404401 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 04:03:58.404580 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 04:03:58.404731 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 04:03:58.413213 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-01 04:03:58.417805 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '68278125-6d20-44e8-812a-514072678249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e1c22b0>]}
2021-11-01 04:03:58.422666 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 04:03:58.423073 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '68278125-6d20-44e8-812a-514072678249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e1668b0>]}
2021-11-01 04:03:58.423488 (MainThread): Found 2 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-01 04:03:58.424925 (MainThread): 
2021-11-01 04:03:58.425303 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 04:03:58.426075 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-01 04:03:58.426235 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 04:03:58.880657 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 04:03:58.881289 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-01 04:03:58.893470 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 04:03:59.154734 (MainThread): 04:03:59 | 
2021-11-01 04:03:59.155280 (MainThread): 04:03:59 | Running 1 on-run-start hook
2021-11-01 04:03:59.155662 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-01 04:03:59.160595 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-01 04:03:59.163595 (MainThread): 04:03:59 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-01 04:03:59.164004 (MainThread): Opening a new connection, currently in state closed
2021-11-01 04:03:59.173183 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds));
$$ LANGUAGE sql
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ));
$$ LANGUAGE sql
;


2021-11-01 04:03:59.174433 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65235), raddr=('142.250.179.234', 443)>
2021-11-01 04:03:59.174682 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65236), raddr=('172.217.16.234', 443)>
2021-11-01 04:03:59.450347 (MainThread): Retry attempt 1 of 1 after error: BadRequest('Syntax error: Illegal input character "$" at [11:1]')
2021-11-01 04:04:00.327854 (MainThread): Database error while running on-run-start
2021-11-01 04:04:00.328618 (MainThread): Connection 'master' was properly closed.
2021-11-01 04:04:00.328890 (MainThread): Connection 'list_ft-data-330317_ft_data' was properly closed.
2021-11-01 04:04:00.329824 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e22ed30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e22eb20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e22eb80>]}
2021-11-01 04:04:00.330349 (MainThread): Flushing usage events
2021-11-01 04:04:00.894650 (MainThread): Encountered an error:
2021-11-01 04:04:00.895058 (MainThread): Database Error
  Syntax error: Illegal input character "$" at [11:1]
2021-11-01 04:04:00.899838 (MainThread): Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Illegal input character "$" at [11:1]

(job ID: 1c0d55b0-3752-4fde-8e5d-d5daa1e464ea)

                                                    -----Query Job SQL Follows-----                                                    

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */
   2:
   3:
   4:create schema if not exists ft_data;
   5:
   6:
   7:    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
   8:     val TIMESTAMP, tumble_seconds INT64)
   9:    AS (
  10:     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds));
  11:$$ LANGUAGE sql
  12:;
  13:
  14:
  15:    CREATE OR REPLACE FUNCTION
  16:     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
  17:    AS ((
  18:     SELECT ARRAY_AGG(x)
  19:     FROM (
  20:       SELECT series_key, tumble_val
  21:       FROM UNNEST(
  22:         GENERATE_TIMESTAMP_ARRAY(
  23:           ft_data.tumble_interval(min_ts, tumble_seconds),
  24:           ft_data.tumble_interval(max_ts, tumble_seconds),
  25:           INTERVAL tumble_seconds SECOND
  26:         )
  27:       ) AS tumble_val
  28:       CROSS JOIN UNNEST(keys) AS series_key
  29:     ) x
  30:    ));
  31:$$ LANGUAGE sql
  32:;
  33:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 127, in main
    results, succeeded = handle_and_check(args)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 205, in handle_and_check
    task, res = run_from_args(parsed)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 258, in run_from_args
    results = task.run()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 452, in run
    result = self.execute_with_hooks(selected_uids)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 410, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 413, in before_run
    self.safe_run_hooks(adapter, RunHookType.Start, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 353, in safe_run_hooks
    self.run_hooks(adapter, hook_type, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 335, in run_hooks
    status, _ = adapter.execute(sql, auto_begin=False,
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error
  Syntax error: Illegal input character "$" at [11:1]

2021-11-01 04:06:10.705367 (MainThread): Running with dbt=0.21.0
2021-11-01 04:06:11.009094 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 04:06:11.010411 (MainThread): Tracking: tracking
2021-11-01 04:06:11.020895 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137fd730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118577c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137e3400>]}
2021-11-01 04:06:11.031869 (MainThread): Partial parsing not enabled
2021-11-01 04:06:11.043632 (MainThread): Parsing macros/create_udfs.sql
2021-11-01 04:06:11.044797 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-01 04:06:11.045330 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-01 04:06:11.046108 (MainThread): Parsing macros/etc.sql
2021-11-01 04:06:11.048414 (MainThread): Parsing macros/catalog.sql
2021-11-01 04:06:11.054787 (MainThread): Parsing macros/adapters.sql
2021-11-01 04:06:11.077028 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 04:06:11.079476 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 04:06:11.081899 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 04:06:11.090945 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 04:06:11.093390 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 04:06:11.106747 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 04:06:11.108345 (MainThread): Parsing macros/core.sql
2021-11-01 04:06:11.112433 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 04:06:11.119319 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 04:06:11.128816 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 04:06:11.130514 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 04:06:11.146864 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 04:06:11.178208 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 04:06:11.199853 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 04:06:11.201467 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 04:06:11.211080 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 04:06:11.229571 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 04:06:11.242548 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 04:06:11.250350 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 04:06:11.257242 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 04:06:11.260803 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 04:06:11.262170 (MainThread): Parsing macros/etc/query.sql
2021-11-01 04:06:11.263042 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 04:06:11.264421 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 04:06:11.272476 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 04:06:11.274098 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 04:06:11.276276 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 04:06:11.277725 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 04:06:11.329615 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 04:06:11.331171 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 04:06:11.332263 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 04:06:11.333492 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 04:06:11.521961 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 04:06:11.534182 (MainThread): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 04:06:11.543732 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-01 04:06:11.569951 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:06:11.571779 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:06:11.573430 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:06:11.576276 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:06:11.576651 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 04:06:11.576828 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 04:06:11.577006 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 04:06:11.577157 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 04:06:11.586254 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-01 04:06:11.590829 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '82ef49da-81f5-4c12-af63-97468510ae46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138f7c10>]}
2021-11-01 04:06:11.595547 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 04:06:11.595918 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '82ef49da-81f5-4c12-af63-97468510ae46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138f74c0>]}
2021-11-01 04:06:11.596375 (MainThread): Found 2 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-01 04:06:11.597802 (MainThread): 
2021-11-01 04:06:11.598218 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 04:06:11.599070 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-01 04:06:11.599372 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 04:06:11.964589 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 04:06:11.965236 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-01 04:06:11.977303 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 04:06:12.236654 (MainThread): 04:06:12 | 
2021-11-01 04:06:12.237208 (MainThread): 04:06:12 | Running 1 on-run-start hook
2021-11-01 04:06:12.237494 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-01 04:06:12.242017 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-01 04:06:12.244678 (MainThread): 04:06:12 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-01 04:06:12.245074 (MainThread): Opening a new connection, currently in state closed
2021-11-01 04:06:12.254026 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds));
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ));
;


2021-11-01 04:06:12.255333 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65244), raddr=('142.250.179.234', 443)>
2021-11-01 04:06:12.255574 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65245), raddr=('172.217.16.234', 443)>
2021-11-01 04:06:12.515893 (MainThread): Retry attempt 1 of 1 after error: BadRequest('Syntax error: Expected end of input but got ";" at [11:1]')
2021-11-01 04:06:13.668873 (MainThread): Database error while running on-run-start
2021-11-01 04:06:13.669853 (MainThread): Connection 'master' was properly closed.
2021-11-01 04:06:13.670199 (MainThread): Connection 'list_ft-data-330317_ft_data' was properly closed.
2021-11-01 04:06:13.670691 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11392a4c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11392a880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11392a7f0>]}
2021-11-01 04:06:13.671247 (MainThread): Flushing usage events
2021-11-01 04:06:14.234521 (MainThread): Encountered an error:
2021-11-01 04:06:14.234923 (MainThread): Database Error
  Syntax error: Expected end of input but got ";" at [11:1]
2021-11-01 04:06:14.239554 (MainThread): Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Expected end of input but got ";" at [11:1]

(job ID: ac8fab41-fceb-4f87-b627-6b8050063489)

                                                    -----Query Job SQL Follows-----                                                    

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */
   2:
   3:
   4:create schema if not exists ft_data;
   5:
   6:
   7:    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
   8:     val TIMESTAMP, tumble_seconds INT64)
   9:    AS (
  10:     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds));
  11:;
  12:
  13:
  14:    CREATE OR REPLACE FUNCTION
  15:     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
  16:    AS ((
  17:     SELECT ARRAY_AGG(x)
  18:     FROM (
  19:       SELECT series_key, tumble_val
  20:       FROM UNNEST(
  21:         GENERATE_TIMESTAMP_ARRAY(
  22:           ft_data.tumble_interval(min_ts, tumble_seconds),
  23:           ft_data.tumble_interval(max_ts, tumble_seconds),
  24:           INTERVAL tumble_seconds SECOND
  25:         )
  26:       ) AS tumble_val
  27:       CROSS JOIN UNNEST(keys) AS series_key
  28:     ) x
  29:    ));
  30:;
  31:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 127, in main
    results, succeeded = handle_and_check(args)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 205, in handle_and_check
    task, res = run_from_args(parsed)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 258, in run_from_args
    results = task.run()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 452, in run
    result = self.execute_with_hooks(selected_uids)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 410, in execute_with_hooks
    self.before_run(adapter, selected_uids)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 413, in before_run
    self.safe_run_hooks(adapter, RunHookType.Start, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 353, in safe_run_hooks
    self.run_hooks(adapter, hook_type, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 335, in run_hooks
    status, _ = adapter.execute(sql, auto_begin=False,
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error
  Syntax error: Expected end of input but got ";" at [11:1]

2021-11-01 04:07:06.154884 (MainThread): Running with dbt=0.21.0
2021-11-01 04:07:06.454098 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 04:07:06.455283 (MainThread): Tracking: tracking
2021-11-01 04:07:06.465720 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10373d430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1056e7400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1056e78b0>]}
2021-11-01 04:07:06.477035 (MainThread): Partial parsing not enabled
2021-11-01 04:07:06.488976 (MainThread): Parsing macros/create_udfs.sql
2021-11-01 04:07:06.490092 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-01 04:07:06.490632 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-01 04:07:06.491402 (MainThread): Parsing macros/etc.sql
2021-11-01 04:07:06.493818 (MainThread): Parsing macros/catalog.sql
2021-11-01 04:07:06.500200 (MainThread): Parsing macros/adapters.sql
2021-11-01 04:07:06.522527 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 04:07:06.524973 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 04:07:06.527402 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 04:07:06.536411 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 04:07:06.539016 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 04:07:06.552707 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 04:07:06.554343 (MainThread): Parsing macros/core.sql
2021-11-01 04:07:06.558160 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 04:07:06.565346 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 04:07:06.575214 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 04:07:06.576854 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 04:07:06.593725 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 04:07:06.625415 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 04:07:06.646946 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 04:07:06.648524 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 04:07:06.658133 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 04:07:06.676696 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 04:07:06.689821 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 04:07:06.697815 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 04:07:06.705157 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 04:07:06.709079 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 04:07:06.710638 (MainThread): Parsing macros/etc/query.sql
2021-11-01 04:07:06.711612 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 04:07:06.713049 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 04:07:06.722002 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 04:07:06.723897 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 04:07:06.726193 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 04:07:06.727668 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 04:07:06.780176 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 04:07:06.781694 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 04:07:06.782780 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 04:07:06.784080 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 04:07:06.974909 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 04:07:06.987562 (MainThread): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 04:07:06.997292 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-01 04:07:07.022837 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:07:07.024593 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:07:07.026251 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:07:07.029155 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:07:07.029539 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 04:07:07.029719 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 04:07:07.029902 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 04:07:07.030055 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 04:07:07.039048 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-01 04:07:07.043437 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e4b720c8-c757-4db0-a6b4-fc56dd751df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10577e220>]}
2021-11-01 04:07:07.048130 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 04:07:07.048504 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e4b720c8-c757-4db0-a6b4-fc56dd751df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057cbd30>]}
2021-11-01 04:07:07.048798 (MainThread): Found 2 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-01 04:07:07.050275 (MainThread): 
2021-11-01 04:07:07.050697 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 04:07:07.051644 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-01 04:07:07.051847 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 04:07:07.432776 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 04:07:07.433421 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-01 04:07:07.445524 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 04:07:07.705942 (MainThread): 04:07:07 | 
2021-11-01 04:07:07.706464 (MainThread): 04:07:07 | Running 1 on-run-start hook
2021-11-01 04:07:07.706840 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-01 04:07:07.711703 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-01 04:07:07.714363 (MainThread): 04:07:07 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-01 04:07:07.714773 (MainThread): Opening a new connection, currently in state closed
2021-11-01 04:07:07.724206 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-01 04:07:07.725471 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65252), raddr=('142.250.179.234', 443)>
2021-11-01 04:07:07.725712 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65253), raddr=('172.217.16.234', 443)>
2021-11-01 04:07:12.002524 (MainThread): 04:07:12 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 4.29s]
2021-11-01 04:07:12.003099 (MainThread): 04:07:12 | 
2021-11-01 04:07:12.003787 (MainThread): 04:07:12 | Concurrency: 4 threads (target='dev')
2021-11-01 04:07:12.004077 (MainThread): 04:07:12 | 
2021-11-01 04:07:12.007466 (Thread-1): Began running node model.freetrade_test.cashflows
2021-11-01 04:07:12.012900 (Thread-1): 04:07:12 | 1 of 2 START table model ft_data.cashflows........................... [RUN]
2021-11-01 04:07:12.013446 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 04:07:12.013701 (Thread-1): Compiling model.freetrade_test.cashflows
2021-11-01 04:07:12.017064 (Thread-1): Writing injected SQL for node "model.freetrade_test.cashflows"
2021-11-01 04:07:12.017609 (Thread-1): finished collecting timing info
2021-11-01 04:07:12.038176 (Thread-1): Opening a new connection, currently in state closed
2021-11-01 04:07:12.044216 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 04:07:12.322779 (Thread-1): Writing runtime SQL for node "model.freetrade_test.cashflows"
2021-11-01 04:07:12.323447 (Thread-1): On model.freetrade_test.cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-01 04:07:14.513169 (Thread-1): finished collecting timing info
2021-11-01 04:07:14.513884 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e4b720c8-c757-4db0-a6b4-fc56dd751df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058167f0>]}
2021-11-01 04:07:14.516013 (Thread-1): 04:07:14 | 1 of 2 OK created table model ft_data.cashflows...................... [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.50s]
2021-11-01 04:07:14.516415 (Thread-1): Finished running node model.freetrade_test.cashflows
2021-11-01 04:07:14.517172 (Thread-3): Began running node model.freetrade_test.account_timeseries
2021-11-01 04:07:14.517573 (Thread-3): 04:07:14 | 2 of 2 START table model ft_data.account_timeseries.................. [RUN]
2021-11-01 04:07:14.518106 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 04:07:14.518336 (Thread-3): Compiling model.freetrade_test.account_timeseries
2021-11-01 04:07:14.522991 (Thread-3): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-01 04:07:14.523663 (Thread-3): finished collecting timing info
2021-11-01 04:07:14.526358 (Thread-3): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-01 04:07:14.526881 (Thread-3): Opening a new connection, currently in state init
2021-11-01 04:07:14.533498 (Thread-3): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-01 04:07:19.014486 (Thread-3): finished collecting timing info
2021-11-01 04:07:19.015570 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e4b720c8-c757-4db0-a6b4-fc56dd751df7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059daf40>]}
2021-11-01 04:07:19.016266 (Thread-3): 04:07:19 | 2 of 2 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.50s]
2021-11-01 04:07:19.016570 (Thread-3): Finished running node model.freetrade_test.account_timeseries
2021-11-01 04:07:19.018529 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 04:07:19.019147 (MainThread): 04:07:19 | 
2021-11-01 04:07:19.019432 (MainThread): 04:07:19 | Finished running 2 table models, 1 hook in 11.97s.
2021-11-01 04:07:19.019679 (MainThread): Connection 'master' was properly closed.
2021-11-01 04:07:19.019876 (MainThread): Connection 'model.freetrade_test.cashflows' was properly closed.
2021-11-01 04:07:19.020062 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-01 04:07:19.027789 (MainThread): 
2021-11-01 04:07:19.028070 (MainThread): Completed successfully
2021-11-01 04:07:19.028302 (MainThread): 
Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
2021-11-01 04:07:19.028617 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059ebe50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059eb640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059ebaf0>]}
2021-11-01 04:07:19.028880 (MainThread): Flushing usage events
2021-11-01 04:10:24.047666 (MainThread): Running with dbt=0.21.0
2021-11-01 04:10:24.596600 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 04:10:24.598431 (MainThread): Tracking: tracking
2021-11-01 04:10:24.617393 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a45dc40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084b4a60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a444970>]}
2021-11-01 04:10:24.638002 (MainThread): Partial parsing not enabled
2021-11-01 04:10:24.661260 (MainThread): Parsing macros/create_udfs.sql
2021-11-01 04:10:24.663226 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-01 04:10:24.664261 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-01 04:10:24.665783 (MainThread): Parsing macros/etc.sql
2021-11-01 04:10:24.670308 (MainThread): Parsing macros/catalog.sql
2021-11-01 04:10:24.682172 (MainThread): Parsing macros/adapters.sql
2021-11-01 04:10:24.727375 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 04:10:24.732442 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 04:10:24.737358 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 04:10:24.755442 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 04:10:24.760566 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 04:10:24.787935 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 04:10:24.791160 (MainThread): Parsing macros/core.sql
2021-11-01 04:10:24.798078 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 04:10:24.810618 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 04:10:24.829367 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 04:10:24.832469 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 04:10:24.865019 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 04:10:24.927660 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 04:10:24.971233 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 04:10:24.974476 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 04:10:24.993862 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 04:10:25.031985 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 04:10:25.058486 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 04:10:25.073795 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 04:10:25.088748 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 04:10:25.096856 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 04:10:25.100158 (MainThread): Parsing macros/etc/query.sql
2021-11-01 04:10:25.102108 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 04:10:25.105074 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 04:10:25.121281 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 04:10:25.124600 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 04:10:25.129119 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 04:10:25.132082 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 04:10:25.238237 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 04:10:25.241524 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 04:10:25.243792 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 04:10:25.246319 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 04:10:25.634532 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 04:10:25.658861 (MainThread): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 04:10:25.677914 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-01 04:10:25.729298 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:10:25.732802 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:10:25.736211 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:10:25.741800 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:10:25.742530 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 04:10:25.742850 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 04:10:25.743098 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 04:10:25.743329 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 04:10:25.760429 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-01 04:10:25.768916 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '47285630-670e-4fd8-8a51-32e340304863', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a55c880>]}
2021-11-01 04:10:25.778654 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 04:10:25.779497 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '47285630-670e-4fd8-8a51-32e340304863', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a55cfa0>]}
2021-11-01 04:10:25.779947 (MainThread): Found 2 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-01 04:10:25.782212 (MainThread): 
2021-11-01 04:10:25.782900 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 04:10:25.784301 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-01 04:10:25.784753 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 04:10:26.272335 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 04:10:26.272954 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-01 04:10:26.284831 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 04:10:26.575160 (MainThread): 04:10:26 | 
2021-11-01 04:10:26.575647 (MainThread): 04:10:26 | Running 1 on-run-start hook
2021-11-01 04:10:26.575999 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-01 04:10:26.580769 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-01 04:10:26.583498 (MainThread): 04:10:26 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-01 04:10:26.583917 (MainThread): Opening a new connection, currently in state closed
2021-11-01 04:10:26.594057 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-01 04:10:26.597587 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65273), raddr=('172.217.169.74', 443)>
2021-11-01 04:10:26.597915 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65274), raddr=('172.217.16.234', 443)>
2021-11-01 04:10:29.847906 (MainThread): 04:10:29 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 3.26s]
2021-11-01 04:10:29.848509 (MainThread): 04:10:29 | 
2021-11-01 04:10:29.849397 (MainThread): 04:10:29 | Concurrency: 4 threads (target='dev')
2021-11-01 04:10:29.849687 (MainThread): 04:10:29 | 
2021-11-01 04:10:29.858404 (Thread-1): Began running node model.freetrade_test.cashflows
2021-11-01 04:10:29.858923 (Thread-1): 04:10:29 | 1 of 2 START table model ft_data.cashflows........................... [RUN]
2021-11-01 04:10:29.859520 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 04:10:29.859783 (Thread-1): Compiling model.freetrade_test.cashflows
2021-11-01 04:10:29.863679 (Thread-1): Writing injected SQL for node "model.freetrade_test.cashflows"
2021-11-01 04:10:29.864356 (Thread-1): finished collecting timing info
2021-11-01 04:10:29.931505 (Thread-1): Writing runtime SQL for node "model.freetrade_test.cashflows"
2021-11-01 04:10:29.932388 (Thread-1): Opening a new connection, currently in state closed
2021-11-01 04:10:29.942308 (Thread-1): On model.freetrade_test.cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-01 04:10:32.473277 (Thread-1): finished collecting timing info
2021-11-01 04:10:32.474013 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '47285630-670e-4fd8-8a51-32e340304863', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a53cd90>]}
2021-11-01 04:10:32.474582 (Thread-1): 04:10:32 | 1 of 2 OK created table model ft_data.cashflows...................... [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.61s]
2021-11-01 04:10:32.474869 (Thread-1): Finished running node model.freetrade_test.cashflows
2021-11-01 04:10:32.475728 (Thread-3): Began running node model.freetrade_test.account_timeseries
2021-11-01 04:10:32.476311 (Thread-3): 04:10:32 | 2 of 2 START table model ft_data.account_timeseries.................. [RUN]
2021-11-01 04:10:32.476994 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 04:10:32.477267 (Thread-3): Compiling model.freetrade_test.account_timeseries
2021-11-01 04:10:32.482682 (Thread-3): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-01 04:10:32.483601 (Thread-3): finished collecting timing info
2021-11-01 04:10:32.486351 (Thread-3): Opening a new connection, currently in state init
2021-11-01 04:10:32.496695 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 04:10:32.754323 (Thread-3): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-01 04:10:32.755219 (Thread-3): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-01 04:10:37.413095 (Thread-3): finished collecting timing info
2021-11-01 04:10:37.414234 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '47285630-670e-4fd8-8a51-32e340304863', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a53cd90>]}
2021-11-01 04:10:37.415094 (Thread-3): 04:10:37 | 2 of 2 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.94s]
2021-11-01 04:10:37.415530 (Thread-3): Finished running node model.freetrade_test.account_timeseries
2021-11-01 04:10:37.417771 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 04:10:37.418405 (MainThread): 04:10:37 | 
2021-11-01 04:10:37.418700 (MainThread): 04:10:37 | Finished running 2 table models, 1 hook in 11.64s.
2021-11-01 04:10:37.418954 (MainThread): Connection 'master' was properly closed.
2021-11-01 04:10:37.419158 (MainThread): Connection 'model.freetrade_test.cashflows' was properly closed.
2021-11-01 04:10:37.419354 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-01 04:10:37.427869 (MainThread): 
2021-11-01 04:10:37.428207 (MainThread): Completed successfully
2021-11-01 04:10:37.428462 (MainThread): 
Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
2021-11-01 04:10:37.428814 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a495910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4951f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a495be0>]}
2021-11-01 04:10:37.429188 (MainThread): Flushing usage events
2021-11-01 04:12:56.802579 (MainThread): Running with dbt=0.21.0
2021-11-01 04:12:57.356380 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, compile=True, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, cls=<class 'dbt.task.generate.GenerateTask'>, which='generate', rpc_method='docs.generate')
2021-11-01 04:12:57.358056 (MainThread): Tracking: tracking
2021-11-01 04:12:57.375264 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083cb8e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10631d940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083b3040>]}
2021-11-01 04:12:57.396005 (MainThread): Partial parsing not enabled
2021-11-01 04:12:57.419160 (MainThread): Parsing macros/create_udfs.sql
2021-11-01 04:12:57.421090 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-01 04:12:57.422084 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-01 04:12:57.423586 (MainThread): Parsing macros/etc.sql
2021-11-01 04:12:57.428129 (MainThread): Parsing macros/catalog.sql
2021-11-01 04:12:57.440036 (MainThread): Parsing macros/adapters.sql
2021-11-01 04:12:57.485553 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 04:12:57.490513 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 04:12:57.495531 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 04:12:57.513546 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 04:12:57.518505 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 04:12:57.545773 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 04:12:57.548895 (MainThread): Parsing macros/core.sql
2021-11-01 04:12:57.555770 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 04:12:57.568398 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 04:12:57.587162 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 04:12:57.590260 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 04:12:57.622809 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 04:12:57.685531 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 04:12:57.729093 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 04:12:57.732360 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 04:12:57.751632 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 04:12:57.789437 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 04:12:57.815856 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 04:12:57.831112 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 04:12:57.844886 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 04:12:57.852076 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 04:12:57.854838 (MainThread): Parsing macros/etc/query.sql
2021-11-01 04:12:57.856612 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 04:12:57.859406 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 04:12:57.875490 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 04:12:57.878823 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 04:12:57.883382 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 04:12:57.886349 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 04:12:57.992715 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 04:12:57.995858 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 04:12:57.998079 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 04:12:58.000591 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 04:12:58.384958 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 04:12:58.409139 (MainThread): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 04:12:58.428015 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-01 04:12:58.479314 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:12:58.482798 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:12:58.486185 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:12:58.491764 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 04:12:58.492481 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 04:12:58.492791 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 04:12:58.493051 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 04:12:58.493286 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 04:12:58.510318 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-01 04:12:58.518798 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3a3f4e56-1f31-4947-a2f0-e2aae41ce127', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10849c2e0>]}
2021-11-01 04:12:58.527930 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 04:12:58.529096 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3a3f4e56-1f31-4947-a2f0-e2aae41ce127', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10849cb50>]}
2021-11-01 04:12:58.529764 (MainThread): Found 2 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-01 04:12:58.532285 (MainThread): 
2021-11-01 04:12:58.532959 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 04:12:58.534563 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 04:12:58.535045 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 04:12:58.546542 (ThreadPoolExecutor-0_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 04:12:58.834845 (MainThread): 04:12:58 | Concurrency: 4 threads (target='dev')
2021-11-01 04:12:58.835282 (MainThread): 04:12:58 | 
2021-11-01 04:12:58.839048 (Thread-1): Began running node model.freetrade_test.cashflows
2021-11-01 04:12:58.839746 (Thread-2): Began running node operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-01 04:12:58.840407 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.cashflows".
2021-11-01 04:12:58.841051 (Thread-2): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-01 04:12:58.841406 (Thread-1): Compiling model.freetrade_test.cashflows
2021-11-01 04:12:58.841687 (Thread-2): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-01 04:12:58.844727 (Thread-1): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65302), raddr=('172.217.169.74', 443)>
2021-11-01 04:12:58.848343 (Thread-2): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-01 04:12:58.848806 (Thread-1): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('10.32.5.34', 65303), raddr=('172.217.16.234', 443)>
2021-11-01 04:12:58.851187 (Thread-1): Writing injected SQL for node "model.freetrade_test.cashflows"
2021-11-01 04:12:58.851826 (Thread-2): finished collecting timing info
2021-11-01 04:12:58.852182 (Thread-2): finished collecting timing info
2021-11-01 04:12:58.852741 (Thread-2): Finished running node operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-01 04:12:58.853128 (Thread-1): finished collecting timing info
2021-11-01 04:12:58.853391 (Thread-1): finished collecting timing info
2021-11-01 04:12:58.853875 (Thread-1): Finished running node model.freetrade_test.cashflows
2021-11-01 04:12:58.854602 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-01 04:12:58.855128 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 04:12:58.855371 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-01 04:12:58.865514 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-01 04:12:58.866362 (Thread-4): finished collecting timing info
2021-11-01 04:12:58.866675 (Thread-4): finished collecting timing info
2021-11-01 04:12:58.867229 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-01 04:12:58.868727 (MainThread): Connection 'master' was properly closed.
2021-11-01 04:12:58.868964 (MainThread): Connection 'model.freetrade_test.cashflows' was properly closed.
2021-11-01 04:12:58.869152 (MainThread): Connection 'operation.freetrade_test.freetrade_test-on-run-start-0' was properly closed.
2021-11-01 04:12:58.869329 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-01 04:12:58.877922 (MainThread): 04:12:58 | Done.
2021-11-01 04:12:58.883545 (MainThread): Acquiring new bigquery connection "generate_catalog".
2021-11-01 04:12:58.883849 (MainThread): 04:12:58 | Building catalog
2021-11-01 04:12:58.885103 (MainThread): Opening a new connection, currently in state init
2021-11-01 04:12:59.237353 (MainThread): Skipping catalog for ft-data-330317.ft_data_dbt_test__audit - schema does not exist
2021-11-01 04:12:59.238539 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "ft-data-330317.information_schema".
2021-11-01 04:12:59.263974 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state init
2021-11-01 04:12:59.273974 (ThreadPoolExecutor-1_0): On ft-data-330317.information_schema: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "ft-data-330317.information_schema"} */

    with tables as (
        select
            project_id as table_database,
            dataset_id as table_schema,
            table_id as original_table_name,

            concat(project_id, '.', dataset_id, '.', table_id) as relation_id,

            row_count,
            size_bytes as size_bytes,
            case
                when type = 1 then 'table'
                when type = 2 then 'view'
                else 'external'
            end as table_type,

            REGEXP_CONTAINS(table_id, '^.+[0-9]{8}$') and coalesce(type, 0) = 1 as is_date_shard,
            REGEXP_EXTRACT(table_id, '^(.+)[0-9]{8}$') as shard_base_name,
            REGEXP_EXTRACT(table_id, '^.+([0-9]{8})$') as shard_name

        from `ft-data-330317`.`ft_data`.__TABLES__
        where (upper(dataset_id) = upper('ft_data'))
    ),

    extracted as (

        select *,
            case
                when is_date_shard then shard_base_name
                else original_table_name
            end as table_name

        from tables

    ),

    unsharded_tables as (

        select
            table_database,
            table_schema,
            table_name,
            coalesce(table_type, 'external') as table_type,
            is_date_shard,

            struct(
                min(shard_name) as shard_min,
                max(shard_name) as shard_max,
                count(*) as shard_count
            ) as table_shards,

            sum(size_bytes) as size_bytes,
            sum(row_count) as row_count,

            max(relation_id) as relation_id

        from extracted
        group by 1,2,3,4,5

    ),

    info_schema_columns as (

        select
            concat(table_catalog, '.', table_schema, '.', table_name) as relation_id,
            table_catalog as table_database,
            table_schema,
            table_name,

            -- use the "real" column name from the paths query below
            column_name as base_column_name,
            ordinal_position as column_index,

            is_partitioning_column,
            clustering_ordinal_position

        from `ft-data-330317`.`ft_data`.INFORMATION_SCHEMA.COLUMNS
        where ordinal_position is not null

    ),

    info_schema_column_paths as (

        select
            concat(table_catalog, '.', table_schema, '.', table_name) as relation_id,
            field_path as column_name,
            data_type as column_type,
            column_name as base_column_name,
            description as column_comment

        from `ft-data-330317`.`ft_data`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS

    ),

    columns as (

        select * except (base_column_name)
        from info_schema_columns
        join info_schema_column_paths using (relation_id, base_column_name)

    ),

    column_stats as (

        select
            table_database,
            table_schema,
            table_name,
            max(relation_id) as relation_id,
            max(case when is_partitioning_column = 'YES' then 1 else 0 end) = 1 as is_partitioned,
            max(case when is_partitioning_column = 'YES' then column_name else null end) as partition_column,
            max(case when clustering_ordinal_position is not null then 1 else 0 end) = 1 as is_clustered,
            array_to_string(
                array_agg(
                    case
                        when clustering_ordinal_position is not null then column_name
                        else null
                    end ignore nulls
                    order by clustering_ordinal_position
                ), ', '
            ) as clustering_columns

        from columns
        group by 1,2,3

    )

    select
        unsharded_tables.table_database,
        unsharded_tables.table_schema,
        case
            when is_date_shard then concat(unsharded_tables.table_name, '*')
            else unsharded_tables.table_name
        end as table_name,
        unsharded_tables.table_type,

        -- coalesce name and type for External tables - these columns are not
        -- present in the COLUMN_FIELD_PATHS resultset
        coalesce(columns.column_name, '<unknown>') as column_name,
        -- invent a row number to account for nested fields -- BQ does
        -- not treat these nested properties as independent fields
        row_number() over (
            partition by relation_id
            order by columns.column_index, columns.column_name
        ) as column_index,
        coalesce(columns.column_type, '<unknown>') as column_type,
        columns.column_comment,

        'Shard count' as `stats__date_shards__label`,
        table_shards.shard_count as `stats__date_shards__value`,
        'The number of date shards in this table' as `stats__date_shards__description`,
        is_date_shard as `stats__date_shards__include`,

        'Shard (min)' as `stats__date_shard_min__label`,
        table_shards.shard_min as `stats__date_shard_min__value`,
        'The first date shard in this table' as `stats__date_shard_min__description`,
        is_date_shard as `stats__date_shard_min__include`,

        'Shard (max)' as `stats__date_shard_max__label`,
        table_shards.shard_max as `stats__date_shard_max__value`,
        'The last date shard in this table' as `stats__date_shard_max__description`,
        is_date_shard as `stats__date_shard_max__include`,

        '# Rows' as `stats__num_rows__label`,
        row_count as `stats__num_rows__value`,
        'Approximate count of rows in this table' as `stats__num_rows__description`,
        (unsharded_tables.table_type = 'table') as `stats__num_rows__include`,

        'Approximate Size' as `stats__num_bytes__label`,
        size_bytes as `stats__num_bytes__value`,
        'Approximate size of table as reported by BigQuery' as `stats__num_bytes__description`,
        (unsharded_tables.table_type = 'table') as `stats__num_bytes__include`,

        'Partitioned By' as `stats__partitioning_type__label`,
        partition_column as `stats__partitioning_type__value`,
        'The partitioning column for this table' as `stats__partitioning_type__description`,
        is_partitioned as `stats__partitioning_type__include`,

        'Clustered By' as `stats__clustering_fields__label`,
        clustering_columns as `stats__clustering_fields__value`,
        'The clustering columns for this table' as `stats__clustering_fields__description`,
        is_clustered as `stats__clustering_fields__include`

    -- join using relation_id (an actual relation, not a shard prefix) to make
    -- sure that column metadata is picked up through the join. This will only
    -- return the column information for the "max" table in a date-sharded table set
    from unsharded_tables
    left join columns using (relation_id)
    left join column_stats using (relation_id)
  
2021-11-01 04:13:01.977977 (MainThread): 04:13:01 | Catalog written to /Users/stephenkyriacou/Projects/freetrade_dbt/ft_dbt/ft_dbt/target/catalog.json
2021-11-01 04:13:01.978444 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083cb8e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086267c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108626b20>]}
2021-11-01 04:13:01.978817 (MainThread): Flushing usage events
2021-11-01 04:13:02.572881 (MainThread): Connection 'generate_catalog' was properly closed.
2021-11-01 04:13:02.573223 (MainThread): Connection 'ft-data-330317.information_schema' was properly closed.
2021-11-01 05:29:34.860369 (MainThread): Running with dbt=0.21.0
2021-11-01 05:29:35.334858 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 05:29:35.336796 (MainThread): Tracking: tracking
2021-11-01 05:29:35.348322 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1145dab20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1126309d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1145c2400>]}
2021-11-01 05:29:35.359301 (MainThread): Partial parsing not enabled
2021-11-01 05:29:35.374620 (MainThread): Parsing macros/create_udfs.sql
2021-11-01 05:29:35.375762 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-01 05:29:35.376341 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-01 05:29:35.377135 (MainThread): Parsing macros/etc.sql
2021-11-01 05:29:35.379574 (MainThread): Parsing macros/catalog.sql
2021-11-01 05:29:35.385826 (MainThread): Parsing macros/adapters.sql
2021-11-01 05:29:35.408091 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 05:29:35.410521 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 05:29:35.412968 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 05:29:35.422371 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 05:29:35.424865 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 05:29:35.439476 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 05:29:35.441178 (MainThread): Parsing macros/core.sql
2021-11-01 05:29:35.444666 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 05:29:35.451084 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 05:29:35.460682 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 05:29:35.462358 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 05:29:35.478846 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 05:29:35.511264 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 05:29:35.533379 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 05:29:35.535015 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 05:29:35.544910 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 05:29:35.564190 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 05:29:35.577823 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 05:29:35.585852 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 05:29:35.592961 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 05:29:35.596622 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 05:29:35.598068 (MainThread): Parsing macros/etc/query.sql
2021-11-01 05:29:35.598949 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 05:29:35.600335 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 05:29:35.608666 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 05:29:35.610647 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 05:29:35.612956 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 05:29:35.614420 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 05:29:35.668730 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 05:29:35.670330 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 05:29:35.671433 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 05:29:35.672668 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 05:29:35.866927 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 05:29:35.879530 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-01 05:29:35.889525 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-01 05:29:35.916589 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 05:29:35.918392 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 05:29:35.920067 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 05:29:35.923121 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 05:29:35.923606 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1147a1130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11477dac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11477dd60>]}
2021-11-01 05:29:35.923822 (MainThread): Flushing usage events
2021-11-01 05:29:37.512889 (MainThread): Connection 'operation.freetrade_test.freetrade_test-on-run-start-0' was properly closed.
2021-11-01 05:29:37.513326 (MainThread): Encountered an error:
2021-11-01 05:29:37.513637 (MainThread): Compilation Error in model account_timeseries (models/accounts/account_timeseries.sql)
  Model 'model.freetrade_test.account_timeseries' (models/accounts/account_timeseries.sql) depends on a node named 'cashflows' which was not found
2021-11-01 05:29:37.518322 (MainThread): Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 127, in main
    results, succeeded = handle_and_check(args)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 205, in handle_and_check
    task, res = run_from_args(parsed)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 258, in run_from_args
    results = task.run()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 433, in run
    self._runtime_initialize()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 149, in _runtime_initialize
    super()._runtime_initialize()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 87, in _runtime_initialize
    self.load_manifest()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 74, in load_manifest
    self.manifest = ManifestLoader.get_full_manifest(self.config)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/parser/manifest.py", line 182, in get_full_manifest
    manifest = loader.load()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/parser/manifest.py", line 355, in load
    self.process_refs(self.root_project.project_name)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/parser/manifest.py", line 715, in process_refs
    _process_refs_for_node(self.manifest, current_project, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/parser/manifest.py", line 1026, in _process_refs_for_node
    invalid_ref_fail_unless_test(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/parser/manifest.py", line 799, in invalid_ref_fail_unless_test
    ref_target_not_found(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/exceptions.py", line 575, in ref_target_not_found
    raise_compiler_error(msg, model)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/exceptions.py", line 444, in raise_compiler_error
    raise CompilationException(msg, node)
dbt.exceptions.CompilationException: Compilation Error in model account_timeseries (models/accounts/account_timeseries.sql)
  Model 'model.freetrade_test.account_timeseries' (models/accounts/account_timeseries.sql) depends on a node named 'cashflows' which was not found

2021-11-01 05:29:58.045888 (MainThread): Running with dbt=0.21.0
2021-11-01 05:29:58.342348 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 05:29:58.343322 (MainThread): Tracking: tracking
2021-11-01 05:29:58.354318 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114a89280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129d4be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114a703d0>]}
2021-11-01 05:29:58.365802 (MainThread): Partial parsing not enabled
2021-11-01 05:29:58.377756 (MainThread): Parsing macros/create_udfs.sql
2021-11-01 05:29:58.378955 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-01 05:29:58.379496 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-01 05:29:58.380261 (MainThread): Parsing macros/etc.sql
2021-11-01 05:29:58.382567 (MainThread): Parsing macros/catalog.sql
2021-11-01 05:29:58.388830 (MainThread): Parsing macros/adapters.sql
2021-11-01 05:29:58.410919 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 05:29:58.413371 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 05:29:58.415747 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 05:29:58.424637 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 05:29:58.427080 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 05:29:58.440584 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 05:29:58.442190 (MainThread): Parsing macros/core.sql
2021-11-01 05:29:58.445999 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 05:29:58.452591 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 05:29:58.462115 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 05:29:58.464497 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 05:29:58.481533 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 05:29:58.513118 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 05:29:58.534577 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 05:29:58.536194 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 05:29:58.545645 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 05:29:58.564804 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 05:29:58.578182 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 05:29:58.586104 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 05:29:58.592825 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 05:29:58.596702 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 05:29:58.598124 (MainThread): Parsing macros/etc/query.sql
2021-11-01 05:29:58.599000 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 05:29:58.600394 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 05:29:58.608260 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 05:29:58.609899 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 05:29:58.612160 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 05:29:58.613631 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 05:29:58.667476 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 05:29:58.669035 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 05:29:58.670125 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 05:29:58.671347 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 05:29:58.863586 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 05:29:58.875658 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-01 05:29:58.886264 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-01 05:29:58.912063 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 05:29:58.913811 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 05:29:58.915455 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 05:29:58.918252 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 05:29:58.918623 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 05:29:58.918794 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/accounts/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 05:29:58.918971 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 05:29:58.919120 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/accounts/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 05:29:58.929191 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-01 05:29:58.934296 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a513b8b2-de58-4c98-87ea-87b34a26eefb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114b64190>]}
2021-11-01 05:29:58.939261 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 05:29:58.939774 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a513b8b2-de58-4c98-87ea-87b34a26eefb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114b3e7f0>]}
2021-11-01 05:29:58.940101 (MainThread): Found 2 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-01 05:29:58.941364 (MainThread): 
2021-11-01 05:29:58.941749 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 05:29:58.942573 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-01 05:29:58.942769 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 05:30:00.509607 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 05:30:00.510240 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-01 05:30:00.522539 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 05:30:01.211481 (MainThread): 05:30:01 | 
2021-11-01 05:30:01.212025 (MainThread): 05:30:01 | Running 1 on-run-start hook
2021-11-01 05:30:01.212429 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-01 05:30:01.217428 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-01 05:30:01.220085 (MainThread): 05:30:01 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-01 05:30:01.220485 (MainThread): Opening a new connection, currently in state closed
2021-11-01 05:30:01.231384 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-01 05:30:01.235970 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.3.167', 49219), raddr=('142.250.187.202', 443)>
2021-11-01 05:30:01.236487 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.3.167', 49220), raddr=('142.250.200.42', 443)>
2021-11-01 05:30:05.768051 (MainThread): 05:30:05 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 4.55s]
2021-11-01 05:30:05.768530 (MainThread): 05:30:05 | 
2021-11-01 05:30:05.769431 (MainThread): 05:30:05 | Concurrency: 4 threads (target='dev')
2021-11-01 05:30:05.770077 (MainThread): 05:30:05 | 
2021-11-01 05:30:05.773740 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-01 05:30:05.774376 (Thread-1): 05:30:05 | 1 of 2 START table model ft_data.account_cashflows................... [RUN]
2021-11-01 05:30:05.775343 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-01 05:30:05.775743 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-01 05:30:05.783792 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-01 05:30:05.784465 (Thread-1): finished collecting timing info
2021-11-01 05:30:05.830061 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-01 05:30:05.830697 (Thread-1): Opening a new connection, currently in state closed
2021-11-01 05:30:05.836416 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-01 05:30:08.705485 (Thread-1): finished collecting timing info
2021-11-01 05:30:08.706170 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a513b8b2-de58-4c98-87ea-87b34a26eefb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114d6a160>]}
2021-11-01 05:30:08.706685 (Thread-1): 05:30:08 | 1 of 2 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.93s]
2021-11-01 05:30:08.706941 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-01 05:30:08.707581 (Thread-3): Began running node model.freetrade_test.account_timeseries
2021-11-01 05:30:08.707962 (Thread-3): 05:30:08 | 2 of 2 START table model ft_data.account_timeseries.................. [RUN]
2021-11-01 05:30:08.708655 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 05:30:08.708911 (Thread-3): Compiling model.freetrade_test.account_timeseries
2021-11-01 05:30:08.713353 (Thread-3): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-01 05:30:08.713912 (Thread-3): finished collecting timing info
2021-11-01 05:30:08.715780 (Thread-3): Opening a new connection, currently in state init
2021-11-01 05:30:08.722561 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 05:30:09.728634 (Thread-3): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-01 05:30:09.730764 (Thread-3): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-01 05:30:15.276856 (Thread-3): finished collecting timing info
2021-11-01 05:30:15.277926 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a513b8b2-de58-4c98-87ea-87b34a26eefb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114b2bd60>]}
2021-11-01 05:30:15.278683 (Thread-3): 05:30:15 | 2 of 2 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 6.57s]
2021-11-01 05:30:15.278984 (Thread-3): Finished running node model.freetrade_test.account_timeseries
2021-11-01 05:30:15.280852 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 05:30:15.281476 (MainThread): 05:30:15 | 
2021-11-01 05:30:15.281766 (MainThread): 05:30:15 | Finished running 2 table models, 1 hook in 16.34s.
2021-11-01 05:30:15.282013 (MainThread): Connection 'master' was properly closed.
2021-11-01 05:30:15.282211 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-01 05:30:15.282395 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-01 05:30:15.290007 (MainThread): 
2021-11-01 05:30:15.290299 (MainThread): Completed successfully
2021-11-01 05:30:15.290534 (MainThread): 
Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
2021-11-01 05:30:15.290857 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114b73700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114b25430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114afe2b0>]}
2021-11-01 05:30:15.291171 (MainThread): Flushing usage events
2021-11-01 23:36:20.699148 (MainThread): Running with dbt=0.21.0
2021-11-01 23:36:21.165471 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-01 23:36:21.166454 (MainThread): Tracking: tracking
2021-11-01 23:36:21.179748 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9e50d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba3c760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9ce3d0>]}
2021-11-01 23:36:21.191082 (MainThread): Partial parsing not enabled
2021-11-01 23:36:21.204852 (MainThread): Parsing macros/create_udfs.sql
2021-11-01 23:36:21.206023 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-01 23:36:21.206553 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-01 23:36:21.207390 (MainThread): Parsing macros/etc.sql
2021-11-01 23:36:21.209838 (MainThread): Parsing macros/catalog.sql
2021-11-01 23:36:21.216195 (MainThread): Parsing macros/adapters.sql
2021-11-01 23:36:21.238766 (MainThread): Parsing macros/materializations/seed.sql
2021-11-01 23:36:21.241589 (MainThread): Parsing macros/materializations/view.sql
2021-11-01 23:36:21.244172 (MainThread): Parsing macros/materializations/table.sql
2021-11-01 23:36:21.253292 (MainThread): Parsing macros/materializations/copy.sql
2021-11-01 23:36:21.255767 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-01 23:36:21.270379 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-01 23:36:21.272096 (MainThread): Parsing macros/core.sql
2021-11-01 23:36:21.275599 (MainThread): Parsing macros/materializations/test.sql
2021-11-01 23:36:21.282990 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-01 23:36:21.292841 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-01 23:36:21.294482 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-01 23:36:21.311517 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-01 23:36:21.343793 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-01 23:36:21.365681 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-01 23:36:21.367345 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-01 23:36:21.377270 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-01 23:36:21.397121 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-01 23:36:21.410641 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-01 23:36:21.418541 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-01 23:36:21.425660 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-01 23:36:21.429249 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-01 23:36:21.430742 (MainThread): Parsing macros/etc/query.sql
2021-11-01 23:36:21.431635 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-01 23:36:21.433025 (MainThread): Parsing macros/etc/datetime.sql
2021-11-01 23:36:21.441277 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-01 23:36:21.442912 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-01 23:36:21.445343 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-01 23:36:21.446962 (MainThread): Parsing macros/adapters/common.sql
2021-11-01 23:36:21.502011 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-01 23:36:21.503964 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-01 23:36:21.505231 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-01 23:36:21.506582 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-01 23:36:21.703916 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 23:36:21.716859 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-01 23:36:21.720562 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue".
2021-11-01 23:36:21.730448 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-01 23:36:21.758612 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 23:36:21.760391 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 23:36:21.762214 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 23:36:21.764058 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-01 23:36:21.764428 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 23:36:21.764586 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-01 23:36:21.764723 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 23:36:21.764870 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-01 23:36:21.774556 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-01 23:36:21.779329 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c702cabf-299f-4071-8cf8-88f2d40541c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db21610>]}
2021-11-01 23:36:21.784197 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-01 23:36:21.785147 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c702cabf-299f-4071-8cf8-88f2d40541c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dacaeb0>]}
2021-11-01 23:36:21.785478 (MainThread): Found 3 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-01 23:36:21.786934 (MainThread): 
2021-11-01 23:36:21.787314 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 23:36:21.788162 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-01 23:36:21.788320 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-01 23:36:22.269128 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-01 23:36:22.269916 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-01 23:36:22.282191 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 23:36:22.582436 (MainThread): 23:36:22 | 
2021-11-01 23:36:22.582970 (MainThread): 23:36:22 | Running 1 on-run-start hook
2021-11-01 23:36:22.583359 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-01 23:36:22.585320 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52709), raddr=('142.250.200.42', 443)>
2021-11-01 23:36:22.585787 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52710), raddr=('216.58.212.202', 443)>
2021-11-01 23:36:22.589431 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-01 23:36:22.593242 (MainThread): 23:36:22 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-01 23:36:22.593709 (MainThread): Opening a new connection, currently in state closed
2021-11-01 23:36:22.602714 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-01 23:36:25.398110 (MainThread): 23:36:25 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.80s]
2021-11-01 23:36:25.398672 (MainThread): 23:36:25 | 
2021-11-01 23:36:25.399296 (MainThread): 23:36:25 | Concurrency: 4 threads (target='dev')
2021-11-01 23:36:25.399579 (MainThread): 23:36:25 | 
2021-11-01 23:36:25.402845 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-01 23:36:25.403360 (Thread-1): 23:36:25 | 1 of 3 START table model ft_data.account_cashflows................... [RUN]
2021-11-01 23:36:25.403716 (Thread-2): Began running node model.freetrade_test.fx_revenue
2021-11-01 23:36:25.404177 (Thread-2): 23:36:25 | 2 of 3 START table model ft_data.fx_revenue.......................... [RUN]
2021-11-01 23:36:25.404790 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-01 23:36:25.405096 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-01 23:36:25.409266 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-01 23:36:25.409918 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue".
2021-11-01 23:36:25.410168 (Thread-2): Compiling model.freetrade_test.fx_revenue
2021-11-01 23:36:25.413380 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue"
2021-11-01 23:36:25.413866 (Thread-1): finished collecting timing info
2021-11-01 23:36:25.435260 (Thread-1): Opening a new connection, currently in state closed
2021-11-01 23:36:25.435516 (Thread-2): finished collecting timing info
2021-11-01 23:36:25.455790 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue"
2021-11-01 23:36:25.456454 (Thread-2): Opening a new connection, currently in state init
2021-11-01 23:36:25.460873 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 23:36:25.461529 (Thread-2): On model.freetrade_test.fx_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
ORDER BY datetime ASC
  );
    
2021-11-01 23:36:25.754029 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-01 23:36:25.755126 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-01 23:36:27.498387 (Thread-2): finished collecting timing info
2021-11-01 23:36:27.500827 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c702cabf-299f-4071-8cf8-88f2d40541c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dcdbfa0>]}
2021-11-01 23:36:27.501386 (Thread-2): 23:36:27 | 2 of 3 OK created table model ft_data.fx_revenue..................... [CREATE TABLE (15.3k rows, 799.5 KB processed) in 2.09s]
2021-11-01 23:36:27.502320 (Thread-2): Finished running node model.freetrade_test.fx_revenue
2021-11-01 23:36:27.613127 (Thread-1): finished collecting timing info
2021-11-01 23:36:27.614089 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c702cabf-299f-4071-8cf8-88f2d40541c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dce32e0>]}
2021-11-01 23:36:27.614938 (Thread-1): 23:36:27 | 1 of 3 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.21s]
2021-11-01 23:36:27.615267 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-01 23:36:27.616160 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-01 23:36:27.616773 (Thread-4): 23:36:27 | 3 of 3 START table model ft_data.account_timeseries.................. [RUN]
2021-11-01 23:36:27.617374 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-01 23:36:27.617640 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-01 23:36:27.623117 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-01 23:36:27.623745 (Thread-4): finished collecting timing info
2021-11-01 23:36:27.625947 (Thread-4): Opening a new connection, currently in state init
2021-11-01 23:36:27.634133 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-01 23:36:27.933295 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-01 23:36:27.934402 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-01 23:36:31.842624 (Thread-4): finished collecting timing info
2021-11-01 23:36:31.843716 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c702cabf-299f-4071-8cf8-88f2d40541c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db4a220>]}
2021-11-01 23:36:31.844576 (Thread-4): 23:36:31 | 3 of 3 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.23s]
2021-11-01 23:36:31.844994 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-01 23:36:31.847072 (MainThread): Acquiring new bigquery connection "master".
2021-11-01 23:36:31.847690 (MainThread): 23:36:31 | 
2021-11-01 23:36:31.847974 (MainThread): 23:36:31 | Finished running 3 table models, 1 hook in 10.06s.
2021-11-01 23:36:31.848216 (MainThread): Connection 'master' was properly closed.
2021-11-01 23:36:31.848408 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-01 23:36:31.848589 (MainThread): Connection 'model.freetrade_test.fx_revenue' was properly closed.
2021-11-01 23:36:31.848764 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-01 23:36:31.856715 (MainThread): 
2021-11-01 23:36:31.856991 (MainThread): Completed successfully
2021-11-01 23:36:31.857225 (MainThread): 
Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
2021-11-01 23:36:31.857544 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db39820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db02790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dae2ac0>]}
2021-11-01 23:36:31.857878 (MainThread): Flushing usage events
2021-11-02 00:13:24.707021 (MainThread): Running with dbt=0.21.0
2021-11-02 00:13:25.168506 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 00:13:25.169625 (MainThread): Tracking: tracking
2021-11-02 00:13:25.181640 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f16b280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1c1be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f154400>]}
2021-11-02 00:13:25.193782 (MainThread): Partial parsing not enabled
2021-11-02 00:13:25.208511 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 00:13:25.210513 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 00:13:25.211176 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 00:13:25.212361 (MainThread): Parsing macros/etc.sql
2021-11-02 00:13:25.218461 (MainThread): Parsing macros/catalog.sql
2021-11-02 00:13:25.228881 (MainThread): Parsing macros/adapters.sql
2021-11-02 00:13:25.260165 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 00:13:25.262751 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 00:13:25.276484 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 00:13:25.294781 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 00:13:25.300887 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 00:13:25.334554 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 00:13:25.352740 (MainThread): Parsing macros/core.sql
2021-11-02 00:13:25.357253 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 00:13:25.372939 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 00:13:25.402785 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 00:13:25.405605 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 00:13:25.434122 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 00:13:25.487747 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 00:13:25.512616 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 00:13:25.514361 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 00:13:25.523964 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 00:13:25.543511 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 00:13:25.557381 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 00:13:25.565724 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 00:13:25.573171 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 00:13:25.576905 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 00:13:25.578599 (MainThread): Parsing macros/etc/query.sql
2021-11-02 00:13:25.579583 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 00:13:25.581029 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 00:13:25.589526 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 00:13:25.591276 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 00:13:25.593624 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 00:13:25.596082 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 00:13:25.656388 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 00:13:25.658097 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 00:13:25.659756 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 00:13:25.661170 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 00:13:25.880080 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 00:13:25.894510 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 00:13:25.898378 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue".
2021-11-02 00:13:25.910608 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 00:13:25.941648 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:13:25.943517 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:13:25.945247 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:13:25.947201 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:13:25.947592 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 00:13:25.947760 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 00:13:25.947934 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 00:13:25.948110 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 00:13:25.958838 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 00:13:25.963482 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bd98dd2f-471d-41fc-a833-0cd98c2c9f3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f267e50>]}
2021-11-02 00:13:25.968865 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 00:13:25.969281 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bd98dd2f-471d-41fc-a833-0cd98c2c9f3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2675e0>]}
2021-11-02 00:13:25.969688 (MainThread): Found 3 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 00:13:25.971043 (MainThread): 
2021-11-02 00:13:25.971364 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 00:13:25.972162 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 00:13:25.972325 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 00:13:26.429256 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 00:13:26.429931 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 00:13:26.438832 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:13:26.749089 (MainThread): 00:13:26 | 
2021-11-02 00:13:26.749567 (MainThread): 00:13:26 | Running 1 on-run-start hook
2021-11-02 00:13:26.750153 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 00:13:26.751755 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52924), raddr=('172.217.169.10', 443)>
2021-11-02 00:13:26.752289 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52925), raddr=('216.58.212.202', 443)>
2021-11-02 00:13:26.755212 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 00:13:26.757167 (MainThread): 00:13:26 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 00:13:26.757901 (MainThread): Opening a new connection, currently in state closed
2021-11-02 00:13:26.764862 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 00:13:29.257750 (MainThread): 00:13:29 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.50s]
2021-11-02 00:13:29.258244 (MainThread): 00:13:29 | 
2021-11-02 00:13:29.258858 (MainThread): 00:13:29 | Concurrency: 4 threads (target='dev')
2021-11-02 00:13:29.259110 (MainThread): 00:13:29 | 
2021-11-02 00:13:29.262859 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 00:13:29.263385 (Thread-2): Began running node model.freetrade_test.fx_revenue
2021-11-02 00:13:29.263864 (Thread-1): 00:13:29 | 1 of 3 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 00:13:29.264261 (Thread-2): 00:13:29 | 2 of 3 START table model ft_data.fx_revenue.......................... [RUN]
2021-11-02 00:13:29.264923 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 00:13:29.265825 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue".
2021-11-02 00:13:29.266154 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 00:13:29.266447 (Thread-2): Compiling model.freetrade_test.fx_revenue
2021-11-02 00:13:29.269948 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 00:13:29.272900 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue"
2021-11-02 00:13:29.273541 (Thread-1): finished collecting timing info
2021-11-02 00:13:29.280091 (Thread-2): finished collecting timing info
2021-11-02 00:13:29.306847 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 00:13:29.307394 (Thread-2): Opening a new connection, currently in state init
2021-11-02 00:13:29.312825 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:13:29.313501 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:13:29.659984 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue"
2021-11-02 00:13:29.660386 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 00:13:29.660975 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 00:13:29.662021 (Thread-2): On model.freetrade_test.fx_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

WITH orders as (SELECT customer_id, 0.01 * value as amount, value, side,  settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
ORDER BY datetime ASC),

SELECT customer_id, amount, datetime CASE
    WHEN side = 'buy' THEN 'buy order'
    WHEN side = 'sell' THEN 'sell order'
    ELSE 'undefined'
END AS cashflow_type FROM orders
  );
    
2021-11-02 00:13:29.795344 (Thread-2): Retry attempt 1 of 1 after error: BadRequest('Syntax error: Trailing comma after the WITH clause before the SELECT clause is not allowed at [16:1]')
2021-11-02 00:13:30.941461 (Thread-2): finished collecting timing info
2021-11-02 00:13:30.942526 (Thread-2): Database Error in model fx_revenue (models/revenue/fx_revenue.sql)
  Syntax error: Trailing comma after the WITH clause before the SELECT clause is not allowed at [16:1]
  compiled SQL at target/run/freetrade_test/models/revenue/fx_revenue.sql
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Trailing comma after the WITH clause before the SELECT clause is not allowed at [16:1]

(job ID: d7df2874-325d-4787-bc02-85656c1ef289)

                                                                         -----Query Job SQL Follows-----                                                                         

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue"} */
   2:
   3:
   4:  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue`
   5:  
   6:  
   7:  OPTIONS()
   8:  as (
   9:    
  10:
  11:/* Assume here that FT take 1% charge on US orders */
  12:
  13:WITH orders as (SELECT customer_id, 0.01 * value as amount, value, side,  settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
  14:ORDER BY datetime ASC),
  15:
  16:SELECT customer_id, amount, datetime CASE
  17:    WHEN side = 'buy' THEN 'buy order'
  18:    WHEN side = 'sell' THEN 'sell order'
  19:    ELSE 'undefined'
  20:END AS cashflow_type FROM orders
  21:  );
  22:    
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 291, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 393, in run
    return self.execute(compiled_node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 249, in execute
    result = MacroGenerator(materialization_macro, context)()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 128, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 41, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model fx_revenue (models/revenue/fx_revenue.sql)
  Syntax error: Trailing comma after the WITH clause before the SELECT clause is not allowed at [16:1]
  compiled SQL at target/run/freetrade_test/models/revenue/fx_revenue.sql
2021-11-02 00:13:30.948626 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bd98dd2f-471d-41fc-a833-0cd98c2c9f3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2cf640>]}
2021-11-02 00:13:30.949367 (Thread-2): 00:13:30 | 2 of 3 ERROR creating table model ft_data.fx_revenue................. [ERROR in 1.68s]
2021-11-02 00:13:30.949685 (Thread-2): Finished running node model.freetrade_test.fx_revenue
2021-11-02 00:13:32.134683 (Thread-1): finished collecting timing info
2021-11-02 00:13:32.135392 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bd98dd2f-471d-41fc-a833-0cd98c2c9f3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3c8dc0>]}
2021-11-02 00:13:32.135916 (Thread-1): 00:13:32 | 1 of 3 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.87s]
2021-11-02 00:13:32.136175 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 00:13:32.136937 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 00:13:32.137320 (Thread-4): 00:13:32 | 3 of 3 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 00:13:32.137922 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 00:13:32.138175 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 00:13:32.142987 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 00:13:32.143579 (Thread-4): finished collecting timing info
2021-11-02 00:13:32.145523 (Thread-4): Opening a new connection, currently in state init
2021-11-02 00:13:32.152147 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:13:32.441570 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 00:13:32.442665 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 00:13:36.977069 (Thread-4): finished collecting timing info
2021-11-02 00:13:36.978193 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bd98dd2f-471d-41fc-a833-0cd98c2c9f3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1104874c0>]}
2021-11-02 00:13:36.979056 (Thread-4): 00:13:36 | 3 of 3 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.84s]
2021-11-02 00:13:36.979474 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 00:13:36.981667 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 00:13:36.982325 (MainThread): 00:13:36 | 
2021-11-02 00:13:36.982616 (MainThread): 00:13:36 | Finished running 3 table models, 1 hook in 11.01s.
2021-11-02 00:13:36.982869 (MainThread): Connection 'master' was properly closed.
2021-11-02 00:13:36.983074 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 00:13:36.983266 (MainThread): Connection 'model.freetrade_test.fx_revenue' was properly closed.
2021-11-02 00:13:36.983453 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 00:13:36.986861 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52928), raddr=('172.217.169.10', 443)>
2021-11-02 00:13:36.987171 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52929), raddr=('216.58.212.202', 443)>
2021-11-02 00:13:36.987445 (MainThread): unclosed <ssl.SSLSocket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52932), raddr=('216.58.212.202', 443)>
2021-11-02 00:13:36.987679 (MainThread): unclosed <ssl.SSLSocket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52930), raddr=('172.217.169.10', 443)>
2021-11-02 00:13:36.987984 (MainThread): unclosed <ssl.SSLSocket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52931), raddr=('172.217.169.10', 443)>
2021-11-02 00:13:36.988281 (MainThread): unclosed <ssl.SSLSocket fd=21, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52933), raddr=('216.58.212.202', 443)>
2021-11-02 00:13:36.988605 (MainThread): unclosed <ssl.SSLSocket fd=22, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52936), raddr=('172.217.169.10', 443)>
2021-11-02 00:13:36.988841 (MainThread): unclosed <ssl.SSLSocket fd=23, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52937), raddr=('216.58.212.202', 443)>
2021-11-02 00:13:36.994801 (MainThread): 
2021-11-02 00:13:36.995049 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 00:13:36.995225 (MainThread): 
2021-11-02 00:13:36.995394 (MainThread): Database Error in model fx_revenue (models/revenue/fx_revenue.sql)
2021-11-02 00:13:36.995552 (MainThread):   Syntax error: Trailing comma after the WITH clause before the SELECT clause is not allowed at [16:1]
2021-11-02 00:13:36.995695 (MainThread):   compiled SQL at target/run/freetrade_test/models/revenue/fx_revenue.sql
2021-11-02 00:13:36.995968 (MainThread): 
Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
2021-11-02 00:13:36.996300 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4c1340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2bc1c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2bce50>]}
2021-11-02 00:13:36.996582 (MainThread): Flushing usage events
2021-11-02 00:13:51.729018 (MainThread): Running with dbt=0.21.0
2021-11-02 00:13:52.026929 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 00:13:52.027983 (MainThread): Tracking: tracking
2021-11-02 00:13:52.037791 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112631d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11057efa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11261f3a0>]}
2021-11-02 00:13:52.049614 (MainThread): Partial parsing not enabled
2021-11-02 00:13:52.061755 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 00:13:52.062872 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 00:13:52.063399 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 00:13:52.064157 (MainThread): Parsing macros/etc.sql
2021-11-02 00:13:52.066492 (MainThread): Parsing macros/catalog.sql
2021-11-02 00:13:52.072718 (MainThread): Parsing macros/adapters.sql
2021-11-02 00:13:52.094716 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 00:13:52.097219 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 00:13:52.099588 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 00:13:52.108390 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 00:13:52.111024 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 00:13:52.126039 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 00:13:52.127833 (MainThread): Parsing macros/core.sql
2021-11-02 00:13:52.131888 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 00:13:52.138488 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 00:13:52.149024 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 00:13:52.150667 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 00:13:52.167300 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 00:13:52.198658 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 00:13:52.220330 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 00:13:52.221914 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 00:13:52.232678 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 00:13:52.251771 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 00:13:52.264979 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 00:13:52.272925 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 00:13:52.281445 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 00:13:52.285666 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 00:13:52.287111 (MainThread): Parsing macros/etc/query.sql
2021-11-02 00:13:52.288014 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 00:13:52.289456 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 00:13:52.299340 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 00:13:52.301588 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 00:13:52.304141 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 00:13:52.305814 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 00:13:52.362738 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 00:13:52.364828 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 00:13:52.366011 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 00:13:52.367300 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 00:13:52.563743 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 00:13:52.576551 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 00:13:52.580040 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue".
2021-11-02 00:13:52.589667 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 00:13:52.616387 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:13:52.618159 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:13:52.619762 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:13:52.621517 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:13:52.622026 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 00:13:52.622222 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 00:13:52.622401 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 00:13:52.622569 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 00:13:52.631731 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 00:13:52.636154 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '71567bef-2ae1-487a-adab-bfd80c1313bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11272f1c0>]}
2021-11-02 00:13:52.641035 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 00:13:52.641437 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '71567bef-2ae1-487a-adab-bfd80c1313bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11272f580>]}
2021-11-02 00:13:52.641705 (MainThread): Found 3 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 00:13:52.643312 (MainThread): 
2021-11-02 00:13:52.643725 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 00:13:52.644534 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 00:13:52.644693 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 00:13:53.078202 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 00:13:53.079122 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 00:13:53.091909 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:13:53.369888 (MainThread): 00:13:53 | 
2021-11-02 00:13:53.370354 (MainThread): 00:13:53 | Running 1 on-run-start hook
2021-11-02 00:13:53.370683 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 00:13:53.372209 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52940), raddr=('172.217.169.10', 443)>
2021-11-02 00:13:53.372555 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52941), raddr=('216.58.212.202', 443)>
2021-11-02 00:13:53.375715 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 00:13:53.378490 (MainThread): 00:13:53 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 00:13:53.378890 (MainThread): Opening a new connection, currently in state closed
2021-11-02 00:13:53.387118 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 00:13:55.795976 (MainThread): 00:13:55 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.42s]
2021-11-02 00:13:55.796543 (MainThread): 00:13:55 | 
2021-11-02 00:13:55.797219 (MainThread): 00:13:55 | Concurrency: 4 threads (target='dev')
2021-11-02 00:13:55.797747 (MainThread): 00:13:55 | 
2021-11-02 00:13:55.801283 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 00:13:55.801688 (Thread-2): Began running node model.freetrade_test.fx_revenue
2021-11-02 00:13:55.802176 (Thread-1): 00:13:55 | 1 of 3 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 00:13:55.802586 (Thread-2): 00:13:55 | 2 of 3 START table model ft_data.fx_revenue.......................... [RUN]
2021-11-02 00:13:55.803134 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 00:13:55.803868 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue".
2021-11-02 00:13:55.804140 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 00:13:55.804391 (Thread-2): Compiling model.freetrade_test.fx_revenue
2021-11-02 00:13:55.808171 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 00:13:55.811028 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue"
2021-11-02 00:13:55.811653 (Thread-2): finished collecting timing info
2021-11-02 00:13:55.817215 (Thread-1): finished collecting timing info
2021-11-02 00:13:55.846190 (Thread-2): Opening a new connection, currently in state init
2021-11-02 00:13:55.846763 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 00:13:55.852140 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:13:55.852362 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:13:56.228735 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 00:13:56.229972 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue"
2021-11-02 00:13:56.230558 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 00:13:56.231627 (Thread-2): On model.freetrade_test.fx_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

WITH orders as (SELECT customer_id, 0.01 * value as amount, value, side,  settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
ORDER BY datetime ASC)

SELECT customer_id, amount, datetime CASE
    WHEN side = 'buy' THEN 'buy order'
    WHEN side = 'sell' THEN 'sell order'
    ELSE 'undefined'
END AS cashflow_type FROM orders
  );
    
2021-11-02 00:13:56.353906 (Thread-2): Retry attempt 1 of 1 after error: BadRequest('Syntax error: Expected ")" but got keyword CASE at [16:38]')
2021-11-02 00:13:57.487136 (Thread-2): finished collecting timing info
2021-11-02 00:13:57.488156 (Thread-2): Database Error in model fx_revenue (models/revenue/fx_revenue.sql)
  Syntax error: Expected ")" but got keyword CASE at [16:38]
  compiled SQL at target/run/freetrade_test/models/revenue/fx_revenue.sql
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Expected ")" but got keyword CASE at [16:38]

(job ID: 9e3160c2-2ccd-4eb0-acba-4e7567561c65)

                                                                         -----Query Job SQL Follows-----                                                                         

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue"} */
   2:
   3:
   4:  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue`
   5:  
   6:  
   7:  OPTIONS()
   8:  as (
   9:    
  10:
  11:/* Assume here that FT take 1% charge on US orders */
  12:
  13:WITH orders as (SELECT customer_id, 0.01 * value as amount, value, side,  settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
  14:ORDER BY datetime ASC)
  15:
  16:SELECT customer_id, amount, datetime CASE
  17:    WHEN side = 'buy' THEN 'buy order'
  18:    WHEN side = 'sell' THEN 'sell order'
  19:    ELSE 'undefined'
  20:END AS cashflow_type FROM orders
  21:  );
  22:    
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 291, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 393, in run
    return self.execute(compiled_node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 249, in execute
    result = MacroGenerator(materialization_macro, context)()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 128, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 41, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model fx_revenue (models/revenue/fx_revenue.sql)
  Syntax error: Expected ")" but got keyword CASE at [16:38]
  compiled SQL at target/run/freetrade_test/models/revenue/fx_revenue.sql
2021-11-02 00:13:57.494105 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71567bef-2ae1-487a-adab-bfd80c1313bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112781c70>]}
2021-11-02 00:13:57.494724 (Thread-2): 00:13:57 | 2 of 3 ERROR creating table model ft_data.fx_revenue................. [ERROR in 1.69s]
2021-11-02 00:13:57.495189 (Thread-2): Finished running node model.freetrade_test.fx_revenue
2021-11-02 00:13:58.099222 (Thread-1): finished collecting timing info
2021-11-02 00:13:58.099907 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71567bef-2ae1-487a-adab-bfd80c1313bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11290cd60>]}
2021-11-02 00:13:58.100417 (Thread-1): 00:13:58 | 1 of 3 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.30s]
2021-11-02 00:13:58.100674 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 00:13:58.101422 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 00:13:58.101797 (Thread-4): 00:13:58 | 3 of 3 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 00:13:58.102411 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 00:13:58.102659 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 00:13:58.107384 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 00:13:58.107927 (Thread-4): finished collecting timing info
2021-11-02 00:13:58.109857 (Thread-4): Opening a new connection, currently in state init
2021-11-02 00:13:58.116759 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:13:58.413173 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 00:13:58.414413 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 00:14:02.431470 (Thread-4): finished collecting timing info
2021-11-02 00:14:02.432867 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71567bef-2ae1-487a-adab-bfd80c1313bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112781ac0>]}
2021-11-02 00:14:02.434010 (Thread-4): 00:14:02 | 3 of 3 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.33s]
2021-11-02 00:14:02.434426 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 00:14:02.436775 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 00:14:02.437464 (MainThread): 00:14:02 | 
2021-11-02 00:14:02.437764 (MainThread): 00:14:02 | Finished running 3 table models, 1 hook in 9.79s.
2021-11-02 00:14:02.438016 (MainThread): Connection 'master' was properly closed.
2021-11-02 00:14:02.438219 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 00:14:02.438412 (MainThread): Connection 'model.freetrade_test.fx_revenue' was properly closed.
2021-11-02 00:14:02.438598 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 00:14:02.443278 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52944), raddr=('172.217.169.10', 443)>
2021-11-02 00:14:02.443648 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52945), raddr=('216.58.212.202', 443)>
2021-11-02 00:14:02.443970 (MainThread): unclosed <ssl.SSLSocket fd=22, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52948), raddr=('216.58.212.202', 443)>
2021-11-02 00:14:02.444213 (MainThread): unclosed <ssl.SSLSocket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52946), raddr=('172.217.169.10', 443)>
2021-11-02 00:14:02.444440 (MainThread): unclosed <ssl.SSLSocket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52947), raddr=('172.217.169.10', 443)>
2021-11-02 00:14:02.444661 (MainThread): unclosed <ssl.SSLSocket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52949), raddr=('216.58.212.202', 443)>
2021-11-02 00:14:02.445024 (MainThread): unclosed <ssl.SSLSocket fd=21, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52950), raddr=('172.217.169.10', 443)>
2021-11-02 00:14:02.445301 (MainThread): unclosed <ssl.SSLSocket fd=23, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52951), raddr=('216.58.212.202', 443)>
2021-11-02 00:14:02.451256 (MainThread): 
2021-11-02 00:14:02.451606 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 00:14:02.451909 (MainThread): 
2021-11-02 00:14:02.452176 (MainThread): Database Error in model fx_revenue (models/revenue/fx_revenue.sql)
2021-11-02 00:14:02.452385 (MainThread):   Syntax error: Expected ")" but got keyword CASE at [16:38]
2021-11-02 00:14:02.452625 (MainThread):   compiled SQL at target/run/freetrade_test/models/revenue/fx_revenue.sql
2021-11-02 00:14:02.452812 (MainThread): 
Done. PASS=2 WARN=0 ERROR=1 SKIP=0 TOTAL=3
2021-11-02 00:14:02.453079 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11295be20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11295ba90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11295ba60>]}
2021-11-02 00:14:02.453352 (MainThread): Flushing usage events
2021-11-02 00:14:29.231130 (MainThread): Running with dbt=0.21.0
2021-11-02 00:14:29.527804 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 00:14:29.528964 (MainThread): Tracking: tracking
2021-11-02 00:14:29.539755 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110df1fa0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee47a00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110dda3d0>]}
2021-11-02 00:14:29.550661 (MainThread): Partial parsing not enabled
2021-11-02 00:14:29.562772 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 00:14:29.563875 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 00:14:29.564402 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 00:14:29.565163 (MainThread): Parsing macros/etc.sql
2021-11-02 00:14:29.567606 (MainThread): Parsing macros/catalog.sql
2021-11-02 00:14:29.573850 (MainThread): Parsing macros/adapters.sql
2021-11-02 00:14:29.595931 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 00:14:29.598322 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 00:14:29.600823 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 00:14:29.609743 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 00:14:29.612254 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 00:14:29.625639 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 00:14:29.627214 (MainThread): Parsing macros/core.sql
2021-11-02 00:14:29.631441 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 00:14:29.638052 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 00:14:29.648840 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 00:14:29.650456 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 00:14:29.666994 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 00:14:29.698036 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 00:14:29.719442 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 00:14:29.721071 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 00:14:29.730639 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 00:14:29.749642 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 00:14:29.762983 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 00:14:29.770624 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 00:14:29.777639 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 00:14:29.781141 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 00:14:29.782476 (MainThread): Parsing macros/etc/query.sql
2021-11-02 00:14:29.783333 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 00:14:29.784843 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 00:14:29.792960 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 00:14:29.794635 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 00:14:29.796883 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 00:14:29.798343 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 00:14:29.852041 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 00:14:29.853674 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 00:14:29.854814 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 00:14:29.856090 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 00:14:30.052682 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 00:14:30.065108 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 00:14:30.068566 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue".
2021-11-02 00:14:30.077884 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 00:14:30.105038 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:14:30.106750 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:14:30.108534 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:14:30.110388 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:14:30.110762 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 00:14:30.110935 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 00:14:30.111113 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 00:14:30.111279 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 00:14:30.120228 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 00:14:30.124608 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2ea94142-c221-4fa9-bc17-d0ed61dd305c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f2d460>]}
2021-11-02 00:14:30.129486 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 00:14:30.130004 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2ea94142-c221-4fa9-bc17-d0ed61dd305c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110ed4eb0>]}
2021-11-02 00:14:30.130404 (MainThread): Found 3 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 00:14:30.131879 (MainThread): 
2021-11-02 00:14:30.132314 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 00:14:30.133229 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 00:14:30.133400 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 00:14:30.530017 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 00:14:30.530664 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 00:14:30.542824 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:14:30.838803 (MainThread): 00:14:30 | 
2021-11-02 00:14:30.839319 (MainThread): 00:14:30 | Running 1 on-run-start hook
2021-11-02 00:14:30.839689 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 00:14:30.841504 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52956), raddr=('172.217.169.10', 443)>
2021-11-02 00:14:30.841977 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52957), raddr=('216.58.212.202', 443)>
2021-11-02 00:14:30.845777 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 00:14:30.848445 (MainThread): 00:14:30 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 00:14:30.848915 (MainThread): Opening a new connection, currently in state closed
2021-11-02 00:14:30.857906 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 00:14:33.358219 (MainThread): 00:14:33 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.51s]
2021-11-02 00:14:33.358768 (MainThread): 00:14:33 | 
2021-11-02 00:14:33.359425 (MainThread): 00:14:33 | Concurrency: 4 threads (target='dev')
2021-11-02 00:14:33.359717 (MainThread): 00:14:33 | 
2021-11-02 00:14:33.363069 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 00:14:33.363456 (Thread-2): Began running node model.freetrade_test.fx_revenue
2021-11-02 00:14:33.363942 (Thread-1): 00:14:33 | 1 of 3 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 00:14:33.364369 (Thread-2): 00:14:33 | 2 of 3 START table model ft_data.fx_revenue.......................... [RUN]
2021-11-02 00:14:33.365085 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 00:14:33.365864 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue".
2021-11-02 00:14:33.366149 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 00:14:33.366366 (Thread-2): Compiling model.freetrade_test.fx_revenue
2021-11-02 00:14:33.370094 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 00:14:33.372828 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue"
2021-11-02 00:14:33.373387 (Thread-1): finished collecting timing info
2021-11-02 00:14:33.379953 (Thread-2): finished collecting timing info
2021-11-02 00:14:33.410001 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 00:14:33.411735 (Thread-2): Opening a new connection, currently in state init
2021-11-02 00:14:33.417634 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:14:33.418224 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:14:33.733275 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue"
2021-11-02 00:14:33.734142 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 00:14:33.734663 (Thread-2): On model.freetrade_test.fx_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

WITH orders as (SELECT customer_id, 0.01 * value as amount, value, side,  settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
ORDER BY datetime ASC)

SELECT customer_id, amount, datetime,
 CASE
    WHEN side = 'buy' THEN 'buy order'
    WHEN side = 'sell' THEN 'sell order'
    ELSE 'undefined'
END AS cashflow_type FROM orders
  );
    
2021-11-02 00:14:33.735725 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 00:14:35.549351 (Thread-2): finished collecting timing info
2021-11-02 00:14:35.550057 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2ea94142-c221-4fa9-bc17-d0ed61dd305c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111100490>]}
2021-11-02 00:14:35.550583 (Thread-2): 00:14:35 | 2 of 3 OK created table model ft_data.fx_revenue..................... [CREATE TABLE (15.3k rows, 949.8 KB processed) in 2.18s]
2021-11-02 00:14:35.550852 (Thread-2): Finished running node model.freetrade_test.fx_revenue
2021-11-02 00:14:35.853464 (Thread-1): finished collecting timing info
2021-11-02 00:14:35.854464 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2ea94142-c221-4fa9-bc17-d0ed61dd305c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11104eca0>]}
2021-11-02 00:14:35.855220 (Thread-1): 00:14:35 | 1 of 3 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.49s]
2021-11-02 00:14:35.855522 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 00:14:35.856243 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 00:14:35.856682 (Thread-4): 00:14:35 | 3 of 3 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 00:14:35.857493 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 00:14:35.857911 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 00:14:35.863517 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 00:14:35.864169 (Thread-4): finished collecting timing info
2021-11-02 00:14:35.866377 (Thread-4): Opening a new connection, currently in state init
2021-11-02 00:14:35.873929 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:14:36.148291 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 00:14:36.149347 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 00:14:39.731836 (Thread-4): finished collecting timing info
2021-11-02 00:14:39.732912 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2ea94142-c221-4fa9-bc17-d0ed61dd305c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1111350d0>]}
2021-11-02 00:14:39.733679 (Thread-4): 00:14:39 | 3 of 3 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 3.88s]
2021-11-02 00:14:39.733984 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 00:14:39.735975 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 00:14:39.736606 (MainThread): 00:14:39 | 
2021-11-02 00:14:39.736901 (MainThread): 00:14:39 | Finished running 3 table models, 1 hook in 9.60s.
2021-11-02 00:14:39.737154 (MainThread): Connection 'master' was properly closed.
2021-11-02 00:14:39.737358 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 00:14:39.737550 (MainThread): Connection 'model.freetrade_test.fx_revenue' was properly closed.
2021-11-02 00:14:39.737736 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 00:14:39.740429 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52960), raddr=('172.217.169.10', 443)>
2021-11-02 00:14:39.740734 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52961), raddr=('216.58.212.202', 443)>
2021-11-02 00:14:39.741004 (MainThread): unclosed <ssl.SSLSocket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52964), raddr=('216.58.212.202', 443)>
2021-11-02 00:14:39.741280 (MainThread): unclosed <ssl.SSLSocket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52962), raddr=('172.217.169.10', 443)>
2021-11-02 00:14:39.741572 (MainThread): unclosed <ssl.SSLSocket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52963), raddr=('172.217.169.10', 443)>
2021-11-02 00:14:39.741810 (MainThread): unclosed <ssl.SSLSocket fd=21, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52965), raddr=('216.58.212.202', 443)>
2021-11-02 00:14:39.742170 (MainThread): unclosed <ssl.SSLSocket fd=22, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52966), raddr=('172.217.169.10', 443)>
2021-11-02 00:14:39.742457 (MainThread): unclosed <ssl.SSLSocket fd=23, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52967), raddr=('216.58.212.202', 443)>
2021-11-02 00:14:39.764149 (MainThread): 
2021-11-02 00:14:39.764375 (MainThread): Completed successfully
2021-11-02 00:14:39.764567 (MainThread): 
Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
2021-11-02 00:14:39.764764 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f2ad90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f2a0a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f2aee0>]}
2021-11-02 00:14:39.764973 (MainThread): Flushing usage events
2021-11-02 00:22:12.827518 (MainThread): Running with dbt=0.21.0
2021-11-02 00:22:13.129930 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 00:22:13.131048 (MainThread): Tracking: tracking
2021-11-02 00:22:13.141444 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c752700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a69f910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c73b3d0>]}
2021-11-02 00:22:13.152622 (MainThread): Partial parsing not enabled
2021-11-02 00:22:13.164771 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 00:22:13.165943 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 00:22:13.166481 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 00:22:13.167268 (MainThread): Parsing macros/etc.sql
2021-11-02 00:22:13.169688 (MainThread): Parsing macros/catalog.sql
2021-11-02 00:22:13.175897 (MainThread): Parsing macros/adapters.sql
2021-11-02 00:22:13.197914 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 00:22:13.200464 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 00:22:13.202842 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 00:22:13.211727 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 00:22:13.214122 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 00:22:13.227368 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 00:22:13.228948 (MainThread): Parsing macros/core.sql
2021-11-02 00:22:13.232821 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 00:22:13.239419 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 00:22:13.249019 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 00:22:13.250573 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 00:22:13.266591 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 00:22:13.297684 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 00:22:13.319814 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 00:22:13.321537 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 00:22:13.330979 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 00:22:13.349620 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 00:22:13.363046 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 00:22:13.370887 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 00:22:13.377652 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 00:22:13.381133 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 00:22:13.382556 (MainThread): Parsing macros/etc/query.sql
2021-11-02 00:22:13.383419 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 00:22:13.384776 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 00:22:13.393178 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 00:22:13.394878 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 00:22:13.397377 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 00:22:13.398894 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 00:22:13.451576 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 00:22:13.453117 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 00:22:13.454196 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 00:22:13.455402 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 00:22:13.651179 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 00:22:13.663605 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 00:22:13.667106 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue".
2021-11-02 00:22:13.676722 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 00:22:13.703101 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:22:13.704789 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:22:13.706370 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:22:13.708271 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:22:13.708644 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 00:22:13.708820 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 00:22:13.708998 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 00:22:13.709165 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 00:22:13.718324 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 00:22:13.722740 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '603914a2-223f-4d2b-ada7-e2f3d2b8f797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c88d400>]}
2021-11-02 00:22:13.728365 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 00:22:13.729165 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '603914a2-223f-4d2b-ada7-e2f3d2b8f797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c7efdf0>]}
2021-11-02 00:22:13.729652 (MainThread): Found 3 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 00:22:13.731058 (MainThread): 
2021-11-02 00:22:13.731405 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 00:22:13.732236 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 00:22:13.732406 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 00:22:14.179427 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 00:22:14.180063 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 00:22:14.192189 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:22:14.509632 (MainThread): 00:22:14 | 
2021-11-02 00:22:14.511287 (MainThread): 00:22:14 | Running 1 on-run-start hook
2021-11-02 00:22:14.512213 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 00:22:14.513792 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52998), raddr=('142.250.187.202', 443)>
2021-11-02 00:22:14.514138 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 52999), raddr=('216.58.212.202', 443)>
2021-11-02 00:22:14.517672 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 00:22:14.519851 (MainThread): 00:22:14 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 00:22:14.520178 (MainThread): Opening a new connection, currently in state closed
2021-11-02 00:22:14.527404 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 00:22:18.180197 (MainThread): 00:22:18 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 3.66s]
2021-11-02 00:22:18.180778 (MainThread): 00:22:18 | 
2021-11-02 00:22:18.181657 (MainThread): 00:22:18 | Concurrency: 4 threads (target='dev')
2021-11-02 00:22:18.182051 (MainThread): 00:22:18 | 
2021-11-02 00:22:18.185343 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 00:22:18.185736 (Thread-2): Began running node model.freetrade_test.fx_revenue
2021-11-02 00:22:18.186202 (Thread-1): 00:22:18 | 1 of 3 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 00:22:18.186619 (Thread-2): 00:22:18 | 2 of 3 START table model ft_data.fx_revenue.......................... [RUN]
2021-11-02 00:22:18.187330 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 00:22:18.188475 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue".
2021-11-02 00:22:18.188824 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 00:22:18.189043 (Thread-2): Compiling model.freetrade_test.fx_revenue
2021-11-02 00:22:18.192816 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 00:22:18.195838 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue"
2021-11-02 00:22:18.196465 (Thread-1): finished collecting timing info
2021-11-02 00:22:18.203026 (Thread-2): finished collecting timing info
2021-11-02 00:22:18.229539 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 00:22:18.232854 (Thread-2): Opening a new connection, currently in state init
2021-11-02 00:22:18.238336 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:22:18.239114 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:22:18.590489 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 00:22:18.591394 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue"
2021-11-02 00:22:18.591964 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 00:22:18.593105 (Thread-2): On model.freetrade_test.fx_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value, side,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
ORDER BY datetime ASC
  );
    
2021-11-02 00:22:20.555868 (Thread-1): finished collecting timing info
2021-11-02 00:22:20.557194 (Thread-2): finished collecting timing info
2021-11-02 00:22:20.557785 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '603914a2-223f-4d2b-ada7-e2f3d2b8f797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c9afca0>]}
2021-11-02 00:22:20.558315 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '603914a2-223f-4d2b-ada7-e2f3d2b8f797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da7aa30>]}
2021-11-02 00:22:20.558806 (Thread-1): 00:22:20 | 1 of 3 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.37s]
2021-11-02 00:22:20.559152 (Thread-2): 00:22:20 | 2 of 3 OK created table model ft_data.fx_revenue..................... [CREATE TABLE (15.3k rows, 2.2 MB processed) in 2.37s]
2021-11-02 00:22:20.559364 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 00:22:20.559785 (Thread-2): Finished running node model.freetrade_test.fx_revenue
2021-11-02 00:22:20.560429 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 00:22:20.560952 (Thread-4): 00:22:20 | 3 of 3 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 00:22:20.561495 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 00:22:20.561717 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 00:22:20.566166 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 00:22:20.566683 (Thread-4): finished collecting timing info
2021-11-02 00:22:20.568241 (Thread-4): Opening a new connection, currently in state init
2021-11-02 00:22:20.574487 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:22:20.877526 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 00:22:20.878612 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 00:22:24.624098 (Thread-4): finished collecting timing info
2021-11-02 00:22:24.625094 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '603914a2-223f-4d2b-ada7-e2f3d2b8f797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab0ee0>]}
2021-11-02 00:22:24.625852 (Thread-4): 00:22:24 | 3 of 3 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.06s]
2021-11-02 00:22:24.626183 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 00:22:24.628058 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 00:22:24.628700 (MainThread): 00:22:24 | 
2021-11-02 00:22:24.628984 (MainThread): 00:22:24 | Finished running 3 table models, 1 hook in 10.90s.
2021-11-02 00:22:24.629225 (MainThread): Connection 'master' was properly closed.
2021-11-02 00:22:24.629420 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 00:22:24.629605 (MainThread): Connection 'model.freetrade_test.fx_revenue' was properly closed.
2021-11-02 00:22:24.629785 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 00:22:24.634076 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53002), raddr=('142.250.187.202', 443)>
2021-11-02 00:22:24.634375 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53003), raddr=('216.58.212.202', 443)>
2021-11-02 00:22:24.634650 (MainThread): unclosed <ssl.SSLSocket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53006), raddr=('216.58.212.202', 443)>
2021-11-02 00:22:24.634886 (MainThread): unclosed <ssl.SSLSocket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53004), raddr=('142.250.187.202', 443)>
2021-11-02 00:22:24.635106 (MainThread): unclosed <ssl.SSLSocket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53005), raddr=('142.250.187.202', 443)>
2021-11-02 00:22:24.635319 (MainThread): unclosed <ssl.SSLSocket fd=21, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53007), raddr=('216.58.212.202', 443)>
2021-11-02 00:22:24.635605 (MainThread): unclosed <ssl.SSLSocket fd=22, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53008), raddr=('142.250.187.202', 443)>
2021-11-02 00:22:24.635823 (MainThread): unclosed <ssl.SSLSocket fd=23, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53009), raddr=('216.58.212.202', 443)>
2021-11-02 00:22:24.640707 (MainThread): 
2021-11-02 00:22:24.640929 (MainThread): Completed successfully
2021-11-02 00:22:24.641107 (MainThread): 
Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
2021-11-02 00:22:24.641360 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10daa2eb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10daa25b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10daa25e0>]}
2021-11-02 00:22:24.641626 (MainThread): Flushing usage events
2021-11-02 00:27:51.398440 (MainThread): Running with dbt=0.21.0
2021-11-02 00:27:51.699664 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 00:27:51.701052 (MainThread): Tracking: tracking
2021-11-02 00:27:51.711320 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089a7e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1069fea00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10898e3d0>]}
2021-11-02 00:27:51.722294 (MainThread): Partial parsing not enabled
2021-11-02 00:27:51.734504 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 00:27:51.735590 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 00:27:51.736147 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 00:27:51.736993 (MainThread): Parsing macros/etc.sql
2021-11-02 00:27:51.740029 (MainThread): Parsing macros/catalog.sql
2021-11-02 00:27:51.746531 (MainThread): Parsing macros/adapters.sql
2021-11-02 00:27:51.768694 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 00:27:51.771087 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 00:27:51.773479 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 00:27:51.783166 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 00:27:51.786625 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 00:27:51.800533 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 00:27:51.802485 (MainThread): Parsing macros/core.sql
2021-11-02 00:27:51.806578 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 00:27:51.813674 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 00:27:51.823295 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 00:27:51.825034 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 00:27:51.841533 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 00:27:51.873043 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 00:27:51.894601 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 00:27:51.896182 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 00:27:51.905664 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 00:27:51.924171 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 00:27:51.937109 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 00:27:51.944618 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 00:27:51.953329 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 00:27:51.957197 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 00:27:51.958713 (MainThread): Parsing macros/etc/query.sql
2021-11-02 00:27:51.959906 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 00:27:51.961487 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 00:27:51.969735 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 00:27:51.971440 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 00:27:51.973725 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 00:27:51.975392 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 00:27:52.031563 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 00:27:52.033234 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 00:27:52.034371 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 00:27:52.035647 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 00:27:52.231495 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 00:27:52.244015 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 00:27:52.247530 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 00:27:52.257064 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 00:27:52.284452 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:27:52.286172 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:27:52.287767 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:27:52.289520 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 00:27:52.289886 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 00:27:52.290052 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 00:27:52.290229 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 00:27:52.290378 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 00:27:52.299524 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 00:27:52.303947 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1550615b-d622-49fa-a661-54c13efa15e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ae33d0>]}
2021-11-02 00:27:52.308861 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 00:27:52.309255 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1550615b-d622-49fa-a661-54c13efa15e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a8ceb0>]}
2021-11-02 00:27:52.309520 (MainThread): Found 3 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 00:27:52.311215 (MainThread): 
2021-11-02 00:27:52.311678 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 00:27:52.312537 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 00:27:52.312822 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 00:27:52.718957 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 00:27:52.719515 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 00:27:52.729890 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:27:53.018212 (MainThread): 00:27:53 | 
2021-11-02 00:27:53.018625 (MainThread): 00:27:53 | Running 1 on-run-start hook
2021-11-02 00:27:53.018936 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 00:27:53.020208 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53031), raddr=('216.58.212.234', 443)>
2021-11-02 00:27:53.020498 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53032), raddr=('216.58.212.202', 443)>
2021-11-02 00:27:53.023680 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 00:27:53.026991 (MainThread): 00:27:53 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 00:27:53.027399 (MainThread): Opening a new connection, currently in state closed
2021-11-02 00:27:53.035518 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 00:27:56.059959 (MainThread): 00:27:56 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 3.03s]
2021-11-02 00:27:56.060676 (MainThread): 00:27:56 | 
2021-11-02 00:27:56.061437 (MainThread): 00:27:56 | Concurrency: 4 threads (target='dev')
2021-11-02 00:27:56.061737 (MainThread): 00:27:56 | 
2021-11-02 00:27:56.065115 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 00:27:56.065504 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 00:27:56.065991 (Thread-1): 00:27:56 | 1 of 3 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 00:27:56.066422 (Thread-2): 00:27:56 | 2 of 3 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 00:27:56.066953 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 00:27:56.067671 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 00:27:56.067945 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 00:27:56.068160 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 00:27:56.072001 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 00:27:56.074788 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 00:27:56.075437 (Thread-2): finished collecting timing info
2021-11-02 00:27:56.081352 (Thread-1): finished collecting timing info
2021-11-02 00:27:56.111529 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 00:27:56.132481 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 00:27:56.133413 (Thread-2): Opening a new connection, currently in state init
2021-11-02 00:27:56.138181 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:27:56.138903 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
ORDER BY datetime ASC
  );
    
2021-11-02 00:27:56.458739 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 00:27:56.459795 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 00:27:58.226079 (Thread-2): finished collecting timing info
2021-11-02 00:27:58.226819 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1550615b-d622-49fa-a661-54c13efa15e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b0cd90>]}
2021-11-02 00:27:58.228638 (Thread-2): 00:27:58 | 2 of 3 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.16s]
2021-11-02 00:27:58.229014 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 00:27:58.959389 (Thread-1): finished collecting timing info
2021-11-02 00:27:58.960088 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1550615b-d622-49fa-a661-54c13efa15e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c8e2b0>]}
2021-11-02 00:27:58.960619 (Thread-1): 00:27:58 | 1 of 3 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.89s]
2021-11-02 00:27:58.960879 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 00:27:58.961605 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 00:27:58.962151 (Thread-4): 00:27:58 | 3 of 3 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 00:27:58.962672 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 00:27:58.962894 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 00:27:58.968387 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 00:27:58.969129 (Thread-4): finished collecting timing info
2021-11-02 00:27:58.971799 (Thread-4): Opening a new connection, currently in state init
2021-11-02 00:27:58.980853 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 00:27:59.264110 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 00:27:59.265008 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 00:28:02.907661 (Thread-4): finished collecting timing info
2021-11-02 00:28:02.908458 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1550615b-d622-49fa-a661-54c13efa15e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c7ed90>]}
2021-11-02 00:28:02.909180 (Thread-4): 00:28:02 | 3 of 3 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 3.95s]
2021-11-02 00:28:02.909486 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 00:28:02.911412 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 00:28:02.911953 (MainThread): 00:28:02 | 
2021-11-02 00:28:02.912353 (MainThread): 00:28:02 | Finished running 3 table models, 1 hook in 10.60s.
2021-11-02 00:28:02.912733 (MainThread): Connection 'master' was properly closed.
2021-11-02 00:28:02.913020 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 00:28:02.913232 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 00:28:02.913405 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 00:28:02.916180 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53035), raddr=('216.58.212.234', 443)>
2021-11-02 00:28:02.916540 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53036), raddr=('216.58.212.202', 443)>
2021-11-02 00:28:02.916824 (MainThread): unclosed <ssl.SSLSocket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53039), raddr=('216.58.212.202', 443)>
2021-11-02 00:28:02.917064 (MainThread): unclosed <ssl.SSLSocket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53037), raddr=('216.58.212.234', 443)>
2021-11-02 00:28:02.917289 (MainThread): unclosed <ssl.SSLSocket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53038), raddr=('216.58.212.234', 443)>
2021-11-02 00:28:02.917508 (MainThread): unclosed <ssl.SSLSocket fd=21, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53040), raddr=('216.58.212.202', 443)>
2021-11-02 00:28:02.917791 (MainThread): unclosed <ssl.SSLSocket fd=22, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53041), raddr=('216.58.212.234', 443)>
2021-11-02 00:28:02.918060 (MainThread): unclosed <ssl.SSLSocket fd=23, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 53042), raddr=('216.58.212.202', 443)>
2021-11-02 00:28:02.938844 (MainThread): 
2021-11-02 00:28:02.939062 (MainThread): Completed successfully
2021-11-02 00:28:02.939210 (MainThread): 
Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
2021-11-02 00:28:02.939427 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ac4310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a92610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108af9cd0>]}
2021-11-02 00:28:02.939653 (MainThread): Flushing usage events
2021-11-02 15:47:38.374197 (MainThread): Running with dbt=0.21.0
2021-11-02 15:47:39.112964 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 15:47:39.114477 (MainThread): Tracking: tracking
2021-11-02 15:47:39.136183 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b584520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095db910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b56c070>]}
2021-11-02 15:47:39.148718 (MainThread): Partial parsing not enabled
2021-11-02 15:47:39.174633 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 15:47:39.175747 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 15:47:39.176268 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 15:47:39.177043 (MainThread): Parsing macros/etc.sql
2021-11-02 15:47:39.181053 (MainThread): Parsing macros/catalog.sql
2021-11-02 15:47:39.187451 (MainThread): Parsing macros/adapters.sql
2021-11-02 15:47:39.209937 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 15:47:39.213668 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 15:47:39.216705 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 15:47:39.226706 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 15:47:39.229305 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 15:47:39.243885 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 15:47:39.245600 (MainThread): Parsing macros/core.sql
2021-11-02 15:47:39.249163 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 15:47:39.256351 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 15:47:39.266200 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 15:47:39.267872 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 15:47:39.285447 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 15:47:39.320303 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 15:47:39.345900 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 15:47:39.349204 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 15:47:39.364722 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 15:47:39.392705 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 15:47:39.408553 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 15:47:39.416770 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 15:47:39.424515 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 15:47:39.428299 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 15:47:39.429729 (MainThread): Parsing macros/etc/query.sql
2021-11-02 15:47:39.430641 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 15:47:39.432214 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 15:47:39.441265 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 15:47:39.443031 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 15:47:39.445369 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 15:47:39.446982 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 15:47:39.504453 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 15:47:39.506242 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 15:47:39.507426 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 15:47:39.508723 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 15:47:39.717975 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 15:47:39.733164 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 15:47:39.737339 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 15:47:39.741095 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 15:47:39.750820 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 15:47:39.780175 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:47:39.782143 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:47:39.783814 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:47:39.785521 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:47:39.785909 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 15:47:39.786067 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 15:47:39.786244 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 15:47:39.786410 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 15:47:39.797502 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 15:47:39.803154 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6a6d4241-7ee9-4bdc-ad3b-e8f7d5a1fc18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b67ed30>]}
2021-11-02 15:47:39.809799 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 15:47:39.810318 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6a6d4241-7ee9-4bdc-ad3b-e8f7d5a1fc18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b67ecd0>]}
2021-11-02 15:47:39.810613 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 187 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 15:47:39.812218 (MainThread): 
2021-11-02 15:47:39.812607 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 15:47:39.814008 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 15:47:39.814216 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 15:47:40.279167 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 15:47:40.279798 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 15:47:40.291954 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:47:40.624268 (MainThread): 15:47:40 | 
2021-11-02 15:47:40.624818 (MainThread): 15:47:40 | Running 1 on-run-start hook
2021-11-02 15:47:40.625408 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 15:47:40.630520 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 15:47:40.633217 (MainThread): 15:47:40 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 15:47:40.633622 (MainThread): Opening a new connection, currently in state closed
2021-11-02 15:47:40.642845 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 15:47:44.425154 (MainThread): 15:47:44 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 3.79s]
2021-11-02 15:47:44.425762 (MainThread): 15:47:44 | 
2021-11-02 15:47:44.426579 (MainThread): 15:47:44 | Concurrency: 4 threads (target='dev')
2021-11-02 15:47:44.426914 (MainThread): 15:47:44 | 
2021-11-02 15:47:44.432257 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 15:47:44.432944 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 15:47:44.433425 (Thread-1): 15:47:44 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 15:47:44.433667 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 15:47:44.434102 (Thread-2): 15:47:44 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 15:47:44.434756 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 15:47:44.435133 (Thread-3): 15:47:44 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 15:47:44.435605 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 15:47:44.435902 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 15:47:44.436389 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 15:47:44.436623 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 15:47:44.440493 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 15:47:44.440748 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 15:47:44.443376 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 15:47:44.446706 (Thread-1): finished collecting timing info
2021-11-02 15:47:44.453102 (Thread-3): finished collecting timing info
2021-11-02 15:47:44.468085 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 15:47:44.468305 (Thread-2): finished collecting timing info
2021-11-02 15:47:44.470121 (Thread-2): Opening a new connection, currently in state init
2021-11-02 15:47:44.475526 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:47:44.476194 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:47:44.453506 (Thread-3): Compilation Error in model month_spine (models/revenue/month_spine.sql)
  'dbt_utils' is undefined. This can happen when calling a macro that does not exist. Check for typos and/or install package dependencies with "dbt deps".
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 517, in catch_jinja
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 1, in top-level template code
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 407, in getattr
    value = getattr(obj, attribute)
jinja2.exceptions.UndefinedError: 'dbt_utils' is undefined

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 285, in compile_and_execute
    ctx.node = self.compile(manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/compile.py", line 33, in compile
    return compiler.compile_node(self.node, manifest, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 543, in compile_node
    node = self._compile_node(node, manifest, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 383, in _compile_node
    compiled_node.compiled_sql = jinja.get_rendered(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 598, in get_rendered
    return render_template(template, ctx, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 522, in catch_jinja
    raise UndefinedMacroException(str(e), node) from e
dbt.exceptions.UndefinedMacroException: Compilation Error in model month_spine (models/revenue/month_spine.sql)
  'dbt_utils' is undefined. This can happen when calling a macro that does not exist. Check for typos and/or install package dependencies with "dbt deps".
2021-11-02 15:47:44.483595 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a6d4241-7ee9-4bdc-ad3b-e8f7d5a1fc18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b85ef70>]}
2021-11-02 15:47:44.484080 (Thread-3): 15:47:44 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 0.05s]
2021-11-02 15:47:44.484251 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 15:47:44.823675 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 15:47:44.825821 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 15:47:44.826435 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 15:47:44.827533 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 15:47:47.232074 (Thread-1): finished collecting timing info
2021-11-02 15:47:47.232780 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a6d4241-7ee9-4bdc-ad3b-e8f7d5a1fc18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b74ac70>]}
2021-11-02 15:47:47.233291 (Thread-1): 15:47:47 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.80s]
2021-11-02 15:47:47.233549 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 15:47:47.234134 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 15:47:47.234528 (Thread-4): 15:47:47 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 15:47:47.235014 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 15:47:47.235244 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 15:47:47.237693 (Thread-4): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54092), raddr=('142.250.200.42', 443)>
2021-11-02 15:47:47.238002 (Thread-4): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54093), raddr=('216.58.212.202', 443)>
2021-11-02 15:47:47.238237 (Thread-4): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54094), raddr=('142.250.200.42', 443)>
2021-11-02 15:47:47.238410 (Thread-4): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54095), raddr=('216.58.212.202', 443)>
2021-11-02 15:47:47.242213 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 15:47:47.242774 (Thread-4): finished collecting timing info
2021-11-02 15:47:47.251363 (Thread-4): Opening a new connection, currently in state init
2021-11-02 15:47:47.257595 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:47:47.313228 (Thread-2): finished collecting timing info
2021-11-02 15:47:47.314021 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a6d4241-7ee9-4bdc-ad3b-e8f7d5a1fc18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b6f5e80>]}
2021-11-02 15:47:47.314610 (Thread-2): 15:47:47 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.88s]
2021-11-02 15:47:47.314912 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 15:47:47.585784 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 15:47:47.586929 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 15:47:52.619467 (Thread-4): finished collecting timing info
2021-11-02 15:47:52.620548 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a6d4241-7ee9-4bdc-ad3b-e8f7d5a1fc18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b650cd0>]}
2021-11-02 15:47:52.621306 (Thread-4): 15:47:52 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 5.39s]
2021-11-02 15:47:52.621606 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 15:47:52.623526 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 15:47:52.624169 (MainThread): 15:47:52 | 
2021-11-02 15:47:52.624459 (MainThread): 15:47:52 | Finished running 1 view model, 3 table models, 1 hook in 12.81s.
2021-11-02 15:47:52.624714 (MainThread): Connection 'master' was properly closed.
2021-11-02 15:47:52.624918 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 15:47:52.625117 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 15:47:52.625307 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 15:47:52.625494 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 15:47:52.635221 (MainThread): 
2021-11-02 15:47:52.635607 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 15:47:52.635886 (MainThread): 
2021-11-02 15:47:52.636113 (MainThread): Compilation Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 15:47:52.636319 (MainThread):   'dbt_utils' is undefined. This can happen when calling a macro that does not exist. Check for typos and/or install package dependencies with "dbt deps".
2021-11-02 15:47:52.636533 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 15:47:52.636869 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b623c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b6ec820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b70abb0>]}
2021-11-02 15:47:52.637226 (MainThread): Flushing usage events
2021-11-02 15:50:09.799900 (MainThread): Running with dbt=0.21.0
2021-11-02 15:50:10.102651 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 15:50:10.103850 (MainThread): Tracking: tracking
2021-11-02 15:50:10.113994 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104be0340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b731c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b737f0>]}
2021-11-02 15:50:10.115266 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104be0340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b731c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b73a00>]}
2021-11-02 15:50:10.115479 (MainThread): Flushing usage events
2021-11-02 15:50:10.557302 (MainThread): Encountered an error:
2021-11-02 15:50:10.557742 (MainThread): Compilation Error
  dbt found 1 package(s) specified in packages.yml, but only 0 package(s) installed in dbt_modules. Run "dbt deps" to install package dependencies.
2021-11-02 15:50:10.569000 (MainThread): Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 127, in main
    results, succeeded = handle_and_check(args)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 205, in handle_and_check
    task, res = run_from_args(parsed)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/main.py", line 258, in run_from_args
    results = task.run()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 433, in run
    self._runtime_initialize()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 149, in _runtime_initialize
    super()._runtime_initialize()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 87, in _runtime_initialize
    self.load_manifest()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/runnable.py", line 74, in load_manifest
    self.manifest = ManifestLoader.get_full_manifest(self.config)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/parser/manifest.py", line 179, in get_full_manifest
    projects = config.load_dependencies()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/config/runtime.py", line 336, in load_dependencies
    raise_compiler_error(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/exceptions.py", line 444, in raise_compiler_error
    raise CompilationException(msg, node)
dbt.exceptions.CompilationException: Compilation Error
  dbt found 1 package(s) specified in packages.yml, but only 0 package(s) installed in dbt_modules. Run "dbt deps" to install package dependencies.

2021-11-02 15:50:43.447626 (MainThread): Running with dbt=0.21.0
2021-11-02 15:50:43.739238 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, defer=None, state=None, cls=<class 'dbt.task.deps.DepsTask'>, which='deps', rpc_method='deps')
2021-11-02 15:50:43.739616 (MainThread): Tracking: tracking
2021-11-02 15:50:43.750601 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fe9dc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fe92e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fe96a0>]}
2021-11-02 15:50:43.752758 (MainThread): Set downloads directory='/var/folders/hx/lvywc02s5f3d13s_klys5s280000gn/T/dbt-downloads-c8l6mczf'
2021-11-02 15:50:43.753577 (MainThread): Making package registry request: GET https://hub.getdbt.com/api/v1/index.json
2021-11-02 15:50:43.919951 (MainThread): Response from registry: GET https://hub.getdbt.com/api/v1/index.json 200
2021-11-02 15:50:43.920493 (MainThread): Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json
2021-11-02 15:50:44.054066 (MainThread): Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json 200
2021-11-02 15:50:44.079524 (MainThread): Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils/0.7.3.json
2021-11-02 15:50:44.195577 (MainThread): Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils/0.7.3.json 200
2021-11-02 15:50:44.196191 (MainThread): Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json
2021-11-02 15:50:44.316035 (MainThread): Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json 200
2021-11-02 15:50:44.340737 (MainThread): Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils/0.7.3.json
2021-11-02 15:50:44.462350 (MainThread): Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils/0.7.3.json 200
2021-11-02 15:50:44.463064 (MainThread): Installing dbt-labs/dbt_utils@0.7.3
2021-11-02 15:50:44.812282 (MainThread):   Installed from version 0.7.3
2021-11-02 15:50:44.812503 (MainThread):   Up to date!
2021-11-02 15:50:44.812706 (MainThread): Sending event: {'category': 'dbt', 'action': 'package', 'label': 'd926a38e-c9f9-4c88-bf67-87194e21a271', 'property_': 'install', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fe9d60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fe9fd0>]}
2021-11-02 15:50:44.813489 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fe9940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fe9850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fe9820>]}
2021-11-02 15:50:44.813695 (MainThread): Flushing usage events
2021-11-02 15:50:48.777134 (MainThread): Running with dbt=0.21.0
2021-11-02 15:50:49.074358 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 15:50:49.075658 (MainThread): Tracking: tracking
2021-11-02 15:50:49.086748 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096ab400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b63b2e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b63b6a0>]}
2021-11-02 15:50:49.104984 (MainThread): Partial parsing not enabled
2021-11-02 15:50:49.128674 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 15:50:49.129662 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 15:50:49.130163 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 15:50:49.130891 (MainThread): Parsing macros/etc.sql
2021-11-02 15:50:49.133143 (MainThread): Parsing macros/catalog.sql
2021-11-02 15:50:49.139033 (MainThread): Parsing macros/adapters.sql
2021-11-02 15:50:49.160589 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 15:50:49.162928 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 15:50:49.165271 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 15:50:49.174160 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 15:50:49.177069 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 15:50:49.191669 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 15:50:49.193407 (MainThread): Parsing macros/core.sql
2021-11-02 15:50:49.196851 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 15:50:49.203067 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 15:50:49.212808 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 15:50:49.214356 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 15:50:49.230391 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 15:50:49.261075 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 15:50:49.283448 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 15:50:49.285127 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 15:50:49.295449 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 15:50:49.314860 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 15:50:49.329256 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 15:50:49.337821 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 15:50:49.345892 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 15:50:49.350235 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 15:50:49.351926 (MainThread): Parsing macros/etc/query.sql
2021-11-02 15:50:49.352999 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 15:50:49.354706 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 15:50:49.364605 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 15:50:49.366695 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 15:50:49.369466 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 15:50:49.371275 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 15:50:49.425513 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 15:50:49.427275 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 15:50:49.428384 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 15:50:49.429585 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 15:50:49.431563 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 15:50:49.432504 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 15:50:49.433617 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 15:50:49.434506 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 15:50:49.440002 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 15:50:49.441011 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 15:50:49.442165 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 15:50:49.444860 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 15:50:49.445806 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 15:50:49.447893 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 15:50:49.457441 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 15:50:49.459108 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 15:50:49.460371 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 15:50:49.461695 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 15:50:49.463177 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 15:50:49.464566 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 15:50:49.465427 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 15:50:49.468659 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 15:50:49.473583 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 15:50:49.476784 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 15:50:49.478430 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 15:50:49.479888 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 15:50:49.481619 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 15:50:49.505162 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 15:50:49.506814 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 15:50:49.509166 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 15:50:49.510691 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 15:50:49.511695 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 15:50:49.512785 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 15:50:49.513946 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 15:50:49.515010 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 15:50:49.516531 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 15:50:49.518010 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 15:50:49.520102 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 15:50:49.521758 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 15:50:49.522875 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 15:50:49.525112 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 15:50:49.527023 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 15:50:49.528319 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 15:50:49.529456 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 15:50:49.532015 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 15:50:49.533848 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 15:50:49.535465 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 15:50:49.537682 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 15:50:49.540077 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 15:50:49.541367 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 15:50:49.544598 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 15:50:49.552943 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 15:50:49.557365 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 15:50:49.558866 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 15:50:49.562078 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 15:50:49.565970 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 15:50:49.569237 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 15:50:49.570856 (MainThread): Parsing macros/sql/star.sql
2021-11-02 15:50:49.574103 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 15:50:49.581543 (MainThread): Parsing macros/sql/union.sql
2021-11-02 15:50:49.589299 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 15:50:49.590522 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 15:50:49.593732 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 15:50:49.595199 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 15:50:49.596679 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 15:50:49.602596 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 15:50:49.607255 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 15:50:49.610955 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 15:50:49.613083 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 15:50:49.937455 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 15:50:49.950383 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 15:50:49.954126 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 15:50:49.957633 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 15:50:49.989478 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 15:50:50.022520 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:50:50.024288 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:50:50.026009 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:50:50.027665 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:50:50.028036 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 15:50:50.028187 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 15:50:50.028362 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 15:50:50.028488 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 15:50:50.087364 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 15:50:50.093608 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c1d01a21-3fe7-4bb5-9920-89475b949538', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096ab340>]}
2021-11-02 15:50:50.102738 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 15:50:50.103244 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c1d01a21-3fe7-4bb5-9920-89475b949538', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b74a820>]}
2021-11-02 15:50:50.103525 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 15:50:50.105178 (MainThread): 
2021-11-02 15:50:50.105560 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 15:50:50.106631 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 15:50:50.106826 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 15:50:50.577176 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 15:50:50.577806 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 15:50:50.589976 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:50:50.918197 (MainThread): 15:50:50 | 
2021-11-02 15:50:50.918703 (MainThread): 15:50:50 | Running 1 on-run-start hook
2021-11-02 15:50:50.919065 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 15:50:50.920818 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54149), raddr=('142.250.187.202', 443)>
2021-11-02 15:50:50.921183 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54150), raddr=('216.58.212.202', 443)>
2021-11-02 15:50:50.930106 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 15:50:50.932407 (MainThread): 15:50:50 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 15:50:50.932742 (MainThread): Opening a new connection, currently in state closed
2021-11-02 15:50:50.940222 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 15:50:54.599049 (MainThread): 15:50:54 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 3.67s]
2021-11-02 15:50:54.599624 (MainThread): 15:50:54 | 
2021-11-02 15:50:54.600287 (MainThread): 15:50:54 | Concurrency: 4 threads (target='dev')
2021-11-02 15:50:54.600571 (MainThread): 15:50:54 | 
2021-11-02 15:50:54.605480 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 15:50:54.605908 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 15:50:54.606366 (Thread-1): 15:50:54 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 15:50:54.606603 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 15:50:54.607030 (Thread-2): 15:50:54 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 15:50:54.607562 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 15:50:54.607909 (Thread-3): 15:50:54 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 15:50:54.608379 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 15:50:54.608627 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 15:50:54.609281 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 15:50:54.609529 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 15:50:54.613813 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 15:50:54.614017 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 15:50:54.616770 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 15:50:54.624762 (Thread-3): Opening a new connection, currently in state init
2021-11-02 15:50:54.625374 (Thread-2): finished collecting timing info
2021-11-02 15:50:54.625612 (Thread-1): finished collecting timing info
2021-11-02 15:50:54.637454 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(cast('2020-01-01' as date) as datetime),
        cast(cast('2019-01-01' as date) as datetime),
        day
    )


2021-11-02 15:50:54.645629 (Thread-2): Opening a new connection, currently in state init
2021-11-02 15:50:54.647457 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 15:50:54.653455 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:50:54.655083 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:50:54.993913 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 15:50:54.995506 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 15:50:54.996046 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 15:50:54.997039 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 15:50:55.860850 (Thread-3): Writing injected SQL for node "model.freetrade_test.month_spine"
2021-11-02 15:50:55.861671 (Thread-3): finished collecting timing info
2021-11-02 15:50:55.885499 (Thread-3): Writing runtime SQL for node "model.freetrade_test.month_spine"
2021-11-02 15:50:55.886071 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


  create or replace view `ft-data-330317`.`ft_data`.`month_spine`
  OPTIONS()
  as 

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
     + 
    
    p4.generated_number * power(2, 4)
     + 
    
    p5.generated_number * power(2, 5)
     + 
    
    p6.generated_number * power(2, 6)
     + 
    
    p7.generated_number * power(2, 7)
     + 
    
    p8.generated_number * power(2, 8)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
     cross join 
    
    p as p4
     cross join 
    
    p as p5
     cross join 
    
    p as p6
     cross join 
    
    p as p7
     cross join 
    
    p as p8
    
    

    )

    select *
    from unioned
    where generated_number <= 365
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2019-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 day
        )


    ) as date_day
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_day <= cast('2020-01-01' as date)

)

select * from filtered

;


2021-11-02 15:50:56.556002 (Thread-3): finished collecting timing info
2021-11-02 15:50:56.556679 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c1d01a21-3fe7-4bb5-9920-89475b949538', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b80ae20>]}
2021-11-02 15:50:56.557204 (Thread-3): 15:50:56 | 3 of 4 OK created view model ft_data.month_spine..................... [OK in 1.95s]
2021-11-02 15:50:56.557454 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 15:50:57.210189 (Thread-2): finished collecting timing info
2021-11-02 15:50:57.211267 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c1d01a21-3fe7-4bb5-9920-89475b949538', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b80e9a0>]}
2021-11-02 15:50:57.211958 (Thread-2): 15:50:57 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.60s]
2021-11-02 15:50:57.212251 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 15:50:57.834567 (Thread-1): finished collecting timing info
2021-11-02 15:50:57.835640 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c1d01a21-3fe7-4bb5-9920-89475b949538', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b84d9a0>]}
2021-11-02 15:50:57.836406 (Thread-1): 15:50:57 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 3.23s]
2021-11-02 15:50:57.836697 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 15:50:57.837441 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 15:50:57.837878 (Thread-4): 15:50:57 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 15:50:57.838676 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 15:50:57.838957 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 15:50:57.845100 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 15:50:57.845802 (Thread-4): finished collecting timing info
2021-11-02 15:50:57.848872 (Thread-4): Opening a new connection, currently in state init
2021-11-02 15:50:57.856211 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:50:58.182502 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 15:50:58.183572 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 15:51:02.829991 (Thread-4): finished collecting timing info
2021-11-02 15:51:02.831464 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c1d01a21-3fe7-4bb5-9920-89475b949538', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bab2880>]}
2021-11-02 15:51:02.832170 (Thread-4): 15:51:02 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.99s]
2021-11-02 15:51:02.832465 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 15:51:02.834393 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 15:51:02.835017 (MainThread): 15:51:02 | 
2021-11-02 15:51:02.835301 (MainThread): 15:51:02 | Finished running 1 view model, 3 table models, 1 hook in 12.73s.
2021-11-02 15:51:02.835545 (MainThread): Connection 'master' was properly closed.
2021-11-02 15:51:02.835742 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 15:51:02.835928 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 15:51:02.836108 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 15:51:02.836287 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 15:51:02.842719 (MainThread): unclosed <ssl.SSLSocket fd=21, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54156), raddr=('142.250.187.202', 443)>
2021-11-02 15:51:02.843028 (MainThread): unclosed <ssl.SSLSocket fd=22, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54159), raddr=('216.58.212.202', 443)>
2021-11-02 15:51:02.843317 (MainThread): unclosed <ssl.SSLSocket fd=24, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54161), raddr=('142.250.187.202', 443)>
2021-11-02 15:51:02.843538 (MainThread): unclosed <ssl.SSLSocket fd=25, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54162), raddr=('216.58.212.202', 443)>
2021-11-02 15:51:02.850260 (MainThread): 
2021-11-02 15:51:02.850500 (MainThread): Completed successfully
2021-11-02 15:51:02.850682 (MainThread): 
Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
2021-11-02 15:51:02.850943 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b755520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10baa5850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10baa5df0>]}
2021-11-02 15:51:02.851214 (MainThread): Flushing usage events
2021-11-02 15:52:21.036828 (MainThread): Running with dbt=0.21.0
2021-11-02 15:52:21.337364 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 15:52:21.338519 (MainThread): Tracking: tracking
2021-11-02 15:52:21.349236 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103a7f400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b1ca30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b1c190>]}
2021-11-02 15:52:21.366891 (MainThread): Partial parsing not enabled
2021-11-02 15:52:21.390758 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 15:52:21.391778 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 15:52:21.392325 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 15:52:21.393161 (MainThread): Parsing macros/etc.sql
2021-11-02 15:52:21.395512 (MainThread): Parsing macros/catalog.sql
2021-11-02 15:52:21.401377 (MainThread): Parsing macros/adapters.sql
2021-11-02 15:52:21.422718 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 15:52:21.425299 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 15:52:21.427758 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 15:52:21.436978 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 15:52:21.439604 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 15:52:21.454998 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 15:52:21.456698 (MainThread): Parsing macros/core.sql
2021-11-02 15:52:21.460244 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 15:52:21.466816 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 15:52:21.476780 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 15:52:21.478473 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 15:52:21.495095 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 15:52:21.525981 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 15:52:21.547931 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 15:52:21.549546 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 15:52:21.559081 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 15:52:21.578022 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 15:52:21.591169 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 15:52:21.598519 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 15:52:21.605271 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 15:52:21.608796 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 15:52:21.610132 (MainThread): Parsing macros/etc/query.sql
2021-11-02 15:52:21.610988 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 15:52:21.612339 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 15:52:21.620336 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 15:52:21.621949 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 15:52:21.624176 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 15:52:21.625608 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 15:52:21.678226 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 15:52:21.679830 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 15:52:21.680915 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 15:52:21.682136 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 15:52:21.684183 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 15:52:21.685426 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 15:52:21.686614 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 15:52:21.687552 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 15:52:21.693274 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 15:52:21.694428 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 15:52:21.695626 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 15:52:21.698391 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 15:52:21.699355 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 15:52:21.701560 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 15:52:21.711349 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 15:52:21.713063 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 15:52:21.714357 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 15:52:21.715718 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 15:52:21.717247 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 15:52:21.718782 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 15:52:21.719684 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 15:52:21.723043 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 15:52:21.727948 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 15:52:21.731220 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 15:52:21.732889 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 15:52:21.734367 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 15:52:21.736179 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 15:52:21.760027 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 15:52:21.761695 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 15:52:21.764068 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 15:52:21.765507 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 15:52:21.766518 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 15:52:21.767701 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 15:52:21.768792 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 15:52:21.769990 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 15:52:21.771533 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 15:52:21.773025 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 15:52:21.775128 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 15:52:21.776719 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 15:52:21.777839 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 15:52:21.780190 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 15:52:21.782156 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 15:52:21.783458 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 15:52:21.784597 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 15:52:21.787288 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 15:52:21.789099 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 15:52:21.790743 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 15:52:21.792894 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 15:52:21.795412 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 15:52:21.796719 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 15:52:21.800210 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 15:52:21.808723 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 15:52:21.813110 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 15:52:21.814616 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 15:52:21.817877 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 15:52:21.821945 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 15:52:21.825104 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 15:52:21.826626 (MainThread): Parsing macros/sql/star.sql
2021-11-02 15:52:21.829864 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 15:52:21.837433 (MainThread): Parsing macros/sql/union.sql
2021-11-02 15:52:21.845024 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 15:52:21.846277 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 15:52:21.849467 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 15:52:21.850953 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 15:52:21.852515 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 15:52:21.858461 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 15:52:21.863024 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 15:52:21.866737 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 15:52:21.869036 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 15:52:22.196271 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 15:52:22.209249 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 15:52:22.212918 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 15:52:22.216419 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 15:52:22.249833 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 15:52:22.285423 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:52:22.287222 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:52:22.288998 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:52:22.290650 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 15:52:22.291035 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 15:52:22.291192 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 15:52:22.291339 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 15:52:22.291456 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 15:52:22.353513 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 15:52:22.359873 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0c10e176-2c87-4461-b6f5-12e62696e693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c3a370>]}
2021-11-02 15:52:22.369742 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 15:52:22.370219 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0c10e176-2c87-4461-b6f5-12e62696e693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105cf97c0>]}
2021-11-02 15:52:22.370494 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 15:52:22.371936 (MainThread): 
2021-11-02 15:52:22.372308 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 15:52:22.373393 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 15:52:22.373587 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 15:52:22.814348 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 15:52:22.814988 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 15:52:22.826978 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:52:23.124022 (MainThread): 15:52:23 | 
2021-11-02 15:52:23.124574 (MainThread): 15:52:23 | Running 1 on-run-start hook
2021-11-02 15:52:23.124978 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 15:52:23.126804 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54172), raddr=('142.250.187.202', 443)>
2021-11-02 15:52:23.127241 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54173), raddr=('216.58.212.202', 443)>
2021-11-02 15:52:23.136807 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 15:52:23.139186 (MainThread): 15:52:23 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 15:52:23.139529 (MainThread): Opening a new connection, currently in state closed
2021-11-02 15:52:23.147188 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 15:52:26.845166 (MainThread): 15:52:26 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 3.71s]
2021-11-02 15:52:26.845749 (MainThread): 15:52:26 | 
2021-11-02 15:52:26.846527 (MainThread): 15:52:26 | Concurrency: 4 threads (target='dev')
2021-11-02 15:52:26.846811 (MainThread): 15:52:26 | 
2021-11-02 15:52:26.850579 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 15:52:26.850961 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 15:52:26.851458 (Thread-1): 15:52:26 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 15:52:26.851705 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 15:52:26.852142 (Thread-2): 15:52:26 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 15:52:26.852697 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 15:52:26.853039 (Thread-3): 15:52:26 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 15:52:26.853517 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 15:52:26.853769 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 15:52:26.854459 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 15:52:26.854685 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 15:52:26.859055 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 15:52:26.859256 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 15:52:26.862065 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 15:52:26.869472 (Thread-3): Opening a new connection, currently in state init
2021-11-02 15:52:26.869770 (Thread-1): finished collecting timing info
2021-11-02 15:52:26.889815 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 15:52:26.890040 (Thread-2): finished collecting timing info
2021-11-02 15:52:26.890337 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(cast('2020-01-01' as date) as datetime),
        cast(cast('2019-01-01' as date) as datetime),
        month
    )


2021-11-02 15:52:26.892348 (Thread-2): Opening a new connection, currently in state init
2021-11-02 15:52:26.898353 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:52:26.899996 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:52:27.252775 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 15:52:27.253158 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 15:52:27.253917 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 15:52:27.254117 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 15:52:28.074955 (Thread-3): Writing injected SQL for node "model.freetrade_test.month_spine"
2021-11-02 15:52:28.075753 (Thread-3): finished collecting timing info
2021-11-02 15:52:28.098301 (Thread-3): Writing runtime SQL for node "model.freetrade_test.month_spine"
2021-11-02 15:52:28.098883 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


  create or replace view `ft-data-330317`.`ft_data`.`month_spine`
  OPTIONS()
  as 

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 12
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2019-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2020-01-01' as date)

)

select * from filtered

;


2021-11-02 15:52:28.787101 (Thread-3): finished collecting timing info
2021-11-02 15:52:28.787788 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0c10e176-2c87-4461-b6f5-12e62696e693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105d46700>]}
2021-11-02 15:52:28.788238 (Thread-3): 15:52:28 | 3 of 4 OK created view model ft_data.month_spine..................... [OK in 1.93s]
2021-11-02 15:52:28.788454 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 15:52:29.364139 (Thread-2): finished collecting timing info
2021-11-02 15:52:29.365088 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0c10e176-2c87-4461-b6f5-12e62696e693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105cfdfd0>]}
2021-11-02 15:52:29.365796 (Thread-2): 15:52:29 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.51s]
2021-11-02 15:52:29.366176 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 15:52:29.731563 (Thread-1): finished collecting timing info
2021-11-02 15:52:29.732853 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0c10e176-2c87-4461-b6f5-12e62696e693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105dc7f10>]}
2021-11-02 15:52:29.733911 (Thread-1): 15:52:29 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.88s]
2021-11-02 15:52:29.734439 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 15:52:29.735962 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 15:52:29.736471 (Thread-4): 15:52:29 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 15:52:29.737087 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 15:52:29.737357 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 15:52:29.743716 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 15:52:29.744391 (Thread-4): finished collecting timing info
2021-11-02 15:52:29.746991 (Thread-4): Opening a new connection, currently in state init
2021-11-02 15:52:29.754479 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 15:52:30.146799 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 15:52:30.148023 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 15:52:34.719254 (Thread-4): finished collecting timing info
2021-11-02 15:52:34.719774 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0c10e176-2c87-4461-b6f5-12e62696e693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105d46f70>]}
2021-11-02 15:52:34.720159 (Thread-4): 15:52:34 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.98s]
2021-11-02 15:52:34.720410 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 15:52:34.721644 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 15:52:34.722004 (MainThread): 15:52:34 | 
2021-11-02 15:52:34.722169 (MainThread): 15:52:34 | Finished running 1 view model, 3 table models, 1 hook in 12.35s.
2021-11-02 15:52:34.722345 (MainThread): Connection 'master' was properly closed.
2021-11-02 15:52:34.722456 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 15:52:34.722549 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 15:52:34.722643 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 15:52:34.722731 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 15:52:34.731096 (MainThread): 
2021-11-02 15:52:34.731275 (MainThread): Completed successfully
2021-11-02 15:52:34.731435 (MainThread): 
Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
2021-11-02 15:52:34.731634 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b6bfd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c282b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105dcb2b0>]}
2021-11-02 15:52:34.731851 (MainThread): Flushing usage events
2021-11-02 16:04:02.412123 (MainThread): Running with dbt=0.21.0
2021-11-02 16:04:02.717489 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:04:02.718863 (MainThread): Tracking: tracking
2021-11-02 16:04:02.729169 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bee35b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10de74100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10de74a00>]}
2021-11-02 16:04:02.746836 (MainThread): Partial parsing not enabled
2021-11-02 16:04:02.771517 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:04:02.772533 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:04:02.773044 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:04:02.773795 (MainThread): Parsing macros/etc.sql
2021-11-02 16:04:02.776144 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:04:02.782006 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:04:02.802946 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:04:02.805416 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:04:02.807783 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:04:02.816571 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:04:02.819182 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:04:02.833311 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:04:02.834991 (MainThread): Parsing macros/core.sql
2021-11-02 16:04:02.838689 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:04:02.844921 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:04:02.854236 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:04:02.855915 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:04:02.871828 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:04:02.902998 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:04:02.924596 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:04:02.926184 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:04:02.935627 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:04:02.954427 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:04:02.967636 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:04:02.974841 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:04:02.981642 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:04:02.985286 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:04:02.986746 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:04:02.987607 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:04:02.988970 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:04:02.996779 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:04:02.998462 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:04:03.000640 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:04:03.002288 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:04:03.059295 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:04:03.060981 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:04:03.062109 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:04:03.063359 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:04:03.065456 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:04:03.066452 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:04:03.067623 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:04:03.068555 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:04:03.074156 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:04:03.075485 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:04:03.077175 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:04:03.080610 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:04:03.081687 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:04:03.083908 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:04:03.093758 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:04:03.095515 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:04:03.096852 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:04:03.098243 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:04:03.099799 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:04:03.101224 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:04:03.102129 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:04:03.105438 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:04:03.110316 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:04:03.113615 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:04:03.115409 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:04:03.116943 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:04:03.118683 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:04:03.142344 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:04:03.144082 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:04:03.146537 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:04:03.148049 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:04:03.149102 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:04:03.150206 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:04:03.151221 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:04:03.152394 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:04:03.153954 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:04:03.155459 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:04:03.157575 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:04:03.159172 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:04:03.160484 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:04:03.162914 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:04:03.165047 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:04:03.166476 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:04:03.167713 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:04:03.170835 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:04:03.173440 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:04:03.175295 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:04:03.177547 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:04:03.180041 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:04:03.181935 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:04:03.185721 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:04:03.194395 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:04:03.199417 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:04:03.201143 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:04:03.204629 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:04:03.208806 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:04:03.212145 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:04:03.213828 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:04:03.218845 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:04:03.226893 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:04:03.236497 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:04:03.237916 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:04:03.241846 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:04:03.243849 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:04:03.245523 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:04:03.252656 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:04:03.262295 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:04:03.269480 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:04:03.273664 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:04:03.647946 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:04:03.662043 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:04:03.666812 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:04:03.670785 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:04:03.704083 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:04:03.737245 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:04:03.738879 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:04:03.740653 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:04:03.742208 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:04:03.742559 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:04:03.742778 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:04:03.742974 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:04:03.743125 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:04:03.804067 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:04:03.810288 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e68f1733-8b68-4f12-96be-17539d1e89f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df7bdc0>]}
2021-11-02 16:04:03.819748 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:04:03.820243 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e68f1733-8b68-4f12-96be-17539d1e89f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df8a490>]}
2021-11-02 16:04:03.820527 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:04:03.822033 (MainThread): 
2021-11-02 16:04:03.822441 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:04:03.823550 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:04:03.823751 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:04:04.278347 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:04:04.278848 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:04:04.289056 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:04:04.597915 (MainThread): 16:04:04 | 
2021-11-02 16:04:04.598433 (MainThread): 16:04:04 | Running 1 on-run-start hook
2021-11-02 16:04:04.598812 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:04:04.600531 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54245), raddr=('142.250.200.10', 443)>
2021-11-02 16:04:04.600972 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54246), raddr=('216.58.212.202', 443)>
2021-11-02 16:04:04.610537 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:04:04.612864 (MainThread): 16:04:04 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:04:04.613205 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:04:04.620918 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:04:07.199720 (MainThread): 16:04:07 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.59s]
2021-11-02 16:04:07.200294 (MainThread): 16:04:07 | 
2021-11-02 16:04:07.201008 (MainThread): 16:04:07 | Concurrency: 4 threads (target='dev')
2021-11-02 16:04:07.201300 (MainThread): 16:04:07 | 
2021-11-02 16:04:07.204876 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:04:07.205399 (Thread-1): 16:04:07 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:04:07.205761 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:04:07.206226 (Thread-2): 16:04:07 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:04:07.206562 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:04:07.207006 (Thread-3): 16:04:07 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:04:07.207657 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:04:07.207924 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:04:07.212344 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:04:07.212986 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:04:07.213239 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:04:07.216365 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:04:07.216873 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:04:07.217070 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:04:07.224719 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:04:07.225065 (Thread-1): finished collecting timing info
2021-11-02 16:04:07.246328 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:04:07.246778 (Thread-2): finished collecting timing info
2021-11-02 16:04:07.247000 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast( as datetime),
        cast( as datetime),
        month
    )


2021-11-02 16:04:07.248957 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:04:07.255575 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:04:07.257625 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:04:07.595367 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:04:07.595862 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:04:07.596403 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:04:07.597519 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:04:07.627169 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Syntax error: Unexpected keyword AS at [7:15]')
2021-11-02 16:04:08.792944 (Thread-3): finished collecting timing info
2021-11-02 16:04:08.793878 (Thread-3): Database Error in model month_spine (models/revenue/month_spine.sql)
  Syntax error: Unexpected keyword AS at [7:15]
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Unexpected keyword AS at [7:15]

(job ID: 43493fac-3443-4e10-bd6e-4df3439506b7)

                                                             -----Query Job SQL Follows-----                                                             

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */
   2:
   3:
   4:        select 
   5:
   6:    datetime_diff(
   7:        cast( as datetime),
   8:        cast( as datetime),
   9:        month
  10:    )
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 285, in compile_and_execute
    ctx.node = self.compile(manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/compile.py", line 33, in compile
    return compiler.compile_node(self.node, manifest, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 543, in compile_node
    node = self._compile_node(node, manifest, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 383, in _compile_node
    compiled_node.compiled_sql = jinja.get_rendered(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 598, in get_rendered
    return render_template(template, ctx, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 6, in top-level template code
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 16, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 10, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model month_spine (models/revenue/month_spine.sql)
  Syntax error: Unexpected keyword AS at [7:15]
2021-11-02 16:04:08.813236 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e68f1733-8b68-4f12-96be-17539d1e89f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e10f3d0>]}
2021-11-02 16:04:08.813964 (Thread-3): 16:04:08 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 1.60s]
2021-11-02 16:04:08.814279 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:04:09.837224 (Thread-1): finished collecting timing info
2021-11-02 16:04:09.837910 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e68f1733-8b68-4f12-96be-17539d1e89f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e09cfa0>]}
2021-11-02 16:04:09.838427 (Thread-1): 16:04:09 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.63s]
2021-11-02 16:04:09.838685 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:04:09.839201 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:04:09.839564 (Thread-4): 16:04:09 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:04:09.840062 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:04:09.840298 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:04:09.845640 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:04:09.846207 (Thread-4): finished collecting timing info
2021-11-02 16:04:09.848638 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:04:09.855685 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:04:10.056151 (Thread-2): finished collecting timing info
2021-11-02 16:04:10.057029 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e68f1733-8b68-4f12-96be-17539d1e89f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e106190>]}
2021-11-02 16:04:10.057706 (Thread-2): 16:04:10 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.84s]
2021-11-02 16:04:10.058056 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:04:10.174857 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:04:10.175925 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:04:14.513939 (Thread-4): finished collecting timing info
2021-11-02 16:04:14.515038 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e68f1733-8b68-4f12-96be-17539d1e89f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e3a7fd0>]}
2021-11-02 16:04:14.515806 (Thread-4): 16:04:14 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.68s]
2021-11-02 16:04:14.516112 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:04:14.518148 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:04:14.518792 (MainThread): 16:04:14 | 
2021-11-02 16:04:14.519086 (MainThread): 16:04:14 | Finished running 1 view model, 3 table models, 1 hook in 10.70s.
2021-11-02 16:04:14.519336 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:04:14.519539 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:04:14.519734 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:04:14.519922 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:04:14.520114 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:04:14.532719 (MainThread): 
2021-11-02 16:04:14.532974 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 16:04:14.533150 (MainThread): 
2021-11-02 16:04:14.533317 (MainThread): Database Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 16:04:14.533470 (MainThread):   Syntax error: Unexpected keyword AS at [7:15]
2021-11-02 16:04:14.533630 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 16:04:14.533886 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df1e4f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df8abe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10de7a100>]}
2021-11-02 16:04:14.534155 (MainThread): Flushing usage events
2021-11-02 16:05:20.607471 (MainThread): Running with dbt=0.21.0
2021-11-02 16:05:20.911511 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:05:20.912595 (MainThread): Tracking: tracking
2021-11-02 16:05:20.922913 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112fa9340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114f3a2b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114f3aa00>]}
2021-11-02 16:05:20.941240 (MainThread): Partial parsing not enabled
2021-11-02 16:05:20.966123 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:05:20.967127 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:05:20.967638 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:05:20.968406 (MainThread): Parsing macros/etc.sql
2021-11-02 16:05:20.970758 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:05:20.976787 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:05:21.000155 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:05:21.002704 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:05:21.005209 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:05:21.014812 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:05:21.017814 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:05:21.032501 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:05:21.034227 (MainThread): Parsing macros/core.sql
2021-11-02 16:05:21.037772 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:05:21.044149 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:05:21.053716 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:05:21.055270 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:05:21.071716 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:05:21.103374 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:05:21.125514 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:05:21.127168 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:05:21.136636 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:05:21.155447 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:05:21.168569 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:05:21.175709 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:05:21.182438 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:05:21.186038 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:05:21.187370 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:05:21.188225 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:05:21.189623 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:05:21.197478 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:05:21.199074 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:05:21.201275 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:05:21.202739 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:05:21.254656 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:05:21.256272 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:05:21.257342 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:05:21.258550 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:05:21.260649 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:05:21.261606 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:05:21.262812 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:05:21.263708 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:05:21.269216 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:05:21.270234 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:05:21.271535 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:05:21.274542 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:05:21.275807 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:05:21.277955 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:05:21.287713 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:05:21.289455 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:05:21.290740 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:05:21.292051 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:05:21.293551 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:05:21.294960 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:05:21.295905 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:05:21.299331 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:05:21.304147 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:05:21.307400 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:05:21.309101 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:05:21.310566 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:05:21.312370 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:05:21.336246 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:05:21.338024 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:05:21.340457 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:05:21.341890 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:05:21.342974 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:05:21.344070 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:05:21.345079 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:05:21.346224 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:05:21.347756 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:05:21.349246 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:05:21.351359 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:05:21.352960 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:05:21.354093 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:05:21.356354 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:05:21.358439 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:05:21.359799 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:05:21.360944 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:05:21.363585 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:05:21.365436 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:05:21.367076 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:05:21.369258 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:05:21.371670 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:05:21.372971 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:05:21.376354 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:05:21.384785 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:05:21.389252 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:05:21.390845 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:05:21.394135 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:05:21.398290 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:05:21.401542 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:05:21.403098 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:05:21.406565 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:05:21.414449 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:05:21.422288 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:05:21.423547 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:05:21.426777 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:05:21.428297 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:05:21.429948 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:05:21.435920 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:05:21.440525 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:05:21.444225 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:05:21.446483 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:05:21.772505 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:05:21.785361 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:05:21.789125 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:05:21.792664 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:05:21.825215 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:05:21.858479 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:05:21.860224 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:05:21.862051 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:05:21.863636 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:05:21.864019 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:05:21.864194 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:05:21.864374 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:05:21.864525 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:05:21.925888 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:05:21.932090 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5d50acd4-032c-4c66-9101-8551908b3f93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112fa9a00>]}
2021-11-02 16:05:21.941681 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:05:21.942162 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5d50acd4-032c-4c66-9101-8551908b3f93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115050400>]}
2021-11-02 16:05:21.942441 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:05:21.943879 (MainThread): 
2021-11-02 16:05:21.944253 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:05:21.945322 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:05:21.945522 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:05:22.366166 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:05:22.366798 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:05:22.377400 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:05:22.681458 (MainThread): 16:05:22 | 
2021-11-02 16:05:22.682157 (MainThread): 16:05:22 | Running 1 on-run-start hook
2021-11-02 16:05:22.682667 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:05:22.684121 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54261), raddr=('142.250.200.10', 443)>
2021-11-02 16:05:22.684577 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54262), raddr=('216.58.212.202', 443)>
2021-11-02 16:05:22.695124 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:05:22.697803 (MainThread): 16:05:22 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:05:22.699049 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:05:22.706330 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:05:25.229833 (MainThread): 16:05:25 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.53s]
2021-11-02 16:05:25.230350 (MainThread): 16:05:25 | 
2021-11-02 16:05:25.230979 (MainThread): 16:05:25 | Concurrency: 4 threads (target='dev')
2021-11-02 16:05:25.231267 (MainThread): 16:05:25 | 
2021-11-02 16:05:25.234851 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:05:25.235233 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:05:25.235698 (Thread-1): 16:05:25 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:05:25.235938 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:05:25.236370 (Thread-2): 16:05:25 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:05:25.236975 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:05:25.237370 (Thread-3): 16:05:25 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:05:25.237844 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:05:25.238131 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:05:25.238761 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:05:25.239008 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:05:25.243236 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:05:25.243496 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:05:25.246355 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:05:25.253818 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:05:25.254403 (Thread-1): finished collecting timing info
2021-11-02 16:05:25.267537 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast( as datetime),
        cast( as datetime),
        month
    )


2021-11-02 16:05:25.274885 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:05:25.275123 (Thread-2): finished collecting timing info
2021-11-02 16:05:25.277037 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:05:25.282916 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:05:25.283152 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:05:25.603857 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Syntax error: Unexpected keyword AS at [7:15]')
2021-11-02 16:05:25.639561 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:05:25.640181 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:05:25.670402 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:05:25.671553 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:05:26.664252 (Thread-3): finished collecting timing info
2021-11-02 16:05:26.665043 (Thread-3): Database Error in model month_spine (models/revenue/month_spine.sql)
  Syntax error: Unexpected keyword AS at [7:15]
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Unexpected keyword AS at [7:15]

(job ID: 7ee9b63b-35c6-4a4f-8cb8-6aff36acd265)

                                                             -----Query Job SQL Follows-----                                                             

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */
   2:
   3:
   4:        select 
   5:
   6:    datetime_diff(
   7:        cast( as datetime),
   8:        cast( as datetime),
   9:        month
  10:    )
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 285, in compile_and_execute
    ctx.node = self.compile(manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/compile.py", line 33, in compile
    return compiler.compile_node(self.node, manifest, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 543, in compile_node
    node = self._compile_node(node, manifest, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 383, in _compile_node
    compiled_node.compiled_sql = jinja.get_rendered(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 598, in get_rendered
    return render_template(template, ctx, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 4, in top-level template code
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 16, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 10, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model month_spine (models/revenue/month_spine.sql)
  Syntax error: Unexpected keyword AS at [7:15]
2021-11-02 16:05:26.671352 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5d50acd4-032c-4c66-9101-8551908b3f93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115199190>]}
2021-11-02 16:05:26.671909 (Thread-3): 16:05:26 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 1.43s]
2021-11-02 16:05:26.672168 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:05:27.911038 (Thread-1): finished collecting timing info
2021-11-02 16:05:27.912452 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5d50acd4-032c-4c66-9101-8551908b3f93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1151b9a30>]}
2021-11-02 16:05:27.912988 (Thread-1): 16:05:27 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.68s]
2021-11-02 16:05:27.914253 (Thread-2): finished collecting timing info
2021-11-02 16:05:27.914805 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5d50acd4-032c-4c66-9101-8551908b3f93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1151b9130>]}
2021-11-02 16:05:27.915275 (Thread-2): 16:05:27 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.68s]
2021-11-02 16:05:27.915541 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:05:27.916060 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:05:27.916431 (Thread-4): 16:05:27 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:05:27.916718 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:05:27.917334 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:05:27.917562 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:05:27.922187 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:05:27.922719 (Thread-4): finished collecting timing info
2021-11-02 16:05:27.925060 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:05:27.931269 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:05:28.233050 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:05:28.234236 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:05:33.002839 (Thread-4): finished collecting timing info
2021-11-02 16:05:33.003917 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5d50acd4-032c-4c66-9101-8551908b3f93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115165490>]}
2021-11-02 16:05:33.004549 (Thread-4): 16:05:33 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 5.09s]
2021-11-02 16:05:33.004850 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:05:33.006786 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:05:33.007418 (MainThread): 16:05:33 | 
2021-11-02 16:05:33.007701 (MainThread): 16:05:33 | Finished running 1 view model, 3 table models, 1 hook in 11.06s.
2021-11-02 16:05:33.007947 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:05:33.008143 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:05:33.008328 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:05:33.008509 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:05:33.008686 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:05:33.020778 (MainThread): 
2021-11-02 16:05:33.021023 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 16:05:33.021194 (MainThread): 
2021-11-02 16:05:33.021356 (MainThread): Database Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 16:05:33.021506 (MainThread):   Syntax error: Unexpected keyword AS at [7:15]
2021-11-02 16:05:33.021663 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 16:05:33.021913 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115050be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1151eb2b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115070af0>]}
2021-11-02 16:05:33.022181 (MainThread): Flushing usage events
2021-11-02 16:06:17.605999 (MainThread): Running with dbt=0.21.0
2021-11-02 16:06:17.908467 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:06:17.909823 (MainThread): Tracking: tracking
2021-11-02 16:06:17.920027 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc57400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbe72e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbe76a0>]}
2021-11-02 16:06:17.937443 (MainThread): Partial parsing not enabled
2021-11-02 16:06:17.961427 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:06:17.962441 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:06:17.962944 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:06:17.963705 (MainThread): Parsing macros/etc.sql
2021-11-02 16:06:17.966128 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:06:17.972038 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:06:17.993716 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:06:17.996121 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:06:17.998495 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:06:18.007275 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:06:18.009929 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:06:18.024525 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:06:18.026202 (MainThread): Parsing macros/core.sql
2021-11-02 16:06:18.029713 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:06:18.036001 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:06:18.045364 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:06:18.046867 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:06:18.063064 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:06:18.094058 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:06:18.115808 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:06:18.117427 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:06:18.126916 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:06:18.146178 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:06:18.159499 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:06:18.169656 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:06:18.177434 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:06:18.181190 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:06:18.182610 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:06:18.183519 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:06:18.184997 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:06:18.193352 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:06:18.195130 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:06:18.197547 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:06:18.199042 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:06:18.251824 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:06:18.253406 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:06:18.254499 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:06:18.255728 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:06:18.257768 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:06:18.258741 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:06:18.259949 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:06:18.260938 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:06:18.266566 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:06:18.267593 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:06:18.268779 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:06:18.272928 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:06:18.274611 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:06:18.278873 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:06:18.291653 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:06:18.293555 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:06:18.294951 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:06:18.296386 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:06:18.297995 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:06:18.299480 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:06:18.300386 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:06:18.303783 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:06:18.309153 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:06:18.312727 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:06:18.314473 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:06:18.316157 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:06:18.317955 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:06:18.344462 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:06:18.346452 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:06:18.348970 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:06:18.350513 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:06:18.351596 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:06:18.352771 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:06:18.353854 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:06:18.355001 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:06:18.356645 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:06:18.358255 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:06:18.360504 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:06:18.362493 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:06:18.363691 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:06:18.366120 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:06:18.368207 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:06:18.369736 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:06:18.371463 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:06:18.374461 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:06:18.376421 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:06:18.378186 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:06:18.380482 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:06:18.383092 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:06:18.384488 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:06:18.387964 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:06:18.397299 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:06:18.401801 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:06:18.403336 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:06:18.406764 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:06:18.410924 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:06:18.414383 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:06:18.415977 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:06:18.419350 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:06:18.427322 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:06:18.435231 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:06:18.436530 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:06:18.439829 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:06:18.441326 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:06:18.442867 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:06:18.449023 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:06:18.453628 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:06:18.457414 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:06:18.459581 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:06:18.804224 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:06:18.817204 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:06:18.821007 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:06:18.824606 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:06:18.856973 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:06:18.890102 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:06:18.892151 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:06:18.894078 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:06:18.895760 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:06:18.896146 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:06:18.896348 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:06:18.896641 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:06:18.896869 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:06:18.954491 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:06:18.960507 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e0f8c6ab-784b-488b-aba9-68f94ab887f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc57c40>]}
2021-11-02 16:06:18.969761 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:06:18.970256 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e0f8c6ab-784b-488b-aba9-68f94ab887f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fcf68e0>]}
2021-11-02 16:06:18.970530 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:06:18.971945 (MainThread): 
2021-11-02 16:06:18.972314 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:06:18.973386 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:06:18.973586 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:06:19.400808 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:06:19.401302 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:06:19.409791 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:06:19.737033 (MainThread): 16:06:19 | 
2021-11-02 16:06:19.737550 (MainThread): 16:06:19 | Running 1 on-run-start hook
2021-11-02 16:06:19.737960 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:06:19.739324 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54281), raddr=('142.250.200.10', 443)>
2021-11-02 16:06:19.739660 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54282), raddr=('216.58.212.202', 443)>
2021-11-02 16:06:19.748442 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:06:19.750755 (MainThread): 16:06:19 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:06:19.751067 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:06:19.758610 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:06:23.111113 (MainThread): 16:06:23 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 3.36s]
2021-11-02 16:06:23.111710 (MainThread): 16:06:23 | 
2021-11-02 16:06:23.112471 (MainThread): 16:06:23 | Concurrency: 4 threads (target='dev')
2021-11-02 16:06:23.112753 (MainThread): 16:06:23 | 
2021-11-02 16:06:23.116310 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:06:23.116693 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:06:23.117148 (Thread-1): 16:06:23 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:06:23.117383 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:06:23.117803 (Thread-2): 16:06:23 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:06:23.118367 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:06:23.118706 (Thread-3): 16:06:23 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:06:23.119173 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:06:23.119425 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:06:23.120080 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:06:23.120333 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:06:23.124638 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:06:23.124835 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:06:23.127629 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:06:23.134949 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:06:23.135228 (Thread-1): finished collecting timing info
2021-11-02 16:06:23.148423 (Thread-2): finished collecting timing info
2021-11-02 16:06:23.155109 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:06:23.156986 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:06:23.159852 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast( as datetime),
        cast( as datetime),
        month
    )


2021-11-02 16:06:23.162573 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:06:23.164535 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:06:23.495719 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:06:23.496332 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:06:23.499792 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Syntax error: Unexpected keyword AS at [7:15]')
2021-11-02 16:06:23.510820 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:06:23.511905 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:06:24.654085 (Thread-3): finished collecting timing info
2021-11-02 16:06:24.655063 (Thread-3): Database Error in model month_spine (models/revenue/month_spine.sql)
  Syntax error: Unexpected keyword AS at [7:15]
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Unexpected keyword AS at [7:15]

(job ID: b70d2873-0d90-4956-84b5-1d2ec2ed4ab7)

                                                             -----Query Job SQL Follows-----                                                             

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */
   2:
   3:
   4:        select 
   5:
   6:    datetime_diff(
   7:        cast( as datetime),
   8:        cast( as datetime),
   9:        month
  10:    )
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 285, in compile_and_execute
    ctx.node = self.compile(manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/compile.py", line 33, in compile
    return compiler.compile_node(self.node, manifest, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 543, in compile_node
    node = self._compile_node(node, manifest, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 383, in _compile_node
    compiled_node.compiled_sql = jinja.get_rendered(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 598, in get_rendered
    return render_template(template, ctx, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 4, in top-level template code
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 16, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 10, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model month_spine (models/revenue/month_spine.sql)
  Syntax error: Unexpected keyword AS at [7:15]
2021-11-02 16:06:24.661497 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0f8c6ab-784b-488b-aba9-68f94ab887f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd8cb20>]}
2021-11-02 16:06:24.662043 (Thread-3): 16:06:24 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 1.54s]
2021-11-02 16:06:24.662300 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:06:25.579086 (Thread-2): finished collecting timing info
2021-11-02 16:06:25.580021 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0f8c6ab-784b-488b-aba9-68f94ab887f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd08550>]}
2021-11-02 16:06:25.580563 (Thread-2): 16:06:25 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.46s]
2021-11-02 16:06:25.581140 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:06:25.785479 (Thread-1): finished collecting timing info
2021-11-02 16:06:25.786723 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0f8c6ab-784b-488b-aba9-68f94ab887f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fdc64c0>]}
2021-11-02 16:06:25.787432 (Thread-1): 16:06:25 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.67s]
2021-11-02 16:06:25.787740 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:06:25.788687 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:06:25.789164 (Thread-4): 16:06:25 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:06:25.789760 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:06:25.790036 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:06:25.796724 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:06:25.797435 (Thread-4): finished collecting timing info
2021-11-02 16:06:25.800204 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:06:25.807607 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:06:26.112565 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:06:26.113809 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:06:30.062884 (Thread-4): finished collecting timing info
2021-11-02 16:06:30.063901 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0f8c6ab-784b-488b-aba9-68f94ab887f0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111144ee0>]}
2021-11-02 16:06:30.064497 (Thread-4): 16:06:30 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.27s]
2021-11-02 16:06:30.064798 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:06:30.066782 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:06:30.067577 (MainThread): 16:06:30 | 
2021-11-02 16:06:30.067898 (MainThread): 16:06:30 | Finished running 1 view model, 3 table models, 1 hook in 11.10s.
2021-11-02 16:06:30.068165 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:06:30.068492 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:06:30.068714 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:06:30.068910 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:06:30.069098 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:06:30.081255 (MainThread): 
2021-11-02 16:06:30.081516 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 16:06:30.081692 (MainThread): 
2021-11-02 16:06:30.081859 (MainThread): Database Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 16:06:30.082011 (MainThread):   Syntax error: Unexpected keyword AS at [7:15]
2021-11-02 16:06:30.082169 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 16:06:30.082424 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe93430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fcf6700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe6c8b0>]}
2021-11-02 16:06:30.082744 (MainThread): Flushing usage events
2021-11-02 16:06:36.662952 (MainThread): Running with dbt=0.21.0
2021-11-02 16:06:36.964857 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:06:36.966147 (MainThread): Tracking: tracking
2021-11-02 16:06:36.977320 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111662400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1135f3970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1135f3730>]}
2021-11-02 16:06:36.995424 (MainThread): Partial parsing not enabled
2021-11-02 16:06:37.019195 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:06:37.020209 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:06:37.020727 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:06:37.021470 (MainThread): Parsing macros/etc.sql
2021-11-02 16:06:37.023790 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:06:37.029717 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:06:37.055592 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:06:37.058060 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:06:37.060575 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:06:37.070205 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:06:37.072873 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:06:37.086494 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:06:37.088063 (MainThread): Parsing macros/core.sql
2021-11-02 16:06:37.091540 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:06:37.097857 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:06:37.107121 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:06:37.108686 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:06:37.124942 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:06:37.156230 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:06:37.178118 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:06:37.179855 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:06:37.189196 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:06:37.207996 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:06:37.221585 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:06:37.229101 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:06:37.236137 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:06:37.239690 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:06:37.241038 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:06:37.241898 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:06:37.243255 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:06:37.251249 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:06:37.252834 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:06:37.254994 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:06:37.256520 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:06:37.309033 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:06:37.310857 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:06:37.311935 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:06:37.313130 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:06:37.315105 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:06:37.316053 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:06:37.317179 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:06:37.318076 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:06:37.323490 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:06:37.324509 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:06:37.325678 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:06:37.328480 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:06:37.329423 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:06:37.331465 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:06:37.340644 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:06:37.342409 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:06:37.343752 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:06:37.345045 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:06:37.346624 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:06:37.348018 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:06:37.348906 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:06:37.352171 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:06:37.357016 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:06:37.360307 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:06:37.361962 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:06:37.363427 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:06:37.365157 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:06:37.388562 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:06:37.390325 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:06:37.392683 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:06:37.394302 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:06:37.395332 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:06:37.396475 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:06:37.397494 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:06:37.398595 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:06:37.400127 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:06:37.401610 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:06:37.403712 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:06:37.405298 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:06:37.406417 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:06:37.408636 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:06:37.410714 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:06:37.412021 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:06:37.413165 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:06:37.415746 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:06:37.417564 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:06:37.419201 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:06:37.421405 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:06:37.423860 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:06:37.425164 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:06:37.428495 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:06:37.436943 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:06:37.441192 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:06:37.442771 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:06:37.446154 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:06:37.450205 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:06:37.453406 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:06:37.454966 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:06:37.458293 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:06:37.465893 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:06:37.473491 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:06:37.474703 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:06:37.478067 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:06:37.479551 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:06:37.481045 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:06:37.487284 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:06:37.492130 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:06:37.496178 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:06:37.498443 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:06:37.829078 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:06:37.841921 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:06:37.845789 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:06:37.849455 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:06:37.858690 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:06:37.891426 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:06:37.893139 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:06:37.895217 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:06:37.896818 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:06:37.897293 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:06:37.897485 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:06:37.897680 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:06:37.897831 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:06:37.956425 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:06:37.962646 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ea1dd3f6-16a7-4142-9db9-21cfb605f161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1135d8550>]}
2021-11-02 16:06:37.972132 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:06:37.972654 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ea1dd3f6-16a7-4142-9db9-21cfb605f161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137202e0>]}
2021-11-02 16:06:37.972943 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:06:37.974421 (MainThread): 
2021-11-02 16:06:37.974810 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:06:37.975900 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:06:37.976094 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:06:38.423424 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:06:38.424063 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:06:38.436155 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:06:38.751219 (MainThread): 16:06:38 | 
2021-11-02 16:06:38.751731 (MainThread): 16:06:38 | Running 1 on-run-start hook
2021-11-02 16:06:38.752102 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:06:38.755802 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54301), raddr=('142.250.200.10', 443)>
2021-11-02 16:06:38.756178 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54302), raddr=('216.58.212.202', 443)>
2021-11-02 16:06:38.759085 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:06:38.761785 (MainThread): 16:06:38 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:06:38.762124 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:06:38.770927 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:06:41.302195 (MainThread): 16:06:41 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.54s]
2021-11-02 16:06:41.302781 (MainThread): 16:06:41 | 
2021-11-02 16:06:41.303558 (MainThread): 16:06:41 | Concurrency: 4 threads (target='dev')
2021-11-02 16:06:41.303845 (MainThread): 16:06:41 | 
2021-11-02 16:06:41.312285 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:06:41.312634 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:06:41.313039 (Thread-1): 16:06:41 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:06:41.313240 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:06:41.313611 (Thread-2): 16:06:41 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:06:41.314174 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:06:41.314516 (Thread-3): 16:06:41 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:06:41.314986 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:06:41.315235 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:06:41.315666 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:06:41.315883 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:06:41.319391 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:06:41.319592 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:06:41.322391 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:06:41.324255 (Thread-3): Writing injected SQL for node "model.freetrade_test.month_spine"
2021-11-02 16:06:41.324789 (Thread-1): finished collecting timing info
2021-11-02 16:06:41.337588 (Thread-2): finished collecting timing info
2021-11-02 16:06:41.343412 (Thread-3): finished collecting timing info
2021-11-02 16:06:41.344733 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:06:41.346516 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:06:41.368079 (Thread-3): Writing runtime SQL for node "model.freetrade_test.month_spine"
2021-11-02 16:06:41.368955 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:06:41.373726 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:06:41.374477 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:06:41.374717 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


  create or replace view `ft-data-330317`.`ft_data`.`month_spine`
  OPTIONS()
  as SELECT min(created_at) min_date, max(created_at) max_date
FROM `ft-data-330317.ft_source_data.subscriptions`;


2021-11-02 16:06:41.719149 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:06:41.720476 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:06:41.721008 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:06:41.722212 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:06:42.300164 (Thread-3): finished collecting timing info
2021-11-02 16:06:42.300840 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea1dd3f6-16a7-4142-9db9-21cfb605f161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113809f70>]}
2021-11-02 16:06:42.301359 (Thread-3): 16:06:42 | 3 of 4 OK created view model ft_data.month_spine..................... [OK in 0.99s]
2021-11-02 16:06:42.301612 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:06:43.584384 (Thread-2): finished collecting timing info
2021-11-02 16:06:43.585590 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea1dd3f6-16a7-4142-9db9-21cfb605f161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113706670>]}
2021-11-02 16:06:43.586412 (Thread-2): 16:06:43 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.27s]
2021-11-02 16:06:43.586743 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:06:43.901954 (Thread-1): finished collecting timing info
2021-11-02 16:06:43.902945 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea1dd3f6-16a7-4142-9db9-21cfb605f161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113809070>]}
2021-11-02 16:06:43.903694 (Thread-1): 16:06:43 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.59s]
2021-11-02 16:06:43.904023 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:06:43.904738 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:06:43.905172 (Thread-4): 16:06:43 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:06:43.905944 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:06:43.906234 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:06:43.912556 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:06:43.913267 (Thread-4): finished collecting timing info
2021-11-02 16:06:43.916299 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:06:43.923841 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:06:44.227484 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:06:44.228654 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:06:48.656364 (Thread-4): finished collecting timing info
2021-11-02 16:06:48.657198 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea1dd3f6-16a7-4142-9db9-21cfb605f161', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114a41ee0>]}
2021-11-02 16:06:48.657806 (Thread-4): 16:06:48 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.75s]
2021-11-02 16:06:48.658105 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:06:48.660110 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:06:48.660756 (MainThread): 16:06:48 | 
2021-11-02 16:06:48.661043 (MainThread): 16:06:48 | Finished running 1 view model, 3 table models, 1 hook in 10.69s.
2021-11-02 16:06:48.661292 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:06:48.661616 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:06:48.661840 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:06:48.662036 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:06:48.662223 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:06:48.674222 (MainThread): 
2021-11-02 16:06:48.674476 (MainThread): Completed successfully
2021-11-02 16:06:48.674658 (MainThread): 
Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
2021-11-02 16:06:48.674919 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1135e8b20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137200d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137207f0>]}
2021-11-02 16:06:48.675182 (MainThread): Flushing usage events
2021-11-02 16:08:36.545178 (MainThread): Running with dbt=0.21.0
2021-11-02 16:08:36.848245 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:08:36.849646 (MainThread): Tracking: tracking
2021-11-02 16:08:36.860603 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b6d430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aafcaf0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aafc610>]}
2021-11-02 16:08:36.878252 (MainThread): Partial parsing not enabled
2021-11-02 16:08:36.902417 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:08:36.903444 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:08:36.903959 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:08:36.904765 (MainThread): Parsing macros/etc.sql
2021-11-02 16:08:36.907259 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:08:36.913469 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:08:36.935475 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:08:36.937860 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:08:36.940224 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:08:36.949548 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:08:36.952406 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:08:36.966948 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:08:36.969320 (MainThread): Parsing macros/core.sql
2021-11-02 16:08:36.972898 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:08:36.979196 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:08:36.989164 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:08:36.990911 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:08:37.007773 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:08:37.039800 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:08:37.061953 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:08:37.063574 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:08:37.073205 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:08:37.092626 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:08:37.105766 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:08:37.113189 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:08:37.119979 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:08:37.123744 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:08:37.125248 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:08:37.126120 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:08:37.127591 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:08:37.136065 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:08:37.137905 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:08:37.140186 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:08:37.141775 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:08:37.195029 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:08:37.196806 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:08:37.198057 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:08:37.199333 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:08:37.201469 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:08:37.202475 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:08:37.203782 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:08:37.204738 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:08:37.210421 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:08:37.211498 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:08:37.212731 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:08:37.215686 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:08:37.216685 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:08:37.218834 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:08:37.228336 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:08:37.230111 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:08:37.231405 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:08:37.232719 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:08:37.234238 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:08:37.235727 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:08:37.236693 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:08:37.240081 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:08:37.245087 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:08:37.248450 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:08:37.250125 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:08:37.251643 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:08:37.253400 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:08:37.277698 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:08:37.279467 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:08:37.281927 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:08:37.283420 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:08:37.284504 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:08:37.285647 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:08:37.286702 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:08:37.287839 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:08:37.289427 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:08:37.291018 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:08:37.293177 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:08:37.294827 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:08:37.295995 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:08:37.298241 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:08:37.300196 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:08:37.301664 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:08:37.302846 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:08:37.305463 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:08:37.307565 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:08:37.309230 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:08:37.311390 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:08:37.313822 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:08:37.315143 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:08:37.318473 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:08:37.326856 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:08:37.331211 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:08:37.332692 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:08:37.335964 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:08:37.339995 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:08:37.343337 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:08:37.344889 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:08:37.348440 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:08:37.355979 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:08:37.363767 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:08:37.365003 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:08:37.368242 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:08:37.369853 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:08:37.371368 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:08:37.377585 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:08:37.382253 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:08:37.386172 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:08:37.388319 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:08:37.724456 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:08:37.737212 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:08:37.741197 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:08:37.745021 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:08:37.754488 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:08:37.788384 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:08:37.790095 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:08:37.792155 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:08:37.793783 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:08:37.794179 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:08:37.794354 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:08:37.794534 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:08:37.794684 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:08:37.854181 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:08:37.860591 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '61841f10-bd2d-4f0c-876f-d06ff6f2f7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac2b940>]}
2021-11-02 16:08:37.870446 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:08:37.870836 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '61841f10-bd2d-4f0c-876f-d06ff6f2f7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aaf0b50>]}
2021-11-02 16:08:37.871110 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:08:37.872513 (MainThread): 
2021-11-02 16:08:37.872870 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:08:37.873903 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:08:37.874097 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:08:38.347113 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:08:38.347748 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:08:38.359993 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:08:38.720128 (MainThread): 16:08:38 | 
2021-11-02 16:08:38.720685 (MainThread): 16:08:38 | Running 1 on-run-start hook
2021-11-02 16:08:38.721091 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:08:38.725067 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54347), raddr=('142.250.179.234', 443)>
2021-11-02 16:08:38.725416 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54348), raddr=('216.58.212.202', 443)>
2021-11-02 16:08:38.728239 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:08:38.730856 (MainThread): 16:08:38 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:08:38.731191 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:08:38.739851 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:08:41.222819 (MainThread): 16:08:41 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.49s]
2021-11-02 16:08:41.223402 (MainThread): 16:08:41 | 
2021-11-02 16:08:41.224197 (MainThread): 16:08:41 | Concurrency: 4 threads (target='dev')
2021-11-02 16:08:41.224490 (MainThread): 16:08:41 | 
2021-11-02 16:08:41.232756 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:08:41.233103 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:08:41.233500 (Thread-1): 16:08:41 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:08:41.233702 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:08:41.234065 (Thread-2): 16:08:41 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:08:41.234587 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:08:41.234933 (Thread-3): 16:08:41 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:08:41.235408 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:08:41.235657 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:08:41.236093 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:08:41.236373 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:08:41.239937 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:08:41.240145 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:08:41.243037 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:08:41.244957 (Thread-3): Writing injected SQL for node "model.freetrade_test.month_spine"
2021-11-02 16:08:41.245411 (Thread-1): finished collecting timing info
2021-11-02 16:08:41.257106 (Thread-2): finished collecting timing info
2021-11-02 16:08:41.269205 (Thread-3): finished collecting timing info
2021-11-02 16:08:41.278241 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:08:41.285059 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:08:41.300424 (Thread-3): Writing runtime SQL for node "model.freetrade_test.month_spine"
2021-11-02 16:08:41.301471 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:08:41.305858 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:08:41.306626 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:08:41.307138 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


  create or replace view `ft-data-330317`.`ft_data`.`month_spine`
  OPTIONS()
  as SELECT DATE(min(created_at)) min_date, DATE(CURRENT_DATE()) max_date
FROM `ft-data-330317.ft_source_data.subscriptions`;


2021-11-02 16:08:41.609633 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:08:41.610321 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:08:41.625062 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:08:41.625965 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:08:42.198716 (Thread-3): finished collecting timing info
2021-11-02 16:08:42.199406 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61841f10-bd2d-4f0c-876f-d06ff6f2f7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10abf9c70>]}
2021-11-02 16:08:42.199923 (Thread-3): 16:08:42 | 3 of 4 OK created view model ft_data.month_spine..................... [OK in 0.96s]
2021-11-02 16:08:42.200185 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:08:43.789465 (Thread-2): finished collecting timing info
2021-11-02 16:08:43.790474 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61841f10-bd2d-4f0c-876f-d06ff6f2f7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad2a1f0>]}
2021-11-02 16:08:43.791242 (Thread-2): 16:08:43 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.56s]
2021-11-02 16:08:43.791584 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:08:43.835878 (Thread-1): finished collecting timing info
2021-11-02 16:08:43.836644 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61841f10-bd2d-4f0c-876f-d06ff6f2f7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad706d0>]}
2021-11-02 16:08:43.837226 (Thread-1): 16:08:43 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.60s]
2021-11-02 16:08:43.837537 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:08:43.838435 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:08:43.838861 (Thread-4): 16:08:43 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:08:43.839541 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:08:43.839921 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:08:43.845640 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:08:43.846158 (Thread-4): finished collecting timing info
2021-11-02 16:08:43.848555 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:08:43.855517 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:08:44.170158 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:08:44.171276 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:08:48.493800 (Thread-4): finished collecting timing info
2021-11-02 16:08:48.494896 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61841f10-bd2d-4f0c-876f-d06ff6f2f7c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10af33fa0>]}
2021-11-02 16:08:48.495568 (Thread-4): 16:08:48 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.66s]
2021-11-02 16:08:48.495878 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:08:48.497863 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:08:48.498499 (MainThread): 16:08:48 | 
2021-11-02 16:08:48.498791 (MainThread): 16:08:48 | Finished running 1 view model, 3 table models, 1 hook in 10.63s.
2021-11-02 16:08:48.499044 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:08:48.499252 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:08:48.499449 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:08:48.499639 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:08:48.499827 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:08:48.512102 (MainThread): 
2021-11-02 16:08:48.512360 (MainThread): Completed successfully
2021-11-02 16:08:48.512546 (MainThread): 
Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
2021-11-02 16:08:48.512808 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aad9dc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aadfb20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aae9d30>]}
2021-11-02 16:08:48.513084 (MainThread): Flushing usage events
2021-11-02 16:10:47.640036 (MainThread): Running with dbt=0.21.0
2021-11-02 16:10:47.957743 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:10:47.958587 (MainThread): Tracking: tracking
2021-11-02 16:10:47.969709 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a0ac370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c03d1c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c03d7c0>]}
2021-11-02 16:10:47.989010 (MainThread): Partial parsing not enabled
2021-11-02 16:10:48.015952 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:10:48.016935 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:10:48.017437 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:10:48.018207 (MainThread): Parsing macros/etc.sql
2021-11-02 16:10:48.020557 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:10:48.026664 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:10:48.051819 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:10:48.054323 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:10:48.056795 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:10:48.067675 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:10:48.070284 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:10:48.084716 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:10:48.086426 (MainThread): Parsing macros/core.sql
2021-11-02 16:10:48.089932 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:10:48.096351 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:10:48.105678 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:10:48.107220 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:10:48.123415 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:10:48.154263 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:10:48.175950 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:10:48.177521 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:10:48.187075 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:10:48.205930 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:10:48.219165 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:10:48.226869 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:10:48.234005 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:10:48.237738 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:10:48.239116 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:10:48.239990 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:10:48.241377 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:10:48.249217 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:10:48.250795 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:10:48.252956 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:10:48.254481 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:10:48.308516 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:10:48.310087 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:10:48.311199 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:10:48.312397 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:10:48.314431 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:10:48.315377 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:10:48.316491 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:10:48.317396 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:10:48.323208 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:10:48.324270 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:10:48.325534 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:10:48.328330 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:10:48.329305 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:10:48.331415 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:10:48.340876 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:10:48.342613 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:10:48.343882 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:10:48.345173 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:10:48.346668 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:10:48.348103 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:10:48.348963 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:10:48.352244 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:10:48.357245 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:10:48.360517 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:10:48.362162 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:10:48.363711 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:10:48.365432 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:10:48.389285 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:10:48.390945 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:10:48.393362 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:10:48.394785 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:10:48.395786 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:10:48.396883 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:10:48.397887 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:10:48.398986 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:10:48.400496 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:10:48.401977 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:10:48.404184 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:10:48.405850 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:10:48.406964 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:10:48.409166 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:10:48.411081 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:10:48.412398 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:10:48.413682 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:10:48.416298 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:10:48.418094 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:10:48.419988 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:10:48.422227 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:10:48.424604 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:10:48.425985 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:10:48.429288 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:10:48.437849 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:10:48.442126 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:10:48.443593 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:10:48.446902 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:10:48.450848 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:10:48.454036 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:10:48.455603 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:10:48.458864 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:10:48.466578 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:10:48.474494 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:10:48.475766 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:10:48.478932 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:10:48.480400 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:10:48.482281 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:10:48.488478 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:10:48.495223 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:10:48.503696 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:10:48.508241 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:10:48.890463 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:10:48.904380 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:10:48.908774 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:10:48.912805 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:10:48.948308 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:10:48.984418 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:10:48.986507 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:10:48.988560 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:10:48.990441 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:10:48.990874 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:10:48.991047 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:10:48.991199 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:10:48.991345 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:10:49.047528 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:10:49.053823 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2fb94e78-9a40-48c4-9e97-71a070c64296', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a0ac9a0>]}
2021-11-02 16:10:49.063572 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:10:49.064068 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2fb94e78-9a40-48c4-9e97-71a070c64296', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c153400>]}
2021-11-02 16:10:49.064334 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:10:49.065729 (MainThread): 
2021-11-02 16:10:49.066173 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:10:49.067344 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:10:49.067568 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:10:49.493366 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:10:49.494004 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:10:49.506954 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:10:49.846397 (MainThread): 16:10:49 | 
2021-11-02 16:10:49.846805 (MainThread): 16:10:49 | Running 1 on-run-start hook
2021-11-02 16:10:49.847090 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:10:49.848454 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54373), raddr=('142.250.179.234', 443)>
2021-11-02 16:10:49.848807 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54374), raddr=('216.58.212.202', 443)>
2021-11-02 16:10:49.857902 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:10:49.860203 (MainThread): 16:10:49 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:10:49.860558 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:10:49.867908 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:10:52.582063 (MainThread): 16:10:52 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.72s]
2021-11-02 16:10:52.582395 (MainThread): 16:10:52 | 
2021-11-02 16:10:52.582912 (MainThread): 16:10:52 | Concurrency: 4 threads (target='dev')
2021-11-02 16:10:52.583132 (MainThread): 16:10:52 | 
2021-11-02 16:10:52.585970 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:10:52.586234 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:10:52.586480 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:10:52.586796 (Thread-1): 16:10:52 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:10:52.587084 (Thread-2): 16:10:52 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:10:52.587306 (Thread-3): 16:10:52 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:10:52.587752 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:10:52.588091 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:10:52.588277 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:10:52.588750 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:10:52.588974 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:10:52.592817 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:10:52.593089 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:10:52.596376 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:10:52.603737 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:10:52.604170 (Thread-1): finished collecting timing info
2021-11-02 16:10:52.610716 (Thread-2): finished collecting timing info
2021-11-02 16:10:52.628546 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:10:52.633605 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:10:52.633923 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(cast('2020-01-01' as date) as datetime),
        cast(cast('2019-01-01' as date) as datetime),
        day
    )


2021-11-02 16:10:52.640517 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:10:52.641422 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:10:52.976595 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:10:52.977075 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:10:52.978310 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:10:52.979188 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:10:53.522442 (Thread-3): Writing injected SQL for node "model.freetrade_test.month_spine"
2021-11-02 16:10:53.523281 (Thread-3): finished collecting timing info
2021-11-02 16:10:53.546848 (Thread-3): Writing runtime SQL for node "model.freetrade_test.month_spine"
2021-11-02 16:10:53.547418 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


  create or replace view `ft-data-330317`.`ft_data`.`month_spine`
  OPTIONS()
  as WITH args AS (SELECT DATE(min(created_at)) min_date, DATE(CURRENT_DATE()) max_date
FROM `ft-data-330317.ft_source_data.subscriptions`)

SELECT * FROM 

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
     + 
    
    p4.generated_number * power(2, 4)
     + 
    
    p5.generated_number * power(2, 5)
     + 
    
    p6.generated_number * power(2, 6)
     + 
    
    p7.generated_number * power(2, 7)
     + 
    
    p8.generated_number * power(2, 8)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
     cross join 
    
    p as p4
     cross join 
    
    p as p5
     cross join 
    
    p as p6
     cross join 
    
    p as p7
     cross join 
    
    p as p8
    
    

    )

    select *
    from unioned
    where generated_number <= 365
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2019-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 day
        )


    ) as date_day
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_day <= cast('2020-01-01' as date)

)

select * from filtered

;


2021-11-02 16:10:53.654813 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Syntax error: Unexpected keyword WITH at [22:1]')
2021-11-02 16:10:54.011528 (Thread-3): finished collecting timing info
2021-11-02 16:10:54.012394 (Thread-3): Database Error in model month_spine (models/revenue/month_spine.sql)
  Syntax error: Unexpected keyword WITH at [22:1]
  compiled SQL at target/run/freetrade_test/models/revenue/month_spine.sql
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Unexpected keyword WITH at [22:1]

(job ID: a5170e48-7af3-4ad9-b9bc-1276e6b100c6)

                                                             -----Query Job SQL Follows-----                                                             

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */
   2:
   3:
   4:  create or replace view `ft-data-330317`.`ft_data`.`month_spine`
   5:  OPTIONS()
   6:  as WITH args AS (SELECT DATE(min(created_at)) min_date, DATE(CURRENT_DATE()) max_date
   7:FROM `ft-data-330317.ft_source_data.subscriptions`)
   8:
   9:SELECT * FROM 
  10:
  11:/*
  12:call as follows:
  13:
  14:date_spine(
  15:    "day",
  16:    "to_date('01/01/2016', 'mm/dd/yyyy')",
  17:    "dateadd(week, 1, current_date)"
  18:)
  19:
  20:*/
  21:
  22:with rawdata as (
  23:
  24:    
  25:
  26:    
  27:
  28:    with p as (
  29:        select 0 as generated_number union all select 1
  30:    ), unioned as (
  31:
  32:    select
  33:
  34:    
  35:    p0.generated_number * power(2, 0)
  36:     + 
  37:    
  38:    p1.generated_number * power(2, 1)
  39:     + 
  40:    
  41:    p2.generated_number * power(2, 2)
  42:     + 
  43:    
  44:    p3.generated_number * power(2, 3)
  45:     + 
  46:    
  47:    p4.generated_number * power(2, 4)
  48:     + 
  49:    
  50:    p5.generated_number * power(2, 5)
  51:     + 
  52:    
  53:    p6.generated_number * power(2, 6)
  54:     + 
  55:    
  56:    p7.generated_number * power(2, 7)
  57:     + 
  58:    
  59:    p8.generated_number * power(2, 8)
  60:    
  61:    
  62:    + 1
  63:    as generated_number
  64:
  65:    from
  66:
  67:    
  68:    p as p0
  69:     cross join 
  70:    
  71:    p as p1
  72:     cross join 
  73:    
  74:    p as p2
  75:     cross join 
  76:    
  77:    p as p3
  78:     cross join 
  79:    
  80:    p as p4
  81:     cross join 
  82:    
  83:    p as p5
  84:     cross join 
  85:    
  86:    p as p6
  87:     cross join 
  88:    
  89:    p as p7
  90:     cross join 
  91:    
  92:    p as p8
  93:    
  94:    
  95:
  96:    )
  97:
  98:    select *
  99:    from unioned
 100:    where generated_number <= 365
 101:    order by generated_number
 102:
 103:
 104:
 105:),
 106:
 107:all_periods as (
 108:
 109:    select (
 110:        
 111:
 112:        datetime_add(
 113:            cast( cast('2019-01-01' as date) as datetime),
 114:        interval row_number() over (order by 1) - 1 day
 115:        )
 116:
 117:
 118:    ) as date_day
 119:    from rawdata
 120:
 121:),
 122:
 123:filtered as (
 124:
 125:    select *
 126:    from all_periods
 127:    where date_day <= cast('2020-01-01' as date)
 128:
 129:)
 130:
 131:select * from filtered
 132:
 133:;
 134:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 291, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 393, in run
    return self.execute(compiled_node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 249, in execute
    result = MacroGenerator(materialization_macro, context)()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 22, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 55, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 41, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model month_spine (models/revenue/month_spine.sql)
  Syntax error: Unexpected keyword WITH at [22:1]
  compiled SQL at target/run/freetrade_test/models/revenue/month_spine.sql
2021-11-02 16:10:54.019828 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2fb94e78-9a40-48c4-9e97-71a070c64296', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c48c220>]}
2021-11-02 16:10:54.020421 (Thread-3): 16:10:54 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 1.43s]
2021-11-02 16:10:54.020781 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:10:54.855817 (Thread-2): finished collecting timing info
2021-11-02 16:10:54.856522 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2fb94e78-9a40-48c4-9e97-71a070c64296', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c21d7f0>]}
2021-11-02 16:10:54.857032 (Thread-2): 16:10:54 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.27s]
2021-11-02 16:10:54.857281 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:10:55.691935 (Thread-1): finished collecting timing info
2021-11-02 16:10:55.692504 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2fb94e78-9a40-48c4-9e97-71a070c64296', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c2e3d90>]}
2021-11-02 16:10:55.693091 (Thread-1): 16:10:55 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 3.10s]
2021-11-02 16:10:55.693400 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:10:55.694201 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:10:55.694701 (Thread-4): 16:10:55 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:10:55.695155 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:10:55.695336 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:10:55.701645 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:10:55.702411 (Thread-4): finished collecting timing info
2021-11-02 16:10:55.704886 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:10:55.711675 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:10:56.033293 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:10:56.034301 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:11:00.448772 (Thread-4): finished collecting timing info
2021-11-02 16:11:00.449855 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2fb94e78-9a40-48c4-9e97-71a070c64296', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c1fe280>]}
2021-11-02 16:11:00.450549 (Thread-4): 16:11:00 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.75s]
2021-11-02 16:11:00.450843 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:11:00.452860 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:11:00.453483 (MainThread): 16:11:00 | 
2021-11-02 16:11:00.453763 (MainThread): 16:11:00 | Finished running 1 view model, 3 table models, 1 hook in 11.39s.
2021-11-02 16:11:00.454020 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:11:00.454217 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:11:00.454401 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:11:00.454582 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:11:00.454760 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:11:00.461723 (MainThread): unclosed <ssl.SSLSocket fd=23, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54384), raddr=('216.58.212.202', 443)>
2021-11-02 16:11:00.462051 (MainThread): unclosed <ssl.SSLSocket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54381), raddr=('142.250.179.234', 443)>
2021-11-02 16:11:00.462300 (MainThread): unclosed <ssl.SSLSocket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54380), raddr=('142.250.179.234', 443)>
2021-11-02 16:11:00.462526 (MainThread): unclosed <ssl.SSLSocket fd=21, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54382), raddr=('216.58.212.202', 443)>
2021-11-02 16:11:00.462818 (MainThread): unclosed <ssl.SSLSocket fd=25, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54386), raddr=('216.58.212.202', 443)>
2021-11-02 16:11:00.462986 (MainThread): unclosed <ssl.SSLSocket fd=24, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54385), raddr=('142.250.179.234', 443)>
2021-11-02 16:11:00.469627 (MainThread): 
2021-11-02 16:11:00.469873 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 16:11:00.470043 (MainThread): 
2021-11-02 16:11:00.470203 (MainThread): Database Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 16:11:00.470349 (MainThread):   Syntax error: Unexpected keyword WITH at [22:1]
2021-11-02 16:11:00.470484 (MainThread):   compiled SQL at target/run/freetrade_test/models/revenue/month_spine.sql
2021-11-02 16:11:00.470637 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 16:11:00.470886 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c1515e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c563220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5630a0>]}
2021-11-02 16:11:00.471148 (MainThread): Flushing usage events
2021-11-02 16:13:17.721510 (MainThread): Running with dbt=0.21.0
2021-11-02 16:13:18.026878 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:13:18.027956 (MainThread): Tracking: tracking
2021-11-02 16:13:18.038744 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103f3f370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105ed02b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105ed0a00>]}
2021-11-02 16:13:18.056458 (MainThread): Partial parsing not enabled
2021-11-02 16:13:18.080360 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:13:18.081373 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:13:18.081868 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:13:18.082618 (MainThread): Parsing macros/etc.sql
2021-11-02 16:13:18.084944 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:13:18.090865 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:13:18.112115 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:13:18.114563 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:13:18.116904 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:13:18.125771 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:13:18.128386 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:13:18.142933 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:13:18.144623 (MainThread): Parsing macros/core.sql
2021-11-02 16:13:18.148087 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:13:18.154618 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:13:18.164112 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:13:18.165702 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:13:18.181839 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:13:18.212800 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:13:18.234966 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:13:18.236568 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:13:18.245933 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:13:18.264665 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:13:18.281818 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:13:18.290545 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:13:18.297930 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:13:18.301873 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:13:18.303426 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:13:18.304402 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:13:18.305859 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:13:18.314055 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:13:18.315704 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:13:18.317967 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:13:18.319419 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:13:18.374901 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:13:18.376533 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:13:18.377650 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:13:18.378893 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:13:18.381149 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:13:18.382529 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:13:18.384556 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:13:18.385756 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:13:18.392007 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:13:18.393105 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:13:18.394350 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:13:18.397258 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:13:18.398268 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:13:18.400449 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:13:18.410755 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:13:18.412644 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:13:18.414039 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:13:18.415382 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:13:18.416932 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:13:18.418454 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:13:18.419344 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:13:18.422806 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:13:18.428039 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:13:18.431369 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:13:18.433218 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:13:18.434789 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:13:18.436739 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:13:18.461863 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:13:18.463698 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:13:18.466229 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:13:18.467740 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:13:18.468776 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:13:18.469903 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:13:18.470938 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:13:18.472089 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:13:18.473819 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:13:18.475361 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:13:18.477542 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:13:18.479174 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:13:18.480514 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:13:18.482817 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:13:18.485052 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:13:18.486431 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:13:18.487601 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:13:18.491136 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:13:18.494937 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:13:18.496724 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:13:18.498978 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:13:18.501873 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:13:18.503422 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:13:18.506799 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:13:18.515601 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:13:18.520481 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:13:18.522029 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:13:18.525434 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:13:18.529929 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:13:18.535392 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:13:18.541795 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:13:18.547923 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:13:18.565326 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:13:18.583327 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:13:18.586699 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:13:18.594345 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:13:18.597142 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:13:18.599198 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:13:18.605758 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:13:18.610761 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:13:18.614817 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:13:18.617180 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:13:19.087322 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:13:19.101174 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:13:19.105053 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:13:19.108808 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:13:19.142944 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:13:19.176695 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:13:19.178536 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:13:19.180435 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:13:19.182168 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:13:19.182567 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:13:19.182746 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:13:19.182870 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:13:19.182986 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:13:19.241398 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:13:19.247794 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f3949ce2-a8eb-4fbd-ab9d-6a7954cc689e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fd6df0>]}
2021-11-02 16:13:19.257629 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:13:19.258122 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f3949ce2-a8eb-4fbd-ab9d-6a7954cc689e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fe5490>]}
2021-11-02 16:13:19.258391 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:13:19.259815 (MainThread): 
2021-11-02 16:13:19.260166 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:13:19.261268 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:13:19.261469 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:13:19.683688 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:13:19.684334 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:13:19.697540 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:13:20.001254 (MainThread): 16:13:20 | 
2021-11-02 16:13:20.001851 (MainThread): 16:13:20 | Running 1 on-run-start hook
2021-11-02 16:13:20.002261 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:13:20.006862 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54400), raddr=('172.217.169.10', 443)>
2021-11-02 16:13:20.007291 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54401), raddr=('216.58.212.202', 443)>
2021-11-02 16:13:20.015764 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:13:20.017585 (MainThread): 16:13:20 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:13:20.017860 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:13:20.025074 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:13:22.454777 (MainThread): 16:13:22 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.44s]
2021-11-02 16:13:22.455367 (MainThread): 16:13:22 | 
2021-11-02 16:13:22.456136 (MainThread): 16:13:22 | Concurrency: 4 threads (target='dev')
2021-11-02 16:13:22.456421 (MainThread): 16:13:22 | 
2021-11-02 16:13:22.460083 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:13:22.460472 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:13:22.460930 (Thread-1): 16:13:22 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:13:22.461171 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:13:22.461602 (Thread-2): 16:13:22 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:13:22.462127 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:13:22.462467 (Thread-3): 16:13:22 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:13:22.462935 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:13:22.463183 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:13:22.463845 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:13:22.464094 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:13:22.468370 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:13:22.468573 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:13:22.471405 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:13:22.478483 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:13:22.478834 (Thread-1): finished collecting timing info
2021-11-02 16:13:22.498325 (Thread-2): finished collecting timing info
2021-11-02 16:13:22.498659 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:13:22.500497 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:13:22.503289 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(cast(current_date() as date) as datetime),
        cast(select cast(min_date as date) from args as datetime),
        day
    )


2021-11-02 16:13:22.506213 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:13:22.508072 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:13:22.858696 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:13:22.860028 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:13:22.860770 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('The argument to CAST is an expression, not a query; to use a query as an expression, the query must be wrapped with additional parentheses to make it a scalar subquery expression at [8:14]')
2021-11-02 16:13:22.861089 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:13:22.862137 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:13:24.007163 (Thread-3): finished collecting timing info
2021-11-02 16:13:24.008083 (Thread-3): Database Error in model month_spine (models/revenue/month_spine.sql)
  The argument to CAST is an expression, not a query; to use a query as an expression, the query must be wrapped with additional parentheses to make it a scalar subquery expression at [8:14]
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 The argument to CAST is an expression, not a query; to use a query as an expression, the query must be wrapped with additional parentheses to make it a scalar subquery expression at [8:14]

(job ID: 00f9575a-0e9e-4d5a-abe0-ae0325bf3802)

                                                             -----Query Job SQL Follows-----                                                             

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */
   2:
   3:
   4:        select 
   5:
   6:    datetime_diff(
   7:        cast(cast(current_date() as date) as datetime),
   8:        cast(select cast(min_date as date) from args as datetime),
   9:        day
  10:    )
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 285, in compile_and_execute
    ctx.node = self.compile(manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/compile.py", line 33, in compile
    return compiler.compile_node(self.node, manifest, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 543, in compile_node
    node = self._compile_node(node, manifest, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 383, in _compile_node
    compiled_node.compiled_sql = jinja.get_rendered(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 598, in get_rendered
    return render_template(template, ctx, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 4, in top-level template code
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 16, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 10, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model month_spine (models/revenue/month_spine.sql)
  The argument to CAST is an expression, not a query; to use a query as an expression, the query must be wrapped with additional parentheses to make it a scalar subquery expression at [8:14]
2021-11-02 16:13:24.014434 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3949ce2-a8eb-4fbd-ab9d-6a7954cc689e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1060c3070>]}
2021-11-02 16:13:24.014974 (Thread-3): 16:13:24 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 1.55s]
2021-11-02 16:13:24.015236 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:13:24.889730 (Thread-2): finished collecting timing info
2021-11-02 16:13:24.891294 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3949ce2-a8eb-4fbd-ab9d-6a7954cc689e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106166f70>]}
2021-11-02 16:13:24.891847 (Thread-2): 16:13:24 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.43s]
2021-11-02 16:13:24.892108 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:13:25.146011 (Thread-1): finished collecting timing info
2021-11-02 16:13:25.147086 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3949ce2-a8eb-4fbd-ab9d-6a7954cc689e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10617ed00>]}
2021-11-02 16:13:25.147774 (Thread-1): 16:13:25 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.69s]
2021-11-02 16:13:25.148087 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:13:25.148804 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:13:25.149456 (Thread-4): 16:13:25 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:13:25.150171 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:13:25.150469 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:13:25.157089 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:13:25.157852 (Thread-4): finished collecting timing info
2021-11-02 16:13:25.160758 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:13:25.168039 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:13:25.524859 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:13:25.526042 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:13:29.783657 (Thread-4): finished collecting timing info
2021-11-02 16:13:29.784769 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3949ce2-a8eb-4fbd-ab9d-6a7954cc689e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106125040>]}
2021-11-02 16:13:29.785473 (Thread-4): 16:13:29 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.63s]
2021-11-02 16:13:29.785786 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:13:29.787802 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:13:29.788439 (MainThread): 16:13:29 | 
2021-11-02 16:13:29.788725 (MainThread): 16:13:29 | Finished running 1 view model, 3 table models, 1 hook in 10.53s.
2021-11-02 16:13:29.788974 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:13:29.789175 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:13:29.789367 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:13:29.789553 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:13:29.789736 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:13:29.802231 (MainThread): 
2021-11-02 16:13:29.802485 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 16:13:29.802753 (MainThread): 
2021-11-02 16:13:29.803024 (MainThread): Database Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 16:13:29.803196 (MainThread):   The argument to CAST is an expression, not a query; to use a query as an expression, the query must be wrapped with additional parentheses to make it a scalar subquery expression at [8:14]
2021-11-02 16:13:29.803366 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 16:13:29.803629 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105faa850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106180820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105fe5a00>]}
2021-11-02 16:13:29.803903 (MainThread): Flushing usage events
2021-11-02 16:14:54.950670 (MainThread): Running with dbt=0.21.0
2021-11-02 16:14:55.249793 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:14:55.250812 (MainThread): Tracking: tracking
2021-11-02 16:14:55.261568 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10953c340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4cf2e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4cf970>]}
2021-11-02 16:14:55.279005 (MainThread): Partial parsing not enabled
2021-11-02 16:14:55.302666 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:14:55.303725 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:14:55.304346 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:14:55.305101 (MainThread): Parsing macros/etc.sql
2021-11-02 16:14:55.307551 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:14:55.313405 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:14:55.334722 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:14:55.337176 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:14:55.339581 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:14:55.348288 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:14:55.350919 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:14:55.365774 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:14:55.367447 (MainThread): Parsing macros/core.sql
2021-11-02 16:14:55.370964 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:14:55.377171 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:14:55.386784 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:14:55.388465 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:14:55.405035 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:14:55.435917 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:14:55.458026 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:14:55.459702 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:14:55.469926 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:14:55.489238 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:14:55.502779 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:14:55.510231 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:14:55.517027 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:14:55.520552 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:14:55.521887 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:14:55.522734 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:14:55.524077 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:14:55.532129 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:14:55.533753 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:14:55.535929 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:14:55.537347 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:14:55.590034 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:14:55.591661 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:14:55.592775 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:14:55.594005 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:14:55.596011 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:14:55.596963 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:14:55.598170 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:14:55.599147 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:14:55.604640 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:14:55.605659 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:14:55.606867 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:14:55.609637 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:14:55.610588 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:14:55.612656 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:14:55.622089 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:14:55.623911 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:14:55.625283 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:14:55.626690 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:14:55.628291 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:14:55.629717 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:14:55.630578 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:14:55.633981 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:14:55.638830 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:14:55.642086 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:14:55.643755 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:14:55.645224 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:14:55.647001 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:14:55.670708 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:14:55.672385 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:14:55.674834 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:14:55.676346 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:14:55.677363 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:14:55.678472 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:14:55.679497 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:14:55.680574 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:14:55.682296 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:14:55.683815 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:14:55.685964 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:14:55.687587 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:14:55.688820 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:14:55.691063 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:14:55.693018 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:14:55.694333 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:14:55.695485 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:14:55.698111 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:14:55.700142 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:14:55.702128 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:14:55.704338 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:14:55.706815 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:14:55.708359 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:14:55.711711 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:14:55.720117 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:14:55.724405 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:14:55.725876 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:14:55.729309 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:14:55.733305 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:14:55.736429 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:14:55.737947 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:14:55.741229 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:14:55.748766 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:14:55.756472 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:14:55.757710 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:14:55.760930 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:14:55.762504 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:14:55.763990 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:14:55.770319 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:14:55.774999 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:14:55.778818 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:14:55.780982 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:14:56.111386 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:14:56.124230 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:14:56.128001 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:14:56.131538 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:14:56.164634 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:14:56.198197 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:14:56.199959 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:14:56.201692 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:14:56.203255 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:14:56.203622 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:14:56.203792 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:14:56.203970 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:14:56.204119 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:14:56.263257 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:14:56.269465 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '968d14e1-45e6-4b10-95a0-20e03e5fc37e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5f9df0>]}
2021-11-02 16:14:56.280342 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:14:56.280839 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '968d14e1-45e6-4b10-95a0-20e03e5fc37e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5bfe80>]}
2021-11-02 16:14:56.281123 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:14:56.282482 (MainThread): 
2021-11-02 16:14:56.282837 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:14:56.283855 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:14:56.284110 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:14:56.702062 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:14:56.702656 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:14:56.714607 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:14:57.043363 (MainThread): 16:14:57 | 
2021-11-02 16:14:57.043910 (MainThread): 16:14:57 | Running 1 on-run-start hook
2021-11-02 16:14:57.044312 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:14:57.046079 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54419), raddr=('172.217.169.10', 443)>
2021-11-02 16:14:57.046422 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54420), raddr=('216.58.212.202', 443)>
2021-11-02 16:14:57.055803 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:14:57.058153 (MainThread): 16:14:57 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:14:57.058421 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:14:57.066607 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:14:59.532810 (MainThread): 16:14:59 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.47s]
2021-11-02 16:14:59.533383 (MainThread): 16:14:59 | 
2021-11-02 16:14:59.534145 (MainThread): 16:14:59 | Concurrency: 4 threads (target='dev')
2021-11-02 16:14:59.534425 (MainThread): 16:14:59 | 
2021-11-02 16:14:59.537910 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:14:59.538425 (Thread-1): 16:14:59 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:14:59.538781 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:14:59.539246 (Thread-2): 16:14:59 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:14:59.539849 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:14:59.540095 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:14:59.544503 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:14:59.544858 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:14:59.545250 (Thread-3): 16:14:59 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:14:59.545814 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:14:59.546058 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:14:59.548983 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:14:59.549557 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:14:59.549758 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:14:59.556956 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:14:59.557368 (Thread-1): finished collecting timing info
2021-11-02 16:14:59.563905 (Thread-2): finished collecting timing info
2021-11-02 16:14:59.595200 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(cast((select * from current_date()) as date) as datetime),
        cast(cast((select min_date from args) as date) as datetime),
        day
    )


2021-11-02 16:14:59.596457 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:14:59.596694 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:14:59.603178 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:14:59.603915 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:15:00.000902 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:15:00.002161 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:15:00.004894 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Table name "args" missing dataset while no default dataset is set in the request.')
2021-11-02 16:15:00.042344 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:15:00.043392 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:15:00.199435 (Thread-3): finished collecting timing info
2021-11-02 16:15:00.200373 (Thread-3): Database Error in model month_spine (models/revenue/month_spine.sql)
  Table name "args" missing dataset while no default dataset is set in the request.
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Table name "args" missing dataset while no default dataset is set in the request.

(job ID: fb9e0b38-f8c7-4f9c-82b1-6995c6039c63)

                                                             -----Query Job SQL Follows-----                                                             

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */
   2:
   3:
   4:        select 
   5:
   6:    datetime_diff(
   7:        cast(cast((select * from current_date()) as date) as datetime),
   8:        cast(cast((select min_date from args) as date) as datetime),
   9:        day
  10:    )
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 285, in compile_and_execute
    ctx.node = self.compile(manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/compile.py", line 33, in compile
    return compiler.compile_node(self.node, manifest, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 543, in compile_node
    node = self._compile_node(node, manifest, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 383, in _compile_node
    compiled_node.compiled_sql = jinja.get_rendered(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 598, in get_rendered
    return render_template(template, ctx, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 4, in top-level template code
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 16, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 10, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model month_spine (models/revenue/month_spine.sql)
  Table name "args" missing dataset while no default dataset is set in the request.
2021-11-02 16:15:00.207450 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '968d14e1-45e6-4b10-95a0-20e03e5fc37e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b7073d0>]}
2021-11-02 16:15:00.208022 (Thread-3): 16:15:00 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 0.66s]
2021-11-02 16:15:00.208284 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:15:02.285629 (Thread-2): finished collecting timing info
2021-11-02 16:15:02.286317 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '968d14e1-45e6-4b10-95a0-20e03e5fc37e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b76cfa0>]}
2021-11-02 16:15:02.286833 (Thread-2): 16:15:02 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.74s]
2021-11-02 16:15:02.287089 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:15:02.293519 (Thread-1): finished collecting timing info
2021-11-02 16:15:02.294439 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '968d14e1-45e6-4b10-95a0-20e03e5fc37e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b6f4640>]}
2021-11-02 16:15:02.295140 (Thread-1): 16:15:02 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.75s]
2021-11-02 16:15:02.295514 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:15:02.296444 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:15:02.296930 (Thread-4): 16:15:02 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:15:02.297523 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:15:02.297796 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:15:02.304136 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:15:02.305018 (Thread-4): finished collecting timing info
2021-11-02 16:15:02.308109 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:15:02.316370 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:15:02.703718 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:15:02.704917 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:15:07.398890 (Thread-4): finished collecting timing info
2021-11-02 16:15:07.399971 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '968d14e1-45e6-4b10-95a0-20e03e5fc37e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ca45ca0>]}
2021-11-02 16:15:07.400728 (Thread-4): 16:15:07 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 5.10s]
2021-11-02 16:15:07.401026 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:15:07.402995 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:15:07.403633 (MainThread): 16:15:07 | 
2021-11-02 16:15:07.403921 (MainThread): 16:15:07 | Finished running 1 view model, 3 table models, 1 hook in 11.12s.
2021-11-02 16:15:07.404169 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:15:07.404370 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:15:07.404559 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:15:07.404743 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:15:07.404922 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:15:07.417383 (MainThread): 
2021-11-02 16:15:07.417644 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 16:15:07.417821 (MainThread): 
2021-11-02 16:15:07.417990 (MainThread): Database Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 16:15:07.418145 (MainThread):   Table name "args" missing dataset while no default dataset is set in the request.
2021-11-02 16:15:07.418302 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 16:15:07.418557 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b78ea60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5bfd60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5e1700>]}
2021-11-02 16:15:07.418829 (MainThread): Flushing usage events
2021-11-02 16:16:58.182924 (MainThread): Running with dbt=0.21.0
2021-11-02 16:16:58.487467 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:16:58.488560 (MainThread): Tracking: tracking
2021-11-02 16:16:58.499876 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a47a3d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c51daf0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c51d610>]}
2021-11-02 16:16:58.517603 (MainThread): Partial parsing not enabled
2021-11-02 16:16:58.541259 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:16:58.542264 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:16:58.542772 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:16:58.543521 (MainThread): Parsing macros/etc.sql
2021-11-02 16:16:58.545951 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:16:58.551991 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:16:58.573258 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:16:58.575625 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:16:58.578089 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:16:58.586939 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:16:58.589469 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:16:58.604625 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:16:58.606273 (MainThread): Parsing macros/core.sql
2021-11-02 16:16:58.609687 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:16:58.616028 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:16:58.625467 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:16:58.626988 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:16:58.642973 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:16:58.674138 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:16:58.696257 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:16:58.697945 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:16:58.707430 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:16:58.726147 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:16:58.739325 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:16:58.746624 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:16:58.753285 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:16:58.756752 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:16:58.758136 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:16:58.759082 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:16:58.760436 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:16:58.768268 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:16:58.769898 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:16:58.772060 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:16:58.773461 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:16:58.825114 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:16:58.826652 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:16:58.827724 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:16:58.829050 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:16:58.831058 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:16:58.832010 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:16:58.833135 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:16:58.834027 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:16:58.839450 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:16:58.840468 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:16:58.841634 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:16:58.844377 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:16:58.845509 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:16:58.847568 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:16:58.856903 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:16:58.858575 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:16:58.859846 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:16:58.861175 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:16:58.862785 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:16:58.864193 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:16:58.865044 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:16:58.868322 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:16:58.873110 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:16:58.876314 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:16:58.877965 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:16:58.879531 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:16:58.881340 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:16:58.904850 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:16:58.906511 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:16:58.908869 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:16:58.910297 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:16:58.911337 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:16:58.912507 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:16:58.913634 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:16:58.914819 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:16:58.916355 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:16:58.917838 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:16:58.920034 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:16:58.921625 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:16:58.922775 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:16:58.924990 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:16:58.926912 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:16:58.928207 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:16:58.929463 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:16:58.932051 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:16:58.933893 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:16:58.935521 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:16:58.937658 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:16:58.940071 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:16:58.941363 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:16:58.944664 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:16:58.953006 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:16:58.957305 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:16:58.958769 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:16:58.962065 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:16:58.965986 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:16:58.969290 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:16:58.970808 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:16:58.974042 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:16:58.981619 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:16:58.989391 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:16:58.990602 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:16:58.993817 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:16:58.995327 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:16:58.996850 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:16:59.002826 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:16:59.007492 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:16:59.011353 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:16:59.013538 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:16:59.340788 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:16:59.354022 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:16:59.357767 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:16:59.361332 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:16:59.393998 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:16:59.427501 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:16:59.429283 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:16:59.431063 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:16:59.432690 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:16:59.433054 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:16:59.433222 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:16:59.433400 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:16:59.433566 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:16:59.494841 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:16:59.501172 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8a61c7a4-8905-4609-ad95-790af8f37083', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c62aac0>]}
2021-11-02 16:16:59.510636 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:16:59.511146 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8a61c7a4-8905-4609-ad95-790af8f37083', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6dc1f0>]}
2021-11-02 16:16:59.511432 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:16:59.512898 (MainThread): 
2021-11-02 16:16:59.513318 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:16:59.514416 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:16:59.514611 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:16:59.956828 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:16:59.957449 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:16:59.969948 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:17:00.303495 (MainThread): 16:17:00 | 
2021-11-02 16:17:00.304047 (MainThread): 16:17:00 | Running 1 on-run-start hook
2021-11-02 16:17:00.304453 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:17:00.306326 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54455), raddr=('172.217.169.10', 443)>
2021-11-02 16:17:00.306773 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54456), raddr=('216.58.212.202', 443)>
2021-11-02 16:17:00.316089 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:17:00.318360 (MainThread): 16:17:00 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:17:00.318694 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:17:00.326419 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:17:03.498140 (MainThread): 16:17:03 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 3.18s]
2021-11-02 16:17:03.498685 (MainThread): 16:17:03 | 
2021-11-02 16:17:03.499457 (MainThread): 16:17:03 | Concurrency: 4 threads (target='dev')
2021-11-02 16:17:03.499749 (MainThread): 16:17:03 | 
2021-11-02 16:17:03.503356 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:17:03.503740 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:17:03.504204 (Thread-1): 16:17:03 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:17:03.504443 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:17:03.504875 (Thread-2): 16:17:03 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:17:03.505472 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:17:03.505821 (Thread-3): 16:17:03 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:17:03.506293 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:17:03.506547 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:17:03.507231 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:17:03.507455 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:17:03.511794 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:17:03.512070 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:17:03.514870 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:17:03.522137 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:17:03.522591 (Thread-1): finished collecting timing info
2021-11-02 16:17:03.535068 (Thread-2): finished collecting timing info
2021-11-02 16:17:03.542768 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:17:03.544576 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:17:03.549851 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(cast((select * from current_date()) as date) as datetime),
        cast(cast((select min_date from 'args') as date) as datetime),
        day
    )


2021-11-02 16:17:03.550891 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:17:03.553248 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:17:03.899130 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:17:03.900196 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:17:03.900823 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:17:03.901886 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:17:03.928579 (Thread-3): Retry attempt 1 of 1 after error: BadRequest("Syntax error: Unexpected string literal 'args' at [8:41]")
2021-11-02 16:17:04.166308 (Thread-3): finished collecting timing info
2021-11-02 16:17:04.167039 (Thread-3): Database Error in model month_spine (models/revenue/month_spine.sql)
  Syntax error: Unexpected string literal 'args' at [8:41]
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Unexpected string literal 'args' at [8:41]

(job ID: dcf2206c-f107-4bf9-b866-f1628a27ff1e)

                                                             -----Query Job SQL Follows-----                                                             

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */
   2:
   3:
   4:        select 
   5:
   6:    datetime_diff(
   7:        cast(cast((select * from current_date()) as date) as datetime),
   8:        cast(cast((select min_date from 'args') as date) as datetime),
   9:        day
  10:    )
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 285, in compile_and_execute
    ctx.node = self.compile(manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/compile.py", line 33, in compile
    return compiler.compile_node(self.node, manifest, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 543, in compile_node
    node = self._compile_node(node, manifest, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 383, in _compile_node
    compiled_node.compiled_sql = jinja.get_rendered(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 598, in get_rendered
    return render_template(template, ctx, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 4, in top-level template code
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 16, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 10, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model month_spine (models/revenue/month_spine.sql)
  Syntax error: Unexpected string literal 'args' at [8:41]
2021-11-02 16:17:04.172793 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8a61c7a4-8905-4609-ad95-790af8f37083', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c7e0610>]}
2021-11-02 16:17:04.173331 (Thread-3): 16:17:04 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 0.67s]
2021-11-02 16:17:04.173590 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:17:06.178699 (Thread-1): finished collecting timing info
2021-11-02 16:17:06.181496 (Thread-2): finished collecting timing info
2021-11-02 16:17:06.182090 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8a61c7a4-8905-4609-ad95-790af8f37083', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c7ecf40>]}
2021-11-02 16:17:06.182609 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8a61c7a4-8905-4609-ad95-790af8f37083', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6f0e20>]}
2021-11-02 16:17:06.183152 (Thread-1): 16:17:06 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.68s]
2021-11-02 16:17:06.183497 (Thread-2): 16:17:06 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.68s]
2021-11-02 16:17:06.183770 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:17:06.183971 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:17:06.184450 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:17:06.184837 (Thread-4): 16:17:06 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:17:06.185296 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:17:06.185483 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:17:06.190273 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:17:06.190858 (Thread-4): finished collecting timing info
2021-11-02 16:17:06.192991 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:17:06.199149 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:17:06.514504 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:17:06.515619 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:17:12.301598 (Thread-4): finished collecting timing info
2021-11-02 16:17:12.302670 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8a61c7a4-8905-4609-ad95-790af8f37083', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c7bfee0>]}
2021-11-02 16:17:12.303390 (Thread-4): 16:17:12 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 6.12s]
2021-11-02 16:17:12.303690 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:17:12.305675 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:17:12.306301 (MainThread): 16:17:12 | 
2021-11-02 16:17:12.306585 (MainThread): 16:17:12 | Finished running 1 view model, 3 table models, 1 hook in 12.79s.
2021-11-02 16:17:12.306834 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:17:12.307032 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:17:12.307217 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:17:12.307395 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:17:12.307571 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:17:12.319809 (MainThread): 
2021-11-02 16:17:12.320056 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 16:17:12.320227 (MainThread): 
2021-11-02 16:17:12.320389 (MainThread): Database Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 16:17:12.320538 (MainThread):   Syntax error: Unexpected string literal 'args' at [8:41]
2021-11-02 16:17:12.320690 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 16:17:12.320942 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c748f70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6dc370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c690a90>]}
2021-11-02 16:17:12.321208 (MainThread): Flushing usage events
2021-11-02 16:18:13.424771 (MainThread): Running with dbt=0.21.0
2021-11-02 16:18:13.723086 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:18:13.724225 (MainThread): Tracking: tracking
2021-11-02 16:18:13.734868 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108abe5b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa4e2e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa4ea00>]}
2021-11-02 16:18:13.752270 (MainThread): Partial parsing not enabled
2021-11-02 16:18:13.776104 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:18:13.777167 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:18:13.777683 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:18:13.778437 (MainThread): Parsing macros/etc.sql
2021-11-02 16:18:13.780779 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:18:13.786644 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:18:13.808121 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:18:13.810544 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:18:13.812994 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:18:13.822068 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:18:13.827909 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:18:13.843015 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:18:13.844718 (MainThread): Parsing macros/core.sql
2021-11-02 16:18:13.848257 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:18:13.854567 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:18:13.864048 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:18:13.865564 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:18:13.881690 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:18:13.912649 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:18:13.934824 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:18:13.936473 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:18:13.946111 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:18:13.965034 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:18:13.978029 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:18:13.985449 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:18:13.992158 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:18:13.995769 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:18:13.997115 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:18:13.997980 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:18:13.999347 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:18:14.007438 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:18:14.009056 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:18:14.011461 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:18:14.012904 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:18:14.065000 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:18:14.066521 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:18:14.067849 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:18:14.069071 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:18:14.071124 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:18:14.072095 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:18:14.073240 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:18:14.074217 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:18:14.079851 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:18:14.080889 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:18:14.082113 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:18:14.084875 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:18:14.085940 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:18:14.088089 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:18:14.097593 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:18:14.099285 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:18:14.100651 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:18:14.101960 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:18:14.103550 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:18:14.105050 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:18:14.105930 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:18:14.109227 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:18:14.114224 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:18:14.117474 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:18:14.119146 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:18:14.120633 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:18:14.122378 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:18:14.146316 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:18:14.148003 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:18:14.150390 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:18:14.151834 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:18:14.152856 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:18:14.153970 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:18:14.154999 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:18:14.156088 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:18:14.157674 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:18:14.159180 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:18:14.161372 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:18:14.163125 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:18:14.164260 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:18:14.166498 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:18:14.168484 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:18:14.169798 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:18:14.170944 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:18:14.173528 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:18:14.175355 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:18:14.177084 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:18:14.179253 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:18:14.181672 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:18:14.182987 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:18:14.186357 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:18:14.194729 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:18:14.199033 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:18:14.200632 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:18:14.204209 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:18:14.208397 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:18:14.211729 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:18:14.213341 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:18:14.216703 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:18:14.224313 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:18:14.232275 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:18:14.233543 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:18:14.236863 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:18:14.238465 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:18:14.240080 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:18:14.246411 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:18:14.251330 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:18:14.255372 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:18:14.257525 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:18:14.593143 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:18:14.606242 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:18:14.609885 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:18:14.613452 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:18:14.645942 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:18:14.679037 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:18:14.680736 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:18:14.682494 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:18:14.684065 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:18:14.684429 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:18:14.684604 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:18:14.684783 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:18:14.684934 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:18:14.742375 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:18:14.748473 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '22d1f5f0-5e3a-4a66-9561-7297f8167741', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108abe340>]}
2021-11-02 16:18:14.757909 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:18:14.758425 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '22d1f5f0-5e3a-4a66-9561-7297f8167741', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ab5c820>]}
2021-11-02 16:18:14.758709 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:18:14.760160 (MainThread): 
2021-11-02 16:18:14.760610 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:18:14.761872 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:18:14.762143 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:18:15.167901 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:18:15.168534 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:18:15.180883 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:18:15.465615 (MainThread): 16:18:15 | 
2021-11-02 16:18:15.466172 (MainThread): 16:18:15 | Running 1 on-run-start hook
2021-11-02 16:18:15.466578 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:18:15.468357 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54478), raddr=('142.250.200.10', 443)>
2021-11-02 16:18:15.468694 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54479), raddr=('216.58.212.202', 443)>
2021-11-02 16:18:15.477822 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:18:15.480209 (MainThread): 16:18:15 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:18:15.480558 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:18:15.487836 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:18:18.032370 (MainThread): 16:18:18 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.55s]
2021-11-02 16:18:18.032681 (MainThread): 16:18:18 | 
2021-11-02 16:18:18.033143 (MainThread): 16:18:18 | Concurrency: 4 threads (target='dev')
2021-11-02 16:18:18.033333 (MainThread): 16:18:18 | 
2021-11-02 16:18:18.035824 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:18:18.036041 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:18:18.036397 (Thread-1): 16:18:18 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:18:18.036558 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:18:18.036866 (Thread-2): 16:18:18 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:18:18.037292 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:18:18.037576 (Thread-3): 16:18:18 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:18:18.037970 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:18:18.038203 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:18:18.038665 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:18:18.038844 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:18:18.042013 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:18:18.042251 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:18:18.044803 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:18:18.050852 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:18:18.051499 (Thread-1): finished collecting timing info
2021-11-02 16:18:18.056890 (Thread-2): finished collecting timing info
2021-11-02 16:18:18.086411 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:18:18.086688 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(cast((select * from current_date()) as date) as datetime),
        cast(2021-1-1 as datetime),
        day
    )


2021-11-02 16:18:18.089321 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:18:18.096800 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:18:18.097517 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:18:18.407767 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:18:18.409645 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:18:18.410178 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:18:18.411181 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:18:18.480637 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Table-valued function not found: `current_date` at [7:34]')
2021-11-02 16:18:18.991982 (Thread-3): finished collecting timing info
2021-11-02 16:18:18.993023 (Thread-3): Database Error in model month_spine (models/revenue/month_spine.sql)
  Table-valued function not found: `current_date` at [7:34]
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Table-valued function not found: `current_date` at [7:34]

(job ID: 1aecebe9-b0a2-4870-b6c7-1b3bcb1921a4)

                                                             -----Query Job SQL Follows-----                                                             

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */
   2:
   3:
   4:        select 
   5:
   6:    datetime_diff(
   7:        cast(cast((select * from current_date()) as date) as datetime),
   8:        cast(2021-1-1 as datetime),
   9:        day
  10:    )
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 285, in compile_and_execute
    ctx.node = self.compile(manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/compile.py", line 33, in compile
    return compiler.compile_node(self.node, manifest, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 543, in compile_node
    node = self._compile_node(node, manifest, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 383, in _compile_node
    compiled_node.compiled_sql = jinja.get_rendered(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 598, in get_rendered
    return render_template(template, ctx, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 1, in top-level template code
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 16, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 10, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model month_spine (models/revenue/month_spine.sql)
  Table-valued function not found: `current_date` at [7:34]
2021-11-02 16:18:19.000020 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22d1f5f0-5e3a-4a66-9561-7297f8167741', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10abe6130>]}
2021-11-02 16:18:19.000571 (Thread-3): 16:18:19 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 0.96s]
2021-11-02 16:18:19.000835 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:18:20.349286 (Thread-2): finished collecting timing info
2021-11-02 16:18:20.349982 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22d1f5f0-5e3a-4a66-9561-7297f8167741', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10abe6250>]}
2021-11-02 16:18:20.350504 (Thread-2): 16:18:20 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.31s]
2021-11-02 16:18:20.350769 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:18:20.611618 (Thread-1): finished collecting timing info
2021-11-02 16:18:20.612909 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22d1f5f0-5e3a-4a66-9561-7297f8167741', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acc4d60>]}
2021-11-02 16:18:20.613616 (Thread-1): 16:18:20 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.58s]
2021-11-02 16:18:20.613929 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:18:20.614657 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:18:20.615108 (Thread-4): 16:18:20 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:18:20.615904 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:18:20.616209 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:18:20.622545 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:18:20.623525 (Thread-4): finished collecting timing info
2021-11-02 16:18:20.626424 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:18:20.633779 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:18:20.989594 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:18:20.990822 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:18:25.011821 (Thread-4): finished collecting timing info
2021-11-02 16:18:25.012688 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22d1f5f0-5e3a-4a66-9561-7297f8167741', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aca2d30>]}
2021-11-02 16:18:25.013301 (Thread-4): 16:18:25 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.40s]
2021-11-02 16:18:25.013609 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:18:25.015669 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:18:25.016316 (MainThread): 16:18:25 | 
2021-11-02 16:18:25.016613 (MainThread): 16:18:25 | Finished running 1 view model, 3 table models, 1 hook in 10.26s.
2021-11-02 16:18:25.016881 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:18:25.017093 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:18:25.017292 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:18:25.017510 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:18:25.017725 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:18:25.032670 (MainThread): 
2021-11-02 16:18:25.032960 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 16:18:25.033220 (MainThread): 
2021-11-02 16:18:25.033433 (MainThread): Database Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 16:18:25.033599 (MainThread):   Table-valued function not found: `current_date` at [7:34]
2021-11-02 16:18:25.033747 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 16:18:25.033971 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aca54f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acd3a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acdbbe0>]}
2021-11-02 16:18:25.034203 (MainThread): Flushing usage events
2021-11-02 16:18:49.010678 (MainThread): Running with dbt=0.21.0
2021-11-02 16:18:49.368010 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:18:49.369688 (MainThread): Tracking: tracking
2021-11-02 16:18:49.384772 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104361700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064242e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064246a0>]}
2021-11-02 16:18:49.409382 (MainThread): Partial parsing not enabled
2021-11-02 16:18:49.436628 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:18:49.437622 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:18:49.438138 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:18:49.438917 (MainThread): Parsing macros/etc.sql
2021-11-02 16:18:49.441681 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:18:49.448663 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:18:49.473005 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:18:49.476539 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:18:49.479405 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:18:49.489459 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:18:49.492836 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:18:49.508516 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:18:49.510366 (MainThread): Parsing macros/core.sql
2021-11-02 16:18:49.514984 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:18:49.521698 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:18:49.533303 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:18:49.535061 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:18:49.554369 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:18:49.590142 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:18:49.616548 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:18:49.618562 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:18:49.630682 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:18:49.652974 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:18:49.668269 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:18:49.677272 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:18:49.684914 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:18:49.688763 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:18:49.690333 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:18:49.691541 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:18:49.693750 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:18:49.702562 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:18:49.704338 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:18:49.706753 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:18:49.708638 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:18:49.768353 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:18:49.770013 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:18:49.771159 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:18:49.772440 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:18:49.775291 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:18:49.776806 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:18:49.778225 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:18:49.779248 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:18:49.785468 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:18:49.786688 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:18:49.787953 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:18:49.791279 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:18:49.792673 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:18:49.794950 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:18:49.805138 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:18:49.807522 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:18:49.809131 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:18:49.810545 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:18:49.812150 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:18:49.813932 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:18:49.814932 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:18:49.818475 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:18:49.823839 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:18:49.827384 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:18:49.829183 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:18:49.831038 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:18:49.832970 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:18:49.859245 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:18:49.861106 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:18:49.863864 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:18:49.865464 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:18:49.866543 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:18:49.867712 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:18:49.868791 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:18:49.870149 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:18:49.871976 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:18:49.873617 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:18:49.875892 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:18:49.877582 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:18:49.879000 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:18:49.881517 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:18:49.883593 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:18:49.884977 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:18:49.886274 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:18:49.889155 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:18:49.891125 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:18:49.892874 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:18:49.895380 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:18:49.898048 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:18:49.899448 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:18:49.903179 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:18:49.913087 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:18:49.917983 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:18:49.919873 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:18:49.923430 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:18:49.928249 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:18:49.931860 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:18:49.933713 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:18:49.937518 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:18:49.945998 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:18:49.954566 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:18:49.955964 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:18:49.959942 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:18:49.961687 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:18:49.963296 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:18:49.969910 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:18:49.975086 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:18:49.979470 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:18:49.981970 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:18:50.328523 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:18:50.341507 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:18:50.345418 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:18:50.348946 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:18:50.381421 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:18:50.415086 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:18:50.416923 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:18:50.418693 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:18:50.420286 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:18:50.420662 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:18:50.420855 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:18:50.421035 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:18:50.421184 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:18:50.480443 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:18:50.486648 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '276bdf29-4a2e-4e75-8641-7b4a755153cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104361340>]}
2021-11-02 16:18:50.496531 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:18:50.497039 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '276bdf29-4a2e-4e75-8641-7b4a755153cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106522820>]}
2021-11-02 16:18:50.497324 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:18:50.498805 (MainThread): 
2021-11-02 16:18:50.499194 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:18:50.500309 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:18:50.500501 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:18:50.928732 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:18:50.929032 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:18:50.935853 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:18:51.207150 (MainThread): 16:18:51 | 
2021-11-02 16:18:51.207404 (MainThread): 16:18:51 | Running 1 on-run-start hook
2021-11-02 16:18:51.207573 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:18:51.208562 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54494), raddr=('142.250.200.10', 443)>
2021-11-02 16:18:51.208815 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54495), raddr=('216.58.212.202', 443)>
2021-11-02 16:18:51.214951 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:18:51.216806 (MainThread): 16:18:51 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:18:51.217143 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:18:51.223767 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:18:53.929298 (MainThread): 16:18:53 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.71s]
2021-11-02 16:18:53.929584 (MainThread): 16:18:53 | 
2021-11-02 16:18:53.930007 (MainThread): 16:18:53 | Concurrency: 4 threads (target='dev')
2021-11-02 16:18:53.930188 (MainThread): 16:18:53 | 
2021-11-02 16:18:53.933384 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:18:53.933821 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:18:53.934163 (Thread-1): 16:18:53 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:18:53.934320 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:18:53.934598 (Thread-2): 16:18:53 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:18:53.935128 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:18:53.935471 (Thread-3): 16:18:53 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:18:53.935932 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:18:53.936148 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:18:53.936731 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:18:53.936919 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:18:53.940078 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:18:53.940323 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:18:53.942879 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:18:53.949013 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:18:53.949545 (Thread-2): finished collecting timing info
2021-11-02 16:18:53.955791 (Thread-1): finished collecting timing info
2021-11-02 16:18:53.977690 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:18:53.982047 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:18:53.982381 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(cast(current_date() as date) as datetime),
        cast(2021-1-1 as datetime),
        day
    )


2021-11-02 16:18:53.988425 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:18:53.989172 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:18:54.286548 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:18:54.288329 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:18:54.288811 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:18:54.289869 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:18:54.369686 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Invalid cast from INT64 to DATETIME at [8:14]')
2021-11-02 16:18:55.217847 (Thread-3): finished collecting timing info
2021-11-02 16:18:55.218700 (Thread-3): Database Error in model month_spine (models/revenue/month_spine.sql)
  Invalid cast from INT64 to DATETIME at [8:14]
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Invalid cast from INT64 to DATETIME at [8:14]

(job ID: 39eb59b2-bc99-4a09-80d6-1795c6ebf687)

                                                             -----Query Job SQL Follows-----                                                             

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */
   2:
   3:
   4:        select 
   5:
   6:    datetime_diff(
   7:        cast(cast(current_date() as date) as datetime),
   8:        cast(2021-1-1 as datetime),
   9:        day
  10:    )
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 285, in compile_and_execute
    ctx.node = self.compile(manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/compile.py", line 33, in compile
    return compiler.compile_node(self.node, manifest, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 543, in compile_node
    node = self._compile_node(node, manifest, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 383, in _compile_node
    compiled_node.compiled_sql = jinja.get_rendered(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 598, in get_rendered
    return render_template(template, ctx, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 1, in top-level template code
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 16, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 10, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model month_spine (models/revenue/month_spine.sql)
  Invalid cast from INT64 to DATETIME at [8:14]
2021-11-02 16:18:55.225521 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '276bdf29-4a2e-4e75-8641-7b4a755153cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106533700>]}
2021-11-02 16:18:55.226231 (Thread-3): 16:18:55 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 1.29s]
2021-11-02 16:18:55.226570 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:18:56.136069 (Thread-2): finished collecting timing info
2021-11-02 16:18:56.137136 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '276bdf29-4a2e-4e75-8641-7b4a755153cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1066baf70>]}
2021-11-02 16:18:56.137930 (Thread-2): 16:18:56 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.20s]
2021-11-02 16:18:56.138296 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:18:57.098583 (Thread-1): finished collecting timing info
2021-11-02 16:18:57.098999 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '276bdf29-4a2e-4e75-8641-7b4a755153cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065f1340>]}
2021-11-02 16:18:57.099293 (Thread-1): 16:18:57 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 3.16s]
2021-11-02 16:18:57.099433 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:18:57.099843 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:18:57.100051 (Thread-4): 16:18:57 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:18:57.100368 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:18:57.100512 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:18:57.104391 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:18:57.104991 (Thread-4): finished collecting timing info
2021-11-02 16:18:57.107304 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:18:57.112930 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:18:57.429065 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:18:57.429687 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:19:02.299256 (Thread-4): finished collecting timing info
2021-11-02 16:19:02.299789 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '276bdf29-4a2e-4e75-8641-7b4a755153cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10694af40>]}
2021-11-02 16:19:02.300172 (Thread-4): 16:19:02 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 5.20s]
2021-11-02 16:19:02.300336 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:19:02.301421 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:19:02.301828 (MainThread): 16:19:02 | 
2021-11-02 16:19:02.301999 (MainThread): 16:19:02 | Finished running 1 view model, 3 table models, 1 hook in 11.80s.
2021-11-02 16:19:02.302128 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:19:02.302229 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:19:02.302324 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:19:02.302415 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:19:02.302505 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:19:02.311925 (MainThread): 
2021-11-02 16:19:02.312125 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 16:19:02.312258 (MainThread): 
2021-11-02 16:19:02.312389 (MainThread): Database Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 16:19:02.312511 (MainThread):   Invalid cast from INT64 to DATETIME at [8:14]
2021-11-02 16:19:02.312773 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 16:19:02.313152 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10664dd30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106699ca0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10650b0d0>]}
2021-11-02 16:19:02.313401 (MainThread): Flushing usage events
2021-11-02 16:20:00.777020 (MainThread): Running with dbt=0.21.0
2021-11-02 16:20:01.105571 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:20:01.106868 (MainThread): Tracking: tracking
2021-11-02 16:20:01.121239 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c45c340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e3ef2b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e3ef7f0>]}
2021-11-02 16:20:01.138538 (MainThread): Partial parsing not enabled
2021-11-02 16:20:01.161816 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:20:01.162799 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:20:01.163293 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:20:01.164057 (MainThread): Parsing macros/etc.sql
2021-11-02 16:20:01.166357 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:20:01.172431 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:20:01.193952 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:20:01.196275 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:20:01.198662 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:20:01.207819 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:20:01.210535 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:20:01.225346 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:20:01.226963 (MainThread): Parsing macros/core.sql
2021-11-02 16:20:01.230483 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:20:01.237072 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:20:01.246451 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:20:01.247987 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:20:01.264304 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:20:01.295883 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:20:01.317413 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:20:01.319333 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:20:01.329056 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:20:01.347723 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:20:01.360732 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:20:01.367998 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:20:01.374842 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:20:01.378348 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:20:01.379683 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:20:01.380539 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:20:01.381893 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:20:01.389676 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:20:01.391401 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:20:01.393672 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:20:01.395088 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:20:01.448944 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:20:01.450570 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:20:01.451665 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:20:01.452898 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:20:01.454949 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:20:01.455931 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:20:01.457092 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:20:01.458055 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:20:01.463573 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:20:01.464594 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:20:01.466030 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:20:01.468801 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:20:01.469771 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:20:01.471850 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:20:01.481301 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:20:01.483026 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:20:01.484299 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:20:01.485642 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:20:01.487185 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:20:01.488606 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:20:01.489473 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:20:01.492819 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:20:01.497608 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:20:01.500867 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:20:01.502548 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:20:01.504185 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:20:01.505923 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:20:01.529564 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:20:01.531274 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:20:01.533628 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:20:01.535058 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:20:01.536178 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:20:01.537273 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:20:01.538280 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:20:01.539343 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:20:01.540872 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:20:01.542487 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:20:01.544614 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:20:01.546208 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:20:01.547332 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:20:01.549583 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:20:01.551504 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:20:01.552838 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:20:01.553975 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:20:01.556585 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:20:01.558465 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:20:01.560094 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:20:01.562315 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:20:01.564749 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:20:01.566044 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:20:01.569343 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:20:01.577741 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:20:01.582069 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:20:01.583540 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:20:01.586817 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:20:01.590747 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:20:01.593931 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:20:01.595456 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:20:01.598776 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:20:01.606266 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:20:01.614037 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:20:01.615256 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:20:01.618555 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:20:01.620039 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:20:01.621532 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:20:01.627463 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:20:01.632187 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:20:01.635954 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:20:01.638069 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:20:01.964862 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:20:01.977892 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:20:01.981662 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:20:01.985142 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:20:02.017604 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:20:02.051642 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:20:02.053447 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:20:02.055350 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:20:02.057009 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:20:02.057401 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:20:02.057561 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:20:02.057718 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:20:02.057879 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:20:02.119774 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:20:02.126096 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '97873262-34e7-4870-bc34-3366a016dd90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c45c9a0>]}
2021-11-02 16:20:02.136242 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:20:02.136726 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '97873262-34e7-4870-bc34-3366a016dd90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e502400>]}
2021-11-02 16:20:02.136999 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:20:02.138416 (MainThread): 
2021-11-02 16:20:02.138789 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:20:02.139860 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:20:02.140060 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:20:02.563750 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:20:02.564393 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:20:02.576724 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:20:02.909307 (MainThread): 16:20:02 | 
2021-11-02 16:20:02.909860 (MainThread): 16:20:02 | Running 1 on-run-start hook
2021-11-02 16:20:02.910268 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:20:02.912024 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54517), raddr=('142.250.200.10', 443)>
2021-11-02 16:20:02.912463 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54518), raddr=('216.58.212.202', 443)>
2021-11-02 16:20:02.922084 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:20:02.924438 (MainThread): 16:20:02 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:20:02.924783 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:20:02.932456 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:20:05.319323 (MainThread): 16:20:05 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.39s]
2021-11-02 16:20:05.319903 (MainThread): 16:20:05 | 
2021-11-02 16:20:05.320714 (MainThread): 16:20:05 | Concurrency: 4 threads (target='dev')
2021-11-02 16:20:05.320999 (MainThread): 16:20:05 | 
2021-11-02 16:20:05.324565 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:20:05.324953 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:20:05.325415 (Thread-1): 16:20:05 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:20:05.325650 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:20:05.326081 (Thread-2): 16:20:05 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:20:05.326677 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:20:05.327083 (Thread-3): 16:20:05 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:20:05.327602 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:20:05.327887 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:20:05.328550 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:20:05.328795 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:20:05.333154 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:20:05.333476 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:20:05.336658 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:20:05.343900 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:20:05.344270 (Thread-1): finished collecting timing info
2021-11-02 16:20:05.344518 (Thread-2): finished collecting timing info
2021-11-02 16:20:05.369011 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:20:05.372239 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:20:05.374004 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(2021-12-31 as datetime),
        cast(2021-1-1 as datetime),
        month
    )


2021-11-02 16:20:05.377507 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:20:05.377883 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:20:05.702747 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:20:05.704151 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:20:05.704718 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:20:05.705866 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:20:05.776562 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Invalid cast from INT64 to DATETIME at [7:14]')
2021-11-02 16:20:06.162280 (Thread-3): finished collecting timing info
2021-11-02 16:20:06.163205 (Thread-3): Database Error in model month_spine (models/revenue/month_spine.sql)
  Invalid cast from INT64 to DATETIME at [7:14]
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Invalid cast from INT64 to DATETIME at [7:14]

(job ID: dfa64ec5-6539-41fe-9dff-4a0210857e06)

                                                             -----Query Job SQL Follows-----                                                             

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */
   2:
   3:
   4:        select 
   5:
   6:    datetime_diff(
   7:        cast(2021-12-31 as datetime),
   8:        cast(2021-1-1 as datetime),
   9:        month
  10:    )
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 285, in compile_and_execute
    ctx.node = self.compile(manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/compile.py", line 33, in compile
    return compiler.compile_node(self.node, manifest, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 543, in compile_node
    node = self._compile_node(node, manifest, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 383, in _compile_node
    compiled_node.compiled_sql = jinja.get_rendered(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 598, in get_rendered
    return render_template(template, ctx, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 1, in top-level template code
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 16, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 10, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model month_spine (models/revenue/month_spine.sql)
  Invalid cast from INT64 to DATETIME at [7:14]
2021-11-02 16:20:06.169575 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '97873262-34e7-4870-bc34-3366a016dd90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e64e8b0>]}
2021-11-02 16:20:06.170133 (Thread-3): 16:20:06 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 0.84s]
2021-11-02 16:20:06.170403 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:20:07.758049 (Thread-1): finished collecting timing info
2021-11-02 16:20:07.758792 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '97873262-34e7-4870-bc34-3366a016dd90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e695f40>]}
2021-11-02 16:20:07.759326 (Thread-1): 16:20:07 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.43s]
2021-11-02 16:20:07.761350 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:20:07.762609 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:20:07.762925 (Thread-4): 16:20:07 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:20:07.763368 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:20:07.763568 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:20:07.767856 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:20:07.768427 (Thread-4): finished collecting timing info
2021-11-02 16:20:07.770948 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:20:07.777337 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:20:07.904760 (Thread-2): finished collecting timing info
2021-11-02 16:20:07.905687 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '97873262-34e7-4870-bc34-3366a016dd90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e668550>]}
2021-11-02 16:20:07.906889 (Thread-2): 16:20:07 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.58s]
2021-11-02 16:20:07.908155 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:20:08.086037 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:20:08.087197 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:20:12.347057 (Thread-4): finished collecting timing info
2021-11-02 16:20:12.348117 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '97873262-34e7-4870-bc34-3366a016dd90', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f93fcd0>]}
2021-11-02 16:20:12.348918 (Thread-4): 16:20:12 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.58s]
2021-11-02 16:20:12.349221 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:20:12.351229 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:20:12.351858 (MainThread): 16:20:12 | 
2021-11-02 16:20:12.352152 (MainThread): 16:20:12 | Finished running 1 view model, 3 table models, 1 hook in 10.21s.
2021-11-02 16:20:12.352407 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:20:12.352616 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:20:12.352814 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:20:12.353005 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:20:12.353192 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:20:12.366045 (MainThread): 
2021-11-02 16:20:12.366323 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 16:20:12.366501 (MainThread): 
2021-11-02 16:20:12.366670 (MainThread): Database Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 16:20:12.366823 (MainThread):   Invalid cast from INT64 to DATETIME at [7:14]
2021-11-02 16:20:12.366982 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 16:20:12.367243 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f936970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e502fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e51faf0>]}
2021-11-02 16:20:12.367520 (MainThread): Flushing usage events
2021-11-02 16:20:32.887904 (MainThread): Running with dbt=0.21.0
2021-11-02 16:20:33.247223 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:20:33.248611 (MainThread): Tracking: tracking
2021-11-02 16:20:33.260079 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aedf430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce722e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce72a00>]}
2021-11-02 16:20:33.281191 (MainThread): Partial parsing not enabled
2021-11-02 16:20:33.311778 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:20:33.312837 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:20:33.313446 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:20:33.314292 (MainThread): Parsing macros/etc.sql
2021-11-02 16:20:33.317219 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:20:33.323784 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:20:33.349116 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:20:33.352333 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:20:33.355456 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:20:33.365680 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:20:33.368922 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:20:33.384811 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:20:33.386718 (MainThread): Parsing macros/core.sql
2021-11-02 16:20:33.390639 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:20:33.397687 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:20:33.408854 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:20:33.410526 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:20:33.428960 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:20:33.462121 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:20:33.485540 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:20:33.487279 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:20:33.497755 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:20:33.518754 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:20:33.533630 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:20:33.542076 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:20:33.549839 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:20:33.554427 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:20:33.555982 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:20:33.556916 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:20:33.558361 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:20:33.567650 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:20:33.569921 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:20:33.572626 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:20:33.574250 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:20:33.633901 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:20:33.635742 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:20:33.637025 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:20:33.638482 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:20:33.640751 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:20:33.641897 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:20:33.643161 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:20:33.644141 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:20:33.651071 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:20:33.652468 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:20:33.653900 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:20:33.657803 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:20:33.658999 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:20:33.661244 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:20:33.672296 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:20:33.674502 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:20:33.675961 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:20:33.677385 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:20:33.679181 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:20:33.681266 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:20:33.682611 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:20:33.686651 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:20:33.692236 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:20:33.695765 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:20:33.698411 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:20:33.700305 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:20:33.702458 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:20:33.730334 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:20:33.732511 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:20:33.735295 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:20:33.736889 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:20:33.738127 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:20:33.739377 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:20:33.740478 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:20:33.741624 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:20:33.743256 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:20:33.744851 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:20:33.747650 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:20:33.749779 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:20:33.751186 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:20:33.753654 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:20:33.755936 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:20:33.757384 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:20:33.758617 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:20:33.761369 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:20:33.764225 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:20:33.766464 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:20:33.768842 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:20:33.771639 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:20:33.773091 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:20:33.776552 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:20:33.786140 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:20:33.790931 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:20:33.792540 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:20:33.796712 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:20:33.801455 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:20:33.805105 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:20:33.806791 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:20:33.810385 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:20:33.818819 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:20:33.827254 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:20:33.828701 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:20:33.832090 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:20:33.833743 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:20:33.835554 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:20:33.841979 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:20:33.847297 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:20:33.851583 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:20:33.853934 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:20:34.252686 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:20:34.268328 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:20:34.272970 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:20:34.276978 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:20:34.315872 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:20:34.356126 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:20:34.357953 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:20:34.359969 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:20:34.361975 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:20:34.362447 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:20:34.362630 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:20:34.362823 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:20:34.362971 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:20:34.419490 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:20:34.424434 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '24e3f410-7378-449c-8212-9b0105925a9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aedf340>]}
2021-11-02 16:20:34.432374 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:20:34.432778 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '24e3f410-7378-449c-8212-9b0105925a9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf7e820>]}
2021-11-02 16:20:34.433015 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:20:34.434340 (MainThread): 
2021-11-02 16:20:34.434666 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:20:34.435582 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:20:34.435747 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:20:34.842835 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:20:34.843333 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:20:34.854638 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:20:35.174955 (MainThread): 16:20:35 | 
2021-11-02 16:20:35.175222 (MainThread): 16:20:35 | Running 1 on-run-start hook
2021-11-02 16:20:35.175467 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:20:35.176765 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54533), raddr=('142.250.200.10', 443)>
2021-11-02 16:20:35.177091 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54534), raddr=('216.58.212.202', 443)>
2021-11-02 16:20:35.183787 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:20:35.185576 (MainThread): 16:20:35 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:20:35.185910 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:20:35.192077 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:20:37.589619 (MainThread): 16:20:37 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.40s]
2021-11-02 16:20:37.590206 (MainThread): 16:20:37 | 
2021-11-02 16:20:37.590978 (MainThread): 16:20:37 | Concurrency: 4 threads (target='dev')
2021-11-02 16:20:37.591279 (MainThread): 16:20:37 | 
2021-11-02 16:20:37.595000 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:20:37.595384 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:20:37.595845 (Thread-1): 16:20:37 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:20:37.596077 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:20:37.596501 (Thread-2): 16:20:37 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:20:37.597073 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:20:37.597413 (Thread-3): 16:20:37 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:20:37.597879 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:20:37.598130 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:20:37.598785 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:20:37.599100 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:20:37.603478 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:20:37.603684 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:20:37.606496 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:20:37.614001 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:20:37.614447 (Thread-1): finished collecting timing info
2021-11-02 16:20:37.627421 (Thread-2): finished collecting timing info
2021-11-02 16:20:37.634794 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:20:37.636643 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:20:37.641827 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(2021-12-31 as datetime),
        cast(2021-1-1 as datetime),
        month
    )


2021-11-02 16:20:37.642093 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:20:37.644420 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:20:37.987830 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:20:37.989698 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:20:37.990374 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:20:37.991475 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:20:38.013121 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Invalid cast from INT64 to DATETIME at [7:14]')
2021-11-02 16:20:39.204226 (Thread-3): finished collecting timing info
2021-11-02 16:20:39.205251 (Thread-3): Database Error in model month_spine (models/revenue/month_spine.sql)
  Invalid cast from INT64 to DATETIME at [7:14]
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Invalid cast from INT64 to DATETIME at [7:14]

(job ID: d4cfc4c8-cdfe-4176-86f7-1fdf7e585a12)

                                                             -----Query Job SQL Follows-----                                                             

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */
   2:
   3:
   4:        select 
   5:
   6:    datetime_diff(
   7:        cast(2021-12-31 as datetime),
   8:        cast(2021-1-1 as datetime),
   9:        month
  10:    )
  11:
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 285, in compile_and_execute
    ctx.node = self.compile(manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/compile.py", line 33, in compile
    return compiler.compile_node(self.node, manifest, {})
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 543, in compile_node
    node = self._compile_node(node, manifest, extra_context)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/compilation.py", line 383, in _compile_node
    compiled_node.compiled_sql = jinja.get_rendered(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 598, in get_rendered
    return render_template(template, ctx, node)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 549, in render_template
    return template.render(ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 1, in top-level template code
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 16, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 2, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 10, in template
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model month_spine (models/revenue/month_spine.sql)
  Invalid cast from INT64 to DATETIME at [7:14]
2021-11-02 16:20:39.212483 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '24e3f410-7378-449c-8212-9b0105925a9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d045ee0>]}
2021-11-02 16:20:39.213065 (Thread-3): 16:20:39 | 3 of 4 ERROR creating view model ft_data.month_spine................. [ERROR in 1.61s]
2021-11-02 16:20:39.213333 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:20:40.167883 (Thread-1): finished collecting timing info
2021-11-02 16:20:40.168624 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '24e3f410-7378-449c-8212-9b0105925a9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d115d30>]}
2021-11-02 16:20:40.169085 (Thread-1): 16:20:40 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.57s]
2021-11-02 16:20:40.169293 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:20:40.169816 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:20:40.170120 (Thread-4): 16:20:40 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:20:40.170598 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:20:40.170808 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:20:40.175620 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:20:40.176118 (Thread-4): finished collecting timing info
2021-11-02 16:20:40.178175 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:20:40.184220 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:20:40.283798 (Thread-2): finished collecting timing info
2021-11-02 16:20:40.284854 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '24e3f410-7378-449c-8212-9b0105925a9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d04ab50>]}
2021-11-02 16:20:40.285567 (Thread-2): 16:20:40 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.69s]
2021-11-02 16:20:40.285872 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:20:40.459482 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:20:40.460715 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:20:45.079448 (Thread-4): finished collecting timing info
2021-11-02 16:20:45.080530 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '24e3f410-7378-449c-8212-9b0105925a9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d01f0d0>]}
2021-11-02 16:20:45.081245 (Thread-4): 16:20:45 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.91s]
2021-11-02 16:20:45.081709 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:20:45.083874 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:20:45.084563 (MainThread): 16:20:45 | 
2021-11-02 16:20:45.084861 (MainThread): 16:20:45 | Finished running 1 view model, 3 table models, 1 hook in 10.65s.
2021-11-02 16:20:45.085113 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:20:45.085318 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:20:45.085510 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:20:45.085697 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:20:45.085880 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:20:45.099879 (MainThread): 
2021-11-02 16:20:45.100126 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 16:20:45.100302 (MainThread): 
2021-11-02 16:20:45.100470 (MainThread): Database Error in model month_spine (models/revenue/month_spine.sql)
2021-11-02 16:20:45.100625 (MainThread):   Invalid cast from INT64 to DATETIME at [7:14]
2021-11-02 16:20:45.100786 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 16:20:45.101036 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce56be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d11c3a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfef7f0>]}
2021-11-02 16:20:45.101301 (MainThread): Flushing usage events
2021-11-02 16:21:26.402314 (MainThread): Running with dbt=0.21.0
2021-11-02 16:21:26.701509 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:21:26.702884 (MainThread): Tracking: tracking
2021-11-02 16:21:26.714125 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107831400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1097c42e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1097c4a00>]}
2021-11-02 16:21:26.732005 (MainThread): Partial parsing not enabled
2021-11-02 16:21:26.755884 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:21:26.757024 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:21:26.757530 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:21:26.758281 (MainThread): Parsing macros/etc.sql
2021-11-02 16:21:26.760600 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:21:26.766572 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:21:26.787645 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:21:26.790000 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:21:26.792327 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:21:26.801290 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:21:26.804090 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:21:26.818987 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:21:26.820884 (MainThread): Parsing macros/core.sql
2021-11-02 16:21:26.824359 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:21:26.830492 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:21:26.840012 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:21:26.841569 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:21:26.857814 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:21:26.888556 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:21:26.910229 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:21:26.911797 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:21:26.921106 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:21:26.939588 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:21:26.952994 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:21:26.960457 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:21:26.967153 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:21:26.970651 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:21:26.971972 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:21:26.972959 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:21:26.974315 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:21:26.982214 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:21:26.983807 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:21:26.986071 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:21:26.987484 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:21:27.039352 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:21:27.040936 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:21:27.042000 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:21:27.043206 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:21:27.045194 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:21:27.046146 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:21:27.047271 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:21:27.048168 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:21:27.053854 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:21:27.054881 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:21:27.056219 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:21:27.058947 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:21:27.059900 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:21:27.062089 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:21:27.071376 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:21:27.073157 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:21:27.074423 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:21:27.075714 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:21:27.077204 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:21:27.078606 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:21:27.079469 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:21:27.082723 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:21:27.087582 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:21:27.090973 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:21:27.092635 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:21:27.094141 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:21:27.095867 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:21:27.119311 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:21:27.120945 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:21:27.123344 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:21:27.124757 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:21:27.125754 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:21:27.126934 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:21:27.127988 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:21:27.129053 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:21:27.130616 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:21:27.132095 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:21:27.134183 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:21:27.135746 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:21:27.136852 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:21:27.139239 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:21:27.141176 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:21:27.142474 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:21:27.143609 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:21:27.146170 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:21:27.147963 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:21:27.149631 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:21:27.151761 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:21:27.154152 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:21:27.155449 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:21:27.158762 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:21:27.167117 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:21:27.171447 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:21:27.172974 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:21:27.176188 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:21:27.180088 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:21:27.183227 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:21:27.184726 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:21:27.188001 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:21:27.195623 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:21:27.203488 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:21:27.204828 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:21:27.208078 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:21:27.209579 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:21:27.211102 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:21:27.217125 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:21:27.221714 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:21:27.225538 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:21:27.227626 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:21:27.550783 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:21:27.563501 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:21:27.567489 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:21:27.571058 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:21:27.603223 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:21:27.636300 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:21:27.637996 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:21:27.639833 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:21:27.641576 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:21:27.641956 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:21:27.642157 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:21:27.642351 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:21:27.642549 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:21:27.703629 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:21:27.709857 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5389fd83-1fc8-438d-9810-8279c710d9d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107831340>]}
2021-11-02 16:21:27.719345 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:21:27.719821 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5389fd83-1fc8-438d-9810-8279c710d9d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098d1820>]}
2021-11-02 16:21:27.720093 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:21:27.721473 (MainThread): 
2021-11-02 16:21:27.721831 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:21:27.722878 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:21:27.723060 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:21:28.164082 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:21:28.164712 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:21:28.176955 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:21:28.492786 (MainThread): 16:21:28 | 
2021-11-02 16:21:28.493261 (MainThread): 16:21:28 | Running 1 on-run-start hook
2021-11-02 16:21:28.493602 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:21:28.495114 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54551), raddr=('142.250.200.10', 443)>
2021-11-02 16:21:28.495492 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54552), raddr=('216.58.212.202', 443)>
2021-11-02 16:21:28.504862 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:21:28.507179 (MainThread): 16:21:28 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:21:28.507517 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:21:28.515459 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:21:31.249025 (MainThread): 16:21:31 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.74s]
2021-11-02 16:21:31.249522 (MainThread): 16:21:31 | 
2021-11-02 16:21:31.250293 (MainThread): 16:21:31 | Concurrency: 4 threads (target='dev')
2021-11-02 16:21:31.250582 (MainThread): 16:21:31 | 
2021-11-02 16:21:31.254095 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:21:31.254476 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:21:31.254943 (Thread-1): 16:21:31 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:21:31.255181 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:21:31.255609 (Thread-2): 16:21:31 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:21:31.256214 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:21:31.256558 (Thread-3): 16:21:31 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:21:31.257025 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:21:31.257309 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:21:31.257944 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:21:31.258186 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:21:31.262488 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:21:31.262761 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:21:31.265512 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:21:31.272745 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:21:31.273304 (Thread-1): finished collecting timing info
2021-11-02 16:21:31.292884 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:21:31.293102 (Thread-2): finished collecting timing info
2021-11-02 16:21:31.293357 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(cast('2021-12-31' as date) as datetime),
        cast(cast('2021-01-01' as date) as datetime),
        month
    )


2021-11-02 16:21:31.295285 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:21:31.300666 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:21:31.304121 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:21:31.648112 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:21:31.649158 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:21:31.649801 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:21:31.650879 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:21:32.428647 (Thread-3): Writing injected SQL for node "model.freetrade_test.month_spine"
2021-11-02 16:21:32.429490 (Thread-3): finished collecting timing info
2021-11-02 16:21:32.452425 (Thread-3): Writing runtime SQL for node "model.freetrade_test.month_spine"
2021-11-02 16:21:32.453006 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


  create or replace view `ft-data-330317`.`ft_data`.`month_spine`
  OPTIONS()
  as 

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 11
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2021-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2021-12-31' as date)

)

select * from filtered

;


2021-11-02 16:21:33.129839 (Thread-3): finished collecting timing info
2021-11-02 16:21:33.130537 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5389fd83-1fc8-438d-9810-8279c710d9d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099f96a0>]}
2021-11-02 16:21:33.131061 (Thread-3): 16:21:33 | 3 of 4 OK created view model ft_data.month_spine..................... [OK in 1.87s]
2021-11-02 16:21:33.131320 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:21:33.496588 (Thread-2): finished collecting timing info
2021-11-02 16:21:33.497655 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5389fd83-1fc8-438d-9810-8279c710d9d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098df5e0>]}
2021-11-02 16:21:33.498450 (Thread-2): 16:21:33 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.24s]
2021-11-02 16:21:33.498745 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:21:33.502868 (Thread-1): finished collecting timing info
2021-11-02 16:21:33.503650 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5389fd83-1fc8-438d-9810-8279c710d9d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a08f70>]}
2021-11-02 16:21:33.504248 (Thread-1): 16:21:33 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.25s]
2021-11-02 16:21:33.504546 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:21:33.505265 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:21:33.505891 (Thread-4): 16:21:33 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:21:33.506400 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:21:33.506636 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:21:33.512297 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:21:33.512934 (Thread-4): finished collecting timing info
2021-11-02 16:21:33.515315 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:21:33.522518 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:21:33.808390 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:21:33.809458 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:21:38.190357 (Thread-4): finished collecting timing info
2021-11-02 16:21:38.191000 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5389fd83-1fc8-438d-9810-8279c710d9d8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a7f880>]}
2021-11-02 16:21:38.191639 (Thread-4): 16:21:38 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.68s]
2021-11-02 16:21:38.191890 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:21:38.193317 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:21:38.193821 (MainThread): 16:21:38 | 
2021-11-02 16:21:38.194030 (MainThread): 16:21:38 | Finished running 1 view model, 3 table models, 1 hook in 10.47s.
2021-11-02 16:21:38.194235 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:21:38.194445 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:21:38.194588 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:21:38.194705 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:21:38.194856 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:21:38.206215 (MainThread): 
2021-11-02 16:21:38.206450 (MainThread): Completed successfully
2021-11-02 16:21:38.206634 (MainThread): 
Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
2021-11-02 16:21:38.207038 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac1c1c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098bc0d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10992faf0>]}
2021-11-02 16:21:38.207352 (MainThread): Flushing usage events
2021-11-02 16:31:19.595682 (MainThread): Running with dbt=0.21.0
2021-11-02 16:31:20.285664 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 16:31:20.286735 (MainThread): Tracking: tracking
2021-11-02 16:31:20.305194 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aae4400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ca74100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ca74a00>]}
2021-11-02 16:31:20.324031 (MainThread): Partial parsing not enabled
2021-11-02 16:31:20.393065 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 16:31:20.394237 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 16:31:20.394860 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 16:31:20.395743 (MainThread): Parsing macros/etc.sql
2021-11-02 16:31:20.399442 (MainThread): Parsing macros/catalog.sql
2021-11-02 16:31:20.406730 (MainThread): Parsing macros/adapters.sql
2021-11-02 16:31:20.429844 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 16:31:20.432372 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 16:31:20.434723 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 16:31:20.443616 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 16:31:20.446071 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 16:31:20.459527 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 16:31:20.461114 (MainThread): Parsing macros/core.sql
2021-11-02 16:31:20.464424 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 16:31:20.470515 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 16:31:20.479696 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 16:31:20.481170 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 16:31:20.497146 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 16:31:20.527979 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 16:31:20.549495 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 16:31:20.551090 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 16:31:20.560789 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 16:31:20.579421 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 16:31:20.592292 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 16:31:20.599701 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 16:31:20.606453 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 16:31:20.610137 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 16:31:20.611632 (MainThread): Parsing macros/etc/query.sql
2021-11-02 16:31:20.612506 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 16:31:20.613872 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 16:31:20.621802 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 16:31:20.623409 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 16:31:20.625583 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 16:31:20.627100 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 16:31:20.679404 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 16:31:20.680972 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 16:31:20.682082 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 16:31:20.683328 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 16:31:20.685448 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 16:31:20.686401 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 16:31:20.687531 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 16:31:20.688434 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 16:31:20.693997 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 16:31:20.695016 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 16:31:20.696229 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 16:31:20.698962 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 16:31:20.699918 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 16:31:20.702021 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 16:31:20.711525 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 16:31:20.713208 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 16:31:20.714491 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 16:31:20.715794 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 16:31:20.717370 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 16:31:20.718782 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 16:31:20.719644 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 16:31:20.722905 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 16:31:20.727909 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 16:31:20.731168 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 16:31:20.732831 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 16:31:20.734299 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 16:31:20.736043 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 16:31:20.759463 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 16:31:20.761262 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 16:31:20.763632 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 16:31:20.765072 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 16:31:20.766155 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 16:31:20.767249 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 16:31:20.768258 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 16:31:20.769330 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 16:31:20.771041 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 16:31:20.772541 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 16:31:20.774644 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 16:31:20.776233 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 16:31:20.777429 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 16:31:20.779750 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 16:31:20.781886 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 16:31:20.783191 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 16:31:20.784334 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 16:31:20.786916 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 16:31:20.788838 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 16:31:20.790491 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 16:31:20.792816 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 16:31:20.795409 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 16:31:20.796728 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 16:31:20.800134 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 16:31:20.808760 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 16:31:20.813288 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 16:31:20.814928 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 16:31:20.818227 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 16:31:20.822326 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 16:31:20.825499 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 16:31:20.827103 (MainThread): Parsing macros/sql/star.sql
2021-11-02 16:31:20.830452 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 16:31:20.838071 (MainThread): Parsing macros/sql/union.sql
2021-11-02 16:31:20.845740 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 16:31:20.846997 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 16:31:20.850158 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 16:31:20.851639 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 16:31:20.853145 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 16:31:20.859205 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 16:31:20.863926 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 16:31:20.867633 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 16:31:20.869797 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 16:31:21.199245 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:31:21.212525 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:31:21.216331 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:31:21.219846 (MainThread): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:31:21.251849 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 16:31:21.285125 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:31:21.286834 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:31:21.288600 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:31:21.290175 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 16:31:21.290557 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:31:21.290779 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 16:31:21.290911 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:31:21.291031 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 16:31:21.350667 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 16:31:21.357064 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1314c587-84b9-4344-a898-1c79b31a9946', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aae47f0>]}
2021-11-02 16:31:21.367158 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 16:31:21.367782 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1314c587-84b9-4344-a898-1c79b31a9946', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cb8b400>]}
2021-11-02 16:31:21.368129 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 16:31:21.369637 (MainThread): 
2021-11-02 16:31:21.370017 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:31:21.371049 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 16:31:21.371237 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 16:31:21.829164 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 16:31:21.829799 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 16:31:21.841861 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:31:22.150704 (MainThread): 16:31:22 | 
2021-11-02 16:31:22.151265 (MainThread): 16:31:22 | Running 1 on-run-start hook
2021-11-02 16:31:22.151666 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 16:31:22.153533 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54705), raddr=('142.250.187.202', 443)>
2021-11-02 16:31:22.154008 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54706), raddr=('216.58.212.202', 443)>
2021-11-02 16:31:22.163656 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 16:31:22.166229 (MainThread): 16:31:22 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 16:31:22.166599 (MainThread): Opening a new connection, currently in state closed
2021-11-02 16:31:22.174108 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 16:31:25.216665 (MainThread): 16:31:25 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 3.05s]
2021-11-02 16:31:25.217240 (MainThread): 16:31:25 | 
2021-11-02 16:31:25.217869 (MainThread): 16:31:25 | Concurrency: 4 threads (target='dev')
2021-11-02 16:31:25.218151 (MainThread): 16:31:25 | 
2021-11-02 16:31:25.223657 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 16:31:25.224074 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:31:25.224537 (Thread-1): 16:31:25 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 16:31:25.224847 (Thread-3): Began running node model.freetrade_test.month_spine
2021-11-02 16:31:25.225314 (Thread-2): 16:31:25 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 16:31:25.226078 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 16:31:25.226397 (Thread-3): 16:31:25 | 3 of 4 START view model ft_data.month_spine.......................... [RUN]
2021-11-02 16:31:25.226809 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 16:31:25.227234 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 16:31:25.227913 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.month_spine".
2021-11-02 16:31:25.232207 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:31:25.232474 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:31:25.232681 (Thread-3): Compiling model.freetrade_test.month_spine
2021-11-02 16:31:25.235711 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:31:25.243162 (Thread-3): Opening a new connection, currently in state init
2021-11-02 16:31:25.243430 (Thread-1): finished collecting timing info
2021-11-02 16:31:25.243639 (Thread-2): finished collecting timing info
2021-11-02 16:31:25.270163 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 16:31:25.270653 (Thread-2): Opening a new connection, currently in state init
2021-11-02 16:31:25.275559 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


        select 

    datetime_diff(
        cast(cast('2022-01-01' as date) as datetime),
        cast(cast('2021-01-01' as date) as datetime),
        month
    )


2021-11-02 16:31:25.276415 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:31:25.277013 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:31:25.651207 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 16:31:25.652322 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 16:31:25.652944 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 16:31:25.654014 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 16:31:27.034141 (Thread-3): Writing injected SQL for node "model.freetrade_test.month_spine"
2021-11-02 16:31:27.034952 (Thread-3): finished collecting timing info
2021-11-02 16:31:27.058173 (Thread-3): Writing runtime SQL for node "model.freetrade_test.month_spine"
2021-11-02 16:31:27.058770 (Thread-3): On model.freetrade_test.month_spine: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.month_spine"} */


  create or replace view `ft-data-330317`.`ft_data`.`month_spine`
  OPTIONS()
  as 

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 12
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2021-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2022-01-01' as date)

)

select * from filtered

;


2021-11-02 16:31:27.725021 (Thread-3): finished collecting timing info
2021-11-02 16:31:27.726484 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1314c587-84b9-4344-a898-1c79b31a9946', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc28f70>]}
2021-11-02 16:31:27.729741 (Thread-3): 16:31:27 | 3 of 4 OK created view model ft_data.month_spine..................... [OK in 2.50s]
2021-11-02 16:31:27.730185 (Thread-3): Finished running node model.freetrade_test.month_spine
2021-11-02 16:31:27.892866 (Thread-2): finished collecting timing info
2021-11-02 16:31:27.894057 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1314c587-84b9-4344-a898-1c79b31a9946', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ccf7250>]}
2021-11-02 16:31:27.894811 (Thread-2): 16:31:27 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.67s]
2021-11-02 16:31:27.897242 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 16:31:28.216053 (Thread-1): finished collecting timing info
2021-11-02 16:31:28.217127 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1314c587-84b9-4344-a898-1c79b31a9946', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ccedd60>]}
2021-11-02 16:31:28.217884 (Thread-1): 16:31:28 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.99s]
2021-11-02 16:31:28.218179 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 16:31:28.219048 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 16:31:28.219492 (Thread-4): 16:31:28 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 16:31:28.220056 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 16:31:28.220331 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 16:31:28.226329 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:31:28.227117 (Thread-4): finished collecting timing info
2021-11-02 16:31:28.230218 (Thread-4): Opening a new connection, currently in state init
2021-11-02 16:31:28.237620 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 16:31:28.855040 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 16:31:28.856226 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 16:31:32.874021 (Thread-4): finished collecting timing info
2021-11-02 16:31:32.874557 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1314c587-84b9-4344-a898-1c79b31a9946', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ccd4490>]}
2021-11-02 16:31:32.874929 (Thread-4): 16:31:32 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.65s]
2021-11-02 16:31:32.875113 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 16:31:32.876390 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 16:31:32.876811 (MainThread): 16:31:32 | 
2021-11-02 16:31:32.876990 (MainThread): 16:31:32 | Finished running 1 view model, 3 table models, 1 hook in 11.51s.
2021-11-02 16:31:32.877140 (MainThread): Connection 'master' was properly closed.
2021-11-02 16:31:32.877260 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 16:31:32.877373 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 16:31:32.877484 (MainThread): Connection 'model.freetrade_test.month_spine' was properly closed.
2021-11-02 16:31:32.877593 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 16:31:32.882436 (MainThread): unclosed <ssl.SSLSocket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54713), raddr=('142.250.187.202', 443)>
2021-11-02 16:31:32.882669 (MainThread): unclosed <ssl.SSLSocket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54712), raddr=('142.250.187.202', 443)>
2021-11-02 16:31:32.882839 (MainThread): unclosed <ssl.SSLSocket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54711), raddr=('142.250.187.202', 443)>
2021-11-02 16:31:32.883007 (MainThread): unclosed <ssl.SSLSocket fd=21, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54714), raddr=('216.58.212.202', 443)>
2021-11-02 16:31:32.883206 (MainThread): unclosed <ssl.SSLSocket fd=22, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54715), raddr=('216.58.212.202', 443)>
2021-11-02 16:31:32.883408 (MainThread): unclosed <ssl.SSLSocket fd=23, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54716), raddr=('216.58.212.202', 443)>
2021-11-02 16:31:32.883616 (MainThread): unclosed <ssl.SSLSocket fd=24, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54718), raddr=('142.250.187.202', 443)>
2021-11-02 16:31:32.883812 (MainThread): unclosed <ssl.SSLSocket fd=25, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54719), raddr=('216.58.212.202', 443)>
2021-11-02 16:31:32.890833 (MainThread): 
2021-11-02 16:31:32.891109 (MainThread): Completed successfully
2021-11-02 16:31:32.891274 (MainThread): 
Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
2021-11-02 16:31:32.891514 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cedd070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ceddc40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cedd490>]}
2021-11-02 16:31:32.891761 (MainThread): Flushing usage events
2021-11-02 17:07:27.564327 (MainThread): Running with dbt=0.21.0
2021-11-02 17:07:28.282932 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 17:07:28.285709 (MainThread): Tracking: tracking
2021-11-02 17:07:28.303614 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111256310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1131e91f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1131e9610>]}
2021-11-02 17:07:28.323192 (MainThread): Partial parsing not enabled
2021-11-02 17:07:28.389613 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 17:07:28.390948 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 17:07:28.391664 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 17:07:28.392771 (MainThread): Parsing macros/etc.sql
2021-11-02 17:07:28.397563 (MainThread): Parsing macros/catalog.sql
2021-11-02 17:07:28.407433 (MainThread): Parsing macros/adapters.sql
2021-11-02 17:07:28.434094 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 17:07:28.436720 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 17:07:28.439252 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 17:07:28.448192 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 17:07:28.450719 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 17:07:28.465269 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 17:07:28.466983 (MainThread): Parsing macros/core.sql
2021-11-02 17:07:28.470471 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 17:07:28.476728 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 17:07:28.485996 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 17:07:28.487489 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 17:07:28.503658 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 17:07:28.534430 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 17:07:28.556230 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 17:07:28.557903 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 17:07:28.567334 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 17:07:28.585987 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 17:07:28.599277 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 17:07:28.606472 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 17:07:28.613329 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 17:07:28.616863 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 17:07:28.618277 (MainThread): Parsing macros/etc/query.sql
2021-11-02 17:07:28.619172 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 17:07:28.620524 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 17:07:28.628418 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 17:07:28.630034 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 17:07:28.632253 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 17:07:28.633678 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 17:07:28.685784 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 17:07:28.687336 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 17:07:28.688405 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 17:07:28.689655 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 17:07:28.691651 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 17:07:28.692718 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 17:07:28.693855 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 17:07:28.694760 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 17:07:28.700240 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 17:07:28.701266 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 17:07:28.702451 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 17:07:28.705255 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 17:07:28.706268 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 17:07:28.708330 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 17:07:28.718251 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 17:07:28.720203 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 17:07:28.721508 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 17:07:28.722809 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 17:07:28.724322 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 17:07:28.725847 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 17:07:28.726711 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 17:07:28.729995 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 17:07:28.734794 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 17:07:28.738096 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 17:07:28.739761 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 17:07:28.741220 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 17:07:28.743033 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 17:07:28.767315 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 17:07:28.769058 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 17:07:28.771500 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 17:07:28.772975 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 17:07:28.774011 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 17:07:28.775137 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 17:07:28.776215 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 17:07:28.777306 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 17:07:28.778891 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 17:07:28.780426 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 17:07:28.782563 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 17:07:28.784158 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 17:07:28.785277 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 17:07:28.787508 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 17:07:28.789516 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 17:07:28.790902 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 17:07:28.792262 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 17:07:28.794898 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 17:07:28.796715 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 17:07:28.798355 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 17:07:28.800479 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 17:07:28.802936 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 17:07:28.804242 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 17:07:28.807488 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 17:07:28.815948 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 17:07:28.820365 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 17:07:28.821834 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 17:07:28.825108 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 17:07:28.829167 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 17:07:28.832292 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 17:07:28.833820 (MainThread): Parsing macros/sql/star.sql
2021-11-02 17:07:28.837104 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 17:07:28.844865 (MainThread): Parsing macros/sql/union.sql
2021-11-02 17:07:28.852625 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 17:07:28.853855 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 17:07:28.857034 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 17:07:28.858521 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 17:07:28.860144 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 17:07:28.866046 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 17:07:28.870682 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 17:07:28.874402 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 17:07:28.876579 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 17:07:29.211213 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:07:29.224145 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:07:29.227963 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:07:29.231500 (MainThread): Acquiring new bigquery connection "model.freetrade_test.monthly_subscription_revenue".
2021-11-02 17:07:29.264615 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 17:07:29.297750 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:07:29.299528 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:07:29.301278 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:07:29.302927 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:07:29.303296 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:07:29.303470 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:07:29.303648 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:07:29.303798 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:07:29.365248 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 17:07:29.371732 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5c1c4058-ca15-49d1-a3a8-27c0949796e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1132f4fa0>]}
2021-11-02 17:07:29.382393 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 17:07:29.383041 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5c1c4058-ca15-49d1-a3a8-27c0949796e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1133b81f0>]}
2021-11-02 17:07:29.383385 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 17:07:29.384889 (MainThread): 
2021-11-02 17:07:29.385266 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:07:29.386443 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 17:07:29.386686 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 17:07:29.857979 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 17:07:29.858613 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 17:07:29.871150 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:07:30.200370 (MainThread): 17:07:30 | 
2021-11-02 17:07:30.200906 (MainThread): 17:07:30 | Running 1 on-run-start hook
2021-11-02 17:07:30.201310 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 17:07:30.203140 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54897), raddr=('172.217.169.42', 443)>
2021-11-02 17:07:30.203475 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54898), raddr=('216.58.212.202', 443)>
2021-11-02 17:07:30.212232 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 17:07:30.217553 (MainThread): 17:07:30 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 17:07:30.217977 (MainThread): Opening a new connection, currently in state closed
2021-11-02 17:07:30.226475 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 17:07:32.700020 (MainThread): 17:07:32 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.48s]
2021-11-02 17:07:32.700428 (MainThread): 17:07:32 | 
2021-11-02 17:07:32.701043 (MainThread): 17:07:32 | Concurrency: 4 threads (target='dev')
2021-11-02 17:07:32.701327 (MainThread): 17:07:32 | 
2021-11-02 17:07:32.709051 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 17:07:32.709482 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:07:32.709953 (Thread-1): 17:07:32 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 17:07:32.710190 (Thread-3): Began running node model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:07:32.710615 (Thread-2): 17:07:32 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 17:07:32.711351 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:07:32.711691 (Thread-3): 17:07:32 | 3 of 4 START table model ft_data.monthly_subscription_revenue........ [RUN]
2021-11-02 17:07:32.712207 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:07:32.712466 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 17:07:32.713065 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.monthly_subscription_revenue".
2021-11-02 17:07:32.713306 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:07:32.717595 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:07:32.717824 (Thread-3): Compiling model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:07:32.720596 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:07:32.728246 (Thread-3): Opening a new connection, currently in state init
2021-11-02 17:07:32.728829 (Thread-1): finished collecting timing info
2021-11-02 17:07:32.748193 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 17:07:32.748432 (Thread-2): finished collecting timing info
2021-11-02 17:07:32.750429 (Thread-2): Opening a new connection, currently in state init
2021-11-02 17:07:32.750881 (Thread-3): On model.freetrade_test.monthly_subscription_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */


        select 

    datetime_diff(
        cast(cast('2022-01-01' as date) as datetime),
        cast(cast('2021-01-01' as date) as datetime),
        month
    )


2021-11-02 17:07:32.757576 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:07:32.757829 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:07:33.108847 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:07:33.110976 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:07:33.111548 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 17:07:33.112645 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 17:07:33.924458 (Thread-3): Writing injected SQL for node "model.freetrade_test.monthly_subscription_revenue"
2021-11-02 17:07:33.927289 (Thread-3): finished collecting timing info
2021-11-02 17:07:33.933655 (Thread-3): Writing runtime SQL for node "model.freetrade_test.monthly_subscription_revenue"
2021-11-02 17:07:33.935311 (Thread-3): On model.freetrade_test.monthly_subscription_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */


  create or replace table `ft-data-330317`.`ft_data`.`monthly_subscription_revenue`
  
  
  OPTIONS()
  as (
    

with months as 

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 12
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2021-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2022-01-01' as date)

)

select * from filtered



select
    subscriptions.customer_id,
    subscriptions.subscription_id,
    subscriptions.monthly_fee,
    subscriptions.subscription_type,
    subscriptions.created_at,
    DATE_ADD(months.date_month, INTERVAL (
        EXTRACT(DAY FROM subscriptions.created_at) - EXTRACT(DAY FROM months.date_month)) DAY) as billing_date

from `ft-data-330317.ft_source_data.subscriptions` subscriptions

join months
    -- all months after start date
    on  months.date_month >= DATE(subscriptions.created_at)
    -- and before end date
    and months.date_month <= DATE('2022-01-01')

ORDER BY customer_id, date_month ASC
  );
    
2021-11-02 17:07:34.080712 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Syntax error: Expected "(" but got keyword WITH at [24:1]')
2021-11-02 17:07:35.020197 (Thread-2): finished collecting timing info
2021-11-02 17:07:35.020888 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5c1c4058-ca15-49d1-a3a8-27c0949796e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11330b250>]}
2021-11-02 17:07:35.021422 (Thread-2): 17:07:35 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.31s]
2021-11-02 17:07:35.021680 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:07:35.243753 (Thread-3): finished collecting timing info
2021-11-02 17:07:35.244790 (Thread-3): Database Error in model monthly_subscription_revenue (models/revenue/monthly_subscription_revenue.sql)
  Syntax error: Expected "(" but got keyword WITH at [24:1]
  compiled SQL at target/run/freetrade_test/models/revenue/monthly_subscription_revenue.sql
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Expected "(" but got keyword WITH at [24:1]

(job ID: fc27e153-1e60-465c-aac9-1298837b9983)

                                                                     -----Query Job SQL Follows-----                                                                      

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */
   2:
   3:
   4:  create or replace table `ft-data-330317`.`ft_data`.`monthly_subscription_revenue`
   5:  
   6:  
   7:  OPTIONS()
   8:  as (
   9:    
  10:
  11:with months as 
  12:
  13:/*
  14:call as follows:
  15:
  16:date_spine(
  17:    "day",
  18:    "to_date('01/01/2016', 'mm/dd/yyyy')",
  19:    "dateadd(week, 1, current_date)"
  20:)
  21:
  22:*/
  23:
  24:with rawdata as (
  25:
  26:    
  27:
  28:    
  29:
  30:    with p as (
  31:        select 0 as generated_number union all select 1
  32:    ), unioned as (
  33:
  34:    select
  35:
  36:    
  37:    p0.generated_number * power(2, 0)
  38:     + 
  39:    
  40:    p1.generated_number * power(2, 1)
  41:     + 
  42:    
  43:    p2.generated_number * power(2, 2)
  44:     + 
  45:    
  46:    p3.generated_number * power(2, 3)
  47:    
  48:    
  49:    + 1
  50:    as generated_number
  51:
  52:    from
  53:
  54:    
  55:    p as p0
  56:     cross join 
  57:    
  58:    p as p1
  59:     cross join 
  60:    
  61:    p as p2
  62:     cross join 
  63:    
  64:    p as p3
  65:    
  66:    
  67:
  68:    )
  69:
  70:    select *
  71:    from unioned
  72:    where generated_number <= 12
  73:    order by generated_number
  74:
  75:
  76:
  77:),
  78:
  79:all_periods as (
  80:
  81:    select (
  82:        
  83:
  84:        datetime_add(
  85:            cast( cast('2021-01-01' as date) as datetime),
  86:        interval row_number() over (order by 1) - 1 month
  87:        )
  88:
  89:
  90:    ) as date_month
  91:    from rawdata
  92:
  93:),
  94:
  95:filtered as (
  96:
  97:    select *
  98:    from all_periods
  99:    where date_month <= cast('2022-01-01' as date)
 100:
 101:)
 102:
 103:select * from filtered
 104:
 105:
 106:
 107:select
 108:    subscriptions.customer_id,
 109:    subscriptions.subscription_id,
 110:    subscriptions.monthly_fee,
 111:    subscriptions.subscription_type,
 112:    subscriptions.created_at,
 113:    DATE_ADD(months.date_month, INTERVAL (
 114:        EXTRACT(DAY FROM subscriptions.created_at) - EXTRACT(DAY FROM months.date_month)) DAY) as billing_date
 115:
 116:from `ft-data-330317.ft_source_data.subscriptions` subscriptions
 117:
 118:join months
 119:    -- all months after start date
 120:    on  months.date_month >= DATE(subscriptions.created_at)
 121:    -- and before end date
 122:    and months.date_month <= DATE('2022-01-01')
 123:
 124:ORDER BY customer_id, date_month ASC
 125:  );
 126:    
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 291, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 393, in run
    return self.execute(compiled_node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 249, in execute
    result = MacroGenerator(materialization_macro, context)()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 128, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 41, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model monthly_subscription_revenue (models/revenue/monthly_subscription_revenue.sql)
  Syntax error: Expected "(" but got keyword WITH at [24:1]
  compiled SQL at target/run/freetrade_test/models/revenue/monthly_subscription_revenue.sql
2021-11-02 17:07:35.274370 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5c1c4058-ca15-49d1-a3a8-27c0949796e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11330bfa0>]}
2021-11-02 17:07:35.275235 (Thread-3): 17:07:35 | 3 of 4 ERROR creating table model ft_data.monthly_subscription_revenue [ERROR in 2.56s]
2021-11-02 17:07:35.275708 (Thread-3): Finished running node model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:07:35.602254 (Thread-1): finished collecting timing info
2021-11-02 17:07:35.603349 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5c1c4058-ca15-49d1-a3a8-27c0949796e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113445070>]}
2021-11-02 17:07:35.604094 (Thread-1): 17:07:35 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.89s]
2021-11-02 17:07:35.604391 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 17:07:35.606403 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 17:07:35.607299 (Thread-4): 17:07:35 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 17:07:35.608027 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:07:35.608314 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 17:07:35.614580 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:07:35.615354 (Thread-4): finished collecting timing info
2021-11-02 17:07:35.618332 (Thread-4): Opening a new connection, currently in state init
2021-11-02 17:07:35.625830 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:07:35.936281 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:07:35.937423 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 17:07:40.336348 (Thread-4): finished collecting timing info
2021-11-02 17:07:40.337445 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5c1c4058-ca15-49d1-a3a8-27c0949796e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11473a1c0>]}
2021-11-02 17:07:40.338261 (Thread-4): 17:07:40 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.73s]
2021-11-02 17:07:40.338563 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 17:07:40.340533 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:07:40.341166 (MainThread): 17:07:40 | 
2021-11-02 17:07:40.341460 (MainThread): 17:07:40 | Finished running 4 table models, 1 hook in 10.96s.
2021-11-02 17:07:40.341712 (MainThread): Connection 'master' was properly closed.
2021-11-02 17:07:40.342027 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 17:07:40.342243 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 17:07:40.342439 (MainThread): Connection 'model.freetrade_test.monthly_subscription_revenue' was properly closed.
2021-11-02 17:07:40.342630 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 17:07:40.355244 (MainThread): 
2021-11-02 17:07:40.355510 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 17:07:40.355688 (MainThread): 
2021-11-02 17:07:40.355857 (MainThread): Database Error in model monthly_subscription_revenue (models/revenue/monthly_subscription_revenue.sql)
2021-11-02 17:07:40.356015 (MainThread):   Syntax error: Expected "(" but got keyword WITH at [24:1]
2021-11-02 17:07:40.356158 (MainThread):   compiled SQL at target/run/freetrade_test/models/revenue/monthly_subscription_revenue.sql
2021-11-02 17:07:40.356318 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 17:07:40.356575 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113497e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1132e67c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1133de100>]}
2021-11-02 17:07:40.356846 (MainThread): Flushing usage events
2021-11-02 17:07:58.901088 (MainThread): Running with dbt=0.21.0
2021-11-02 17:07:59.205748 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 17:07:59.206917 (MainThread): Tracking: tracking
2021-11-02 17:07:59.219220 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ccb73a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec477c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec47040>]}
2021-11-02 17:07:59.236661 (MainThread): Partial parsing not enabled
2021-11-02 17:07:59.260401 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 17:07:59.261436 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 17:07:59.261941 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 17:07:59.262696 (MainThread): Parsing macros/etc.sql
2021-11-02 17:07:59.265034 (MainThread): Parsing macros/catalog.sql
2021-11-02 17:07:59.270943 (MainThread): Parsing macros/adapters.sql
2021-11-02 17:07:59.292088 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 17:07:59.294433 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 17:07:59.296792 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 17:07:59.305716 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 17:07:59.308717 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 17:07:59.322917 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 17:07:59.324543 (MainThread): Parsing macros/core.sql
2021-11-02 17:07:59.327993 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 17:07:59.334120 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 17:07:59.343398 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 17:07:59.344900 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 17:07:59.360762 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 17:07:59.391498 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 17:07:59.413303 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 17:07:59.414973 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 17:07:59.424375 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 17:07:59.446351 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 17:07:59.460032 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 17:07:59.467409 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 17:07:59.474229 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 17:07:59.477806 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 17:07:59.479136 (MainThread): Parsing macros/etc/query.sql
2021-11-02 17:07:59.479989 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 17:07:59.481344 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 17:07:59.489255 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 17:07:59.490872 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 17:07:59.493140 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 17:07:59.494565 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 17:07:59.547851 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 17:07:59.549576 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 17:07:59.550730 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 17:07:59.552040 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 17:07:59.554279 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 17:07:59.555272 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 17:07:59.556409 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 17:07:59.557468 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 17:07:59.562979 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 17:07:59.564009 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 17:07:59.565200 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 17:07:59.567954 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 17:07:59.568912 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 17:07:59.570975 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 17:07:59.580292 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 17:07:59.581972 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 17:07:59.583250 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 17:07:59.584547 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 17:07:59.586046 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 17:07:59.587486 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 17:07:59.588359 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 17:07:59.591744 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 17:07:59.596549 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 17:07:59.599827 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 17:07:59.601568 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 17:07:59.603038 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 17:07:59.604810 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 17:07:59.628540 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 17:07:59.630314 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 17:07:59.632836 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 17:07:59.634315 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 17:07:59.635350 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 17:07:59.636476 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 17:07:59.637521 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 17:07:59.638630 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 17:07:59.640230 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 17:07:59.641855 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 17:07:59.643984 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 17:07:59.645576 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 17:07:59.646699 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 17:07:59.648927 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 17:07:59.650862 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 17:07:59.652208 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 17:07:59.653357 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 17:07:59.655942 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 17:07:59.657762 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 17:07:59.659660 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 17:07:59.661829 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 17:07:59.664296 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 17:07:59.665608 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 17:07:59.669013 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 17:07:59.677561 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 17:07:59.681871 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 17:07:59.683342 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 17:07:59.686608 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 17:07:59.690636 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 17:07:59.694131 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 17:07:59.695718 (MainThread): Parsing macros/sql/star.sql
2021-11-02 17:07:59.699244 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 17:07:59.707562 (MainThread): Parsing macros/sql/union.sql
2021-11-02 17:07:59.715707 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 17:07:59.717019 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 17:07:59.720377 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 17:07:59.721936 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 17:07:59.723491 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 17:07:59.729591 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 17:07:59.734228 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 17:07:59.738119 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 17:07:59.740279 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 17:08:00.072464 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:08:00.085403 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:08:00.089043 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:08:00.092640 (MainThread): Acquiring new bigquery connection "model.freetrade_test.monthly_subscription_revenue".
2021-11-02 17:08:00.125167 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 17:08:00.158362 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:08:00.160072 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:08:00.161802 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:08:00.163365 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:08:00.163740 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:08:00.163914 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:08:00.164095 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:08:00.164265 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:08:00.223866 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 17:08:00.230094 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3092e9fb-676a-45fb-86c6-fb21e1078261', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed22fa0>]}
2021-11-02 17:08:00.239838 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 17:08:00.240354 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3092e9fb-676a-45fb-86c6-fb21e1078261', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eea3dc0>]}
2021-11-02 17:08:00.240643 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 17:08:00.242129 (MainThread): 
2021-11-02 17:08:00.242526 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:08:00.243633 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 17:08:00.243859 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 17:08:00.671932 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 17:08:00.672574 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 17:08:00.684487 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:08:00.994445 (MainThread): 17:08:00 | 
2021-11-02 17:08:00.994991 (MainThread): 17:08:00 | Running 1 on-run-start hook
2021-11-02 17:08:00.995397 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 17:08:00.997225 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54913), raddr=('142.250.187.234', 443)>
2021-11-02 17:08:00.997703 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54914), raddr=('216.58.212.202', 443)>
2021-11-02 17:08:01.007315 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 17:08:01.009689 (MainThread): 17:08:01 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 17:08:01.010042 (MainThread): Opening a new connection, currently in state closed
2021-11-02 17:08:01.017687 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 17:08:03.447036 (MainThread): 17:08:03 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.44s]
2021-11-02 17:08:03.447703 (MainThread): 17:08:03 | 
2021-11-02 17:08:03.448353 (MainThread): 17:08:03 | Concurrency: 4 threads (target='dev')
2021-11-02 17:08:03.448648 (MainThread): 17:08:03 | 
2021-11-02 17:08:03.452268 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 17:08:03.452656 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:08:03.453125 (Thread-1): 17:08:03 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 17:08:03.453371 (Thread-3): Began running node model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:08:03.453775 (Thread-2): 17:08:03 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 17:08:03.454308 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:08:03.454698 (Thread-3): 17:08:03 | 3 of 4 START table model ft_data.monthly_subscription_revenue........ [RUN]
2021-11-02 17:08:03.455221 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:08:03.455485 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 17:08:03.456088 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.monthly_subscription_revenue".
2021-11-02 17:08:03.456331 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:08:03.460506 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:08:03.460712 (Thread-3): Compiling model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:08:03.463505 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:08:03.470961 (Thread-3): Opening a new connection, currently in state init
2021-11-02 17:08:03.471444 (Thread-1): finished collecting timing info
2021-11-02 17:08:03.484529 (Thread-2): finished collecting timing info
2021-11-02 17:08:03.492675 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 17:08:03.495179 (Thread-2): Opening a new connection, currently in state init
2021-11-02 17:08:03.495491 (Thread-3): On model.freetrade_test.monthly_subscription_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */


        select 

    datetime_diff(
        cast(cast('2022-01-01' as date) as datetime),
        cast(cast('2021-01-01' as date) as datetime),
        month
    )


2021-11-02 17:08:03.501711 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:08:03.503473 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:08:03.837401 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:08:03.839601 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:08:03.840239 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 17:08:03.841330 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 17:08:04.395745 (Thread-3): Writing injected SQL for node "model.freetrade_test.monthly_subscription_revenue"
2021-11-02 17:08:04.396599 (Thread-3): finished collecting timing info
2021-11-02 17:08:04.401381 (Thread-3): Writing runtime SQL for node "model.freetrade_test.monthly_subscription_revenue"
2021-11-02 17:08:04.402001 (Thread-3): On model.freetrade_test.monthly_subscription_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */


  create or replace table `ft-data-330317`.`ft_data`.`monthly_subscription_revenue`
  
  
  OPTIONS()
  as (
    

with months as (SELECT * FROM 

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 12
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2021-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2022-01-01' as date)

)

select * from filtered

)

select
    subscriptions.customer_id,
    subscriptions.subscription_id,
    subscriptions.monthly_fee,
    subscriptions.subscription_type,
    subscriptions.created_at,
    DATE_ADD(months.date_month, INTERVAL (
        EXTRACT(DAY FROM subscriptions.created_at) - EXTRACT(DAY FROM months.date_month)) DAY) as billing_date

from `ft-data-330317.ft_source_data.subscriptions` subscriptions

join months
    -- all months after start date
    on  months.date_month >= DATE(subscriptions.created_at)
    -- and before end date
    and months.date_month <= DATE('2022-01-01')

ORDER BY customer_id, date_month ASC
  );
    
2021-11-02 17:08:04.530022 (Thread-3): Retry attempt 1 of 1 after error: BadRequest('Syntax error: Unexpected keyword WITH at [24:1]')
2021-11-02 17:08:05.165878 (Thread-3): finished collecting timing info
2021-11-02 17:08:05.166932 (Thread-3): Database Error in model monthly_subscription_revenue (models/revenue/monthly_subscription_revenue.sql)
  Syntax error: Unexpected keyword WITH at [24:1]
  compiled SQL at target/run/freetrade_test/models/revenue/monthly_subscription_revenue.sql
Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 163, in exception_handler
    yield
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 345, in fn
    return self._query_and_results(client, sql, conn, job_params)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 552, in _query_and_results
    iterator = query_job.result(timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1450, in result
    do_get_result()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 286, in retry_wrapped_func
    return retry_target(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/retry.py", line 189, in retry_target
    return target()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/query.py", line 1440, in do_get_result
    super(QueryJob, self).result(retry=retry, timeout=timeout)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/cloud/bigquery/job/base.py", line 727, in result
    return super(_AsyncJob, self).result(timeout=timeout, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/google/api_core/future/polling.py", line 135, in result
    raise self._exception
google.api_core.exceptions.BadRequest: 400 Syntax error: Unexpected keyword WITH at [24:1]

(job ID: ad9ca079-438d-4eda-9892-7c493034fc43)

                                                                     -----Query Job SQL Follows-----                                                                      

    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
   1:/* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */
   2:
   3:
   4:  create or replace table `ft-data-330317`.`ft_data`.`monthly_subscription_revenue`
   5:  
   6:  
   7:  OPTIONS()
   8:  as (
   9:    
  10:
  11:with months as (SELECT * FROM 
  12:
  13:/*
  14:call as follows:
  15:
  16:date_spine(
  17:    "day",
  18:    "to_date('01/01/2016', 'mm/dd/yyyy')",
  19:    "dateadd(week, 1, current_date)"
  20:)
  21:
  22:*/
  23:
  24:with rawdata as (
  25:
  26:    
  27:
  28:    
  29:
  30:    with p as (
  31:        select 0 as generated_number union all select 1
  32:    ), unioned as (
  33:
  34:    select
  35:
  36:    
  37:    p0.generated_number * power(2, 0)
  38:     + 
  39:    
  40:    p1.generated_number * power(2, 1)
  41:     + 
  42:    
  43:    p2.generated_number * power(2, 2)
  44:     + 
  45:    
  46:    p3.generated_number * power(2, 3)
  47:    
  48:    
  49:    + 1
  50:    as generated_number
  51:
  52:    from
  53:
  54:    
  55:    p as p0
  56:     cross join 
  57:    
  58:    p as p1
  59:     cross join 
  60:    
  61:    p as p2
  62:     cross join 
  63:    
  64:    p as p3
  65:    
  66:    
  67:
  68:    )
  69:
  70:    select *
  71:    from unioned
  72:    where generated_number <= 12
  73:    order by generated_number
  74:
  75:
  76:
  77:),
  78:
  79:all_periods as (
  80:
  81:    select (
  82:        
  83:
  84:        datetime_add(
  85:            cast( cast('2021-01-01' as date) as datetime),
  86:        interval row_number() over (order by 1) - 1 month
  87:        )
  88:
  89:
  90:    ) as date_month
  91:    from rawdata
  92:
  93:),
  94:
  95:filtered as (
  96:
  97:    select *
  98:    from all_periods
  99:    where date_month <= cast('2022-01-01' as date)
 100:
 101:)
 102:
 103:select * from filtered
 104:
 105:)
 106:
 107:select
 108:    subscriptions.customer_id,
 109:    subscriptions.subscription_id,
 110:    subscriptions.monthly_fee,
 111:    subscriptions.subscription_type,
 112:    subscriptions.created_at,
 113:    DATE_ADD(months.date_month, INTERVAL (
 114:        EXTRACT(DAY FROM subscriptions.created_at) - EXTRACT(DAY FROM months.date_month)) DAY) as billing_date
 115:
 116:from `ft-data-330317.ft_source_data.subscriptions` subscriptions
 117:
 118:join months
 119:    -- all months after start date
 120:    on  months.date_month >= DATE(subscriptions.created_at)
 121:    -- and before end date
 122:    and months.date_month <= DATE('2022-01-01')
 123:
 124:ORDER BY customer_id, date_month ASC
 125:  );
 126:    
    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 348, in safe_run
    result = self.compile_and_execute(manifest, ctx)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 291, in compile_and_execute
    result = self.run(ctx.node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/base.py", line 393, in run
    return self.execute(compiled_node, manifest)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/task/run.py", line 249, in execute
    result = MacroGenerator(materialization_macro, context)()
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 128, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 333, in __call__
    return self.call_macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/clients/jinja.py", line 260, in call_macro
    return macro(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 675, in __call__
    return self._invoke(arguments, autoescape)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 679, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 41, in macro
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/sandbox.py", line 462, in call
    return __context.call(__obj, *args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/jinja2/runtime.py", line 290, in call
    return __obj(*args, **kwargs)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/base/impl.py", line 226, in execute
    return self.connections.execute(
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 356, in execute
    query_job, iterator = self.raw_execute(sql, fetch=fetch)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 347, in raw_execute
    query_job, iterator = self._retry_and_handle(msg=sql, conn=conn, fn=fn)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 566, in _retry_and_handle
    return retry.retry_target(
  File "/usr/local/Cellar/python@3.9/3.9.7_1/Frameworks/Python.framework/Versions/3.9/lib/python3.9/contextlib.py", line 137, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 167, in exception_handler
    self.handle_error(e, message)
  File "/Users/stephenkyriacou/Projects/freetrade_dbt/freetrade_dbt/lib/python3.9/site-packages/dbt/adapters/bigquery/connections.py", line 155, in handle_error
    raise DatabaseException(error_msg)
dbt.exceptions.DatabaseException: Database Error in model monthly_subscription_revenue (models/revenue/monthly_subscription_revenue.sql)
  Syntax error: Unexpected keyword WITH at [24:1]
  compiled SQL at target/run/freetrade_test/models/revenue/monthly_subscription_revenue.sql
2021-11-02 17:08:05.172652 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3092e9fb-676a-45fb-86c6-fb21e1078261', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee733a0>]}
2021-11-02 17:08:05.173297 (Thread-3): 17:08:05 | 3 of 4 ERROR creating table model ft_data.monthly_subscription_revenue [ERROR in 1.72s]
2021-11-02 17:08:05.173566 (Thread-3): Finished running node model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:08:05.728896 (Thread-2): finished collecting timing info
2021-11-02 17:08:05.729594 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3092e9fb-676a-45fb-86c6-fb21e1078261', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eea2400>]}
2021-11-02 17:08:05.730116 (Thread-2): 17:08:05 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.27s]
2021-11-02 17:08:05.730381 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:08:05.779249 (Thread-1): finished collecting timing info
2021-11-02 17:08:05.779991 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3092e9fb-676a-45fb-86c6-fb21e1078261', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ef17fd0>]}
2021-11-02 17:08:05.780515 (Thread-1): 17:08:05 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.33s]
2021-11-02 17:08:05.780773 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 17:08:05.781382 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 17:08:05.781768 (Thread-4): 17:08:05 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 17:08:05.782271 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:08:05.782506 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 17:08:05.787887 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:08:05.788580 (Thread-4): finished collecting timing info
2021-11-02 17:08:05.791000 (Thread-4): Opening a new connection, currently in state init
2021-11-02 17:08:05.797968 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:08:06.116702 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:08:06.117370 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 17:08:10.380194 (Thread-4): finished collecting timing info
2021-11-02 17:08:10.381285 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3092e9fb-676a-45fb-86c6-fb21e1078261', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f171df0>]}
2021-11-02 17:08:10.382050 (Thread-4): 17:08:10 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.60s]
2021-11-02 17:08:10.382358 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 17:08:10.384320 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:08:10.384964 (MainThread): 17:08:10 | 
2021-11-02 17:08:10.385266 (MainThread): 17:08:10 | Finished running 4 table models, 1 hook in 10.14s.
2021-11-02 17:08:10.385523 (MainThread): Connection 'master' was properly closed.
2021-11-02 17:08:10.385729 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 17:08:10.385925 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 17:08:10.386114 (MainThread): Connection 'model.freetrade_test.monthly_subscription_revenue' was properly closed.
2021-11-02 17:08:10.386303 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 17:08:10.398944 (MainThread): 
2021-11-02 17:08:10.399208 (MainThread): Completed with 1 error and 0 warnings:
2021-11-02 17:08:10.399391 (MainThread): 
2021-11-02 17:08:10.399563 (MainThread): Database Error in model monthly_subscription_revenue (models/revenue/monthly_subscription_revenue.sql)
2021-11-02 17:08:10.399721 (MainThread):   Syntax error: Unexpected keyword WITH at [24:1]
2021-11-02 17:08:10.399866 (MainThread):   compiled SQL at target/run/freetrade_test/models/revenue/monthly_subscription_revenue.sql
2021-11-02 17:08:10.400027 (MainThread): 
Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
2021-11-02 17:08:10.400286 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec47850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eef7460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed76f10>]}
2021-11-02 17:08:10.400563 (MainThread): Flushing usage events
2021-11-02 17:08:49.342799 (MainThread): Running with dbt=0.21.0
2021-11-02 17:08:49.926995 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 17:08:49.929876 (MainThread): Tracking: tracking
2021-11-02 17:08:49.943537 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be5e340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ddf1af0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ddf1970>]}
2021-11-02 17:08:49.962720 (MainThread): Partial parsing not enabled
2021-11-02 17:08:50.022547 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 17:08:50.023680 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 17:08:50.024232 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 17:08:50.025043 (MainThread): Parsing macros/etc.sql
2021-11-02 17:08:50.028083 (MainThread): Parsing macros/catalog.sql
2021-11-02 17:08:50.034992 (MainThread): Parsing macros/adapters.sql
2021-11-02 17:08:50.057263 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 17:08:50.059741 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 17:08:50.062236 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 17:08:50.071164 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 17:08:50.073622 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 17:08:50.087085 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 17:08:50.088595 (MainThread): Parsing macros/core.sql
2021-11-02 17:08:50.091987 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 17:08:50.098257 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 17:08:50.107351 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 17:08:50.108894 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 17:08:50.124891 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 17:08:50.155631 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 17:08:50.177243 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 17:08:50.178826 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 17:08:50.188120 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 17:08:50.207080 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 17:08:50.223111 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 17:08:50.230720 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 17:08:50.237717 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 17:08:50.241379 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 17:08:50.242727 (MainThread): Parsing macros/etc/query.sql
2021-11-02 17:08:50.243588 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 17:08:50.244938 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 17:08:50.252788 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 17:08:50.254384 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 17:08:50.256548 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 17:08:50.258043 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 17:08:50.312110 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 17:08:50.313750 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 17:08:50.314832 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 17:08:50.316078 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 17:08:50.318093 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 17:08:50.319056 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 17:08:50.320386 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 17:08:50.321291 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 17:08:50.326947 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 17:08:50.327973 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 17:08:50.329156 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 17:08:50.331891 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 17:08:50.332845 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 17:08:50.334917 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 17:08:50.344471 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 17:08:50.346174 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 17:08:50.347463 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 17:08:50.348840 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 17:08:50.350346 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 17:08:50.351759 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 17:08:50.352628 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 17:08:50.355903 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 17:08:50.360870 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 17:08:50.364122 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 17:08:50.365864 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 17:08:50.367340 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 17:08:50.369088 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 17:08:50.392753 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 17:08:50.394419 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 17:08:50.396789 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 17:08:50.398224 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 17:08:50.399242 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 17:08:50.400351 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 17:08:50.401408 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 17:08:50.402486 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 17:08:50.404064 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 17:08:50.405564 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 17:08:50.407782 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 17:08:50.409380 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 17:08:50.410514 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 17:08:50.412742 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 17:08:50.414833 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 17:08:50.416135 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 17:08:50.417279 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 17:08:50.419856 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 17:08:50.421716 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 17:08:50.423353 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 17:08:50.425598 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 17:08:50.428027 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 17:08:50.429336 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 17:08:50.432616 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 17:08:50.441301 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 17:08:50.446186 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 17:08:50.447748 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 17:08:50.451031 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 17:08:50.455062 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 17:08:50.458411 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 17:08:50.459988 (MainThread): Parsing macros/sql/star.sql
2021-11-02 17:08:50.463334 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 17:08:50.470787 (MainThread): Parsing macros/sql/union.sql
2021-11-02 17:08:50.478455 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 17:08:50.479673 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 17:08:50.483162 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 17:08:50.484656 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 17:08:50.486151 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 17:08:50.493297 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 17:08:50.498149 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 17:08:50.501998 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 17:08:50.504173 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 17:08:50.881949 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:08:50.895765 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:08:50.899737 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:08:50.903796 (MainThread): Acquiring new bigquery connection "model.freetrade_test.monthly_subscription_revenue".
2021-11-02 17:08:50.942460 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 17:08:50.978368 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:08:50.980141 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:08:50.981984 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:08:50.983663 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:08:50.984053 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:08:50.984214 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:08:50.984406 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:08:50.984548 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:08:51.041726 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 17:08:51.047307 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '193a4d10-70b8-47d4-8b03-454ca8e66925', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10defdee0>]}
2021-11-02 17:08:51.055982 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 17:08:51.056381 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '193a4d10-70b8-47d4-8b03-454ca8e66925', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dfb71f0>]}
2021-11-02 17:08:51.056612 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 17:08:51.057826 (MainThread): 
2021-11-02 17:08:51.058147 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:08:51.059064 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 17:08:51.059235 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 17:08:51.466896 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 17:08:51.467535 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 17:08:51.479500 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:08:51.817228 (MainThread): 17:08:51 | 
2021-11-02 17:08:51.817783 (MainThread): 17:08:51 | Running 1 on-run-start hook
2021-11-02 17:08:51.818195 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 17:08:51.820061 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54931), raddr=('142.250.187.234', 443)>
2021-11-02 17:08:51.820530 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 54932), raddr=('216.58.212.202', 443)>
2021-11-02 17:08:51.829920 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 17:08:51.834440 (MainThread): 17:08:51 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 17:08:51.834902 (MainThread): Opening a new connection, currently in state closed
2021-11-02 17:08:51.844420 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 17:08:54.231739 (MainThread): 17:08:54 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.40s]
2021-11-02 17:08:54.232341 (MainThread): 17:08:54 | 
2021-11-02 17:08:54.233184 (MainThread): 17:08:54 | Concurrency: 4 threads (target='dev')
2021-11-02 17:08:54.233603 (MainThread): 17:08:54 | 
2021-11-02 17:08:54.238389 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 17:08:54.238824 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:08:54.239316 (Thread-1): 17:08:54 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 17:08:54.239565 (Thread-3): Began running node model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:08:54.240027 (Thread-2): 17:08:54 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 17:08:54.240639 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:08:54.241082 (Thread-3): 17:08:54 | 3 of 4 START table model ft_data.monthly_subscription_revenue........ [RUN]
2021-11-02 17:08:54.241834 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:08:54.242182 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 17:08:54.243022 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.monthly_subscription_revenue".
2021-11-02 17:08:54.243381 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:08:54.247623 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:08:54.247888 (Thread-3): Compiling model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:08:54.250729 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:08:54.258904 (Thread-3): Opening a new connection, currently in state init
2021-11-02 17:08:54.259774 (Thread-1): finished collecting timing info
2021-11-02 17:08:54.271712 (Thread-2): finished collecting timing info
2021-11-02 17:08:54.278014 (Thread-3): On model.freetrade_test.monthly_subscription_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */


        select 

    datetime_diff(
        cast(cast('2022-01-01' as date) as datetime),
        cast(cast('2021-01-01' as date) as datetime),
        month
    )


2021-11-02 17:08:54.280728 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 17:08:54.282573 (Thread-2): Opening a new connection, currently in state init
2021-11-02 17:08:54.289222 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:08:54.289653 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:08:54.659195 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:08:54.659593 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:08:54.661242 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 17:08:54.662781 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 17:08:55.272753 (Thread-3): Writing injected SQL for node "model.freetrade_test.monthly_subscription_revenue"
2021-11-02 17:08:55.277807 (Thread-3): finished collecting timing info
2021-11-02 17:08:55.283018 (Thread-3): Writing runtime SQL for node "model.freetrade_test.monthly_subscription_revenue"
2021-11-02 17:08:55.283769 (Thread-3): On model.freetrade_test.monthly_subscription_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */


  create or replace table `ft-data-330317`.`ft_data`.`monthly_subscription_revenue`
  
  
  OPTIONS()
  as (
    

with months as (

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 12
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2021-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2022-01-01' as date)

)

select * from filtered

)

select
    subscriptions.customer_id,
    subscriptions.subscription_id,
    subscriptions.monthly_fee,
    subscriptions.subscription_type,
    subscriptions.created_at,
    DATE_ADD(months.date_month, INTERVAL (
        EXTRACT(DAY FROM subscriptions.created_at) - EXTRACT(DAY FROM months.date_month)) DAY) as billing_date

from `ft-data-330317.ft_source_data.subscriptions` subscriptions

join months
    -- all months after start date
    on  months.date_month >= DATE(subscriptions.created_at)
    -- and before end date
    and months.date_month <= DATE('2022-01-01')

ORDER BY customer_id, date_month ASC
  );
    
2021-11-02 17:08:56.576818 (Thread-2): finished collecting timing info
2021-11-02 17:08:56.577498 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '193a4d10-70b8-47d4-8b03-454ca8e66925', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df13b50>]}
2021-11-02 17:08:56.578022 (Thread-2): 17:08:56 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.34s]
2021-11-02 17:08:56.578279 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:08:56.793062 (Thread-1): finished collecting timing info
2021-11-02 17:08:56.794116 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '193a4d10-70b8-47d4-8b03-454ca8e66925', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e04d040>]}
2021-11-02 17:08:56.794903 (Thread-1): 17:08:56 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.55s]
2021-11-02 17:08:56.795203 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 17:08:56.795860 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 17:08:56.796325 (Thread-4): 17:08:56 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 17:08:56.796884 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:08:56.797151 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 17:08:56.803190 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:08:56.803843 (Thread-4): finished collecting timing info
2021-11-02 17:08:56.806893 (Thread-4): Opening a new connection, currently in state init
2021-11-02 17:08:56.814306 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:08:57.128965 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:08:57.129787 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 17:08:57.594576 (Thread-3): finished collecting timing info
2021-11-02 17:08:57.595658 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '193a4d10-70b8-47d4-8b03-454ca8e66925', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df13580>]}
2021-11-02 17:08:57.596357 (Thread-3): 17:08:57 | 3 of 4 OK created table model ft_data.monthly_subscription_revenue... [CREATE TABLE (5.1k rows, 38.2 KB processed) in 3.35s]
2021-11-02 17:08:57.596660 (Thread-3): Finished running node model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:09:01.281328 (Thread-4): finished collecting timing info
2021-11-02 17:09:01.282394 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '193a4d10-70b8-47d4-8b03-454ca8e66925', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f27f5b0>]}
2021-11-02 17:09:01.283093 (Thread-4): 17:09:01 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.49s]
2021-11-02 17:09:01.283389 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 17:09:01.285458 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:09:01.286079 (MainThread): 17:09:01 | 
2021-11-02 17:09:01.286362 (MainThread): 17:09:01 | Finished running 4 table models, 1 hook in 10.23s.
2021-11-02 17:09:01.286608 (MainThread): Connection 'master' was properly closed.
2021-11-02 17:09:01.286809 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 17:09:01.286999 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 17:09:01.287190 (MainThread): Connection 'model.freetrade_test.monthly_subscription_revenue' was properly closed.
2021-11-02 17:09:01.287373 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 17:09:01.300167 (MainThread): 
2021-11-02 17:09:01.300424 (MainThread): Completed successfully
2021-11-02 17:09:01.300610 (MainThread): 
Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
2021-11-02 17:09:01.300876 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10defdac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10deee7c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e09feb0>]}
2021-11-02 17:09:01.301150 (MainThread): Flushing usage events
2021-11-02 17:31:06.802982 (MainThread): Running with dbt=0.21.0
2021-11-02 17:31:07.452563 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 17:31:07.454446 (MainThread): Tracking: tracking
2021-11-02 17:31:07.471075 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b56310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ae91f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ae9610>]}
2021-11-02 17:31:07.491461 (MainThread): Partial parsing not enabled
2021-11-02 17:31:07.544740 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 17:31:07.545808 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 17:31:07.546352 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 17:31:07.547174 (MainThread): Parsing macros/etc.sql
2021-11-02 17:31:07.550601 (MainThread): Parsing macros/catalog.sql
2021-11-02 17:31:07.557497 (MainThread): Parsing macros/adapters.sql
2021-11-02 17:31:07.579642 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 17:31:07.582165 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 17:31:07.584534 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 17:31:07.593531 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 17:31:07.596110 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 17:31:07.609439 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 17:31:07.611094 (MainThread): Parsing macros/core.sql
2021-11-02 17:31:07.618182 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 17:31:07.624564 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 17:31:07.635555 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 17:31:07.637153 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 17:31:07.653739 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 17:31:07.684649 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 17:31:07.706280 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 17:31:07.707889 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 17:31:07.717331 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 17:31:07.735828 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 17:31:07.748622 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 17:31:07.755808 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 17:31:07.762606 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 17:31:07.766104 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 17:31:07.767504 (MainThread): Parsing macros/etc/query.sql
2021-11-02 17:31:07.768351 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 17:31:07.769695 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 17:31:07.777680 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 17:31:07.779293 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 17:31:07.781467 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 17:31:07.782876 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 17:31:07.834712 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 17:31:07.836226 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 17:31:07.837298 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 17:31:07.838509 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 17:31:07.840549 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 17:31:07.841506 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 17:31:07.842633 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 17:31:07.843535 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 17:31:07.849049 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 17:31:07.850115 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 17:31:07.851282 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 17:31:07.854183 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 17:31:07.855202 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 17:31:07.857608 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 17:31:07.867163 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 17:31:07.868893 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 17:31:07.870178 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 17:31:07.871525 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 17:31:07.873029 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 17:31:07.874444 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 17:31:07.875308 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 17:31:07.878690 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 17:31:07.883579 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 17:31:07.886834 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 17:31:07.888499 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 17:31:07.889965 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 17:31:07.891696 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 17:31:07.917062 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 17:31:07.918879 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 17:31:07.921330 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 17:31:07.922811 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 17:31:07.923849 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 17:31:07.925108 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 17:31:07.926217 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 17:31:07.927352 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 17:31:07.928946 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 17:31:07.930990 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 17:31:07.933725 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 17:31:07.935381 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 17:31:07.936532 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 17:31:07.938918 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 17:31:07.940903 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 17:31:07.942251 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 17:31:07.943458 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 17:31:07.946166 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 17:31:07.948080 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 17:31:07.949913 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 17:31:07.952096 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 17:31:07.954574 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 17:31:07.955906 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 17:31:07.959275 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 17:31:07.967731 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 17:31:07.972102 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 17:31:07.973794 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 17:31:07.977063 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 17:31:07.981172 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 17:31:07.984386 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 17:31:07.985943 (MainThread): Parsing macros/sql/star.sql
2021-11-02 17:31:07.989333 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 17:31:07.996972 (MainThread): Parsing macros/sql/union.sql
2021-11-02 17:31:08.004671 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 17:31:08.005890 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 17:31:08.009154 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 17:31:08.011005 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 17:31:08.013217 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 17:31:08.019308 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 17:31:08.024019 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 17:31:08.027874 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 17:31:08.030056 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 17:31:08.437983 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:31:08.451257 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:31:08.455082 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:31:08.458671 (MainThread): Acquiring new bigquery connection "model.freetrade_test.monthly_subscription_revenue".
2021-11-02 17:31:08.491311 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 17:31:08.525496 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:31:08.527660 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:31:08.529522 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:31:08.531152 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:31:08.531536 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:31:08.531697 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:31:08.531845 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:31:08.532016 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:31:08.592474 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 17:31:08.599091 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c7bc7dff-edd0-4d06-b9c5-92af03570aa6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108bf2ee0>]}
2021-11-02 17:31:08.608725 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 17:31:08.609233 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c7bc7dff-edd0-4d06-b9c5-92af03570aa6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108cba1f0>]}
2021-11-02 17:31:08.609513 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 17:31:08.610946 (MainThread): 
2021-11-02 17:31:08.611305 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:31:08.612355 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 17:31:08.612546 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 17:31:09.081455 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 17:31:09.082190 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 17:31:09.093330 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:31:09.424871 (MainThread): 17:31:09 | 
2021-11-02 17:31:09.425425 (MainThread): 17:31:09 | Running 1 on-run-start hook
2021-11-02 17:31:09.425834 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 17:31:09.427636 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55074), raddr=('142.250.200.10', 443)>
2021-11-02 17:31:09.427984 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55075), raddr=('216.58.212.202', 443)>
2021-11-02 17:31:09.437055 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 17:31:09.439396 (MainThread): 17:31:09 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 17:31:09.439763 (MainThread): Opening a new connection, currently in state closed
2021-11-02 17:31:09.447025 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 17:31:12.470731 (MainThread): 17:31:12 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 3.03s]
2021-11-02 17:31:12.471326 (MainThread): 17:31:12 | 
2021-11-02 17:31:12.472047 (MainThread): 17:31:12 | Concurrency: 4 threads (target='dev')
2021-11-02 17:31:12.472333 (MainThread): 17:31:12 | 
2021-11-02 17:31:12.477903 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 17:31:12.478332 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:31:12.478807 (Thread-1): 17:31:12 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 17:31:12.479046 (Thread-3): Began running node model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:31:12.479478 (Thread-2): 17:31:12 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 17:31:12.480120 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:31:12.480508 (Thread-3): 17:31:12 | 3 of 4 START table model ft_data.monthly_subscription_revenue........ [RUN]
2021-11-02 17:31:12.480986 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:31:12.481244 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 17:31:12.481900 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.monthly_subscription_revenue".
2021-11-02 17:31:12.482152 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:31:12.486424 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:31:12.486684 (Thread-3): Compiling model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:31:12.489569 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:31:12.497324 (Thread-3): Opening a new connection, currently in state init
2021-11-02 17:31:12.497646 (Thread-1): finished collecting timing info
2021-11-02 17:31:12.516777 (Thread-2): finished collecting timing info
2021-11-02 17:31:12.523848 (Thread-2): Opening a new connection, currently in state init
2021-11-02 17:31:12.524814 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 17:31:12.525046 (Thread-3): On model.freetrade_test.monthly_subscription_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */


        select 

    datetime_diff(
        cast(cast('2022-01-01' as date) as datetime),
        cast(cast('2021-01-01' as date) as datetime),
        month
    )


2021-11-02 17:31:12.530973 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:31:12.531247 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:31:12.878389 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:31:12.878988 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 17:31:12.895607 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:31:12.896583 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 17:31:13.458964 (Thread-3): Writing injected SQL for node "model.freetrade_test.monthly_subscription_revenue"
2021-11-02 17:31:13.463044 (Thread-3): finished collecting timing info
2021-11-02 17:31:13.468314 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:31:13.583052 (Thread-3): Writing runtime SQL for node "model.freetrade_test.monthly_subscription_revenue"
2021-11-02 17:31:13.585617 (Thread-3): On model.freetrade_test.monthly_subscription_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */


  create or replace table `ft-data-330317`.`ft_data`.`monthly_subscription_revenue`
  
  
  OPTIONS()
  as (
    

with months as (

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 12
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2021-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2022-01-01' as date)

)

select * from filtered

)

select
    subscriptions.customer_id,
    subscriptions.subscription_id,
    subscriptions.monthly_fee,
    subscriptions.subscription_type,
    subscriptions.created_at,
    DATE_ADD(months.date_month, INTERVAL (
        EXTRACT(DAY FROM subscriptions.created_at) - EXTRACT(DAY FROM months.date_month) - 30) DAY) as billing_date

from `ft-data-330317.ft_source_data.subscriptions` subscriptions

join months
    -- all months after start date
    on  months.date_month >= DATE(subscriptions.created_at)
    -- and before end date
    and months.date_month <= DATE('2022-01-01')

ORDER BY customer_id, date_month ASC
  );
    
2021-11-02 17:31:14.766687 (Thread-1): finished collecting timing info
2021-11-02 17:31:14.767717 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c7bc7dff-edd0-4d06-b9c5-92af03570aa6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c9e8b0>]}
2021-11-02 17:31:14.768344 (Thread-1): 17:31:14 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.29s]
2021-11-02 17:31:14.768648 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 17:31:14.769335 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 17:31:14.769821 (Thread-4): 17:31:14 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 17:31:14.770463 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:31:14.770730 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 17:31:14.775544 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:31:14.776101 (Thread-4): finished collecting timing info
2021-11-02 17:31:14.778792 (Thread-4): Opening a new connection, currently in state init
2021-11-02 17:31:14.785413 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:31:14.800175 (Thread-2): finished collecting timing info
2021-11-02 17:31:14.800879 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c7bc7dff-edd0-4d06-b9c5-92af03570aa6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c913a0>]}
2021-11-02 17:31:14.801417 (Thread-2): 17:31:14 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.32s]
2021-11-02 17:31:14.801680 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:31:15.057417 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:31:15.058548 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 17:31:16.132075 (Thread-3): finished collecting timing info
2021-11-02 17:31:16.133152 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c7bc7dff-edd0-4d06-b9c5-92af03570aa6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c9b100>]}
2021-11-02 17:31:16.133943 (Thread-3): 17:31:16 | 3 of 4 OK created table model ft_data.monthly_subscription_revenue... [CREATE TABLE (5.1k rows, 38.2 KB processed) in 3.65s]
2021-11-02 17:31:16.134249 (Thread-3): Finished running node model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:31:19.747078 (Thread-4): finished collecting timing info
2021-11-02 17:31:19.748167 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c7bc7dff-edd0-4d06-b9c5-92af03570aa6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108f57f70>]}
2021-11-02 17:31:19.748873 (Thread-4): 17:31:19 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.98s]
2021-11-02 17:31:19.749181 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 17:31:19.751186 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:31:19.751824 (MainThread): 17:31:19 | 
2021-11-02 17:31:19.752121 (MainThread): 17:31:19 | Finished running 4 table models, 1 hook in 11.14s.
2021-11-02 17:31:19.752374 (MainThread): Connection 'master' was properly closed.
2021-11-02 17:31:19.752581 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 17:31:19.752781 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 17:31:19.752972 (MainThread): Connection 'model.freetrade_test.monthly_subscription_revenue' was properly closed.
2021-11-02 17:31:19.753159 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 17:31:19.765588 (MainThread): 
2021-11-02 17:31:19.765843 (MainThread): Completed successfully
2021-11-02 17:31:19.766032 (MainThread): 
Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
2021-11-02 17:31:19.766301 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108f57f70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ae97c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c226d0>]}
2021-11-02 17:31:19.766577 (MainThread): Flushing usage events
2021-11-02 17:32:16.377415 (MainThread): Running with dbt=0.21.0
2021-11-02 17:32:16.840082 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 17:32:16.841760 (MainThread): Tracking: tracking
2021-11-02 17:32:16.856232 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db2a340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fabc1f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fabc610>]}
2021-11-02 17:32:16.874684 (MainThread): Partial parsing not enabled
2021-11-02 17:32:16.928872 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 17:32:16.929997 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 17:32:16.930623 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 17:32:16.931525 (MainThread): Parsing macros/etc.sql
2021-11-02 17:32:16.938150 (MainThread): Parsing macros/catalog.sql
2021-11-02 17:32:16.950708 (MainThread): Parsing macros/adapters.sql
2021-11-02 17:32:16.977443 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 17:32:16.980157 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 17:32:16.982791 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 17:32:16.991757 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 17:32:16.994207 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 17:32:17.007480 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 17:32:17.009058 (MainThread): Parsing macros/core.sql
2021-11-02 17:32:17.012427 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 17:32:17.018442 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 17:32:17.027698 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 17:32:17.029192 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 17:32:17.045581 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 17:32:17.077323 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 17:32:17.099230 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 17:32:17.100846 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 17:32:17.110445 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 17:32:17.129121 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 17:32:17.142500 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 17:32:17.149927 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 17:32:17.156707 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 17:32:17.160258 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 17:32:17.161592 (MainThread): Parsing macros/etc/query.sql
2021-11-02 17:32:17.162484 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 17:32:17.163979 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 17:32:17.171862 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 17:32:17.173515 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 17:32:17.175743 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 17:32:17.177208 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 17:32:17.230259 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 17:32:17.231828 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 17:32:17.232909 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 17:32:17.234196 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 17:32:17.236357 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 17:32:17.237314 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 17:32:17.238531 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 17:32:17.239493 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 17:32:17.245068 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 17:32:17.246104 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 17:32:17.247278 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 17:32:17.250051 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 17:32:17.251008 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 17:32:17.253120 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 17:32:17.262580 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 17:32:17.264269 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 17:32:17.265696 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 17:32:17.267029 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 17:32:17.268542 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 17:32:17.270173 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 17:32:17.271040 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 17:32:17.274316 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 17:32:17.279779 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 17:32:17.283346 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 17:32:17.285079 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 17:32:17.286757 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 17:32:17.288598 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 17:32:17.313389 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 17:32:17.315132 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 17:32:17.317599 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 17:32:17.319072 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 17:32:17.320086 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 17:32:17.321192 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 17:32:17.322215 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 17:32:17.323393 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 17:32:17.324945 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 17:32:17.326539 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 17:32:17.328673 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 17:32:17.330277 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 17:32:17.331400 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 17:32:17.333641 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 17:32:17.335660 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 17:32:17.336971 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 17:32:17.338118 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 17:32:17.340708 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 17:32:17.342606 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 17:32:17.344253 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 17:32:17.346547 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 17:32:17.349010 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 17:32:17.350317 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 17:32:17.353574 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 17:32:17.362041 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 17:32:17.366324 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 17:32:17.367977 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 17:32:17.371230 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 17:32:17.375170 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 17:32:17.378411 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 17:32:17.380089 (MainThread): Parsing macros/sql/star.sql
2021-11-02 17:32:17.383358 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 17:32:17.390917 (MainThread): Parsing macros/sql/union.sql
2021-11-02 17:32:17.398686 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 17:32:17.399950 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 17:32:17.403123 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 17:32:17.404725 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 17:32:17.406223 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 17:32:17.412271 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 17:32:17.416851 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 17:32:17.420679 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 17:32:17.422870 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 17:32:17.752768 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:32:17.766337 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:32:17.770174 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:32:17.773765 (MainThread): Acquiring new bigquery connection "model.freetrade_test.monthly_subscription_revenue".
2021-11-02 17:32:17.807300 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 17:32:17.841029 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:32:17.842947 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:32:17.844732 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:32:17.846347 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:32:17.846720 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:32:17.846895 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:32:17.847072 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:32:17.847224 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:32:17.906154 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 17:32:17.912318 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5a8adc6a-3141-4425-85dd-0da8c82075b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbe8100>]}
2021-11-02 17:32:17.921875 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 17:32:17.922359 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5a8adc6a-3141-4425-85dd-0da8c82075b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbadd60>]}
2021-11-02 17:32:17.922633 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 17:32:17.924070 (MainThread): 
2021-11-02 17:32:17.924439 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:32:17.925497 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 17:32:17.925704 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 17:32:18.341002 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 17:32:18.341331 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 17:32:18.348248 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:32:18.694652 (MainThread): 17:32:18 | 
2021-11-02 17:32:18.695202 (MainThread): 17:32:18 | Running 1 on-run-start hook
2021-11-02 17:32:18.695613 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 17:32:18.697464 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55099), raddr=('142.250.200.10', 443)>
2021-11-02 17:32:18.697939 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55100), raddr=('216.58.212.202', 443)>
2021-11-02 17:32:18.707477 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 17:32:18.709846 (MainThread): 17:32:18 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 17:32:18.710195 (MainThread): Opening a new connection, currently in state closed
2021-11-02 17:32:18.717748 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 17:32:21.241416 (MainThread): 17:32:21 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.53s]
2021-11-02 17:32:21.242011 (MainThread): 17:32:21 | 
2021-11-02 17:32:21.242727 (MainThread): 17:32:21 | Concurrency: 4 threads (target='dev')
2021-11-02 17:32:21.243021 (MainThread): 17:32:21 | 
2021-11-02 17:32:21.248933 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 17:32:21.249524 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:32:21.250171 (Thread-1): 17:32:21 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 17:32:21.250513 (Thread-3): Began running node model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:32:21.251118 (Thread-2): 17:32:21 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 17:32:21.251998 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:32:21.252569 (Thread-3): 17:32:21 | 3 of 4 START table model ft_data.monthly_subscription_revenue........ [RUN]
2021-11-02 17:32:21.253533 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:32:21.253892 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 17:32:21.254645 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.monthly_subscription_revenue".
2021-11-02 17:32:21.254929 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:32:21.259944 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:32:21.260202 (Thread-3): Compiling model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:32:21.263799 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:32:21.272406 (Thread-3): Opening a new connection, currently in state init
2021-11-02 17:32:21.273094 (Thread-1): finished collecting timing info
2021-11-02 17:32:21.291511 (Thread-2): finished collecting timing info
2021-11-02 17:32:21.293828 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 17:32:21.295713 (Thread-2): Opening a new connection, currently in state init
2021-11-02 17:32:21.295884 (Thread-3): On model.freetrade_test.monthly_subscription_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */


        select 

    datetime_diff(
        cast(cast('2022-01-01' as date) as datetime),
        cast(cast('2021-01-01' as date) as datetime),
        month
    )


2021-11-02 17:32:21.301927 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:32:21.303800 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:32:21.635342 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:32:21.635724 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:32:21.636346 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 17:32:21.637441 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount, value,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'
       
ORDER BY datetime ASC
  );
    
2021-11-02 17:32:22.324898 (Thread-3): Writing injected SQL for node "model.freetrade_test.monthly_subscription_revenue"
2021-11-02 17:32:22.325508 (Thread-3): finished collecting timing info
2021-11-02 17:32:22.328183 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:32:22.440204 (Thread-3): Writing runtime SQL for node "model.freetrade_test.monthly_subscription_revenue"
2021-11-02 17:32:22.441417 (Thread-3): On model.freetrade_test.monthly_subscription_revenue: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.monthly_subscription_revenue"} */


  create or replace table `ft-data-330317`.`ft_data`.`monthly_subscription_revenue`
  
  
  OPTIONS()
  as (
    

with months as (

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 12
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2021-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2022-01-01' as date)

)

select * from filtered

)

select
    subscriptions.customer_id,
    subscriptions.subscription_id,
    subscriptions.monthly_fee,
    subscriptions.subscription_type,
    subscriptions.created_at,
    DATE_ADD(months.date_month, INTERVAL (
        EXTRACT(DAY FROM subscriptions.created_at) - EXTRACT(DAY FROM months.date_month) - 15) DAY) as billing_date

from `ft-data-330317.ft_source_data.subscriptions` subscriptions

join months
    -- all months after start date
    on  months.date_month >= DATE(subscriptions.created_at)
    -- and before end date
    and months.date_month <= DATE('2022-01-01')

ORDER BY customer_id, date_month ASC
  );
    
2021-11-02 17:32:23.595668 (Thread-2): finished collecting timing info
2021-11-02 17:32:23.596371 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a8adc6a-3141-4425-85dd-0da8c82075b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc9cfd0>]}
2021-11-02 17:32:23.596897 (Thread-2): 17:32:23 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.34s]
2021-11-02 17:32:23.597158 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:32:23.616063 (Thread-1): finished collecting timing info
2021-11-02 17:32:23.617028 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a8adc6a-3141-4425-85dd-0da8c82075b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fcd1b50>]}
2021-11-02 17:32:23.617737 (Thread-1): 17:32:23 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.37s]
2021-11-02 17:32:23.618104 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 17:32:23.618751 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 17:32:23.619260 (Thread-4): 17:32:23 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 17:32:23.619856 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:32:23.620131 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 17:32:23.626254 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:32:23.626922 (Thread-4): finished collecting timing info
2021-11-02 17:32:23.629970 (Thread-4): Opening a new connection, currently in state init
2021-11-02 17:32:23.637637 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:32:23.944435 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:32:23.945595 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 17:32:24.696794 (Thread-3): finished collecting timing info
2021-11-02 17:32:24.697818 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a8adc6a-3141-4425-85dd-0da8c82075b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbde250>]}
2021-11-02 17:32:24.699291 (Thread-3): 17:32:24 | 3 of 4 OK created table model ft_data.monthly_subscription_revenue... [CREATE TABLE (5.1k rows, 38.2 KB processed) in 3.44s]
2021-11-02 17:32:24.699722 (Thread-3): Finished running node model.freetrade_test.monthly_subscription_revenue
2021-11-02 17:32:28.736517 (Thread-4): finished collecting timing info
2021-11-02 17:32:28.737373 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a8adc6a-3141-4425-85dd-0da8c82075b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff14970>]}
2021-11-02 17:32:28.737919 (Thread-4): 17:32:28 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 5.12s]
2021-11-02 17:32:28.738187 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 17:32:28.740011 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:32:28.740567 (MainThread): 17:32:28 | 
2021-11-02 17:32:28.740815 (MainThread): 17:32:28 | Finished running 4 table models, 1 hook in 10.82s.
2021-11-02 17:32:28.741028 (MainThread): Connection 'master' was properly closed.
2021-11-02 17:32:28.741200 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 17:32:28.741362 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 17:32:28.741519 (MainThread): Connection 'model.freetrade_test.monthly_subscription_revenue' was properly closed.
2021-11-02 17:32:28.741673 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 17:32:28.754257 (MainThread): 
2021-11-02 17:32:28.754471 (MainThread): Completed successfully
2021-11-02 17:32:28.754626 (MainThread): 
Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
2021-11-02 17:32:28.754847 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd33c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10faa5640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbb9d00>]}
2021-11-02 17:32:28.755074 (MainThread): Flushing usage events
2021-11-02 17:39:03.198021 (MainThread): Running with dbt=0.21.0
2021-11-02 17:39:03.720153 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 17:39:03.721307 (MainThread): Tracking: tracking
2021-11-02 17:39:03.735288 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104bb7370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b461c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b467c0>]}
2021-11-02 17:39:03.753787 (MainThread): Partial parsing not enabled
2021-11-02 17:39:03.832622 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 17:39:03.833776 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 17:39:03.834390 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 17:39:03.835298 (MainThread): Parsing macros/etc.sql
2021-11-02 17:39:03.840223 (MainThread): Parsing macros/catalog.sql
2021-11-02 17:39:03.849866 (MainThread): Parsing macros/adapters.sql
2021-11-02 17:39:03.874571 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 17:39:03.877028 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 17:39:03.879758 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 17:39:03.888923 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 17:39:03.891376 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 17:39:03.905310 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 17:39:03.906915 (MainThread): Parsing macros/core.sql
2021-11-02 17:39:03.910609 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 17:39:03.916781 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 17:39:03.926430 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 17:39:03.928385 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 17:39:03.945798 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 17:39:03.977780 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 17:39:04.000404 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 17:39:04.002103 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 17:39:04.012016 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 17:39:04.032695 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 17:39:04.046699 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 17:39:04.054611 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 17:39:04.062020 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 17:39:04.066195 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 17:39:04.067722 (MainThread): Parsing macros/etc/query.sql
2021-11-02 17:39:04.068710 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 17:39:04.070152 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 17:39:04.078748 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 17:39:04.080753 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 17:39:04.083145 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 17:39:04.084648 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 17:39:04.140673 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 17:39:04.142319 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 17:39:04.143450 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 17:39:04.144717 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 17:39:04.147077 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 17:39:04.148187 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 17:39:04.149403 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 17:39:04.150361 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 17:39:04.156359 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 17:39:04.157551 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 17:39:04.158811 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 17:39:04.161839 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 17:39:04.163035 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 17:39:04.165519 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 17:39:04.175562 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 17:39:04.177399 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 17:39:04.178968 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 17:39:04.180413 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 17:39:04.182016 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 17:39:04.183520 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 17:39:04.184443 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 17:39:04.188277 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 17:39:04.193453 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 17:39:04.197292 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 17:39:04.199132 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 17:39:04.200726 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 17:39:04.202764 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 17:39:04.228367 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 17:39:04.230276 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 17:39:04.232767 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 17:39:04.234266 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 17:39:04.235762 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 17:39:04.237053 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 17:39:04.238161 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 17:39:04.239297 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 17:39:04.240923 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 17:39:04.242489 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 17:39:04.244976 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 17:39:04.246719 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 17:39:04.247914 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 17:39:04.250266 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 17:39:04.252911 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 17:39:04.254739 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 17:39:04.256230 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 17:39:04.259377 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 17:39:04.261602 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 17:39:04.263414 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 17:39:04.265685 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 17:39:04.268634 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 17:39:04.270100 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 17:39:04.273542 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 17:39:04.282530 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 17:39:04.287622 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 17:39:04.289256 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 17:39:04.293175 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 17:39:04.297445 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 17:39:04.300946 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 17:39:04.302619 (MainThread): Parsing macros/sql/star.sql
2021-11-02 17:39:04.306137 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 17:39:04.314268 (MainThread): Parsing macros/sql/union.sql
2021-11-02 17:39:04.322794 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 17:39:04.324349 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 17:39:04.327834 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 17:39:04.329475 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 17:39:04.331065 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 17:39:04.337336 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 17:39:04.342350 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 17:39:04.349325 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 17:39:04.351690 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 17:39:04.705230 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:39:04.720254 (MainThread): 1699: statically parsed accounts/account_cashflows.sql
2021-11-02 17:39:04.720600 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:39:04.724246 (MainThread): Sending event: {'category': 'dbt', 'action': 'experimental_parser', 'label': '0a139fdb-f154-47eb-894b-854b1a5479ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cff700>]}
2021-11-02 17:39:04.725294 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:39:04.729314 (MainThread): Acquiring new bigquery connection "model.freetrade_test.subscription_revenue_cashflows".
2021-11-02 17:39:04.765180 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 17:39:04.801484 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:39:04.803442 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:39:04.805378 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:39:04.807058 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:39:04.807444 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:39:04.807602 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:39:04.807726 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:39:04.807856 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:39:04.875280 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 17:39:04.881767 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0a139fdb-f154-47eb-894b-854b1a5479ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104bb7bb0>]}
2021-11-02 17:39:04.891641 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 17:39:04.892172 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0a139fdb-f154-47eb-894b-854b1a5479ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106c5d400>]}
2021-11-02 17:39:04.892455 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 17:39:04.893907 (MainThread): 
2021-11-02 17:39:04.894281 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:39:04.895348 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 17:39:04.895550 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 17:39:05.372310 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 17:39:05.372942 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 17:39:05.385253 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:39:05.712684 (MainThread): 17:39:05 | 
2021-11-02 17:39:05.713252 (MainThread): 17:39:05 | Running 1 on-run-start hook
2021-11-02 17:39:05.713654 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 17:39:05.715580 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55133), raddr=('216.58.212.202', 443)>
2021-11-02 17:39:05.716056 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55134), raddr=('216.58.212.202', 443)>
2021-11-02 17:39:05.725432 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 17:39:05.730036 (MainThread): 17:39:05 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 17:39:05.730637 (MainThread): Opening a new connection, currently in state closed
2021-11-02 17:39:05.741617 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 17:39:08.293788 (MainThread): 17:39:08 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.56s]
2021-11-02 17:39:08.294369 (MainThread): 17:39:08 | 
2021-11-02 17:39:08.295001 (MainThread): 17:39:08 | Concurrency: 4 threads (target='dev')
2021-11-02 17:39:08.295286 (MainThread): 17:39:08 | 
2021-11-02 17:39:08.300092 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 17:39:08.300517 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:39:08.300984 (Thread-1): 17:39:08 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 17:39:08.301226 (Thread-3): Began running node model.freetrade_test.subscription_revenue_cashflows
2021-11-02 17:39:08.301652 (Thread-2): 17:39:08 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 17:39:08.302243 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:39:08.302593 (Thread-3): 17:39:08 | 3 of 4 START table model ft_data.subscription_revenue_cashflows...... [RUN]
2021-11-02 17:39:08.303071 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:39:08.303322 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 17:39:08.303919 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.subscription_revenue_cashflows".
2021-11-02 17:39:08.304189 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:39:08.308567 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:39:08.308840 (Thread-3): Compiling model.freetrade_test.subscription_revenue_cashflows
2021-11-02 17:39:08.311779 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:39:08.319406 (Thread-3): Opening a new connection, currently in state init
2021-11-02 17:39:08.320197 (Thread-1): finished collecting timing info
2021-11-02 17:39:08.338567 (Thread-3): On model.freetrade_test.subscription_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.subscription_revenue_cashflows"} */


        select 

    datetime_diff(
        cast(cast('2022-01-01' as date) as datetime),
        cast(cast('2021-01-01' as date) as datetime),
        month
    )


2021-11-02 17:39:08.340233 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 17:39:08.341034 (Thread-2): finished collecting timing info
2021-11-02 17:39:08.343047 (Thread-2): Opening a new connection, currently in state init
2021-11-02 17:39:08.348853 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:39:08.350745 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:39:08.686686 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:39:08.689214 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:39:08.689751 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 17:39:08.690754 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'

ORDER BY datetime ASC
  );
    
2021-11-02 17:39:09.538829 (Thread-3): Writing injected SQL for node "model.freetrade_test.subscription_revenue_cashflows"
2021-11-02 17:39:09.539722 (Thread-3): finished collecting timing info
2021-11-02 17:39:09.544754 (Thread-3): Writing runtime SQL for node "model.freetrade_test.subscription_revenue_cashflows"
2021-11-02 17:39:09.545599 (Thread-3): On model.freetrade_test.subscription_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.subscription_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`subscription_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

with months as (

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 12
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2021-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2022-01-01' as date)

)

select * from filtered

)

select
    subscriptions.customer_id,
    subscriptions.subscription_id,
    subscriptions.monthly_fee as amount,
    subscriptions.subscription_type,
    DATE_ADD(months.date_month, INTERVAL (
        EXTRACT(DAY FROM subscriptions.created_at) - EXTRACT(DAY FROM months.date_month) - 15) DAY) as billing_date

from `ft-data-330317.ft_source_data.subscriptions` subscriptions

join months
    -- all months after start date
    on  months.date_month >= DATE(subscriptions.created_at)
    -- and before end date
    and months.date_month <= DATE('2022-01-01')

ORDER BY customer_id, date_month ASC
  );
    
2021-11-02 17:39:10.661818 (Thread-1): finished collecting timing info
2021-11-02 17:39:10.662583 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a139fdb-f154-47eb-894b-854b1a5479ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106dd3a30>]}
2021-11-02 17:39:10.663138 (Thread-1): 17:39:10 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.36s]
2021-11-02 17:39:10.663408 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 17:39:10.664016 (Thread-4): Began running node model.freetrade_test.account_timeseries
2021-11-02 17:39:10.664414 (Thread-4): 17:39:10 | 4 of 4 START table model ft_data.account_timeseries.................. [RUN]
2021-11-02 17:39:10.664909 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.account_timeseries".
2021-11-02 17:39:10.665139 (Thread-4): Compiling model.freetrade_test.account_timeseries
2021-11-02 17:39:10.670152 (Thread-4): Writing injected SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:39:10.672503 (Thread-4): finished collecting timing info
2021-11-02 17:39:10.675331 (Thread-4): Opening a new connection, currently in state init
2021-11-02 17:39:10.682058 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:39:10.889018 (Thread-2): finished collecting timing info
2021-11-02 17:39:10.890113 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a139fdb-f154-47eb-894b-854b1a5479ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d61d60>]}
2021-11-02 17:39:10.890768 (Thread-2): 17:39:10 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.59s]
2021-11-02 17:39:10.891074 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:39:10.991887 (Thread-4): Writing runtime SQL for node "model.freetrade_test.account_timeseries"
2021-11-02 17:39:10.993107 (Thread-4): On model.freetrade_test.account_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 17:39:12.043746 (Thread-3): finished collecting timing info
2021-11-02 17:39:12.044751 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a139fdb-f154-47eb-894b-854b1a5479ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cf0a90>]}
2021-11-02 17:39:12.045489 (Thread-3): 17:39:12 | 3 of 4 OK created table model ft_data.subscription_revenue_cashflows. [CREATE TABLE (5.1k rows, 38.2 KB processed) in 3.74s]
2021-11-02 17:39:12.045794 (Thread-3): Finished running node model.freetrade_test.subscription_revenue_cashflows
2021-11-02 17:39:15.122728 (Thread-4): finished collecting timing info
2021-11-02 17:39:15.123814 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a139fdb-f154-47eb-894b-854b1a5479ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fbbe20>]}
2021-11-02 17:39:15.124627 (Thread-4): 17:39:15 | 4 of 4 OK created table model ft_data.account_timeseries............. [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.46s]
2021-11-02 17:39:15.124925 (Thread-4): Finished running node model.freetrade_test.account_timeseries
2021-11-02 17:39:15.126862 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:39:15.127504 (MainThread): 17:39:15 | 
2021-11-02 17:39:15.127800 (MainThread): 17:39:15 | Finished running 4 table models, 1 hook in 10.23s.
2021-11-02 17:39:15.128054 (MainThread): Connection 'master' was properly closed.
2021-11-02 17:39:15.128260 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 17:39:15.128456 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 17:39:15.128645 (MainThread): Connection 'model.freetrade_test.subscription_revenue_cashflows' was properly closed.
2021-11-02 17:39:15.128832 (MainThread): Connection 'model.freetrade_test.account_timeseries' was properly closed.
2021-11-02 17:39:15.141460 (MainThread): 
2021-11-02 17:39:15.141717 (MainThread): Completed successfully
2021-11-02 17:39:15.141906 (MainThread): 
Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
2021-11-02 17:39:15.142168 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fa2b20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b9aee0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106c7d130>]}
2021-11-02 17:39:15.142441 (MainThread): Flushing usage events
2021-11-02 17:43:20.469262 (MainThread): Running with dbt=0.21.0
2021-11-02 17:43:21.151223 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 17:43:21.152329 (MainThread): Tracking: tracking
2021-11-02 17:43:21.170807 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103d18580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105cab0d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105cab610>]}
2021-11-02 17:43:21.189572 (MainThread): Partial parsing not enabled
2021-11-02 17:43:21.251992 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 17:43:21.253408 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 17:43:21.254190 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 17:43:21.255344 (MainThread): Parsing macros/etc.sql
2021-11-02 17:43:21.259386 (MainThread): Parsing macros/catalog.sql
2021-11-02 17:43:21.267647 (MainThread): Parsing macros/adapters.sql
2021-11-02 17:43:21.291690 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 17:43:21.294077 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 17:43:21.296504 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 17:43:21.305257 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 17:43:21.307677 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 17:43:21.321172 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 17:43:21.322728 (MainThread): Parsing macros/core.sql
2021-11-02 17:43:21.326063 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 17:43:21.332452 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 17:43:21.341585 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 17:43:21.343081 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 17:43:21.359231 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 17:43:21.390424 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 17:43:21.412445 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 17:43:21.414041 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 17:43:21.423519 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 17:43:21.442529 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 17:43:21.455533 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 17:43:21.462766 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 17:43:21.469569 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 17:43:21.473042 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 17:43:21.474379 (MainThread): Parsing macros/etc/query.sql
2021-11-02 17:43:21.475237 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 17:43:21.476671 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 17:43:21.484569 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 17:43:21.486266 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 17:43:21.488452 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 17:43:21.490034 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 17:43:21.542492 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 17:43:21.544067 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 17:43:21.545139 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 17:43:21.546422 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 17:43:21.548430 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 17:43:21.549469 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 17:43:21.550680 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 17:43:21.551584 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 17:43:21.557013 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 17:43:21.558035 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 17:43:21.559292 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 17:43:21.562085 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 17:43:21.563058 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 17:43:21.565128 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 17:43:21.574631 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 17:43:21.576342 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 17:43:21.577710 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 17:43:21.579092 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 17:43:21.580595 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 17:43:21.582122 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 17:43:21.582980 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 17:43:21.586239 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 17:43:21.591195 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 17:43:21.594489 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 17:43:21.596213 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 17:43:21.597677 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 17:43:21.599414 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 17:43:21.623035 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 17:43:21.625400 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 17:43:21.628485 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 17:43:21.630363 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 17:43:21.631818 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 17:43:21.633323 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 17:43:21.634836 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 17:43:21.636050 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 17:43:21.637700 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 17:43:21.639439 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 17:43:21.641841 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 17:43:21.643554 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 17:43:21.644744 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 17:43:21.647106 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 17:43:21.649152 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 17:43:21.650556 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 17:43:21.651763 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 17:43:21.654483 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 17:43:21.656348 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 17:43:21.658164 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 17:43:21.660474 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 17:43:21.663007 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 17:43:21.664349 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 17:43:21.667686 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 17:43:21.676308 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 17:43:21.680697 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 17:43:21.682170 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 17:43:21.685409 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 17:43:21.689420 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 17:43:21.692557 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 17:43:21.694154 (MainThread): Parsing macros/sql/star.sql
2021-11-02 17:43:21.697582 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 17:43:21.705083 (MainThread): Parsing macros/sql/union.sql
2021-11-02 17:43:21.712916 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 17:43:21.714271 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 17:43:21.717444 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 17:43:21.718974 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 17:43:21.720475 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 17:43:21.726378 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 17:43:21.731244 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 17:43:21.735161 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 17:43:21.737291 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 17:43:22.071364 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:43:22.084162 (MainThread): Acquiring new bigquery connection "model.freetrade_test.withdrawable_cash_timeseries".
2021-11-02 17:43:22.088566 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:43:22.092193 (MainThread): Acquiring new bigquery connection "model.freetrade_test.subscription_revenue_cashflows".
2021-11-02 17:43:22.129780 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 17:43:22.165236 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:43:22.166967 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:43:22.168704 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:43:22.170277 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 17:43:22.170652 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:43:22.170829 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 17:43:22.171008 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:43:22.171158 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 17:43:22.231010 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 17:43:22.237226 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '80a12f00-dd7f-4709-a292-fd7168eefbf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105db8550>]}
2021-11-02 17:43:22.249733 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 17:43:22.251091 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '80a12f00-dd7f-4709-a292-fd7168eefbf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f07e50>]}
2021-11-02 17:43:22.251457 (MainThread): Found 4 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 17:43:22.253085 (MainThread): 
2021-11-02 17:43:22.253496 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:43:22.254758 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 17:43:22.255075 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 17:43:22.691509 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 17:43:22.693142 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 17:43:22.701345 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:43:23.012179 (MainThread): 17:43:23 | 
2021-11-02 17:43:23.012725 (MainThread): 17:43:23 | Running 1 on-run-start hook
2021-11-02 17:43:23.013132 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 17:43:23.014955 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55166), raddr=('172.217.16.234', 443)>
2021-11-02 17:43:23.015288 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55167), raddr=('216.58.212.202', 443)>
2021-11-02 17:43:23.024165 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 17:43:23.026515 (MainThread): 17:43:23 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 17:43:23.026854 (MainThread): Opening a new connection, currently in state closed
2021-11-02 17:43:23.034500 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 17:43:25.501024 (MainThread): 17:43:25 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.47s]
2021-11-02 17:43:25.501617 (MainThread): 17:43:25 | 
2021-11-02 17:43:25.502281 (MainThread): 17:43:25 | Concurrency: 4 threads (target='dev')
2021-11-02 17:43:25.502576 (MainThread): 17:43:25 | 
2021-11-02 17:43:25.509099 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 17:43:25.509521 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:43:25.510005 (Thread-1): 17:43:25 | 1 of 4 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 17:43:25.510249 (Thread-3): Began running node model.freetrade_test.subscription_revenue_cashflows
2021-11-02 17:43:25.510693 (Thread-2): 17:43:25 | 2 of 4 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 17:43:25.511315 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 17:43:25.511784 (Thread-3): 17:43:25 | 3 of 4 START table model ft_data.subscription_revenue_cashflows...... [RUN]
2021-11-02 17:43:25.512494 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 17:43:25.512800 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 17:43:25.514011 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.subscription_revenue_cashflows".
2021-11-02 17:43:25.514410 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:43:25.519880 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:43:25.520141 (Thread-3): Compiling model.freetrade_test.subscription_revenue_cashflows
2021-11-02 17:43:25.523090 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:43:25.531221 (Thread-3): Opening a new connection, currently in state init
2021-11-02 17:43:25.531960 (Thread-1): finished collecting timing info
2021-11-02 17:43:25.532170 (Thread-2): finished collecting timing info
2021-11-02 17:43:25.544862 (Thread-3): On model.freetrade_test.subscription_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.subscription_revenue_cashflows"} */


        select 

    datetime_diff(
        cast(cast('2022-01-01' as date) as datetime),
        cast(cast('2021-01-01' as date) as datetime),
        month
    )


2021-11-02 17:43:25.552743 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 17:43:25.554557 (Thread-2): Opening a new connection, currently in state init
2021-11-02 17:43:25.560641 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:43:25.562311 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:43:25.899799 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 17:43:25.900421 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 17:43:25.906861 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 17:43:25.907411 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'

ORDER BY datetime ASC
  );
    
2021-11-02 17:43:26.474095 (Thread-3): Writing injected SQL for node "model.freetrade_test.subscription_revenue_cashflows"
2021-11-02 17:43:26.474942 (Thread-3): finished collecting timing info
2021-11-02 17:43:26.478834 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 17:43:26.596521 (Thread-3): Writing runtime SQL for node "model.freetrade_test.subscription_revenue_cashflows"
2021-11-02 17:43:26.597680 (Thread-3): On model.freetrade_test.subscription_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.subscription_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`subscription_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

with months as (

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 12
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2021-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2022-01-01' as date)

)

select * from filtered

)

select
    subscriptions.customer_id,
    subscriptions.subscription_id,
    subscriptions.monthly_fee as amount,
    subscriptions.subscription_type,
    DATE_ADD(months.date_month, INTERVAL (
        EXTRACT(DAY FROM subscriptions.created_at) - EXTRACT(DAY FROM months.date_month) - 15) DAY) as billing_date

from `ft-data-330317.ft_source_data.subscriptions` subscriptions

join months
    -- all months after start date
    on  months.date_month >= DATE(subscriptions.created_at)
    -- and before end date
    and months.date_month <= DATE('2022-01-01')

ORDER BY customer_id, date_month ASC
  );
    
2021-11-02 17:43:27.905577 (Thread-1): finished collecting timing info
2021-11-02 17:43:27.906405 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '80a12f00-dd7f-4709-a292-fd7168eefbf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f7d790>]}
2021-11-02 17:43:27.907022 (Thread-1): 17:43:27 | 1 of 4 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.40s]
2021-11-02 17:43:27.907351 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 17:43:27.908067 (Thread-4): Began running node model.freetrade_test.withdrawable_cash_timeseries
2021-11-02 17:43:27.908500 (Thread-4): 17:43:27 | 4 of 4 START table model ft_data.withdrawable_cash_timeseries........ [RUN]
2021-11-02 17:43:27.909048 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.withdrawable_cash_timeseries".
2021-11-02 17:43:27.909283 (Thread-4): Compiling model.freetrade_test.withdrawable_cash_timeseries
2021-11-02 17:43:27.914011 (Thread-4): Writing injected SQL for node "model.freetrade_test.withdrawable_cash_timeseries"
2021-11-02 17:43:27.916191 (Thread-2): finished collecting timing info
2021-11-02 17:43:27.916903 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '80a12f00-dd7f-4709-a292-fd7168eefbf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e8bb80>]}
2021-11-02 17:43:27.917453 (Thread-2): 17:43:27 | 2 of 4 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.40s]
2021-11-02 17:43:27.917826 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 17:43:27.918286 (Thread-4): finished collecting timing info
2021-11-02 17:43:27.921207 (Thread-4): Writing runtime SQL for node "model.freetrade_test.withdrawable_cash_timeseries"
2021-11-02 17:43:27.921669 (Thread-4): Opening a new connection, currently in state init
2021-11-02 17:43:27.927953 (Thread-4): On model.freetrade_test.withdrawable_cash_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.withdrawable_cash_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`withdrawable_cash_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 17:43:29.056096 (Thread-3): finished collecting timing info
2021-11-02 17:43:29.056507 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '80a12f00-dd7f-4709-a292-fd7168eefbf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f69940>]}
2021-11-02 17:43:29.056806 (Thread-3): 17:43:29 | 3 of 4 OK created table model ft_data.subscription_revenue_cashflows. [CREATE TABLE (5.1k rows, 38.2 KB processed) in 3.54s]
2021-11-02 17:43:29.056951 (Thread-3): Finished running node model.freetrade_test.subscription_revenue_cashflows
2021-11-02 17:43:32.451010 (Thread-4): finished collecting timing info
2021-11-02 17:43:32.452739 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '80a12f00-dd7f-4709-a292-fd7168eefbf4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f2b940>]}
2021-11-02 17:43:32.453422 (Thread-4): 17:43:32 | 4 of 4 OK created table model ft_data.withdrawable_cash_timeseries... [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.54s]
2021-11-02 17:43:32.453842 (Thread-4): Finished running node model.freetrade_test.withdrawable_cash_timeseries
2021-11-02 17:43:32.456529 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 17:43:32.457222 (MainThread): 17:43:32 | 
2021-11-02 17:43:32.457492 (MainThread): 17:43:32 | Finished running 4 table models, 1 hook in 10.20s.
2021-11-02 17:43:32.457709 (MainThread): Connection 'master' was properly closed.
2021-11-02 17:43:32.457884 (MainThread): Connection 'model.freetrade_test.account_cashflows' was properly closed.
2021-11-02 17:43:32.458050 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 17:43:32.458209 (MainThread): Connection 'model.freetrade_test.subscription_revenue_cashflows' was properly closed.
2021-11-02 17:43:32.458366 (MainThread): Connection 'model.freetrade_test.withdrawable_cash_timeseries' was properly closed.
2021-11-02 17:43:32.470925 (MainThread): 
2021-11-02 17:43:32.471239 (MainThread): Completed successfully
2021-11-02 17:43:32.471584 (MainThread): 
Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
2021-11-02 17:43:32.471907 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f07730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f594f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f250a0>]}
2021-11-02 17:43:32.472211 (MainThread): Flushing usage events
2021-11-02 19:11:08.116330 (MainThread): Running with dbt=0.21.0
2021-11-02 19:11:08.885832 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 19:11:08.887183 (MainThread): Tracking: tracking
2021-11-02 19:11:08.910168 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e3873d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11031f2b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11031fa30>]}
2021-11-02 19:11:08.929249 (MainThread): Partial parsing not enabled
2021-11-02 19:11:09.000939 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 19:11:09.002042 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 19:11:09.002596 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 19:11:09.003441 (MainThread): Parsing macros/etc.sql
2021-11-02 19:11:09.007896 (MainThread): Parsing macros/catalog.sql
2021-11-02 19:11:09.015182 (MainThread): Parsing macros/adapters.sql
2021-11-02 19:11:09.038576 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 19:11:09.041084 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 19:11:09.043525 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 19:11:09.056100 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 19:11:09.058696 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 19:11:09.072696 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 19:11:09.074319 (MainThread): Parsing macros/core.sql
2021-11-02 19:11:09.077727 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 19:11:09.083875 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 19:11:09.093430 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 19:11:09.095096 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 19:11:09.111672 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 19:11:09.143202 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 19:11:09.165165 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 19:11:09.166885 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 19:11:09.176578 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 19:11:09.195559 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 19:11:09.208877 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 19:11:09.216074 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 19:11:09.222995 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 19:11:09.226501 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 19:11:09.227846 (MainThread): Parsing macros/etc/query.sql
2021-11-02 19:11:09.228790 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 19:11:09.230156 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 19:11:09.238058 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 19:11:09.239740 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 19:11:09.241933 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 19:11:09.243360 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 19:11:09.296815 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 19:11:09.298490 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 19:11:09.299769 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 19:11:09.301160 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 19:11:09.303288 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 19:11:09.304287 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 19:11:09.305553 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 19:11:09.306540 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 19:11:09.312610 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 19:11:09.313703 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 19:11:09.314925 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 19:11:09.317757 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 19:11:09.318751 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 19:11:09.320933 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 19:11:09.330392 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 19:11:09.332110 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 19:11:09.333528 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 19:11:09.334848 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 19:11:09.336362 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 19:11:09.337891 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 19:11:09.338877 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 19:11:09.342222 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 19:11:09.347101 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 19:11:09.350426 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 19:11:09.352182 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 19:11:09.353659 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 19:11:09.355544 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 19:11:09.381030 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 19:11:09.382865 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 19:11:09.385328 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 19:11:09.386877 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 19:11:09.387971 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 19:11:09.389118 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 19:11:09.390175 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 19:11:09.391380 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 19:11:09.392958 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 19:11:09.394457 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 19:11:09.396674 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 19:11:09.398275 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 19:11:09.399408 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 19:11:09.401733 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 19:11:09.403757 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 19:11:09.405273 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 19:11:09.406449 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 19:11:09.409069 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 19:11:09.410899 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 19:11:09.412568 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 19:11:09.414781 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 19:11:09.417213 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 19:11:09.418531 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 19:11:09.421885 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 19:11:09.430264 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 19:11:09.434582 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 19:11:09.436156 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 19:11:09.439603 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 19:11:09.443655 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 19:11:09.446898 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 19:11:09.448471 (MainThread): Parsing macros/sql/star.sql
2021-11-02 19:11:09.451884 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 19:11:09.459568 (MainThread): Parsing macros/sql/union.sql
2021-11-02 19:11:09.467334 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 19:11:09.468636 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 19:11:09.471994 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 19:11:09.473508 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 19:11:09.475021 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 19:11:09.481193 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 19:11:09.485778 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 19:11:09.489760 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 19:11:09.492277 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 19:11:09.823057 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 19:11:09.835603 (MainThread): Acquiring new bigquery connection "model.freetrade_test.withdrawable_cash_timeseries".
2021-11-02 19:11:09.840212 (MainThread): Acquiring new bigquery connection "model.freetrade_test.revenue_cashflows".
2021-11-02 19:11:09.844659 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 19:11:09.848152 (MainThread): Acquiring new bigquery connection "model.freetrade_test.subscription_revenue_cashflows".
2021-11-02 19:11:09.881902 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 19:11:09.914584 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 19:11:09.916341 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 19:11:09.918127 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 19:11:09.919706 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 19:11:09.920086 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_first_dbt_model_id.16e066b321' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 19:11:09.920262 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_first_dbt_model_id.5fb22c2710' (models/schema.yml) depends on a node named 'my_first_dbt_model' which was not found
2021-11-02 19:11:09.920442 (MainThread): [WARNING]: Test 'test.freetrade_test.unique_my_second_dbt_model_id.57a0f8c493' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 19:11:09.920593 (MainThread): [WARNING]: Test 'test.freetrade_test.not_null_my_second_dbt_model_id.151b76d778' (models/schema.yml) depends on a node named 'my_second_dbt_model' which was not found
2021-11-02 19:11:09.984779 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 19:11:09.991055 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5cb167f6-ac96-4ef3-8a20-e06f4c2df2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1104f9fd0>]}
2021-11-02 19:11:10.002282 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 19:11:10.004404 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5cb167f6-ac96-4ef3-8a20-e06f4c2df2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110522a30>]}
2021-11-02 19:11:10.004963 (MainThread): Found 5 models, 0 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 19:11:10.007293 (MainThread): 
2021-11-02 19:11:10.007841 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 19:11:10.009678 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 19:11:10.010153 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 19:11:10.474108 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 19:11:10.474743 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 19:11:10.486941 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 19:11:10.809691 (MainThread): 19:11:10 | 
2021-11-02 19:11:10.810253 (MainThread): 19:11:10 | Running 1 on-run-start hook
2021-11-02 19:11:10.810753 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 19:11:10.816541 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 19:11:10.819196 (MainThread): 19:11:10 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 19:11:10.819599 (MainThread): Opening a new connection, currently in state closed
2021-11-02 19:11:10.828685 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 19:11:13.330729 (MainThread): 19:11:13 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.51s]
2021-11-02 19:11:13.331314 (MainThread): 19:11:13 | 
2021-11-02 19:11:13.332028 (MainThread): 19:11:13 | Concurrency: 4 threads (target='dev')
2021-11-02 19:11:13.332311 (MainThread): 19:11:13 | 
2021-11-02 19:11:13.337525 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 19:11:13.337978 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 19:11:13.338444 (Thread-1): 19:11:13 | 1 of 5 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 19:11:13.338899 (Thread-3): Began running node model.freetrade_test.subscription_revenue_cashflows
2021-11-02 19:11:13.339345 (Thread-2): 19:11:13 | 2 of 5 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 19:11:13.339995 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 19:11:13.340337 (Thread-3): 19:11:13 | 3 of 5 START table model ft_data.subscription_revenue_cashflows...... [RUN]
2021-11-02 19:11:13.340806 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 19:11:13.341055 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 19:11:13.341592 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.subscription_revenue_cashflows".
2021-11-02 19:11:13.341818 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 19:11:13.346194 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 19:11:13.346474 (Thread-3): Compiling model.freetrade_test.subscription_revenue_cashflows
2021-11-02 19:11:13.349541 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 19:11:13.357218 (Thread-3): Opening a new connection, currently in state init
2021-11-02 19:11:13.357820 (Thread-1): finished collecting timing info
2021-11-02 19:11:13.365077 (Thread-1): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55438), raddr=('142.250.180.10', 443)>
2021-11-02 19:11:13.365470 (Thread-1): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55439), raddr=('216.58.212.202', 443)>
2021-11-02 19:11:13.365750 (Thread-1): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55440), raddr=('142.250.180.10', 443)>
2021-11-02 19:11:13.366167 (Thread-2): finished collecting timing info
2021-11-02 19:11:13.366581 (Thread-1): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55441), raddr=('216.58.212.202', 443)>
2021-11-02 19:11:13.386033 (Thread-2): Opening a new connection, currently in state init
2021-11-02 19:11:13.386450 (Thread-3): On model.freetrade_test.subscription_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.subscription_revenue_cashflows"} */


        select 

    datetime_diff(
        cast(cast('2022-01-01' as date) as datetime),
        cast(cast('2021-01-01' as date) as datetime),
        month
    )


2021-11-02 19:11:13.395248 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 19:11:13.401269 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 19:11:13.402104 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 19:11:13.762816 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 19:11:13.763783 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 19:11:13.764337 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'

ORDER BY datetime ASC
  );
    
2021-11-02 19:11:13.765441 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 19:11:14.337964 (Thread-3): Writing injected SQL for node "model.freetrade_test.subscription_revenue_cashflows"
2021-11-02 19:11:14.338797 (Thread-3): finished collecting timing info
2021-11-02 19:11:14.342785 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 19:11:14.460742 (Thread-3): Writing runtime SQL for node "model.freetrade_test.subscription_revenue_cashflows"
2021-11-02 19:11:14.461941 (Thread-3): On model.freetrade_test.subscription_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.subscription_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`subscription_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

with months as (

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 12
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2021-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2022-01-01' as date)

)

select * from filtered

)

select
    subscriptions.customer_id,
    subscriptions.subscription_id,
    subscriptions.monthly_fee as amount,
    subscriptions.subscription_type,
    DATE_ADD(months.date_month, INTERVAL (
        EXTRACT(DAY FROM subscriptions.created_at) - EXTRACT(DAY FROM months.date_month) - 15) DAY) as billing_date

from `ft-data-330317.ft_source_data.subscriptions` subscriptions

join months
    -- all months after start date
    on  months.date_month >= DATE(subscriptions.created_at)
    -- and before end date
    and months.date_month <= DATE('2022-01-01')

ORDER BY customer_id, date_month ASC
  );
    
2021-11-02 19:11:16.046167 (Thread-1): finished collecting timing info
2021-11-02 19:11:16.046876 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5cb167f6-ac96-4ef3-8a20-e06f4c2df2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110519460>]}
2021-11-02 19:11:16.047403 (Thread-1): 19:11:16 | 1 of 5 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.71s]
2021-11-02 19:11:16.047666 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 19:11:16.048235 (Thread-4): Began running node model.freetrade_test.withdrawable_cash_timeseries
2021-11-02 19:11:16.048626 (Thread-4): 19:11:16 | 4 of 5 START table model ft_data.withdrawable_cash_timeseries........ [RUN]
2021-11-02 19:11:16.049126 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.withdrawable_cash_timeseries".
2021-11-02 19:11:16.049353 (Thread-4): Compiling model.freetrade_test.withdrawable_cash_timeseries
2021-11-02 19:11:16.054278 (Thread-4): Writing injected SQL for node "model.freetrade_test.withdrawable_cash_timeseries"
2021-11-02 19:11:16.056585 (Thread-4): finished collecting timing info
2021-11-02 19:11:16.059443 (Thread-4): Opening a new connection, currently in state init
2021-11-02 19:11:16.066436 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 19:11:16.366323 (Thread-4): Writing runtime SQL for node "model.freetrade_test.withdrawable_cash_timeseries"
2021-11-02 19:11:16.367446 (Thread-4): On model.freetrade_test.withdrawable_cash_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.withdrawable_cash_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`withdrawable_cash_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 19:11:16.554227 (Thread-2): finished collecting timing info
2021-11-02 19:11:16.555312 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5cb167f6-ac96-4ef3-8a20-e06f4c2df2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110519670>]}
2021-11-02 19:11:16.556032 (Thread-2): 19:11:16 | 2 of 5 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 3.21s]
2021-11-02 19:11:16.556345 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 19:11:16.962314 (Thread-3): finished collecting timing info
2021-11-02 19:11:16.963396 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5cb167f6-ac96-4ef3-8a20-e06f4c2df2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110522580>]}
2021-11-02 19:11:16.964150 (Thread-3): 19:11:16 | 3 of 5 OK created table model ft_data.subscription_revenue_cashflows. [CREATE TABLE (5.1k rows, 38.2 KB processed) in 3.62s]
2021-11-02 19:11:16.964455 (Thread-3): Finished running node model.freetrade_test.subscription_revenue_cashflows
2021-11-02 19:11:16.965065 (Thread-1): Began running node model.freetrade_test.revenue_cashflows
2021-11-02 19:11:16.965519 (Thread-1): 19:11:16 | 5 of 5 START table model ft_data.revenue_cashflows................... [RUN]
2021-11-02 19:11:16.966054 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.revenue_cashflows".
2021-11-02 19:11:16.966318 (Thread-1): Compiling model.freetrade_test.revenue_cashflows
2021-11-02 19:11:16.972656 (Thread-1): Writing injected SQL for node "model.freetrade_test.revenue_cashflows"
2021-11-02 19:11:16.973340 (Thread-1): finished collecting timing info
2021-11-02 19:11:16.977136 (Thread-1): Writing runtime SQL for node "model.freetrade_test.revenue_cashflows"
2021-11-02 19:11:16.977636 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 19:11:16.984908 (Thread-1): On model.freetrade_test.revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`revenue_cashflows`
  
  
  OPTIONS()
  as (
    

WITH isa_revenues AS
(
       SELECT customer_id,
              TIMESTAMP(billing_date)  AS transaction_datetime,
              amount,
              "isa_monthly_fee" AS transaction_type
       FROM   `ft-data-330317`.`ft_data`.`subscription_revenue_cashflows` where
       subscription_type = 'isa'),

sipp_revenues AS

(

       SELECT customer_id,
              TIMESTAMP(billing_date)  AS transaction_datetime,
              amount,
              "sipp_monthly_fee" AS transaction_type
       FROM   `ft-data-330317`.`ft_data`.`subscription_revenue_cashflows`
       where subscription_type = 'sipp'),

fx_revenues AS

(SELECT customer_id, datetime AS transaction_datetime, amount, 'US_fx_charge' as transaction_type
 FROM `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
)


       SELECT *
       FROM   isa_revenues
       UNION ALL
                 (
                    SELECT *
                        FROM   sipp_revenues )
          UNION ALL
                    (
                           SELECT *
                           FROM   fx_revenues)

             ORDER BY  customer_id,
                       transaction_datetime
  );
    
2021-11-02 19:11:19.485469 (Thread-1): finished collecting timing info
2021-11-02 19:11:19.486559 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5cb167f6-ac96-4ef3-8a20-e06f4c2df2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110522580>]}
2021-11-02 19:11:19.487332 (Thread-1): 19:11:19 | 5 of 5 OK created table model ft_data.revenue_cashflows.............. [CREATE TABLE (20.4k rows, 503.1 KB processed) in 2.52s]
2021-11-02 19:11:19.487645 (Thread-1): Finished running node model.freetrade_test.revenue_cashflows
2021-11-02 19:11:20.335348 (Thread-4): finished collecting timing info
2021-11-02 19:11:20.336142 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5cb167f6-ac96-4ef3-8a20-e06f4c2df2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11042b730>]}
2021-11-02 19:11:20.336734 (Thread-4): 19:11:20 | 4 of 5 OK created table model ft_data.withdrawable_cash_timeseries... [CREATE TABLE (1.1m rows, 888.4 KB processed) in 4.29s]
2021-11-02 19:11:20.337034 (Thread-4): Finished running node model.freetrade_test.withdrawable_cash_timeseries
2021-11-02 19:11:20.339156 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 19:11:20.339807 (MainThread): 19:11:20 | 
2021-11-02 19:11:20.340097 (MainThread): 19:11:20 | Finished running 5 table models, 1 hook in 10.33s.
2021-11-02 19:11:20.340346 (MainThread): Connection 'master' was properly closed.
2021-11-02 19:11:20.340547 (MainThread): Connection 'model.freetrade_test.revenue_cashflows' was properly closed.
2021-11-02 19:11:20.340743 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 19:11:20.340944 (MainThread): Connection 'model.freetrade_test.subscription_revenue_cashflows' was properly closed.
2021-11-02 19:11:20.341101 (MainThread): Connection 'model.freetrade_test.withdrawable_cash_timeseries' was properly closed.
2021-11-02 19:11:20.344375 (MainThread): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55444), raddr=('142.250.180.10', 443)>
2021-11-02 19:11:20.344682 (MainThread): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55447), raddr=('216.58.212.202', 443)>
2021-11-02 19:11:20.344935 (MainThread): unclosed <ssl.SSLSocket fd=21, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55448), raddr=('216.58.212.202', 443)>
2021-11-02 19:11:20.345170 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55446), raddr=('142.250.180.10', 443)>
2021-11-02 19:11:20.345396 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55445), raddr=('142.250.180.10', 443)>
2021-11-02 19:11:20.345623 (MainThread): unclosed <ssl.SSLSocket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55449), raddr=('216.58.212.202', 443)>
2021-11-02 19:11:20.345903 (MainThread): unclosed <ssl.SSLSocket fd=23, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55451), raddr=('216.58.212.202', 443)>
2021-11-02 19:11:20.346129 (MainThread): unclosed <ssl.SSLSocket fd=22, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55450), raddr=('142.250.180.10', 443)>
2021-11-02 19:11:20.346412 (MainThread): unclosed <ssl.SSLSocket fd=24, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55452), raddr=('142.250.180.10', 443)>
2021-11-02 19:11:20.346633 (MainThread): unclosed <ssl.SSLSocket fd=25, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55453), raddr=('216.58.212.202', 443)>
2021-11-02 19:11:20.375434 (MainThread): 
2021-11-02 19:11:20.375630 (MainThread): Completed successfully
2021-11-02 19:11:20.375769 (MainThread): 
Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
2021-11-02 19:11:20.375981 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11052fe80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11052fa00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11040b3a0>]}
2021-11-02 19:11:20.376189 (MainThread): Flushing usage events
2021-11-02 19:32:36.734882 (MainThread): Running with dbt=0.21.0
2021-11-02 19:32:37.037161 (MainThread): running dbt with arguments Namespace(record_timing_info=None, debug=False, log_format='default', write_json=True, use_colors=None, strict=False, warn_error=False, partial_parse=None, single_threaded=False, test_new_parser=False, use_experimental_parser=False, project_dir=None, profiles_dir='/Users/stephenkyriacou/.dbt', profile=None, target=None, vars='{}', log_cache_events=False, use_cache=True, fail_fast=False, threads=None, version_check=True, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=True, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
2021-11-02 19:32:37.038427 (MainThread): Tracking: tracking
2021-11-02 19:32:37.050199 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10edf52e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110d87760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110d87190>]}
2021-11-02 19:32:37.067906 (MainThread): Partial parsing not enabled
2021-11-02 19:32:37.096088 (MainThread): Parsing macros/create_udfs.sql
2021-11-02 19:32:37.097075 (MainThread): Parsing macros/udfs/tumble_interval.sql
2021-11-02 19:32:37.097590 (MainThread): Parsing macros/udfs/timeseries_index.sql
2021-11-02 19:32:37.098352 (MainThread): Parsing macros/etc.sql
2021-11-02 19:32:37.100691 (MainThread): Parsing macros/catalog.sql
2021-11-02 19:32:37.106798 (MainThread): Parsing macros/adapters.sql
2021-11-02 19:32:37.128447 (MainThread): Parsing macros/materializations/seed.sql
2021-11-02 19:32:37.130790 (MainThread): Parsing macros/materializations/view.sql
2021-11-02 19:32:37.133187 (MainThread): Parsing macros/materializations/table.sql
2021-11-02 19:32:37.143113 (MainThread): Parsing macros/materializations/copy.sql
2021-11-02 19:32:37.145835 (MainThread): Parsing macros/materializations/incremental.sql
2021-11-02 19:32:37.160541 (MainThread): Parsing macros/materializations/snapshot.sql
2021-11-02 19:32:37.162207 (MainThread): Parsing macros/core.sql
2021-11-02 19:32:37.165817 (MainThread): Parsing macros/materializations/test.sql
2021-11-02 19:32:37.172291 (MainThread): Parsing macros/materializations/helpers.sql
2021-11-02 19:32:37.181743 (MainThread): Parsing macros/materializations/snapshot/snapshot_merge.sql
2021-11-02 19:32:37.183304 (MainThread): Parsing macros/materializations/snapshot/strategies.sql
2021-11-02 19:32:37.199724 (MainThread): Parsing macros/materializations/snapshot/snapshot.sql
2021-11-02 19:32:37.231489 (MainThread): Parsing macros/materializations/seed/seed.sql
2021-11-02 19:32:37.253639 (MainThread): Parsing macros/materializations/incremental/helpers.sql
2021-11-02 19:32:37.255256 (MainThread): Parsing macros/materializations/incremental/incremental.sql
2021-11-02 19:32:37.264715 (MainThread): Parsing macros/materializations/incremental/on_schema_change.sql
2021-11-02 19:32:37.284108 (MainThread): Parsing macros/materializations/common/merge.sql
2021-11-02 19:32:37.297339 (MainThread): Parsing macros/materializations/table/table.sql
2021-11-02 19:32:37.305712 (MainThread): Parsing macros/materializations/view/view.sql
2021-11-02 19:32:37.320743 (MainThread): Parsing macros/materializations/view/create_or_replace_view.sql
2021-11-02 19:32:37.327615 (MainThread): Parsing macros/etc/get_custom_alias.sql
2021-11-02 19:32:37.330341 (MainThread): Parsing macros/etc/query.sql
2021-11-02 19:32:37.332084 (MainThread): Parsing macros/etc/is_incremental.sql
2021-11-02 19:32:37.336394 (MainThread): Parsing macros/etc/datetime.sql
2021-11-02 19:32:37.354450 (MainThread): Parsing macros/etc/where_subquery.sql
2021-11-02 19:32:37.360242 (MainThread): Parsing macros/etc/get_custom_schema.sql
2021-11-02 19:32:37.364566 (MainThread): Parsing macros/etc/get_custom_database.sql
2021-11-02 19:32:37.367282 (MainThread): Parsing macros/adapters/common.sql
2021-11-02 19:32:37.473280 (MainThread): Parsing macros/schema_tests/relationships.sql
2021-11-02 19:32:37.478253 (MainThread): Parsing macros/schema_tests/not_null.sql
2021-11-02 19:32:37.480245 (MainThread): Parsing macros/schema_tests/unique.sql
2021-11-02 19:32:37.482480 (MainThread): Parsing macros/schema_tests/accepted_values.sql
2021-11-02 19:32:37.486199 (MainThread): Parsing macros/cross_db_utils/except.sql
2021-11-02 19:32:37.487468 (MainThread): Parsing macros/cross_db_utils/replace.sql
2021-11-02 19:32:37.488689 (MainThread): Parsing macros/cross_db_utils/concat.sql
2021-11-02 19:32:37.489671 (MainThread): Parsing macros/cross_db_utils/datatypes.sql
2021-11-02 19:32:37.495587 (MainThread): Parsing macros/cross_db_utils/_is_relation.sql
2021-11-02 19:32:37.496727 (MainThread): Parsing macros/cross_db_utils/length.sql
2021-11-02 19:32:37.497980 (MainThread): Parsing macros/cross_db_utils/dateadd.sql
2021-11-02 19:32:37.501035 (MainThread): Parsing macros/cross_db_utils/intersect.sql
2021-11-02 19:32:37.502488 (MainThread): Parsing macros/cross_db_utils/right.sql
2021-11-02 19:32:37.504694 (MainThread): Parsing macros/cross_db_utils/datediff.sql
2021-11-02 19:32:37.519885 (MainThread): Parsing macros/cross_db_utils/safe_cast.sql
2021-11-02 19:32:37.522195 (MainThread): Parsing macros/cross_db_utils/hash.sql
2021-11-02 19:32:37.523653 (MainThread): Parsing macros/cross_db_utils/cast_bool_to_text.sql
2021-11-02 19:32:37.525096 (MainThread): Parsing macros/cross_db_utils/identifier.sql
2021-11-02 19:32:37.527376 (MainThread): Parsing macros/cross_db_utils/position.sql
2021-11-02 19:32:37.529838 (MainThread): Parsing macros/cross_db_utils/literal.sql
2021-11-02 19:32:37.531313 (MainThread): Parsing macros/cross_db_utils/current_timestamp.sql
2021-11-02 19:32:37.536963 (MainThread): Parsing macros/cross_db_utils/width_bucket.sql
2021-11-02 19:32:37.545803 (MainThread): Parsing macros/cross_db_utils/last_day.sql
2021-11-02 19:32:37.551151 (MainThread): Parsing macros/cross_db_utils/split_part.sql
2021-11-02 19:32:37.554302 (MainThread): Parsing macros/cross_db_utils/date_trunc.sql
2021-11-02 19:32:37.556419 (MainThread): Parsing macros/cross_db_utils/_is_ephemeral.sql
2021-11-02 19:32:37.558392 (MainThread): Parsing macros/materializations/insert_by_period_materialization.sql
2021-11-02 19:32:37.582719 (MainThread): Parsing macros/web/get_url_host.sql
2021-11-02 19:32:37.584885 (MainThread): Parsing macros/web/get_url_path.sql
2021-11-02 19:32:37.587476 (MainThread): Parsing macros/web/get_url_parameter.sql
2021-11-02 19:32:37.589151 (MainThread): Parsing macros/jinja_helpers/pretty_log_format.sql
2021-11-02 19:32:37.590320 (MainThread): Parsing macros/jinja_helpers/pretty_time.sql
2021-11-02 19:32:37.591497 (MainThread): Parsing macros/jinja_helpers/log_info.sql
2021-11-02 19:32:37.592563 (MainThread): Parsing macros/jinja_helpers/slugify.sql
2021-11-02 19:32:37.593767 (MainThread): Parsing macros/schema_tests/fewer_rows_than.sql
2021-11-02 19:32:37.595536 (MainThread): Parsing macros/schema_tests/equal_rowcount.sql
2021-11-02 19:32:37.597116 (MainThread): Parsing macros/schema_tests/relationships_where.sql
2021-11-02 19:32:37.599333 (MainThread): Parsing macros/schema_tests/recency.sql
2021-11-02 19:32:37.600994 (MainThread): Parsing macros/schema_tests/not_constant.sql
2021-11-02 19:32:37.602304 (MainThread): Parsing macros/schema_tests/accepted_range.sql
2021-11-02 19:32:37.604847 (MainThread): Parsing macros/schema_tests/not_accepted_values.sql
2021-11-02 19:32:37.606937 (MainThread): Parsing macros/schema_tests/test_unique_where.sql
2021-11-02 19:32:37.608312 (MainThread): Parsing macros/schema_tests/at_least_one.sql
2021-11-02 19:32:37.609504 (MainThread): Parsing macros/schema_tests/unique_combination_of_columns.sql
2021-11-02 19:32:37.612250 (MainThread): Parsing macros/schema_tests/cardinality_equality.sql
2021-11-02 19:32:37.614263 (MainThread): Parsing macros/schema_tests/expression_is_true.sql
2021-11-02 19:32:37.615985 (MainThread): Parsing macros/schema_tests/not_null_proportion.sql
2021-11-02 19:32:37.618219 (MainThread): Parsing macros/schema_tests/sequential_values.sql
2021-11-02 19:32:37.620970 (MainThread): Parsing macros/schema_tests/test_not_null_where.sql
2021-11-02 19:32:37.622337 (MainThread): Parsing macros/schema_tests/equality.sql
2021-11-02 19:32:37.625753 (MainThread): Parsing macros/schema_tests/mutually_exclusive_ranges.sql
2021-11-02 19:32:37.634332 (MainThread): Parsing macros/sql/date_spine.sql
2021-11-02 19:32:37.638831 (MainThread): Parsing macros/sql/nullcheck_table.sql
2021-11-02 19:32:37.640435 (MainThread): Parsing macros/sql/get_relations_by_pattern.sql
2021-11-02 19:32:37.643732 (MainThread): Parsing macros/sql/generate_series.sql
2021-11-02 19:32:37.647778 (MainThread): Parsing macros/sql/get_relations_by_prefix.sql
2021-11-02 19:32:37.650944 (MainThread): Parsing macros/sql/get_tables_by_prefix_sql.sql
2021-11-02 19:32:37.652674 (MainThread): Parsing macros/sql/star.sql
2021-11-02 19:32:37.655974 (MainThread): Parsing macros/sql/unpivot.sql
2021-11-02 19:32:37.663538 (MainThread): Parsing macros/sql/union.sql
2021-11-02 19:32:37.671470 (MainThread): Parsing macros/sql/groupby.sql
2021-11-02 19:32:37.672731 (MainThread): Parsing macros/sql/surrogate_key.sql
2021-11-02 19:32:37.675986 (MainThread): Parsing macros/sql/safe_add.sql
2021-11-02 19:32:37.677496 (MainThread): Parsing macros/sql/nullcheck.sql
2021-11-02 19:32:37.679055 (MainThread): Parsing macros/sql/get_tables_by_pattern_sql.sql
2021-11-02 19:32:37.685390 (MainThread): Parsing macros/sql/get_column_values.sql
2021-11-02 19:32:37.690183 (MainThread): Parsing macros/sql/pivot.sql
2021-11-02 19:32:37.693935 (MainThread): Parsing macros/sql/get_query_results_as_dict.sql
2021-11-02 19:32:37.696071 (MainThread): Parsing macros/sql/haversine_distance.sql
2021-11-02 19:32:38.032386 (MainThread): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 19:32:38.045209 (MainThread): Acquiring new bigquery connection "model.freetrade_test.withdrawable_cash_timeseries".
2021-11-02 19:32:38.049807 (MainThread): Acquiring new bigquery connection "model.freetrade_test.revenue_cashflows".
2021-11-02 19:32:38.054277 (MainThread): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 19:32:38.057729 (MainThread): Acquiring new bigquery connection "model.freetrade_test.subscription_revenue_cashflows".
2021-11-02 19:32:38.091955 (MainThread): Acquiring new bigquery connection "operation.freetrade_test.freetrade_test-on-run-start-0".
2021-11-02 19:32:38.129861 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 19:32:38.131595 (MainThread): 'soft_unicode' has been renamed to 'soft_str'. The old name will be removed in MarkupSafe 2.1.
2021-11-02 19:32:38.193215 (MainThread): [WARNING]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.freetrade_test.example

2021-11-02 19:32:38.199718 (MainThread): Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b00754d8-d842-4b4a-933e-cf0d1fcfa1a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f88130>]}
2021-11-02 19:32:38.209349 (MainThread): write_gpickle is deprecated and will be removed in 3.0.Use ``pickle.dump(G, path, protocol)``
2021-11-02 19:32:38.209843 (MainThread): Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b00754d8-d842-4b4a-933e-cf0d1fcfa1a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f880a0>]}
2021-11-02 19:32:38.210114 (MainThread): Found 5 models, 2 tests, 0 snapshots, 0 analyses, 374 macros, 1 operation, 0 seed files, 0 sources, 0 exposures
2021-11-02 19:32:38.211572 (MainThread): 
2021-11-02 19:32:38.211945 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 19:32:38.213213 (ThreadPoolExecutor-0_0): Acquiring new bigquery connection "list_ft-data-330317".
2021-11-02 19:32:38.213408 (ThreadPoolExecutor-0_0): Opening a new connection, currently in state init
2021-11-02 19:32:38.659412 (ThreadPoolExecutor-1_0): Acquiring new bigquery connection "list_ft-data-330317_ft_data".
2021-11-02 19:32:38.660042 (ThreadPoolExecutor-1_0): Opening a new connection, currently in state closed
2021-11-02 19:32:38.672191 (ThreadPoolExecutor-1_0): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 19:32:38.994114 (MainThread): 19:32:38 | 
2021-11-02 19:32:38.994658 (MainThread): 19:32:38 | Running 1 on-run-start hook
2021-11-02 19:32:38.995065 (MainThread): Compiling operation.freetrade_test.freetrade_test-on-run-start-0
2021-11-02 19:32:39.000851 (MainThread): Writing injected SQL for node "operation.freetrade_test.freetrade_test-on-run-start-0"
2021-11-02 19:32:39.003560 (MainThread): 19:32:39 | 1 of 1 START hook: freetrade_test.on-run-start.0..................... [RUN]
2021-11-02 19:32:39.003955 (MainThread): Opening a new connection, currently in state closed
2021-11-02 19:32:39.013048 (MainThread): On master: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "connection_name": "master"} */


create schema if not exists ft_data;


    CREATE OR REPLACE FUNCTION ft_data.tumble_interval(
     val TIMESTAMP, tumble_seconds INT64)
    AS (
     timestamp_seconds(div(UNIX_SECONDS(val), tumble_seconds) *  tumble_seconds))
;


    CREATE OR REPLACE FUNCTION
     ft_data.timeseries_index(keys ARRAY<INT64>, tumble_seconds INT64, min_ts TIMESTAMP, max_ts Timestamp)
    AS ((
     SELECT ARRAY_AGG(x)
     FROM (
       SELECT series_key, tumble_val
       FROM UNNEST(
         GENERATE_TIMESTAMP_ARRAY(
           ft_data.tumble_interval(min_ts, tumble_seconds),
           ft_data.tumble_interval(max_ts, tumble_seconds),
           INTERVAL tumble_seconds SECOND
         )
       ) AS tumble_val
       CROSS JOIN UNNEST(keys) AS series_key
     ) x
    ))
;


2021-11-02 19:32:41.777942 (MainThread): 19:32:41 | 1 of 1 OK hook: freetrade_test.on-run-start.0........................ [SCRIPT (0.0 Bytes processed) in 2.77s]
2021-11-02 19:32:41.778529 (MainThread): 19:32:41 | 
2021-11-02 19:32:41.779264 (MainThread): 19:32:41 | Concurrency: 4 threads (target='dev')
2021-11-02 19:32:41.779545 (MainThread): 19:32:41 | 
2021-11-02 19:32:41.782770 (Thread-1): Began running node model.freetrade_test.account_cashflows
2021-11-02 19:32:41.783149 (Thread-2): Began running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 19:32:41.783616 (Thread-1): 19:32:41 | 1 of 5 START table model ft_data.account_cashflows................... [RUN]
2021-11-02 19:32:41.783850 (Thread-3): Began running node model.freetrade_test.subscription_revenue_cashflows
2021-11-02 19:32:41.784490 (Thread-2): 19:32:41 | 2 of 5 START table model ft_data.fx_revenue_cashflows................ [RUN]
2021-11-02 19:32:41.785076 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.account_cashflows".
2021-11-02 19:32:41.785427 (Thread-3): 19:32:41 | 3 of 5 START table model ft_data.subscription_revenue_cashflows...... [RUN]
2021-11-02 19:32:41.785900 (Thread-2): Acquiring new bigquery connection "model.freetrade_test.fx_revenue_cashflows".
2021-11-02 19:32:41.786150 (Thread-1): Compiling model.freetrade_test.account_cashflows
2021-11-02 19:32:41.786683 (Thread-3): Acquiring new bigquery connection "model.freetrade_test.subscription_revenue_cashflows".
2021-11-02 19:32:41.786909 (Thread-2): Compiling model.freetrade_test.fx_revenue_cashflows
2021-11-02 19:32:41.791449 (Thread-1): Writing injected SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 19:32:41.791663 (Thread-3): Compiling model.freetrade_test.subscription_revenue_cashflows
2021-11-02 19:32:41.794766 (Thread-2): Writing injected SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 19:32:41.802548 (Thread-3): Opening a new connection, currently in state init
2021-11-02 19:32:41.802919 (Thread-1): finished collecting timing info
2021-11-02 19:32:41.809824 (Thread-2): finished collecting timing info
2021-11-02 19:32:41.815791 (Thread-1): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55538), raddr=('142.250.187.202', 443)>
2021-11-02 19:32:41.822493 (Thread-1): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55539), raddr=('216.58.212.202', 443)>
2021-11-02 19:32:41.822750 (Thread-3): On model.freetrade_test.subscription_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.subscription_revenue_cashflows"} */


        select 

    datetime_diff(
        cast(cast('2022-01-01' as date) as datetime),
        cast(cast('2021-01-01' as date) as datetime),
        month
    )


2021-11-02 19:32:41.823441 (Thread-1): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55540), raddr=('142.250.187.202', 443)>
2021-11-02 19:32:41.830333 (Thread-2): Opening a new connection, currently in state init
2021-11-02 19:32:41.830643 (Thread-1): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55541), raddr=('216.58.212.202', 443)>
2021-11-02 19:32:41.840828 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 19:32:41.845980 (Thread-2): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 19:32:41.846710 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 19:32:42.201090 (Thread-1): Writing runtime SQL for node "model.freetrade_test.account_cashflows"
2021-11-02 19:32:42.201377 (Thread-2): Writing runtime SQL for node "model.freetrade_test.fx_revenue_cashflows"
2021-11-02 19:32:42.201933 (Thread-1): On model.freetrade_test.account_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.account_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`account_cashflows`
  
  
  OPTIONS()
  as (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



WITH deposits AS
(
       SELECT customer_id,
              deposited_at  AS log_datetime,
              amount_in_gbp AS amount,
              "deposit"     AS transaction_type
       FROM   `ft-data-330317.ft_source_data.deposits`), withdrawals AS
(
       SELECT customer_id,
              requested_at AS log_datetime,
              -amount      AS amount,
              "withdrawal" AS transaction_type
       FROM   `ft-data-330317.ft_source_data.withdrawals`),

       buys AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              -value      AS amount,
              "buy"       AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'buy'),

       sells AS
(
       SELECT customer_id,
              executed_at AS log_datetime,
              value       AS amount,
              "sell"      AS transaction_type,
       FROM   `ft-data-330317.ft_source_data.orders`
       WHERE  side = 'sell'),

       cashflows AS
(
       SELECT *
       FROM   withdrawals
       UNION ALL
                 (
                        SELECT *
                        FROM   deposits)
          UNION ALL
                    (
                           SELECT *
                           FROM   buys)
             UNION ALL
                       (
                              SELECT *
                              FROM   sells)
             ORDER BY  customer_id,
                       log_datetime)
SELECT   *
FROM     cashflows
ORDER BY customer_id, log_datetime ASC

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
    
2021-11-02 19:32:42.203021 (Thread-2): On model.freetrade_test.fx_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.fx_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

/* Assume here that FT take 1% charge on US orders */

SELECT customer_id, 0.01 * value as amount,
       order_id, settled_at as datetime FROM `ft-data-330317.ft_source_data.orders` where instrument_country = 'US'

ORDER BY datetime ASC
  );
    
2021-11-02 19:32:42.767513 (Thread-3): Writing injected SQL for node "model.freetrade_test.subscription_revenue_cashflows"
2021-11-02 19:32:42.768428 (Thread-3): finished collecting timing info
2021-11-02 19:32:42.772494 (Thread-3): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 19:32:42.909171 (Thread-3): Writing runtime SQL for node "model.freetrade_test.subscription_revenue_cashflows"
2021-11-02 19:32:42.910423 (Thread-3): On model.freetrade_test.subscription_revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.subscription_revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`subscription_revenue_cashflows`
  
  
  OPTIONS()
  as (
    

with months as (

/*
call as follows:

date_spine(
    "day",
    "to_date('01/01/2016', 'mm/dd/yyyy')",
    "dateadd(week, 1, current_date)"
)

*/

with rawdata as (

    

    

    with p as (
        select 0 as generated_number union all select 1
    ), unioned as (

    select

    
    p0.generated_number * power(2, 0)
     + 
    
    p1.generated_number * power(2, 1)
     + 
    
    p2.generated_number * power(2, 2)
     + 
    
    p3.generated_number * power(2, 3)
    
    
    + 1
    as generated_number

    from

    
    p as p0
     cross join 
    
    p as p1
     cross join 
    
    p as p2
     cross join 
    
    p as p3
    
    

    )

    select *
    from unioned
    where generated_number <= 12
    order by generated_number



),

all_periods as (

    select (
        

        datetime_add(
            cast( cast('2021-01-01' as date) as datetime),
        interval row_number() over (order by 1) - 1 month
        )


    ) as date_month
    from rawdata

),

filtered as (

    select *
    from all_periods
    where date_month <= cast('2022-01-01' as date)

)

select * from filtered

)

select
    subscriptions.customer_id,
    subscriptions.subscription_id,
    subscriptions.monthly_fee as amount,
    subscriptions.subscription_type,
    DATE_ADD(months.date_month, INTERVAL (
        EXTRACT(DAY FROM subscriptions.created_at) - EXTRACT(DAY FROM months.date_month)) DAY) as billing_date

from `ft-data-330317.ft_source_data.subscriptions` subscriptions

join months
    -- all months after start date
    on  months.date_month >= DATE(subscriptions.created_at)
    -- and before end date
    and months.date_month <= DATE('2022-01-01')

ORDER BY customer_id, date_month ASC
  );
    
2021-11-02 19:32:44.170505 (Thread-2): finished collecting timing info
2021-11-02 19:32:44.171243 (Thread-2): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b00754d8-d842-4b4a-933e-cf0d1fcfa1a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f9ec10>]}
2021-11-02 19:32:44.171778 (Thread-2): 19:32:44 | 2 of 5 OK created table model ft_data.fx_revenue_cashflows........... [CREATE TABLE (15.3k rows, 2.1 MB processed) in 2.39s]
2021-11-02 19:32:44.172043 (Thread-2): Finished running node model.freetrade_test.fx_revenue_cashflows
2021-11-02 19:32:44.400114 (Thread-1): finished collecting timing info
2021-11-02 19:32:44.401213 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b00754d8-d842-4b4a-933e-cf0d1fcfa1a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110e7ee50>]}
2021-11-02 19:32:44.402008 (Thread-1): 19:32:44 | 1 of 5 OK created table model ft_data.account_cashflows.............. [CREATE TABLE (37.9k rows, 1.0 MB processed) in 2.62s]
2021-11-02 19:32:44.402308 (Thread-1): Finished running node model.freetrade_test.account_cashflows
2021-11-02 19:32:44.402982 (Thread-4): Began running node model.freetrade_test.withdrawable_cash_timeseries
2021-11-02 19:32:44.403445 (Thread-4): 19:32:44 | 4 of 5 START table model ft_data.withdrawable_cash_timeseries........ [RUN]
2021-11-02 19:32:44.404007 (Thread-4): Acquiring new bigquery connection "model.freetrade_test.withdrawable_cash_timeseries".
2021-11-02 19:32:44.404275 (Thread-4): Compiling model.freetrade_test.withdrawable_cash_timeseries
2021-11-02 19:32:44.410474 (Thread-4): Writing injected SQL for node "model.freetrade_test.withdrawable_cash_timeseries"
2021-11-02 19:32:44.411165 (Thread-4): finished collecting timing info
2021-11-02 19:32:44.414217 (Thread-4): Opening a new connection, currently in state init
2021-11-02 19:32:44.421690 (Thread-4): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 19:32:44.727025 (Thread-4): Writing runtime SQL for node "model.freetrade_test.withdrawable_cash_timeseries"
2021-11-02 19:32:44.729243 (Thread-4): On model.freetrade_test.withdrawable_cash_timeseries: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.withdrawable_cash_timeseries"} */


  create or replace table `ft-data-330317`.`ft_data`.`withdrawable_cash_timeseries`
  
  
  OPTIONS()
  as (
    /*
A timeseries of account balances for each client binned every 4hrs.
Can definitely be tidied up - e.g. not use inline functions but need to figure out how to do this in dbt
*/



/*
Project/aggregate cashflow data into tumbled bins and project onto customer_id, datetime index
*/

    WITH event_logs AS
    (
             SELECT   * ,
                      sum(amount) OVER ( partition BY customer_id ORDER BY log_datetime rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row) AS balance
             FROM     `ft-data-330317`.`ft_data`.`account_cashflows`
             ORDER BY log_datetime ASC),

          agged_events AS
    (
             SELECT   sum(amount) delta,
                      customer_id,
                     ft_data.tumble_interval(log_datetime, 21600) tumble
             FROM     event_logs
             GROUP BY customer_id,
                      tumble
             ORDER BY customer_id,
                      tumble ASC ),
           args AS
    (
           SELECT array_agg(DISTINCT customer_id) AS KEY,
                  min(tumble)                     AS min_ts,
                  max(tumble)                     AS max_ts
           FROM   agged_events ),

           timeseries AS
    (
                    SELECT          series_key         AS customer_id,
                                    tumble_val         AS tumble,
                                    COALESCE(delta, 0) AS def,
                                    delta              AS unfilled
                    FROM            unnest(
                                    (
                                           SELECT  ft_data.timeseries_index(KEY, 21600, min_ts, max_ts)
                                           FROM   args) ) a
                    LEFT OUTER JOIN agged_events b
                    ON              a.series_key = b.customer_id
                    AND             a.tumble_val = b.tumble
                    ORDER BY        customer_id,
                                    tumble_val DESC)

    SELECT   customer_id,
             tumble                                                                                                           AS datetime,
             sum(def) OVER ( partition BY customer_id ORDER BY tumble rows BETWEEN UNBOUNDED PRECEDING AND      CURRENT row ) AS account_balance
    FROM     timeseries
    ORDER BY customer_id,
             tumble ASC
  );
    
2021-11-02 19:32:45.129399 (Thread-3): finished collecting timing info
2021-11-02 19:32:45.130495 (Thread-3): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b00754d8-d842-4b4a-933e-cf0d1fcfa1a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1111c8f40>]}
2021-11-02 19:32:45.131256 (Thread-3): 19:32:45 | 3 of 5 OK created table model ft_data.subscription_revenue_cashflows. [CREATE TABLE (5.1k rows, 38.2 KB processed) in 3.34s]
2021-11-02 19:32:45.131561 (Thread-3): Finished running node model.freetrade_test.subscription_revenue_cashflows
2021-11-02 19:32:45.132172 (Thread-1): Began running node model.freetrade_test.revenue_cashflows
2021-11-02 19:32:45.132635 (Thread-1): 19:32:45 | 5 of 5 START table model ft_data.revenue_cashflows................... [RUN]
2021-11-02 19:32:45.133171 (Thread-1): Acquiring new bigquery connection "model.freetrade_test.revenue_cashflows".
2021-11-02 19:32:45.133428 (Thread-1): Compiling model.freetrade_test.revenue_cashflows
2021-11-02 19:32:45.139754 (Thread-1): Writing injected SQL for node "model.freetrade_test.revenue_cashflows"
2021-11-02 19:32:45.140453 (Thread-1): finished collecting timing info
2021-11-02 19:32:45.143446 (Thread-1): Opening a new connection, currently in state closed
2021-11-02 19:32:45.150734 (Thread-1): Client.dataset is deprecated and will be removed in a future version. Use a string like 'my_project.my_dataset' or a cloud.google.bigquery.DatasetReference object, instead.
2021-11-02 19:32:45.461359 (Thread-1): Writing runtime SQL for node "model.freetrade_test.revenue_cashflows"
2021-11-02 19:32:45.462471 (Thread-1): On model.freetrade_test.revenue_cashflows: /* {"app": "dbt", "dbt_version": "0.21.0", "profile_name": "freetrade_test", "target_name": "dev", "node_id": "model.freetrade_test.revenue_cashflows"} */


  create or replace table `ft-data-330317`.`ft_data`.`revenue_cashflows`
  
  
  OPTIONS()
  as (
    

WITH isa_revenues AS
(
       SELECT customer_id,
              TIMESTAMP(billing_date)  AS transaction_datetime,
              amount,
              "isa_monthly_fee" AS transaction_type
       FROM   `ft-data-330317`.`ft_data`.`subscription_revenue_cashflows` where
       subscription_type = 'isa'),

sipp_revenues AS

(

       SELECT customer_id,
              TIMESTAMP(billing_date)  AS transaction_datetime,
              amount,
              "sipp_monthly_fee" AS transaction_type
       FROM   `ft-data-330317`.`ft_data`.`subscription_revenue_cashflows`
       where subscription_type = 'sipp'),

fx_revenues AS

(SELECT customer_id, datetime AS transaction_datetime, amount, 'US_fx_charge' as transaction_type
 FROM `ft-data-330317`.`ft_data`.`fx_revenue_cashflows`
)


       SELECT *
       FROM   isa_revenues
       UNION ALL
                 (
                    SELECT *
                        FROM   sipp_revenues )
          UNION ALL
                    (
                           SELECT *
                           FROM   fx_revenues)

             ORDER BY  customer_id,
                       transaction_datetime
  );
    
2021-11-02 19:32:47.410477 (Thread-1): finished collecting timing info
2021-11-02 19:32:47.411566 (Thread-1): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b00754d8-d842-4b4a-933e-cf0d1fcfa1a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112232c70>]}
2021-11-02 19:32:47.412303 (Thread-1): 19:32:47 | 5 of 5 OK created table model ft_data.revenue_cashflows.............. [CREATE TABLE (20.4k rows, 503.1 KB processed) in 2.28s]
2021-11-02 19:32:47.412604 (Thread-1): Finished running node model.freetrade_test.revenue_cashflows
2021-11-02 19:32:49.787927 (Thread-4): finished collecting timing info
2021-11-02 19:32:49.789045 (Thread-4): Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b00754d8-d842-4b4a-933e-cf0d1fcfa1a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f392e0>]}
2021-11-02 19:32:49.789827 (Thread-4): 19:32:49 | 4 of 5 OK created table model ft_data.withdrawable_cash_timeseries... [CREATE TABLE (1.1m rows, 888.4 KB processed) in 5.39s]
2021-11-02 19:32:49.790123 (Thread-4): Finished running node model.freetrade_test.withdrawable_cash_timeseries
2021-11-02 19:32:49.792117 (MainThread): Acquiring new bigquery connection "master".
2021-11-02 19:32:49.792757 (MainThread): 19:32:49 | 
2021-11-02 19:32:49.793048 (MainThread): 19:32:49 | Finished running 5 table models, 1 hook in 11.58s.
2021-11-02 19:32:49.793296 (MainThread): Connection 'master' was properly closed.
2021-11-02 19:32:49.793520 (MainThread): Connection 'model.freetrade_test.revenue_cashflows' was properly closed.
2021-11-02 19:32:49.793721 (MainThread): Connection 'model.freetrade_test.fx_revenue_cashflows' was properly closed.
2021-11-02 19:32:49.793909 (MainThread): Connection 'model.freetrade_test.subscription_revenue_cashflows' was properly closed.
2021-11-02 19:32:49.794090 (MainThread): Connection 'model.freetrade_test.withdrawable_cash_timeseries' was properly closed.
2021-11-02 19:32:49.797641 (MainThread): unclosed <ssl.SSLSocket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55544), raddr=('142.250.187.202', 443)>
2021-11-02 19:32:49.797941 (MainThread): unclosed <ssl.SSLSocket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55547), raddr=('216.58.212.202', 443)>
2021-11-02 19:32:49.798185 (MainThread): unclosed <ssl.SSLSocket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55546), raddr=('142.250.187.202', 443)>
2021-11-02 19:32:49.798413 (MainThread): unclosed <ssl.SSLSocket fd=10, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55545), raddr=('142.250.187.202', 443)>
2021-11-02 19:32:49.798640 (MainThread): unclosed <ssl.SSLSocket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55548), raddr=('216.58.212.202', 443)>
2021-11-02 19:32:49.798868 (MainThread): unclosed <ssl.SSLSocket fd=21, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55549), raddr=('216.58.212.202', 443)>
2021-11-02 19:32:49.799165 (MainThread): unclosed <ssl.SSLSocket fd=23, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55551), raddr=('216.58.212.202', 443)>
2021-11-02 19:32:49.799401 (MainThread): unclosed <ssl.SSLSocket fd=22, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55550), raddr=('142.250.187.202', 443)>
2021-11-02 19:32:49.799654 (MainThread): unclosed <ssl.SSLSocket fd=24, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55552), raddr=('142.250.187.202', 443)>
2021-11-02 19:32:49.799868 (MainThread): unclosed <ssl.SSLSocket fd=25, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=('192.168.0.111', 55553), raddr=('216.58.212.202', 443)>
2021-11-02 19:32:49.827732 (MainThread): 
2021-11-02 19:32:49.827967 (MainThread): Completed successfully
2021-11-02 19:32:49.828153 (MainThread): 
Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
2021-11-02 19:32:49.828359 (MainThread): Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110d87b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110e77d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110ef5460>]}
2021-11-02 19:32:49.828567 (MainThread): Flushing usage events
